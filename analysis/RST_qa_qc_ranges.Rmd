---
title: "RST QA/QC Ranges"
author: "Erin Cain"
date: "4/29/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(ggplot2)
library(googleCloudStorageR)
```


## RST QA/QC

## Load in combined RST Datasets

### Import Data-sets
```{r}
# Access Data from Google Cloud (Download and Import)
# Link : <https://console.cloud.google.com/storage/browser/jpe-dev-bucket/standard-format-data;tab=[â€¦]iew=project&prefix=&forceOnObjectsSortingFiltering=false>

# Google Cloud Set up
# Sys.setenv("GCS_AUTH_FILE" = "config.json")
# Sys.setenv("GCS_DEFAULT_BUCKET" = "jpe-dev-bucket")
# gcs_auth(json_file = Sys.getenv("GCS_AUTH_FILE"))
# gcs_global_bucket(bucket = Sys.getenv("GCS_DEFAULT_BUCKET"))
# 
# gcs_get_object(object_name = "standard-format-data/standard_RST_environmental.csv",
#                bucket = gcs_get_global_bucket(),
#                saveToDisk = "standard_RST_environmental.csv",
#                overwrite = TRUE)
# gcs_get_object(object_name = "standard-format-data/standard_rst_trap.csv",
#                bucket = gcs_get_global_bucket(),
#                saveToDisk = "standard_rst_trap.csv",
#                overwrite = TRUE)
# gcs_get_object(object_name = "standard-format-data/standard_rst_catch.csv",
#                bucket = gcs_get_global_bucket(),
#                saveToDisk = "standard_rst_catch.csv",
#                overwrite = TRUE)
# gcs_get_object(object_name = "standard-format-data/standard_recapture.csv",
#                bucket = gcs_get_global_bucket(),
#                saveToDisk = "standard_recapture.csv",
#                overwrite = TRUE)

# Import Data-sets
environmental <- read_csv("standard_RST_environmental.csv")
trap_operation <- read_csv("standard_rst_trap.csv")
catch <- read_csv("standard_rst_catch.csv")
mark_recapture <- read_csv("standard_recapture.csv")
```


## Explore Catch Ranges
* `fork_length` - fork length (mm)
* `count` - number of fish observed
* `weight`- observed fish weight

```{r}
# Identify Numerical Columns
catch %>% glimpse()

# Filter for numerical columns
catch_variables <- catch %>%
  select(c(fork_length,count,weight))

# HELPER FUNCTION: Get Ranges of a column
find_range <- function(data) {
  # Get the min and max value
  result <- range(data, na.rm = TRUE)
}

# Get Ranges
catch_ranges <- as.data.frame(apply(catch_variables, 2, find_range)) # get ranges
rownames(catch_ranges) <- c("min","max") # labels
catch_ranges
```
These min and max seem a bit strange, so we would need to explore further to define more representative ranges.

### Boxplots
```{r}
catch_variables %>%
  ggplot(aes(fork_length)) +
  geom_boxplot() +
  labs(title="Fork Lengths")

catch_variables %>%
  ggplot(aes(count)) +
  geom_boxplot() +
  labs(title="Count")

catch_variables %>%
  ggplot(aes(weight)) +
  geom_boxplot() +
  labs(title="weight")
```

### Association Plots
```{r}
catch_variables %>%
  ggplot(mapping=aes(x= fork_length,y=weight)) +
  geom_point() +
  labs(y="Weight",x ="Fork Length (mm)",title="Fork Length vs Weight")
```
Current axis values does not give an accurate representation of ranges.

```{r}
catch_variables %>% 
  filter(fork_length<250,
         fork_length>0,
         weight<100,
         weight>0) %>% 
  ggplot(mapping=aes(x= fork_length,y=weight)) +
  geom_point() +
  labs(y="Weight",x ="Fork Length (mm)",title="Fork Length vs Weight")
```
It looks like the average fork length and weight will fall within these axis ranges as these bound are more representative of the data than we had originally. Therefore, we can get our expected ranges by getting the 5num summary for the following.

```{r}
catch_variables %>% 
  filter(fork_length<250,
         fork_length>0,
         weight<100,
         weight>0,
         count>40) %>%
  ggplot(mapping=aes(x= fork_length,y=weight)) +
  geom_point() +
  labs(y="Weight",x ="Fork Length (mm)",title="Fork Length vs Weight")
```
It appears that when counts are abnormally high (greater than 40) the data for weight and and fork length is usually missing. So we can exclude count greater than 40 when considering our ranges.

### Cleaned Variable
```{r}
catach_variables_cleaned <- catch_variables %>% 
  filter(fork_length<250,
         fork_length>0,
         weight<100,
         weight>0,
         count<40)
```

### 5 Number Summary
```{r}
### 5NumSum
col1 = summary(catach_variables_cleaned$fork_length)
col2 = summary(catach_variables_cleaned$count)
col3 = summary(catach_variables_cleaned$weight)
catch_5NumSum = matrix(c(col1,col2,col3),ncol=3)
rownames(catch_5NumSum) = c("Min","1st Qu.","Median","Mean","3rd Qu.","Max")
colnames(catch_5NumSum) = c("fork_length","count","weight")
catch_5NumSum
```
### Recommendations
`fork length`: 41-75
`count`: 1-39
`weight`: 0.5-4.3

## Explore Environmental Ranges
* `turbidity` - turbidity measure in NTU 
* `flow`-  flow in cfs  
* `secchi` - secchi measure in ft 

### Variables
```{r}
# Identify Numerical Columns
environmental %>%
  glimpse()

# Filter for numerical columns
environmental_variables <- environmental %>%
  select(c(turbidity, flow, secchi))

# Get Ranges
environmental_ranges <- as.data.frame(apply(environmental_variables, 2, find_range)) # get ranges
rownames(environmental_ranges) <- c("min","max") # labels
environmental_ranges
```


### Association Plots
```{r}
environmental_variables %>%
  ggplot(mapping=aes(x= fork_length,y=weight)) +
  geom_point() +
  labs(y="Weight",x ="Fork Length (mm)",title="Fork Length vs Weight")
```

## Explore Trap Operation Ranges
Capture juvenile fish during out migration. During efficiency trials, the sample of fish are caught and later released to determine how effective the trap is at capturing the fish. Traps are sometimes measured with rotational as a function of flow going through trap and its affect on velocity.

# TODO: revolution and flow. IF flow is 10,000 then revloution could be. Pair ranging.Reasonal numbers might be rotary screwshop and rotary number on google. Box plots will help us narrow.

* `sample_period_revolutions` - number of revolutions on cone at given point of time
* `river_left_depth`- 
* `river_center_depth` -
* `river_right_depth`-
* `depth_adjust`-
* `avg_time_per_rev` -
* `debris_volume` -
* `rpms_start`- revolutions per minute at start
* `rpms_end` - revolutions per minute at end
* `cone_rpm`- 

### Variables
```{r}
# Identify Numerical Columns
trap_operation %>%
  glimpse()

# Filter for numerical columns
trap_operation_variables <- trap_operation %>%
  select(c(sample_period_revolutions,river_left_depth,
           river_center_depth, river_right_depth, depth_adjust, avg_time_per_rev,
           debris_volume, rpms_start, rpms_end, cone_rpm))

# Get Ranges
trap_operation_ranges <- as.data.frame(apply(trap_operation_variables, 2, find_range)) # get ranges
rownames(trap_operation_ranges) <- c("min","max") # labels
trap_operation_ranges
```


# ===== Consider Doing Later


## Explore Mark Recapture Ranges 
Description of what variables we are defining ranges for. 

* `number_recaptured` - count of observed fish 
* `median_fork_length_recaptured` - average fork length

### Variables
```{r}
# Identify Numerical Columns
mark_recapture %>%
  glimpse()

# Filter for numerical columns
mark_recapture_variables <- mark_recapture %>%
  select(c(number_recaptured, median_fork_length_recaptured))

# Get Ranges
mark_recapture_ranges <- as.data.frame(apply(mark_recapture_variables, 2, find_range)) # get ranges
rownames(mark_recapture_ranges) <- c("min","max") # labels
mark_recapture_ranges
```