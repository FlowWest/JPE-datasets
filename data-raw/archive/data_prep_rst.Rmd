---
title: "Data prep for JPE model"
output: html_document
---
# RST data

## Table 1. Unmarked catch (5 fields)
Guidance from Josh
- Fields would be: Year (Yr), Julian Week (Jwk), Unmarked catch (u1),
and mean size of unmarked catch (u1_sz), Effort (Eff, hours trap fished per week).
- If more than one trap, sum data across traps (including effort).

```{r, include = F}
library(tidyverse)
library(lubridate)
library(googleCloudStorageR)

Sys.setenv("GCS_AUTH_FILE" = "config.json")
Sys.setenv("GCS_DEFAULT_BUCKET" = "jpe-dev-bucket")
```

Data were checked and cleaned in scripts available [here](https://github.com/FlowWest/JPE-datasets/tree/main/scripts/rst)
Cleaned data were saved on the jpe-dev-bucket on google cloud with the exception
of Knights Landing data from CAMP which has not yet been saved to google cloud.

```{r, data_pull}
# # Data pull ---------------------------------------------------------------

# Set your authentication using gcs_auth

gcs_auth(json_file = Sys.getenv("GCS_AUTH_FILE"))
# Set global bucket
gcs_global_bucket(bucket = Sys.getenv("GCS_DEFAULT_BUCKET"))

# define files to pull in (in some cases there is just one catch file while others
# have sample and environmental data)
files_battle <- tibble(path = rep("rst/battle-creek/data/battle_rst_",3),
                       name = c("catch","environmental","passage_estimates"),
                       save = rep("data/rst/battle_rst_",3))
files_butte <- tibble(path = "rst/butte-creek/data/butte_rst",
                      name = c(""),
                      save = "data/rst/butte_rst")
files_clear <- tibble(path = rep("rst/clear-creek/data/clear_rst_",3),
                      name = c("catch","environmental","passage_estimates"),
                      save = rep("data/rst/clear_rst_",3))
files_deer <- tibble(path = "rst/deer-creek/data/deer_rst",
                     name = c(""),
                     save = "data/rst/deer_rst")
files_feather <- tibble(path = rep("rst/feather-river/data/feather_rst",2),
                        name = c("","_effort"),
                        save = rep("data/rst/feather_rst",2))
# files_knights <- tibble(path = rep("rst/lower-sac-river/data/knights-landing/knl_combine_",2),
#                         name = c("rst_clean","sampling_effort_clean"),
#                         save = rep("data/rst/knights_",2))
files_tisdale <- tibble(path = "rst/lower-sac-river/data/tisdale/rst_clean",
                        name = c(""),
                        save = "data/rst/tisdale_rst")
files_mill <- tibble(path = "rst/mill-creek/data/mill_rst",
                     name = c(""),
                     save = "data/rst/mill_rst")
files_yuba <- tibble(path = "rst/yuba-river/data/yuba_rst",
                     name = c(""),
                     save = "data/rst/yuba_rst")
# function to save file to disk
get_data <- function(path, name, save) {
  gcs_get_object(object_name = paste0(path, name, ".csv"),
                 bucket = gcs_get_global_bucket(),
                 saveToDisk = paste0(save, name, ".csv"),
                 overwrite = TRUE)
}
# apply function to each set of files
pmap(files_battle, get_data)
pmap(files_butte, get_data)
pmap(files_clear, get_data)
pmap(files_deer, get_data)
pmap(files_feather, get_data)
# pmap(files_knights, get_data)
pmap(files_tisdale, get_data)
pmap(files_mill, get_data)
pmap(files_yuba, get_data)

# load in data
# catch data
battle_rst <- read_csv("data/rst/battle_rst_catch.csv")
butte_rst <- read_csv("data/rst/butte_rst.csv") # contains trap data too
clear_rst <- read_csv("data/rst/clear_rst_catch.csv")
deer_rst <- read_csv("data/rst/deer_rst.csv") # contains trap data too
feather_rst <- read_csv("data/rst/feather_rst.csv")
# knights_rst <- read_csv("data/rst/knights_rst_clean.csv") # contains cpue info
tisdale_rst <- read_csv("data/rst/tisdale_rst.csv")
mill_rst <- read_csv("data/rst/mill_rst.csv") # contains trap data too
yuba_rst <- read_csv("data/rst/yuba_rst.csv")

# sampling effort and environmental
battle_environmental <- read_csv("data/rst/battle_rst_environmental.csv")
clear_environmental <- read_csv("data/rst/clear_rst_environmental.csv")
feather_effort <- read_csv("data/rst/feather_rst_effort.csv")
# knights_effort <- read_csv("data/rst/knights_sampling_effort_clean.csv")

# Knights landing data pulled from camp
# TODO add to cloud (this dataset was shared later and has not yet been added to cloud)
knights_landing_rst <- read_rds("data/rst/knights_landing_raw_catch.rds")
```

Battle Creek has data available to calculate the hours fished. About 1% of catch
data is interpolated. Fork length measurements
are missing for `r (filter(battle_rst, is.na(fork_length), count >0) %>% tally()/length(battle_rst$date))*100`%. There are no
missing run designations.


```{r, helpers}

# calculating hours fished when have start and stop datetime
hours_fished <- function(dat){
  dat %>%
    filter(!is.na(start_date), !is.na(start_time)) %>%
    mutate(start_datetime = ymd_hms(paste(start_date, start_time)),
         stop_datetime = ymd_hms(paste(stop_date, stop_time)),
         hours_fished = difftime(stop_datetime, start_datetime, units = "hours"),
         week = week(stop_date),
         year = year(stop_date))
}

# calculating hours fished when have only date and time
hours_fished_no_end_date <- function(dat) {
  dat %>%
  arrange(start_datetime) %>%
  mutate(end_datetime = lead(start_datetime)) %>%
  mutate(hours_fished = difftime(end_datetime, start_datetime, units = "hours"),
         week = week(end_datetime),
         year = year(end_datetime)) %>%
  # removing counts between seasons (e.g. 06-23 to 10-01)
  filter(hours_fished < 1500)
}

# standard encoding fixes for run
run_encoding <- function(dat) {
  dat %>%
    mutate(run = case_when(is.na(run) | run == "Not recorded" |  run == "Not applicable (n/a)" ~ "not recorded",
                         count == 0  ~ NA_character_,
                         T ~ tolower(run)))
}

# origin_encoding <- function(dat) {
#   dat %>%
#     mutate(origin = case_when(is.na(origin) ~ "not recorded",
#                               count == 0 ~ NA_character_,
#                               T ~ tolower(origin)))
# }
```


```{r, battle}
## Battle ####
### Hours fished ####
# battle_environmental has trap_start_date, trap_state_time, sample_date, sample_time
battle_hours_fished <- battle_environmental %>%
  rename(start_date = trap_start_date,
         start_time = trap_start_time,
         stop_date = sample_date,
         stop_time = sample_time) %>%
  hours_fished()

#filter(battle_environmental, is.na(trap_start_time)) %>% tally()

battle_hours_fished_week_mean <- battle_hours_fished %>%
    # manual check of values, negative values and those greater than 50 are typos
    filter(hours_fished > 0, hours_fished < 50) %>%
    group_by(week, year) %>%
    summarize(mean_hours = mean(hours_fished))
  
battle_hours_fished_final <- left_join(battle_hours_fished, battle_hours_fished_week_mean) %>%
    mutate(hours_fished = case_when(hours_fished < 0 | hours_fished >= 50 ~ mean_hours,
                             T ~ hours_fished)) %>%
  group_by(week, year) %>%
  summarize(hours_fished = sum(hours_fished)) %>%
  mutate(tributary = "Battle Creek",
         site = "Battle Creek")

### Catch #####
battle_rst %>% glimpse
unique(battle_rst$run)
filter(battle_rst, is.na(fork_length), count > 0) %>% glimpse
filter(battle_rst, is.na(run)) %>% glimpse
# notes to include
# some data may be interpolated (~1% may be interpolated)
# no variable for marked so assume all are unmarked
# run is not filtered
# TODO compare mean observed v interpolated to decide if we should use
# TODO determine if natural production or if unknown. Natural because trap is above that hatchery

battle_rst_clean <- battle_rst %>%
  select(-c(sample_id, lifestage, dead, interpolated)) %>%
  mutate(tributary = "Battle Creek",
         site = "Battle Creek",
         origin = "natural") %>%
  run_encoding()
```

Hours fished are calculated by taking the difference between the date/time at for 
each observation. Only spring run salmon are monitored
on Butte Creek. Hatchery fish are included in the counts. Data are collected at
multiple sites: Okie Dam 1, Adams Dam, Okie Dam 2. Fork length measurements
are missing for `r (filter(butte_rst, is.na(fork_length), count >0) %>% tally()/length(butte_rst$date))*100`%.

```{r, butte}
## Butte ####
### Hours fished ####
butte_hours_fished <- butte_rst %>%
  distinct(date, time, station) %>%
  mutate(start_datetime = ymd_hms(paste(date, time))) %>%
  hours_fished_no_end_date()

butte_hours_fished_week_mean <- butte_hours_fished %>%
  # manual check of values, negative values and those greater than 100 are typos
  filter(hours_fished > 0, hours_fished < 100) %>%
  group_by(week, year, station) %>%
  summarize(mean_hours = mean(hours_fished))

butte_hours_fished_final <- left_join(butte_hours_fished, butte_hours_fished_week_mean) %>%
  mutate(hours_fished = case_when(hours_fished < 0 | hours_fished >= 100 ~ mean_hours,
                                  T ~ hours_fished)) %>%
  group_by(week, year, station) %>%
  summarize(hours_fished = sum(hours_fished, na.rm = T)) %>%
  mutate(tributary = "Butte Creek") %>%
  rename(site = station)

# Run was filtered to spring (or only spring is collected) prior to sharing data
# TODO include hatchery?
# TODO create origin variable where adclip is "hatchery", is NA natural or unknown?

butte_rst %>% glimpse
unique(butte_rst$station)
unique(butte_rst$mark_code)
filter(butte_rst, is.na(fork_length), count > 0) %>% glimpse
filter(butte_rst, is.na(mark_code)) %>% tally()

butte_rst_clean <- butte_rst %>%
  select(date, station, count, fork_length, mark_code) %>%
  rename(origin = mark_code) %>%
  mutate(tributary = "Butte Creek",
         run = "spring",
         origin = case_when(is.na(origin) ~ "not recorded",
                            count == 0 ~ NA_character_,
                            origin == "none" ~ "natural",
                            origin == "adclipped" ~ "hatchery")) %>%
  rename(site = station)
```

Clear Creek has data available to calculate the hours fished. Less than 1% of catch
data is interpolated. Fork length measurements
are missing for `r (filter(clear_rst, is.na(fork_length), count >0) %>% tally()/length(clear_rst$date))*100`%. There is one
missing run designation with no fork length, lifestage is parr.

```{r, clear}
## Clear ####
### Hours fished ####
# clear_environmental has trap_start_date, trap_state_time, sample_date, sample_time
clear_hours_fished <- clear_environmental %>%
  rename(start_date = trap_start_date,
         start_time = trap_start_time,
         stop_date = sample_date,
         stop_time = sample_time) %>%
  hours_fished()

clear_hours_fished_week_mean <- clear_hours_fished %>%
  # manual check of values, negative values and those greater than 50 are typos
  filter(hours_fished > 0, hours_fished < 50) %>%
  group_by(week, year) %>%
  summarize(mean_hours = mean(hours_fished))

clear_hours_fished_final <- left_join(clear_hours_fished, clear_hours_fished_week_mean) %>%
  mutate(hours_fished = case_when(hours_fished < 0 | hours_fished >= 50 ~ mean_hours,
                           T ~ hours_fished)) %>%
  group_by(week, year, station_code) %>%
  summarize(hours_fished = sum(hours_fished)) %>%
  rename(site = station_code) %>%
  mutate(tributary = "Clear Creek")

### Catch ####
clear_rst %>%glimpse
unique(clear_rst$run)
# only one with missing run designation
filter(clear_rst, is.na(run)) %>% tally()
# notes to include
# some data may be interpolated (less than 1% may be interpolated)
# all runs included
# no variable for mark code so assume all unmarked
# locations are unique locations
unique(clear_rst$station_code)
# TODO all natural or uknown origin?

clear_rst_clean <- clear_rst %>%
  select(-c(sample_id, lifestage, dead, interpolated)) %>%
  mutate(tributary = "Clear Creek",
         origin = "natural") %>%
  run_encoding() %>%
  rename(site = station_code)
```

Deer Creek does not have data available (no time variable) to calculate hours
fished. Run is not recorded. Fork length measurements
are missing for `r (filter(deer_rst, is.na(fork_length), count >0) %>% tally()/length(deer_rst$date))*100`%. Locations
are different names for the same trap and are summed across.

```{r, deer}
## Deer #####
# notes to include
# no variable for mark code so assume all unmarked
# locations are different names for trap at same location
# run is NA (not recorded or collected)
# TODO all natural origin or origin unknown?

deer_rst %>% glimpse
unique(deer_rst$location)
filter(deer_rst, is.na(fork_length), count > 0) %>% glimpse
deer_rst_clean <- deer_rst %>%
  select(date, location, count, fork_length) %>%
  group_by(date, fork_length) %>%
  summarize(count = sum(count, na.rm = T)) %>%
  mutate(tributary = "Deer Creek",
         site = "Deer Creek",
         run = "not recorded",
         origin = "natural")
```
Feather River has data available to calculate the hours fished. Data are for all 
natural salmon. Fork length measurements
are missing for `r (filter(feather_rst, is.na(fork_length), count > 0) %>% tally()/length(feather_rst$date))*100`%. 

```{r, feather}
## Feather ####
### Hours fished ####
feather_hours_fished <- feather_effort %>%
  distinct(visit_time, site_name) %>%
  rename(start_datetime = visit_time) %>%
  hours_fished_no_end_date()

feather_hours_fished_week_mean <- feather_hours_fished %>%
  # manual check of values, negative values and those greater than 50 are typos
  filter(hours_fished > 0, hours_fished < 100) %>%
  group_by(week, year, site_name) %>%
  summarize(mean_hours = mean(hours_fished))

feather_hours_fished_final <- left_join(feather_hours_fished,feather_hours_fished_week_mean) %>%
  mutate(hours_fished = case_when(hours_fished < 0 | hours_fished >= 100 ~ mean_hours,
                                  T ~ hours_fished)) %>%
  group_by(week, year, site_name) %>%
  summarize(hours_fished = sum(hours_fished, na.rm = T)) %>%
  mutate(tributary = "Feather River") %>%
  rename(site = site_name)

### Catch ####
feather_rst %>% glimpse
unique(feather_rst$run)
# 127 out of 180871 where run is not designated
# data are for all natural salmon
filter(feather_rst, is.na(run)) %>% tally()
# notes - sites are unique locations
# origin is all natural

feather_rst_clean <- feather_rst %>%
  select(date, site_name, fork_length, count, run) %>%
  mutate(tributary = "Feather River",
         origin = "natural") %>%
  run_encoding() %>%
  rename(site = site_name)
```
Knights Landing has data available to calculate the hours fished. Data include hatchery
and natural salmon. Fork length measurements
are missing for `r (filter(knights_landing_rst, is.na(forkLength), n > 0) %>% tally()/length(knights_landing_rst$visitTime))*100`%. 
5 cases where run was encoded as "Not applicable (n/a)" were changed to "not recorded"

```{r, knights}
## Knights Landing ####
### Hours fished ####
knights_hours_fished <- knights_landing_rst %>%
  distinct(visitTime, visitTime2) %>%
  rename(start_datetime = visitTime) %>%
  hours_fished_no_end_date()

knights_hours_fished_week_mean <- knights_hours_fished %>%
  # manual check of values, negative values and those greater than 50 are typos
  filter(hours_fished > 0, hours_fished < 100) %>%
  group_by(week, year) %>%
  summarize(mean_hours = mean(hours_fished))

knights_hours_fished_final <- left_join(knights_hours_fished, knights_hours_fished_week_mean) %>%
  mutate(hours_fished = case_when(hours_fished < 0 | hours_fished >= 100 ~ mean_hours,
                                  T ~ hours_fished)) %>%
  group_by(week, year) %>%
  summarize(hours_fished = sum(hours_fished, na.rm = T)) %>%
  mutate(tributary = "Lower Sacramento - Knights Landing",
         site = "Lower Sacramento - Knights Landing")

### Catch #####
unique(knights_landing_rst$commonName)
unique(knights_landing_rst$fishOrigin)
unique(knights_landing_rst$run)
filter(knights_landing_rst, run == "Not applicable (n/a)") %>% glimpse
filter(knights_landing_rst, is.na(forkLength), n > 0) %>% glimpse
# 1,603 unknown, 2 not recorded
filter(knights_landing_rst, fishOrigin == "Unknown") %>% tally()

knights_rst_clean <- knights_landing_rst %>%
  # filter(commonName == "Chinook salmon", fishOrigin == "Natural") %>%
  filter(commonName == "Chinook salmon") %>%
  select(forkLength, n, run, visitTime, fishOrigin) %>%
  rename(count = n,
         date = visitTime,
         fork_length = forkLength,
         origin = fishOrigin) %>%
  mutate(tributary = "Lower Sacramento - Knights Landing",
         site = "Lower Sacramento - Knights Landing",
         date = as_date(date),
         origin = tolower(origin)) %>%
  run_encoding()
```
Tisdale does not have data available to calculate the hours fished though we
did not receive their CAMP database and it may be in there. Data include hatchery
and natural salmon. Fork length measurements
are missing for `r (filter(tisdale_rst, is.na(fork_length_mm), count > 0) %>% tally()/length(tisdale_rst$date))*100`%. Filtered
out fish (n = 18) where mark type was pigment as these are included in mark
and recapture.

```{r, tisdale}
## Tisdale ####
# No hours data available
# Note that tisdale was aggregated to sum together traps from left and right
tisdale_rst %>% glimpse
# 15 obs where run is not recorded, 9 where run is NA
unique(tisdale_rst$run)
unique(tisdale_rst$species)
unique(tisdale_rst$rearing)
unique(tisdale_rst$mark_type)
filter(tisdale_rst, mark_type == "Pigment") %>% glimpse
filter(tisdale_rst, is.na(run)) %>% glimpse
filter(tisdale_rst, is.na(fork_length_mm), count > 0) %>% glimpse
filter(tisdale_rst, run == "unknown") %>% glimpse

tisdale_rst_clean <- tisdale_rst %>%
  # filter(rearing == "Natural", mark_type == "None") %>%
  # removed marked fish that were marked for efficiency
  filter(mark_type != "Pigment") %>%
  select(date, trap_position, fork_length_mm, count, run, rearing) %>%
  rename(fork_length = fork_length_mm,
         origin = rearing) %>%
  group_by(date, fork_length, run, origin) %>%
  summarize(count = sum(count, na.rm = T)) %>%
  mutate(tributary = "Lower Sacramento - Tisdale",
         site = "Lower Sacramento - Tisdale",
         origin = tolower(origin)) %>%
  run_encoding()
```

Mill Creek does not have data available (no time variable) to calculate hours
fished. Run is not recorded. Fork length measurements
are missing for `r (filter(mill_rst, is.na(fork_length), count >0) %>% tally()/length(mill_rst$date))*100`%. 

```{r, mill}
## Mill ####
# No hours fishing data available
# Run is not collected
# TODO natural origin or origin unknown?
mill_rst %>% glimpse
unique(mill_rst$location)
filter(mill_rst, is.na(fork_length), count > 0) %>% glimpse

mill_rst_clean <- mill_rst %>%
  select(date, count, fork_length) %>%
  mutate(tributary = "Mill Creek",
         site = "Mill Creek",
         run = "not recorded",
         origin = "natural")
```
Hours fished are calculated by taking the difference between the date/time at for 
each observation. Fork length measurements
are missing for `r (filter(yuba_rst, is.na(fork_length), count >0) %>% tally()/length(yuba_rst$date))*100`%. Locations
are different names for the same trap and are summed across. In less than 1%
run was encoded as "unknown"

```{r, yuba}
## Yuba ####
### Hours fished ####
yuba_hours_fished <- yuba_rst %>%
  distinct(date, time) %>%
  mutate(start_datetime = ymd_hms(paste(date, time))) %>%
  hours_fished_no_end_date()

yuba_hours_fished_week_mean <- yuba_hours_fished %>%
  # manual check of values, negative values and those greater than 100 are typos
  filter(hours_fished > 0, hours_fished < 100) %>%
  group_by(week, year) %>%
  summarize(mean_hours = mean(hours_fished))

yuba_hours_fished_final <- left_join(yuba_hours_fished, yuba_hours_fished_week_mean) %>%
  mutate(hours_fished = case_when(hours_fished < 0 | hours_fished >= 100 ~ mean_hours,
                                  T ~ hours_fished)) %>%
  group_by(week, year) %>%
  summarize(hours_fished = sum(hours_fished, na.rm = T)) %>%
  mutate(tributary = "Yuba River",
         site = "Yuba River")

yuba_rst %>% glimpse
unique(yuba_rst$location)
unique(yuba_rst$run)
ck <- filter(yuba_rst, is.na(run), !is.na(count), count > 0)
# all are CHN
unique(yuba_rst$organism_code)
# note that run designation is a combination of run and lifestage.
# run not filtered
# sites are names for traps at the same location and should be summed
# TODO natural origin or origin unknown?
filter(yuba_rst, is.na(fork_length), count > 0) %>% glimpse
filter(yuba_rst, is.na(run), count > 0) %>% glimpse
filter(yuba_rst, run == "unknown") %>% glimpse

yuba_rst_clean<- yuba_rst %>%
  select(date, fork_length, count, location, run) %>%
  group_by(date, fork_length, run) %>%
  summarize(count = sum(count, na.rm = T)) %>%
  mutate(tributary = "Yuba River",
         site = "Yuba River",
         origin = "natural") %>%
  run_encoding()
```

```{r, combine_format}
combined_rst <- bind_rows(battle_rst_clean,
                          butte_rst_clean,
                          clear_rst_clean,
                          deer_rst_clean,
                          feather_rst_clean,
                          knights_rst_clean,
                          tisdale_rst_clean,
                          mill_rst_clean,
                          yuba_rst_clean)

combined_hours_fished <- bind_rows(butte_hours_fished_final,
                                   battle_hours_fished_final,
                                   clear_hours_fished_final,
                                   knights_hours_fished_final,
                                   feather_hours_fished_final,
                                   yuba_hours_fished_final)
# Format data -------------------------------------------------------------
combined_rst_format <- combined_rst %>%
  mutate(week = week(date),
         year = year(date)) %>%
  group_by(week, year, tributary, site, run, origin) %>%
  summarize(count = sum(count, na.rm = T),
            mean_fork_length = mean(fork_length, na.rm = T)) %>%
  left_join(combined_hours_fished) %>%
  mutate(hours_fished = as.numeric(hours_fished))

filter(combined_rst_format, is.na(mean_fork_length), count > 0)
filter(combined_rst_format, is.na(hours_fished), !tributary %in% c("Lower Sacramento - Tisdale","Deer Creek","Mill Creek"))
combined_rst_model_format <- combined_rst_format %>%
  rename(Yr = year,
         Jwk = week,
         u1 = count,
         u1_sz = mean_fork_length,
         Eff = hours_fished)
```

Data processing decisions
- Run was not filtered. Some tributaries do not collect or designate a run. When
count is 0 run is encoded as NA. When run is not recorded it is encoded as not recorded.
- If locations had multiple traps, counts were summed.
- Some tribs have multiple sites, summaries were provided by site but could be 
summarized further if needed. Knights Landing and Tisdale were included as separate
tributaries because they are different monitoring programs but could be summarized differently.
- Data were filtered to only include chinook. 
- Data includes both natural and hatchery fish but could be filtered if needed.
- In some cases fork length was missing and was left as NA.

```{r, save_data}
saveRDS(combined_rst_model_format, "data/rst/jpe_historical_rst.rds")
write_csv(combined_rst_model_format, "data/rst/jpe_weekly_unmarked_catch.csv")
```

## Table 2. Releases and Recaptures (~ 6 fields)
- Year (yr)
- Julian week marked fish were released on (Jwk)
- Number of marked fish released (r1),
- Number of recaptures of r1 within first week of release (m1)
- Number of recaptures of r1 within second week of release (m2),
- Number of recaptures of r1 within second week of release (m3), probably don’t 
need more than this, and m2 might be sufficient.

If not too much trouble, also include mean size fields for release (r1_sz)
and recaptures (e.g., m1_sz).

With a year-stream, there should not be more rows in Table 2 than Table 1.
However, as many streams and weeks will not have efficiency data, I suspect
the number of rows in Table 2 < rows in Table 1.

Down the road I could see an accompanying covariate table which would include
the discharge and average temperature for each Jwk. Could use that data as
covariates to predict efficiency. Don’t need that to start though.

```{r, data_pull_mc}
# rst pull battle and clear data from google cloud 
battle_mark_recapture <- gcs_get_object(object_name = "rst/battle-creek/data/battle_mark_reacpture.csv",
                                        bucket = gcs_get_global_bucket(),
                                        saveToDisk = "data/rst/battle_mark_recapture.csv",
                                        overwrite = TRUE)
clear_mark_recapture <- gcs_get_object(object_name = "rst/clear-creek/data/clear_mark_reacpture.csv",
                                       bucket = gcs_get_global_bucket(),
                                       saveToDisk = "data/rst/clear_mark_recapture.csv",
                                       overwrite = TRUE)

battle_mark_recap <- read_csv("data/rst/battle_mark_recapture.csv") %>% 
  rename(number_recaptured = recaps, number_released = no_released) %>% 
  mutate(watershed = "Battle Creek") %>% glimpse

clear_mark_recap <- read_csv("data/rst/clear_mark_recapture.csv")  %>% 
  rename(number_recaptured = recaps, number_released = no_released) %>% 
  mutate(watershed = "Clear Creek") %>% glimpse

filter(battle_mark_recap, is.na(mark_med_fork_length_mm)) %>% glimpse
filter(battle_mark_recap, is.na(recap_med_fork_length_mm)) %>% glimpse
filter(clear_mark_recap, is.na(mark_med_fork_length_mm)) %>% glimpse
filter(clear_mark_recap, is.na(recap_med_fork_length_mm)) %>% glimpse

# Pull feather and knights landing data from package 
feather_mark_recapture <- read_rds("data/rst/feather_mark_recapture_data.rds") %>% 
  rename(number_released = nReleased) %>% 
  mutate(watershed = "Feather River") %>%
  glimpse

knights_landing_mark_recapture <- read_rds("data/rst/knights_landing_mark_recapture_data.rds") %>% 
  mutate(watershed = "Lower Sacramento - Knights Landing") %>%
  rename(number_released = nReleased) %>% glimpse
```

```{r}
# Combine feather and knights landing and add catch week for recaptures 
# TODO does the site matter? Email Mike to see if they record traps for recaptures 
# TODO check to see if I can find feather and knights landing mark recapture 

feather_and_knights  <- bind_rows(feather_mark_recapture, knights_landing_mark_recapture) %>%
   mutate(days_btw_release_and_catch = as_date(recaptured_date) - as_date(release_date), 
          caught_week_1 = ifelse(days_btw_release_and_catch >= 0 & days_btw_release_and_catch <= 7, number_recaptured, 0),
          caught_week_2 = ifelse(days_btw_release_and_catch > 7 & days_btw_release_and_catch <= 14, number_recaptured, 0),
          caught_week_3 = ifelse(days_btw_release_and_catch > 14 & days_btw_release_and_catch <= 21, number_recaptured, 0)) %>% 
  group_by(watershed, release_date, number_released) %>%
  summarise(caught_week_1 = sum(caught_week_1, na.rm = T),
            caught_week_2 = sum(caught_week_2, na.rm = T), 
            caught_week_3 = sum(caught_week_3, na.rm = T),
            mark_med_fork_length_mm = median(median_fork_length_released, na.rm = T),
            recap_med_fork_length_mm = median(median_fork_length_recaptured, na.rm = T)) %>%
  ungroup() %>%
  glimpse

feather_and_knights$mark_med_fork_length_mm %>% unique
feather_and_knights$recap_med_fork_length_mm %>% unique
# Combine battle and clear 
battle_clear <- bind_rows(battle_mark_recap, clear_mark_recap) %>%
  mutate(caught_week_1 = number_recaptured) %>% glimpse

# COmbine battle, clear, feather, and knights 
combined_mark_recapture <- bind_rows(battle_clear, feather_and_knights) %>% glimpse

# Description from Josh of what he was looking for 
# Table 2. Releases and Recaptures (~ 6 fields)
# 
# Year (yr)
# Julian week marked fish were released on (Jwk)
# Number of marked fish released (r1),
# Number of recaptures of r1 within first week of release (m1)
# Number of recaptures of r1 within second week of release (m2),
# Number of recaptures of r1 within third week of release (m3),
# … probably don’t need more than this, and m2 might be sufficient.
mark_recapture_data <- combined_mark_recapture %>% 
  select(watershed, release_date, number_released, number_recaptured, 
         caught_week_1, caught_week_2, caught_week_3, 
         median_fl_released = mark_med_fork_length_mm, 
         median_fl_recaptured = recap_med_fork_length_mm) %>% 
  mutate(year = year(release_date), 
         julian_week = week(release_date),
         release_date = as_date(release_date)) %>% 
  select(watershed, release_date, year, julian_week, number_released, 
         caught_week_1, caught_week_2, caught_week_3, median_fl_released, 
         median_fl_recaptured) %>%
  glimpse() 

mark_recapture_data$median_fl_released %>% unique
mark_recapture_data$median_fl_recaptured %>% unique
# Rename and reformat for Josh
# Summarize by week 
weekly_releases_and_recaptures <- mark_recapture_data %>% 
  select(-release_date) %>%
  rename(tributary = watershed, yr = year, Jwk = julian_week, 
         r1 = number_released, m1 = caught_week_1, 
         m2 = caught_week_2, m3 = caught_week_3) %>% 
  group_by(tributary, yr, Jwk) %>%
  summarize(r1 = sum(r1, na.rm = T),
            m1 = sum(m1, na.rm = T), 
            m2 = sum(m2, na.rm = T),
            m3 = sum(m3, na.rm = T),
            released_fl = mean(median_fl_released, na.rm = T),
            recaptured_fl = mean(median_fl_recaptured, na.rm = T)) %>%
  mutate(m2 = ifelse(tributary %in% c("Battle Creek", "Clear Creek"), NA, m2), # Replace 0 that were created in summarize statement with NA
         m3 = ifelse(tributary %in% c("Battle Creek", "Clear Creek"), NA, m3)) 

unique(weekly_releases_and_recaptures$recaptured_fl)
unique(weekly_releases_and_recaptures$released_fl)
# Rename and reformat for Josh
# Do not summarize by week 
releases_and_recaptures <- mark_recapture_data %>% 
  select(-release_date) %>%
  rename(tributary = watershed, yr = year, Jwk = julian_week, 
         r1 = number_released, m1 = caught_week_1, 
         m2 = caught_week_2, m3 = caught_week_3) %>% 
  glimpse

```

```{r, save_data_mc}
# weekly summary csv
write_csv(weekly_releases_and_recaptures, "data/datasets_for_josh/jpe_weekly_releases_and_recaptures.csv")

# row for each efficiency trial 
write_csv(releases_and_recaptures, "data/datasets_for_josh/jpe_releases_and_recaptures.csv")
```

```{r, visualize_data}

# Visualize 
releases_and_recaptures %>% 
  mutate(week_1_efficiency = m1/r1) %>%
  ggplot(aes(x = week_1_efficiency, color = tributary)) + 
  geom_density()

releases_and_recaptures %>% 
  group_by(yr, tributary) %>% 
  summarise(trials_per_year = n()) %>% 
  ggplot(aes(x = as.character(yr), y = trials_per_year, fill = tributary)) + 
  geom_col(position = 'dodge')

releases_and_recaptures %>% 
  mutate(week_1_efficiency = m1/r1) %>%
  ggplot(aes(x = Jwk, y = yr, size = week_1_efficiency)) +
  geom_point()

```

