---
title: "Feather Carcass QC 2000"
author: "Inigo Peng"
date: '2022-07-21'
output: rmarkdown::github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, fig.width=15, fig.height=10)

library(tidyverse)
library(lubridate)
library(googleCloudStorageR)
library(ggplot2)
library(scales)
library(readxl)
library(janitor)
library(hms) #?as_hms()
library(RODBC)
library(knitr)
library(wesanderson)
```

# Feather River Carcass Data

## Description of Monitoring Data

**Timeframe:** 

**Video Season:** 

**Completeness of Record throughout timeframe:** 

**Sampling Location:**

**Data Contact:** 

Any additional info?

## Access Cloud Data

```{r, include=FALSE}
# Run Sys.setenv() to specify GCS_AUTH_FILE and GCS_DEFAULT_BUCKET before running 
# getwd() to see how to specify paths 
# Open object from google cloud storage
# Set your authentication using gcs_auth

gcs_auth(json_file = Sys.getenv("GCS_AUTH_FILE"))
# Set global bucket 
gcs_global_bucket(bucket = Sys.getenv("GCS_DEFAULT_BUCKET"))

# git data and save as xlsx
```

Read in data from google cloud, glimpse raw data and domain description sheet:
```{r, include=FALSE}
gcs_get_object(object_name = "adult-holding-redd-and-carcass-surveys/feather-river/data-raw/carcass/Carcass_2000.mdb",
               bucket = gcs_get_global_bucket(),
               saveToDisk = "data-raw/qc-markdowns/adult-holding-redd-and-carcass-surveys/feather-river/feather_carcass_2000.mdb",
               overwrite = TRUE)

filepath <- "data-raw/qc-markdowns/adult-holding-redd-and-carcass-surveys/feather-river/feather_carcass_2000.mdb"

operating_system <- ifelse(grepl("Mac", Sys.info()['nodename']) | grepl("MBP", Sys.info()['nodename']), "mac", "pc")

# Mac and PC need to run different code to pull data from Access db
if(operating_system == "pc") {
  DRIVERINFO <- "Driver={Microsoft Access Driver (*.mdb, *.accdb)};"
  PATH <- paste0(DRIVERINFO, "DBQ=", filepath)
  con <- odbcDriverConnect(PATH)
  # sqlTables(con)$TABLE_NAME
  ChopEnv_raw <- sqlFetch(con, "ChopEnvTBL")
  RecovTag_raw <- sqlFetch(con, "RecovTagTBL")
  ChopRecov_raw <- sqlFetch(con, "ChopRecovTBL")
  TagCol <- sqlFetch(con, "TagColLU")
  TagData <- sqlFetch(con, "TagDataTBL")
  TagEnv <- sqlFetch(con, "TagEnvTBL")
  cwt <- sqlFetch(con, "cwtTBL")
} else{
  library(Hmisc)
  mdb.get(filepath, tables = TRUE) # check for name differences
  # TagColLU contains metadata about tag colors
  # Jason's Week #'s contains information about week # and date
  ChopEnv_raw <- mdb.get(filepath, tables = "ChopEnvTBL")
  RecovTag_raw <- mdb.get(filepath, tables = "RecovTagTBL")
  ChopRecov_raw <- mdb.get(filepath, tables = "ChopRecovTBL")
  TagCol <- mdb.get(filepath, tables = "TagColLU")
  TagData <- mdb.get(filepath, tables = "TagDataTBL")
  TagEnv <- mdb.get(filepath, tables = "TagEnvTBL")
  cwt <- mdb.get(filepath, tables = "cwtTBL")
  detach(package:Hmisc)
}

write_csv(ChopEnv_raw, here::here("data-raw", "qc-markdowns", "adult-holding-redd-and-carcass-surveys", "feather-river", "ChopEnv_2000.csv"))
write_csv(RecovTag_raw, here::here("data-raw", "qc-markdowns", "adult-holding-redd-and-carcass-surveys", "feather-river", "RecovTag_2000.csv"))
write_csv(ChopRecov_raw, here::here("data-raw", "qc-markdowns", "adult-holding-redd-and-carcass-surveys", "feather-river", "ChopRecov_2000.csv"))
write_csv(TagCol, here::here("data-raw", "qc-markdowns", "adult-holding-redd-and-carcass-surveys", "feather-river", "TagCol_2000.csv"))
write_csv(TagData, here::here("data-raw", "qc-markdowns", "adult-holding-redd-and-carcass-surveys", "feather-river", "TagData_2000.csv"))
write_csv(TagEnv, here::here("data-raw", "qc-markdowns", "adult-holding-redd-and-carcass-surveys", "feather-river", "TagEnvTBL_2000.csv"))
write_csv(cwt, here::here("data-raw", "qc-markdowns", "adult-holding-redd-and-carcass-surveys", "feather-river", "cwt_2000.csv"))
```

## Raw Data Glimpse: {.tabset}

### ChopEnv_Raw
Heading information for chops data.
```{r}
# Read Data
ChopEnv_raw <- read_csv(here::here("data-raw", "qc-markdowns",
                                 "adult-holding-redd-and-carcass-surveys",
                                 "feather-river", "ChopEnv_2000.csv"),
                                 col_types = list("d", "c", "T", "c", "T", "c", "c")) |>  
  glimpse()
```

### ChopRecov_raw
Recovered chop counts with no sampling information.
```{r}
#Data collection for Chopping and Spawning to determine how many carcasses are being captured (link by recovID)
ChopRecov_raw <-read_csv(here::here("data-raw", "qc-markdowns",
                                 "adult-holding-redd-and-carcass-surveys",
                                 "feather-river", "ChopRecov_2000.csv")) |>  
  rename("Number Spawned" = Spawn) |>  
  glimpse()
```

### RecovTag_Raw
```{r}
#Data for Recovered Tags
#What is RelStat and MultRecov? 
RecovTag_raw <- read_csv(here::here("data-raw", "qc-markdowns",
                                 "adult-holding-redd-and-carcass-surveys",
                                 "feather-river", "RecovTag_2000.csv")) |>  
  glimpse()
```

### TagData_raw
```{r}
#Data for Tagging DataSheet - when export access table to excel, Tag Number is automatically changed to TagID - converting it back here
TagData_raw <- read_csv(here::here("data-raw", "qc-markdowns",
                                 "adult-holding-redd-and-carcass-surveys",
                                 "feather-river", "TagData_2000.csv")) |>  
  rename("TagNum" = "TagID") |> 
  glimpse()
```

### TagEnv_raw
```{r}
#Heading Info for Tagging Data Sheet
TagEnv_raw <- read_csv(here::here("data-raw", "qc-markdowns",
                                 "adult-holding-redd-and-carcass-surveys",
                                 "feather-river", "TagEnvTBL_2000.csv")) |>  
  glimpse()
```

### cwt_raw
This table contains all carcasses with sampling information.

```{r}
cwt_raw <- read_csv(here::here("data-raw", "qc-markdowns",
                                 "adult-holding-redd-and-carcass-surveys",
                                 "feather-river", "cwt_2000.csv")) |>  
  glimpse()
```

## Data transformations: {.tabset}

### Recovery

The `chop_recovery_join` table contains recovered carcass counts 

```{r}
#1. Link ChopRecov with ChopEnv to get the date
chop_recovery_join <- full_join(ChopEnv_raw |>  
                                  select(ChopEnvID, Date, Start, TagCol), ChopRecov_raw, 
                                by = "ChopEnvID") |>  
  clean_names() |>  
  rename(male_chop = "adult_m",
         female_chop = "adult_f",
         grilse_male = "gril_m",
         grilse_female = "gril_f") |>  glimpse()
```

### Tags

The `tag_join` table contains additional tag information 

```{r}
tag_join <- left_join(TagData_raw, RecovTag_raw) |>  
  clean_names() |>  
  select(c(tag_num, sect, unit, fl, sex, egg_ret, recov_id)) |>  glimpse()
```

### Survey

The `chop_header` table contains survey metadata and covariates

```{r}
chop_header <- ChopEnv_raw |>  
  clean_names() |>  glimpse()
```

### CWT

The `cwt` table contains sampling information on individual carcasses. It is not joined with the other tables.

```{r}
cwt <- cwt_raw |>  
  clean_names() |>  glimpse()
```


## Explore Numeric Variables: {.tabset}

### Chop Recovery Variable: `chop_env_id`, `sect`, `unit`

```{r}
# Filter clean data to show only numeric variables 
chop_recovery_join |>  
  select_if(is.numeric) |> 
  colnames()
```

```{r}
summary(chop_recovery_join$chop_env_id)
```
```{r}
summary(chop_recovery_join$sect)
```
```{r}
summary(chop_recovery_join$unit)
```


### Chop Recovery Variable: `male_chop`, `female_chop`, `grilse_male`, `grilse_female`, `spawn`

```{r}
summary(chop_recovery_join$male_chop)
```
```{r}
summary(chop_recovery_join$female_chop)
```

**Plotting male_chop and female_chop over Period of Record**

```{r}
chop_recovery_join |>  
  group_by(date) |>  
  summarize(male_chop = sum(male_chop),
            female_chop = sum(female_chop)) |>  
  pivot_longer(cols = c(male_chop, female_chop), names_to = "sex", values_to = "count") |>   
  ggplot(aes(x = date, y = count, fill = sex)) +
  geom_bar(stat = "identity", position = "dodge") + 
  labs(x = "Date", 
       y = "Chops") +
  theme_minimal() + 
  theme(text = element_text(size = 15)) 
```
This plot shows chop counts over period of record by sex and is helpful for understanding the seasonality of the survey, i.e. chop counts peak in Oct-Nov. 

**Plotting Total Adult Chops over Period of Record**

```{r}
total_adult_chops <- chop_recovery_join |>  
  mutate(total_adult_chops = male_chop + female_chop,
         date = as_date(date)) |>  
  select(date, male_chop, female_chop, total_adult_chops) |>  glimpse()

total_adult_chops_test <- total_adult_chops |>  
  filter(date == as_date("2000-09-05"))
nrow(total_adult_chops) == (sum(total_adult_chops$total_adult_chops == (total_adult_chops$male_chop + total_adult_chops$female_chop)))

total_adult_chops_summary <- total_adult_chops |>  
  group_by(date) |>  
  summarise(total_adult_chops = sum(total_adult_chops, na.rm = T),
            male_chops = sum(male_chop, na.rm = T),
            female_chops = sum(female_chop, na.rm = T))
```

```{r}
total_adult_chops_summary |>  
  pivot_longer(cols = c(male_chops, female_chops), names_to = "sex", values_to = "count") |>  
  mutate(proportions = (count/total_adult_chops)) |>  
  ggplot(aes(x = date, y = proportions, fill = sex)) + 
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(values = c("Blue","Red"), 
                    name = "Sex", 
                    labels = c("Female", "Male")) +
  theme_minimal() + 
  labs(y = "Proportion", x = "Date") +
  scale_fill_manual(values = wes_palette("Moonrise2"))
```

This plot shows the sex proportion of adult chops for each day over the the period of 2000-09-05 to 2000-12-14. The data gaps that we see are a result of the data collection process in which the data was collected 2-4 days each week (with no specific period day of week) over the 4 month period. All of the Adult Chop data have been identified for their sexes.

```{r}
summary(chop_recovery_join$grilse_male)
```
```{r}
summary(chop_recovery_join$grilse_female)
```

**Plotting grilse_male  over Period of Record**

```{r}
chop_recovery_join |>  
  group_by(date) |>  
  summarize(grilse_male = sum(grilse_male)) |>  
  ggplot(aes(x = date, y = grilse_male)) +
  geom_col(fill = "red") + 
  labs(x = "Date", 
       y = "Grilse Male") +
  theme_minimal() + 
  theme(text = element_text(size = 15)) 
```
This plot shows total male chops over period of record. Like plot above, data gaps are a result of the data collection process where data was collected for 2-4 days per week. 

**Plotting grilse_female  over Period of Record**

```{r}
chop_recovery_join |>  
  group_by(date) |>  
  summarize(grilse_female = sum(grilse_female)) |>  
  ggplot(aes(x = date, y = grilse_female)) +
  geom_col(fill = "blue") + 
  labs(x = "Date", 
       y = "Grilse Female") +
  theme_minimal() + 
  theme(text = element_text(size = 15)) 
```
This plot shows total female chops over period of record. Like plot above, data gaps are a result of the data collection process where data was collected for 2-4 days per week. 

**Plotting Total Grilse Chops  over Period of Record**

```{r}
total_grilse_chops <- chop_recovery_join |>  
  mutate(total_grilse_chops = grilse_male + grilse_female,
         date = as_date(date)) |>  
  select(date, grilse_male, grilse_female, total_grilse_chops) |>  glimpse()

total_grilse_chops_test <- total_grilse_chops |>  
  filter(date == as_date("2000-09-05"))
nrow(total_grilse_chops) == (sum(total_grilse_chops$total_grilse_chops == (total_grilse_chops$grilse_male + total_grilse_chops$grilse_female)))

total_grilse_chops_summary <- total_grilse_chops |>  
  group_by(date) |>  
  summarise(total_grilse_chops = sum(total_grilse_chops, na.rm = T),
            grilse_male = sum(grilse_male, na.rm = T),
            grilse_female = sum(grilse_female, na.rm = T))
```

```{r}
total_grilse_chops_summary |>  
  pivot_longer(cols = c(grilse_male, grilse_female), names_to = "sex", values_to = "count") |>  
  mutate(proportions = (count/total_grilse_chops)) |>  
  ggplot(aes(x = date, y = proportions, fill = sex)) + 
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(values = c("Blue","Red"), 
                    name = "Sex", 
                    labels = c("Female", "Male")) +
  theme_minimal() + 
  labs(y = "Proportion", x = "Date") +
  scale_fill_manual(values = wes_palette("Moonrise2"))
```

This plot shows the sex proportion of grilse chops for each day over the the period of 2000-09-05 to 2000-12-14. There are more data gap for the grilse data compared to the normal chops data. All of the grilse chop data have been identified for their sexes as well - there is a significant higher proportion of males compared to the females.


**Plotting Total Chops  over Period of Record**
Chops are considered to be subset into three categories: adult male, adult female, and grilse (i.e. female and male grilse are mutually exclusive from female and male adults). 

```{r}
total_chops <- chop_recovery_join |>  
  mutate(total_chops = grilse_male + grilse_female + male_chop + female_chop,
         date = as_date(date)) |>  
  select(date, grilse_male, grilse_female, male_chop, female_chop, total_chops) |>  glimpse()

total_chops_test <- total_chops |>  
  filter(date == as_date("2000-09-05"))
nrow(total_chops) == (sum(total_chops$total_chops == (total_chops$grilse_male + total_chops$grilse_female + total_chops$male_chop + total_chops$female_chop)))

total_chops_summary <- total_chops |>  
  group_by(date) |>  
  summarise(total_chops = sum(total_chops, na.rm = T),
            grilse_male = sum(grilse_male, na.rm = T),
            grilse_female = sum(grilse_female, na.rm = T),
            male_chop = sum(male_chop, na.rm = T),
            female_chop = sum(female_chop, na.rm = T))
```

```{r}
total_chops_summary |>  
  pivot_longer(cols = c(grilse_male, grilse_female, male_chop, female_chop), names_to = "chops", values_to = "count") |>  
  mutate(proportions = (count/total_chops)) |>  
  ggplot(aes(x = date, y = proportions, fill = chops)) + 
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(name = "chops", 
                    labels = c("Grilse Male", "Grilse Female", "Adult Male", "Adult Female")) +
  theme_minimal() + 
  labs(y = "Proportion", x = "Date") +
  scale_fill_manual(values = wes_palette("Moonrise2"))
```

This plot shows the proportion of the adult male and female chops, and grilse male and female chops for each day over the period of 2000-09-05 to 2000-12-14. 
 
```{r}
summary(chop_recovery_join$number_spawned)
```

* `r round(sum(is.na(chop_recovery_join$number_spawned))/nrow(chop_recovery_join), 3) * 100` % of values in the `number_spawned` column are NA.

**Plotting number_spawned over a Period of Record**

```{r}
chop_recovery_join |>  
  group_by(date) |>  
  summarize(number_spawned = sum(number_spawned, na.rm = T)) |>  
  ggplot(aes(x = date, y = number_spawned)) +
  geom_col(fill = "blue") + 
  labs(x = "Date", 
       y = "spawn") +
  theme_minimal() + 
  theme(text = element_text(size = 15)) 
```
This plot shows the number spawned for each day over the the period of 2000-09-05 to 2000-12-14. Data on number spawned was not present for all dates, but was collected on 09-05-2000 and 09-21-2000 (seen in the two columns). 


### Tag Join Variable: `tag_num`, `sect`, `unit`, `recov_id`
```{r}
# Filter clean data to show only numeric variables 
tag_join  |>  
  select_if(is.numeric) |>  
  colnames()
```
```{r}
summary(tag_join$tag_num)
```
```{r}
summary(tag_join$sect)
```
```{r}
summary(tag_join$unit)
```

```{r}
summary(tag_join$recov_id)
```
* `r round(sum(is.na(tag_join$recov_id))/nrow(tag_join), 3) * 100` % of values in the `recov_id` column are NA.


### Tag Join Variable: `sex`, `fl`, `female_tag`, `male_tag`, `unknown_tag`

**Plotting proportion of sex of the tags**

```{r}
unique(tag_join$sex)
```


```{r}
#Create a tag_count column
#Pivot table to expand sex column to female_tag, male_tag, and unknown_tags 

all_tags <- tag_join |>  
  mutate(tag_count = 1) |>  
  pivot_wider(names_from = sex, values_from = tag_count) |>  
  rename("unknown_tags" = X,
         "male_tag" = M,
         "female_tag" = F) 

total_tags_summary <- all_tags|>  
  mutate(male_tag = ifelse(is.na(male_tag), 0, male_tag), # fill na
         female_tag = ifelse(is.na(female_tag), 0, female_tag),
         unknown_tags = ifelse(is.na(unknown_tags), 0, unknown_tags),
         total_tags = unknown_tags + male_tag + female_tag) |>  
  select(male_tag, female_tag, unknown_tags, total_tags) |>  
  summarise(total_tags = sum(total_tags),
            male_tags = sum(male_tag),
            female_tags = sum(female_tag),
            unknown_tags = sum(unknown_tags))
```
```{r}
#Unknown tags proportion is very small and is rounded to zero 
total_tags_summary |>  
  pivot_longer(cols = c(male_tags, female_tags, unknown_tags), names_to = "sex", values_to = "count") |>  
  mutate(proportions = (count / total_tags)) |>  
  ggplot(aes(x = sex, y = proportions)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(values = c("Blue","Red"), 
                    name = "Sex", 
                    labels = c("Female", "Male", "Unknown")) +
  theme_minimal() + 
  labs(y = "Proportion", x = "Sex") +
  scale_fill_manual(values = wes_palette("Moonrise2"))
```

**Plotting fork length of each sex**

```{r}
summary(tag_join$fl)
```

```{r}
tag_join |>  
  mutate(sex = ifelse(tag_join$sex == "X", "Unknown Tags", tag_join$sex)) |>  
  ggplot(aes(x = sex, y = fl)) + 
  geom_boxplot() +
  theme_minimal() + 
  labs(y = "FL", x = "Sex")
```

**Numeric Summary of `female_tag`, `male_tag`,`unknown_tag`**

```{r}
summary(all_tags$male_tag)
```
* `r round(sum(is.na(all_tags$male_tag))/nrow(all_tags), 3) * 100` % of values in the `male_tag` column are NA.
```{r}
summary(all_tags$female_tag)
```
* `r round(sum(is.na(all_tags$female_tag))/nrow(all_tags), 3) * 100` % of values in the `female_tag` column are NA.

```{r}
summary(all_tags$unknown_tags)
```

* `r round(sum(is.na(all_tags$unknown_tags))/nrow(all_tags), 3) * 100` % of values in the `unknown_tags` column are NA.

**Plotting tags sex proportion with dates over Period of Record**

```{r}
tags_with_dates <- left_join(tag_join |>  
  mutate(tag_count = 1) |>  
  pivot_wider(names_from = sex, values_from = tag_count) |>  
  rename("unknown_tags" = X,
         "male_tag" = M,
         "female_tag" = F), chop_recovery_join)|>  
  filter(!is.na(date)) |>  glimpse()

total_tags_with_dates <- tags_with_dates|>  
  mutate(male_tag = ifelse(is.na(male_tag), 0, male_tag), # fill na
         female_tag = ifelse(is.na(female_tag), 0, female_tag),
         unknown_tags = ifelse(is.na(unknown_tags), 0, unknown_tags),
         total_tags = unknown_tags + male_tag + female_tag) |>  
  select(date, male_tag, female_tag, unknown_tags, total_tags)

total_tags_with_dates_summary <- total_tags_with_dates |> 
  group_by(date) |> 
  summarise(total_tags = sum(total_tags, na.rm = T),
            male_tags = sum(male_tag, na.rm = T),
            female_tags = sum(female_tag, na.rm = T),
            unknown_tags = sum(unknown_tags, na.rm = T))

total_tags_with_dates_summary |>  
  pivot_longer(cols = c(male_tags, female_tags, unknown_tags), names_to = "sex", values_to = "count") |>  
  mutate(proportions = (count / total_tags)) |>  
  ggplot(aes(x = date, y = proportions, fill = sex)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(values = c("Blue","Red", "Black"), 
                    name = "Sex", 
                    labels = c("Female", "Male", "Unknown")) +
  theme_minimal() + 
  labs(y = "Proportion", x = "Date") +
  scale_fill_manual(values = wes_palette("Moonrise2"))
```

**Plotting total tags over Period of Record**

```{r}
total_tags_with_dates_summary |>  
  ggplot(aes(x = date, y = total_tags)) +
  geom_col() +
  theme_minimal()
```
```{r}
total_carcass <- full_join(total_chops_summary, total_tags_with_dates_summary) |>  
  select(date, total_chops, total_tags) |>  
  pivot_longer(c(total_chops, total_tags), names_to = "mark")

full_join(total_chops_summary, total_tags_with_dates_summary) |>  
  select(date, total_chops, total_tags) |>  
  pivot_longer(c(total_chops, total_tags), names_to = "mark")

ggplot(total_carcass, aes(x = date, y = value, fill = mark)) +
  geom_col() +
  theme_minimal() +
  scale_fill_manual(values = wes_palette("Moonrise2"))
```
### Chop Header Variable: `chop_env_id`, `week`, 

```{r}
chop_header |>  
  select_if(is.numeric) |>  
  colnames()
```
```{r}
summary(chop_header$chop_env_id)
```

```{r}
summary(chop_header$week)
```

### CWT Variable:  `id`, `sect`, `unit`, `fl`, `ht_num`, `sex`
```{r}
cwt |>  
  select_if(is.numeric) |>  
  colnames()
```
```{r}
summary(cwt$cwt_id)
```
```{r}
summary(cwt$sect)
```
```{r}
summary(cwt$unit)
```
```{r}
summary(cwt$fl)
```
* `r round(sum(is.na(cwt$fl))/nrow(cwt), 3) * 100` % of values in the `fl` column are NA.

```{r}
summary(cwt$ht_num)
```

```{r}
#Create a cwt_count column
#Pivot table to expand sex column to female_cwt, male_cwt, and unknown_cwt 
unique(cwt$sex)
cwt_count <- cwt |>  
  mutate(cwt_count = 1) |>  
  pivot_wider(names_from = sex, values_from = cwt_count, values_fill = 0) |>  
  rename("unknown_cwt" = X,
         "male_cwt" = M,
         "female_cwt" = F) 
total_cwt_summary <- cwt_count |>  
  mutate(male_cwt = ifelse(is.na(male_cwt), 0, male_cwt), # fill na
         female_cwt = ifelse(is.na(female_cwt), 0, female_cwt),
         unknown_cwt = ifelse(is.na(unknown_cwt), 0, unknown_cwt),
         total_cwt = unknown_cwt + male_cwt + female_cwt) |>  
  group_by(month(date)) |>  
  summarise(total_cwt = sum(total_cwt),
            male_cwt = sum(male_cwt),
            female_cwt = sum(female_cwt),
            unknown_cwt = sum(unknown_cwt))
```
```{r}
total_cwt_summary |>  
  pivot_longer(cols = c(male_cwt, female_cwt, unknown_cwt), names_to = "sex", values_to = "count") |>  
  mutate(proportions = (count / total_cwt)) |>  
  ggplot(aes(x = `month(date)`, y = proportions, fill = sex)) + 
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(name = "chops", 
                    labels = c("CWT Male", "CWT Female", "CWT Unknown")) +
  theme_minimal() + 
  labs(y = "Proportion", x = "Date") +
  scale_fill_manual(values = wes_palette("Moonrise2"))
```

**Plotting fork length of each sex**
```{r}
cwt |>  
  mutate(sex = ifelse(cwt$sex == "X", "Unknown", cwt$sex)) |>  
  ggplot(aes(x = sex, y = fl)) + 
  geom_boxplot() +
  theme_minimal() + 
  theme(text = element_text(size = 15))
```

## Explore Categorical variables: {.tabset}

### Chop Recovery Clean Data

Fix inconsistencies with spelling, capitalization, and dates

```{r}
chop_recovery_join |>  
  select_if(is.character) |>  
  colnames()
```
```{r}
unique(chop_recovery_join$tag_col)
```
```{r}
chop_recovery_cleaner <- chop_recovery_join |> 
  mutate(date = paste(as_date(date)))|> 
  mutate_if(is.character, str_to_lower) |>  
  select(-c(start, number_spawned, recov_id)) |>  # start has time data and is removed because no stop time provided so information is not useful
  glimpse()
```

### Tag Join Clean Data
```{r}
tag_join |>  
  select_if(is.character) |>  
  colnames()
```
```{r}
#X is unknown? Need look up table
unique(tag_join$egg_ret)
```
```{r}
unique(tag_join$sex)
```

```{r}
tag_join_cleaner <-  tag_join |>  
  mutate(sex = ifelse(tag_join$sex == "X", "Unknown", tag_join$sex)) |>  
   mutate_if(is.character, str_to_lower)
```

### Chop Header Clean Data
```{r}
chop_header |>  
  select_if(is.character) |>  
  colnames()
```
```{r}
unique(chop_header$crew)
```
```{r}
unique(chop_header$recorder)
```
```{r}
unique(chop_header$weather)
```
```{r}
#Not sure what turbot is
unique(chop_header$turbot)
```

```{r}
chop_header_cleaner <- chop_header |>  
  mutate(date = as_date(date))|>  
  mutate_if(is.character, str_to_lower) |>  
  mutate(crew = str_replace_all(crew, " ", ""),
         crew = str_replace_all(crew, "/", ","),
         crew = str_replace_all(crew, "&", ","),
         weather = case_when(weather == "ran" ~ "rain",
                             weather == "unk" ~ NA_character_,
                             TRUE ~ weather)) |>  
  select(-c(start, stop, week, turbot)) # stop is all NA and start is not useful without stop; turbot (?) does not have any data

```

### CWT Clean Data
```{r}
cwt |>  
  select_if(is.character) |>  
  colnames()
```
```{r}
unique(cwt$egg_ret)
```

```{r}
cwt_cleaner <- cwt |>  
  mutate(sex = ifelse(cwt$sex == "X", "unknown", cwt$sex)) |>  
  mutate_if(is.character, str_to_lower) |> 
  glimpse()
```

## Comments

* The chop data shows both sexes for both adult chops and grilse chops. Not all datasets contain this
* There is no lookup table for egg_ret in tag_join
* What is `Unit` in chops table?
* Could remove some of the ID columns for standardization
* Not sure what is ht_number in cwt table
* Did not read in tag color - not sure if it's necessary
* Did not clean all of the recorder and crew entries - lots of variations

## Data Dictionaries

### Chop Data
```{r}
percent_na <- chop_recovery_cleaner |> 
  summarise_all(list(name = ~sum(is.na(.))/length(.))) |> 
  pivot_longer(cols = everything())


counts_data_dictionary <- tibble(variables = colnames(chop_recovery_cleaner),
                          description = c("Environment ID",
                                          "Date of survey",
                                          "Colour of tag applied to carcass",
                                          "Sect", 
                                          "Unit",
                                          "Carcass that were chopped and male",
                                          "Carcass that were chopped and female",
                                          "Grilse carcass that were chopped and male",
                                          "Grilse carcass that were chopped and female"),
                          percent_na = round(percent_na$value*100))

kable(counts_data_dictionary)
```

### Tag Data

```{r}
percent_na <- tag_join_cleaner |> 
  summarise_all(list(name = ~sum(is.na(.))/length(.))) |> 
  pivot_longer(cols = everything())

tag_counts_data_dictionary <- tibble(variables = colnames(tag_join_cleaner),
                          description = c("Tag number",
                                          "Sect", 
                                          "Unit",
                                          "Fork length",
                                          "Sex", 
                                          "Egg Retained",
                                          "Recovery ID"),
                          percent_na = round(percent_na$value*100))

kable(tag_counts_data_dictionary)
```

### Survey

```{r}
percent_na <- chop_header_cleaner |> 
  summarise_all(list(name = ~sum(is.na(.))/length(.))) |> 
  pivot_longer(cols = everything())

header_data_dictionary <- tibble(variables = colnames(chop_header_cleaner),
                          description = c("Chop Environment ID",
                                          "Tag Colour",
                                          "Crew memeber initials that collected",
                                          "Individual of crew member who recorded",
                                          "Weather",
                                          "Comments",
                                          "Date and time of survey"),
                          percent_na = round(percent_na$value*100,
                                             digits = 1))

kable(header_data_dictionary)
```

### CWT
```{r}
percent_na <- cwt_cleaner |> 
  summarise_all(list(name = ~sum(is.na(.))/length(.))) |> 
  pivot_longer(cols = everything())

cwt_data_dictionary <- tibble(variables = colnames(cwt_cleaner),
                          description = c("CWT ID",
                                          "Date of survey",
                                          "Sect",
                                          "Unit",
                                          "Fork length",
                                          "Sex",
                                          "Egg retained",
                                          "Ht Num?",
                                          "CWT Code",
                                          "Comments"),
                          percent_na = round(percent_na$value*100,
                                             digits = 1))

kable(cwt_data_dictionary)
```


## Save cleaned data back to google cloud (TBA)

```{r}
feather_carcass_chops_2000 <- chop_recovery_cleaner |>  glimpse()
feather_carcass_tags_2000 <- tag_join_cleaner |>  glimpse()
feather_carcass_cwt_2000 <- cwt_cleaner |>  glimpse()
feather_carcass_chop_header_2000 <- chop_header_cleaner |>  glimpse()
```
```{r, include=FALSE}
f <- function(input, output) write_csv(input, file = output)

gcs_upload(feather_carcass_chops_2000,
           object_function = f,
           type = "csv",
           name = "adult-holding-redd-and-carcass-surveys/feather-river/data/feather_carcass_chops_2000.csv")

gcs_upload(feather_carcass_tags_2000,
           object_function = f,
           type = "csv",
           name = "adult-holding-redd-and-carcass-surveys/feather-river/data/feather_carcass_tags_2000.csv")

gcs_upload(feather_carcass_cwt_2000,
           object_function = f,
           type = "csv",
           name = "adult-holding-redd-and-carcass-surveys/feather-river/data/feather_carcass_cwt_2000.csv")
gcs_upload(feather_carcass_chop_header_2000,
           object_function = f,
           type = "csv",
           name = "adult-holding-redd-and-carcass-surveys/feather-river/data/feather_carcass_chop_header_2000.csv")


```

