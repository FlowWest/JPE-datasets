---
title: "Feather Carcass QC 2000"
author: "Inigo Peng"
date: '2022-07-21'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, fig.width=15, fig.height=10)

library(tidyverse)
library(lubridate)
library(googleCloudStorageR)
library(ggplot2)
library(scales)
library(readxl)
library(janitor)
library(hms) #?as_hms()
library(RODBC)
library(knitr)
library(wesanderson)
```

# Feather River Carcass Data

## Description of Monitoring Data

**Timeframe:** 

**Video Season:** 

**Completeness of Record throughout timeframe:** 

**Sampling Location:**

**Data Contact:** 

Any additional info?

## Access Cloud Data

```{r, eval=FALSE}
# Run Sys.setenv() to specify GCS_AUTH_FILE and GCS_DEFAULT_BUCKET before running 
# getwd() to see how to specify paths 
# Open object from google cloud storage
# Set your authentication using gcs_auth
Sys.setenv("GCS_AUTH_FILE" = "C:/Users/InigoPeng/Projects/jpe/JPE-datasets/config.json")
Sys.setenv("GCS_DEFAULT_BUCKET" = "jpe-dev-bucket")

gcs_auth(json_file = Sys.getenv("GCS_AUTH_FILE"))
# Set global bucket 
gcs_global_bucket(bucket = Sys.getenv("GCS_DEFAULT_BUCKET"))

# git data and save as xlsx
```

Read in data from google cloud, glimpse raw data and domain description sheet:
```{r}
DRIVERINFO <- "Driver={Microsoft Access Driver (*.mdb, *.accdb)};"
MDBPATH <- "C:/Users/InigoPeng/Projects/jpe/JPE-datasets/data-raw/qc-markdowns/adult-holding-redd-and-carcass-surveys/feather-river/Carcass 2000.mdb"
PATH <- paste0(DRIVERINFO, "DBQ=", MDBPATH)

con <- odbcDriverConnect(PATH)

sqlTables(con)$TABLE_NAME

ChopEnv_raw <- sqlFetch(con, "ChopEnvTBL")
write_csv(ChopEnv_raw, "ChopEnv_2000.csv")

RecovTag_raw <- sqlFetch(con, "RecovTagTBL")
write_csv(RecovTag_raw, "RecovTag_2000.csv")

ChopRecov_raw <- sqlFetch(con,"ChopRecovTBL")
write_csv(ChopRecov_raw, "ChopRecov_2000.csv")

TagCol<- sqlFetch(con, "TagColLU")
write_csv(TagCol, "TagCol_2000.csv")

TagData <- sqlFetch(con, "TagDataTBL")
write_csv(TagData, "TagDataTBL_2000.csv")

TagEnv <- sqlFetch(con, "TagEnvTBL")
write_csv(TagEnv, "TagEnvTBL_2000.csv")

cwt <- sqlFetch(con, "cwtTBL")
write_csv(cwt, "cwt_2000.csv")
```


```{r}
# knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

# Google Cloud Set up
# Sys.setenv("GCS_AUTH_FILE" = "config.json")
# Sys.setenv("GCS_DEFAULT_BUCKET" = "jpe-dev-bucket")
# 
# gcs_get_object(object_name = "adult-holding-redd-and-carcass-surveys/feather-river/data-raw/carcass/2000/ChopEnvTBL_2000.csv",
#                bucket = gcs_get_global_bucket(),
#                saveToDisk = "ChopEnv_2000.csv",
#                overwrite = TRUE)
# 
# gcs_get_object(object_name = "adult-holding-redd-and-carcass-surveys/feather-river/data-raw/carcass/2000/ChopRecovTBL_2000.csv",
#                bucket = gcs_get_global_bucket(),
#                saveToDisk = "ChopRecov_2000.csv",
#                overwrite = TRUE)
# 
# gcs_get_object(object_name = "adult-holding-redd-and-carcass-surveys/feather-river/data-raw/carcass/2000/RecovTagTBL_2000.csv",
#                bucket = gcs_get_global_bucket(),
#                saveToDisk = "RecovTag_2000.csv",
#                overwrite = TRUE)
# 
# gcs_get_object(object_name = "adult-holding-redd-and-carcass-surveys/feather-river/data-raw/carcass/2000/TagColLU_2000.csv",
#                bucket = gcs_get_global_bucket(),
#                saveToDisk = "TagCol_2000.csv",
#                overwrite = TRUE)
# 
# gcs_get_object(object_name = "adult-holding-redd-and-carcass-surveys/feather-river/data-raw/carcass/2000/TagDataTBL_2000.csv",
#                bucket = gcs_get_global_bucket(),
#                saveToDisk = "TagData_2000.csv",
#                overwrite = TRUE)
# 
# gcs_get_object(object_name = "adult-holding-redd-and-carcass-surveys/feather-river/data-raw/carcass/2000/TagEnvTBL_2000.csv",
#                bucket = gcs_get_global_bucket(),
#                saveToDisk = "TagEnv_2000.csv",
#                overwrite = TRUE)

# Read Data
#Data for Recovered Tags
RecovTag_raw <- read_csv("RecovTag_2000.csv") %>% 
  # rename("ID" = HeaderID) %>% 
  glimpse()

#Heading Info for Chopped Data
ChopEnv_raw <- read_csv("ChopEnv_2000.csv",col_types = list("d", "c", "T", "c", "T", "c", "c")) %>% 
  # mutate("Start" = as_hms("Start")) %>%
  glimpse()

#Data collection for Chopping and Spawning to determine how many carcasses are being captured (link by recovID)
ChopRecov_raw <-read_csv("ChopRecov_2000.csv") %>% 
  glimpse()

#tag colour lookup table
TagCol_raw <- read_csv("TagCol_2000.csv") %>% 
  glimpse()

#Data for Tagging DataSheet - for some reason when export access table to excel, Tag Number is automatically changed to TagID
#Link to RecovTag table
TagData_raw <- read_csv("TagData_2000.csv") %>% 
  rename("TagNum" = "TagID") %>% 
  glimpse()

#Heading Info for Tagging Data Sheet
TagEnv_raw <- read_csv("TagEnvTBL_2000.csv") %>% 
  glimpse()

#Coded Wiretag Info

cwt_raw <- read_csv("cwt_2000.csv") %>% 
  glimpse
```

## Data transformations

```{r}
#1. Link ChopRecov with ChopEnv to get the date
chop_recovery_join <- full_join(ChopEnv_raw %>% 
                                  select(ChopEnvID, Date, Start, TagCol), ChopRecov_raw ) %>% 
  clean_names() %>% 
  rename(male_chop = "adult_m",
         female_chop = "adult_f",
         grilse_male = "gril_m",
         grilse_female = "gril_f") 

tag_join <- left_join(TagData_raw, RecovTag_raw) %>% 
  clean_names() %>% 
  select(c(tag_num, sect, unit, fl, sex, egg_ret, recov_id))

chop_header <- ChopEnv_raw %>% 
  clean_names()

cwt <- cwt_raw %>% 
  clean_names()
```

# Recovery 

The `chop_recovery_join` table contains recovered carcass counts 

# Tags

The `tag_join` table contains additional tag information 

### Survey

The `chop_header` table contains survey metadata and covariates

#CWT

The `cwt` table contains coded wire tag information. It is not joined with the other tables.

## Explore Numeric Variables: {.tabset}

```{r}
# Filter clean data to show only numeric variables 
chop_recovery_join %>% 
  select_if(is.numeric) %>%
  colnames()
```

### Variable: `chop_env_id`, `sect`, `unit`

```{r}
summary(chop_recovery_join$chop_env_id)
```
```{r}
summary(chop_recovery_join$sect)
```
```{r}
summary(chop_recovery_join$unit)
```



### Variable: `male_chop`, `female_chop`, `grilse_male`, `grilse_female`, `spawn`

```{r}
summary(chop_recovery_join$male_chop)
```
```{r}
summary(chop_recovery_join$female_chop)
```

**Plotting male_chop  over Period of Record**

```{r}
chop_recovery_join %>% 
  ggplot(aes(x = date, y = male_chop)) +
  geom_point(size = 1.4, alpha = .5, color = "blue") + 
  labs(x = "Date", 
       y = "Male Chop") +
  theme_minimal() + 
  theme(text = element_text(size = 15)) 
```

**Plotting female_chop over Period of Record**

```{r}
chop_recovery_join %>% 
  ggplot(aes(x = date, y = female_chop)) +
  geom_point(size = 1.4, alpha = .5, color = "blue") + 
  labs(x = "Date", 
       y = "Female Chop") +
  theme_minimal() + 
  theme(text = element_text(size = 15)) 
```

**Plotting Total Chops over Period of Record**

```{r}
total_chops <- chop_recovery_join %>% 
  mutate(total_chops = male_chop + female_chop,
         date = as_date(date)) %>% 
  select(date, male_chop, female_chop, total_chops) %>% glimpse()

total_chops_test <- total_chops %>% 
  filter(date == as_date("2000-09-05"))
nrow(total_chops) == (sum(total_chops$total_chops == (total_chops$male_chop + total_chops$female_chop)))

total_chops_summary <- total_chops %>% 
  group_by(date) %>% 
  summarise(total_chops = sum(total_chops, na.rm = T),
            male_chops = sum(male_chop, na.rm = T),
            female_chops = sum(female_chop, na.rm = T))
```

```{r}
total_chops_summary %>% 
  pivot_longer(cols = c(male_chops, female_chops), names_to = "sex", values_to = "count") %>% 
  mutate(proportions = (count/total_chops)) %>% 
  ggplot(aes(x = date, y = proportions, fill = sex)) + 
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(values = c("Blue","Red"), 
                    name = "Sex", 
                    labels = c("Female", "Male")) +
  theme_minimal() + 
  labs(y = "Proportion", x = "Date") +
  scale_fill_manual(values = wes_palette("Moonrise2"))
```

This plot shows the gender proportion of chops for each day over the the period of 2000-09-05 to 2000-12-14. The data gaps that we see are a result of the data collection process in which the data was collected 2-4 days each week (with no specific period day of week) over the 4 month period. All of the Chop data have been identified for their sexes.

```{r}
summary(chop_recovery_join$grilse_male)
```
```{r}
summary(chop_recovery_join$grilse_female)
```
```{r}
summary(chop_recovery_join$spawn)
```
* `r round(sum(is.na(chop_recovery_join$spawn))/nrow(chop_recovery_join), 3) * 100` % of values in the `spawn` column are NA.

**Plotting grilse_male  over Period of Record**

```{r}
chop_recovery_join %>% 
  ggplot(aes(x = date, y = grilse_male)) +
  geom_point(size = 1.4, alpha = .5, color = "blue") + 
  labs(x = "Date", 
       y = "Grilse Male") +
  theme_minimal() + 
  theme(text = element_text(size = 15)) 
```

**Plotting grilse_female  over Period of Record**

```{r}
chop_recovery_join %>% 
  ggplot(aes(x = date, y = grilse_female)) +
  geom_point(size = 1.4, alpha = .5, color = "blue") + 
  labs(x = "Date", 
       y = "Grilse Female") +
  theme_minimal() + 
  theme(text = element_text(size = 15)) 
```
**Plotting Total Grilse Chops  over Period of Record**

```{r}
total_grilse_chops <- chop_recovery_join %>% 
  mutate(total_grilse_chops = grilse_male + grilse_female,
         date = as_date(date)) %>% 
  select(date, grilse_male, grilse_female, total_grilse_chops) %>% glimpse()

total_grilse_chops_test <- total_grilse_chops %>% 
  filter(date == as_date("2000-09-05"))
nrow(total_grilse_chops) == (sum(total_grilse_chops$total_grilse_chops == (total_grilse_chops$grilse_male + total_grilse_chops$grilse_female)))

total_grilse_chops_summary <- total_grilse_chops %>% 
  group_by(date) %>% 
  summarise(total_grilse_chops = sum(total_grilse_chops, na.rm = T),
            grilse_male = sum(grilse_male, na.rm = T),
            grilse_female = sum(grilse_female, na.rm = T))
```

```{r}
total_grilse_chops_summary %>% 
  pivot_longer(cols = c(grilse_male, grilse_female), names_to = "sex", values_to = "count") %>% 
  mutate(proportions = (count/total_grilse_chops)) %>% 
  ggplot(aes(x = date, y = proportions, fill = sex)) + 
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(values = c("Blue","Red"), 
                    name = "Sex", 
                    labels = c("Female", "Male")) +
  theme_minimal() + 
  labs(y = "Proportion", x = "Date") +
  scale_fill_manual(values = wes_palette("Moonrise2"))
```

This plot shows the gender proportion of grilse chops for each day over the the period of 2000-09-05 to 2000-12-14. There are more data gap for the grilse data compared to the normal chops data. All of the grilse chop data have been identified for their sexes as well - there is a significant higher proportion of males compared to the females.

**Plotting spawn over a Period of Record**

```{r}
chop_recovery_join %>% 
  ggplot(aes(x = date, y = spawn)) +
  geom_point(size = 1.4, alpha = .5, color = "blue") + 
  labs(x = "Date", 
       y = "spawn") +
  theme_minimal() + 
  theme(text = element_text(size = 15)) 
```
This plot shows the number spawned for each day over the the period of 2000-09-05 to 2000-12-14. 

```{r}
# Filter clean data to show only numeric variables 
tag_join %>% 
  select_if(is.numeric) %>% 
  colnames()
```
```{r}
summary(tag_join$tag_num)
```
```{r}
summary(tag_join$sect)
```
```{r}
summary(tag_join$unit)
```
```{r}
summary(tag_join$fl)
```
```{r}
summary(tag_join$recov_id)
```

```{r}
all_tags <- tag_join %>% 
  mutate(tag_count = 1) %>% 
  pivot_wider(names_from = sex, values_from = tag_count) %>% 
  rename("unknown_tags" = X,
         "male_tag" = M,
         "female_tag" = F) 

total_tags_summary <- all_tags%>% 
  mutate(male_tag = ifelse(is.na(male_tag), 0, male_tag), # fill na
         female_tag = ifelse(is.na(female_tag), 0, female_tag),
         unknown_tags = ifelse(is.na(unknown_tags), 0, unknown_tags),
         total_tags = unknown_tags + male_tag + female_tag) %>% 
  select(male_tag, female_tag, unknown_tags, total_tags) %>% 
  summarise(total_tags = sum(total_tags),
            male_tags = sum(male_tag),
            female_tags = sum(female_tag),
            unknown_tags = sum(unknown_tags))

#Unknown tags proportion is very small and is rounded to zero 
total_tags_summary %>% 
  pivot_longer(cols = c(male_tags, female_tags, unknown_tags), names_to = "sex", values_to = "count") %>% 
  mutate(proportions = (count / total_tags)) %>% 
  ggplot(aes(x = sex, y = proportions)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(values = c("Blue","Red"), 
                    name = "Sex", 
                    labels = c("Female", "Male", "Unknown")) +
  theme_minimal() + 
  labs(y = "Proportion", x = "Sex") +
  scale_fill_manual(values = wes_palette("Moonrise2"))
```

```{r}
tag_join %>% 
  mutate(sex = ifelse(tag_join$sex == "X", "Unknown", tag_join$sex)) %>% 
  ggplot(aes(x = sex, y = fl)) + 
  geom_boxplot()
```

### Variable: `female_tag`, `male_tag`, `unknown_tag`

**Numeric Summary of `female_tag`, `male_tag`,`unknown_tag`**

```{r}
summary(all_tags$male_tag)
```
* `r round(sum(is.na(total_tags$male_tag))/nrow(total_tags), 3) * 100` % of values in the `male_tag` column are NA.
```{r}
summary(all_tags$female_tag)
```
* `r round(sum(is.na(tag_chop_join$female_tag))/nrow(tag_chop_join), 3) * 100` % of values in the `female_tag` column are NA.

```{r}
summary(all_tags$unknown_tags)
```

* `r round(sum(is.na(tag_chop_join$unknown_tags))/nrow(tag_chop_join), 3) * 100` % of values in the `unknown_tags` column are NA.

```{r}
tags_with_dates <- left_join(tag_join %>% 
  mutate(tag_count = 1) %>% 
  pivot_wider(names_from = sex, values_from = tag_count) %>% 
  rename("unknown_tags" = X,
         "male_tag" = M,
         "female_tag" = F), chop_recovery_join)%>% 
  filter(!is.na(date)) %>% glimpse

total_tags_with_dates <- tags_with_dates%>% 
  mutate(male_tag = ifelse(is.na(male_tag), 0, male_tag), # fill na
         female_tag = ifelse(is.na(female_tag), 0, female_tag),
         unknown_tags = ifelse(is.na(unknown_tags), 0, unknown_tags),
         total_tags = unknown_tags + male_tag + female_tag) %>% 
  select(date, male_tag, female_tag, unknown_tags, total_tags)

total_tags_with_dates_summary <- total_tags_with_dates %>%
  group_by(date) %>%
  summarise(total_tags = sum(total_tags, na.rm = T),
            male_tags = sum(male_tag, na.rm = T),
            female_tags = sum(female_tag, na.rm = T),
            unknown_tags = sum(unknown_tags, na.rm = T))

total_tags_with_dates_summary %>% 
  pivot_longer(cols = c(male_tags, female_tags, unknown_tags), names_to = "sex", values_to = "count") %>% 
  mutate(proportions = (count / total_tags)) %>% 
  ggplot(aes(x = date, y = proportions, fill = sex)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(values = c("Blue","Red", "Black"), 
                    name = "Sex", 
                    labels = c("Female", "Male", "Unknown")) +
  theme_minimal() + 
  labs(y = "Proportion", x = "Date") +
  scale_fill_manual(values = wes_palette("Moonrise2"))
#Lots of NA Dates - making plots over period of time will not be as informative
```


**Plotting female_tag over Period of Record**
```{r}
# Make whatever plot is appropriate 
total_tags_with_dates_summary %>% 
  ggplot(aes(x = date, y = female_tags)) +
  geom_point(size = 1.4, alpha = .5, color = "red") + 
  labs(x = "Date", 
       y = "Female Tag") +
  theme_minimal() + 
  theme(text = element_text(size = 15)) 
```
```{r}
total_tags_with_dates_summary %>% 
  ggplot(aes(x = date, y = female_tags)) +
  geom_point(size = 1.4, alpha = .5, color = "blue") + 
  labs(x = "Date", 
       y = "Male Tag") +
  theme_minimal() +
  theme(text = element_text(size = 15))
```


```{r}
theme(text = element_text(size = 15))
```

```{r}
chop_header %>% 
  select_if(is.numeric) %>% 
  colnames()
```
```{r}
summary(chop_header$id)
```

```{r}
summary(chop_header$tag_col)
```

```{r}
summary(chop_header$week_num)
```

```{r}
cwt %>% 
  select_if(is.numeric) %>% 
  colnames()
```
```{r}
summary(cwt$cwt_id)
```
```{r}
summary(cwt$sect)
```
```{r}
summary(cwt$unit)
```

```{r}
summary(cwt$ht_num)
```

```{r}
unique(cwt$sex)
cwt %>% 
  mutate(sex = ifelse(cwt$sex == "X", "Unknown", cwt$sex)) %>% 
  ggplot(aes(x = sex, y = fl)) + 
  geom_boxplot() +
  theme_minimal() + 
  theme(text = element_text(size = 15))
```



## Explore Categorical variables: {.tabset}

```{r}
chop_recovery_join %>% 
  select_if(is.character) %>% 
  colnames()
```
## Clean data

Fix inconsistencies with spelling, capitalization, and dates
```{r}
chop_recovery_cleaner <- chop_recovery_join %>%
  mutate(datetime = paste(as_date(date), as_hms(as.POSIXct(start, format = "%Y-%m-%dT%H:%M:%OSZ"))))%>%
  mutate_if(is.character, str_to_lower) %>% 
  select(-c(date, start)) %>%
  glimpse
```

```{r}
chop_header %>% 
  select_if(is.character) %>% 
  colnames()
```
```{r}
chop_header_cleaner <- chop_header %>% 
  mutate(datetime = paste(as_date(date), as_hms(as.POSIXct(start, format = "%Y-%m-%dT%H:%M:%OSZ"))))%>% 
  mutate_if(is.character, str_to_lower) %>% 
  select(-c(date, start, stop, week, turbot))
```
```{r}
tag_join %>% 
  select_if(is.character) %>% 
  colnames()
```
```{r}
tag_join_cleaner <-  tag_join %>% 
  mutate(sex = ifelse(tag_join$sex == "X", "Unknown", tag_join$sex)) %>% 
   mutate_if(is.character, str_to_lower) %>%
  select(-c(sect, unit))
```
```{r}
unique(tag_join_cleaner$sex)
#Not sure what the value of egg_ret supposed to be
unique(tag_join_cleaner$egg_ret)
```

```{r}
cwt %>% 
  select_if(is.character) %>% 
  colnames()
```
```{r}
cwt_cleaner <- cwt %>% 
  mutate(sex = ifelse(cwt$sex == "X", "Unknown", cwt$sex)) %>% 
  mutate_if(is.character, str_to_lower) %>%
  glimpse

unique(cwt_cleaner$sex)
unique(cwt_cleaner$egg_ret)
```


## Data Dictionaries

### Chop Recovery Count

```{r}
percent_na <- chop_recovery_cleaner %>%
  summarise_all(list(name = ~sum(is.na(.))/length(.))) %>%
  pivot_longer(cols = everything())


counts_data_dictionary <- tibble(variables = colnames(chop_recovery_cleaner),
                          description = c("Environment ID",
                                          "Colour of tag applied to carcass",
                                          "Sect", 
                                          "Unit",
                                          "Carcass that were chopped and male",
                                          "Carcass that were chopped and female",
                                          "Grilse carcass that were chopped and male",
                                          "Grilse carcass that were chopped and female",
                                          "Spawn",
                                          "Recovery ID",
                                          "Date and time of survey"),
                          percent_na = round(percent_na$value*100))

kable(counts_data_dictionary)
```
###Chop Tag Count

```{r}
percent_na <- tag_join_cleaner %>%
  summarise_all(list(name = ~sum(is.na(.))/length(.))) %>%
  pivot_longer(cols = everything())
```

```{r}
tag_counts_data_dictionary <- tibble(variables = colnames(tag_join_cleaner),
                          description = c("Tag number",
                                          "Fin length",
                                          "Sex", 
                                          "Egg Retained?",
                                          "Recovery ID"),
                          percent_na = round(percent_na$value*100))

kable(tag_counts_data_dictionary)
```

### Survey

```{r}
percent_na <- chop_header_cleaner %>%
  summarise_all(list(name = ~sum(is.na(.))/length(.))) %>%
  pivot_longer(cols = everything())

header_data_dictionary <- tibble(variables = colnames(chop_header_cleaner),
                          description = c("Chop Environment ID",
                                          "Tag Colour",
                                          "Crew memeber initials that collected",
                                          "Individual of crew member who recorded",
                                          "Weather",
                                          "Comments",
                                          "Date and time of survey"),
                          percent_na = round(percent_na$value*100,
                                             digits = 1))

kable(header_data_dictionary)
```

### CWT
```{r}
percent_na <- cwt_cleaner %>%
  summarise_all(list(name = ~sum(is.na(.))/length(.))) %>%
  pivot_longer(cols = everything())

cwt_data_dictionary <- tibble(variables = colnames(cwt_cleaner),
                          description = c("CWT ID",
                                          "Date of survey",
                                          "Sect",
                                          "Unit",
                                          "Fin length",
                                          "Sex",
                                          "Egg retained?",
                                          "Ht Num?",
                                          "CWT Code",
                                          "Comments"),
                          percent_na = round(percent_na$value*100,
                                             digits = 1))

kable(cwt_data_dictionary)
```

## Save cleaned data back to google cloud (TBA)

```{r}
# Name file [watershed]_[data type].csv
```



