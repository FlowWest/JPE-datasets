---
title: "Feather Carcass QC 2008"
author: "Inigo Peng"
date: '2022-07-21'
output: rmarkdown::github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, fig.width=15, fig.height=10)

library(tidyverse)
library(lubridate)
library(googleCloudStorageR)
library(ggplot2)
library(scales)
library(readxl)
library(janitor)
library(hms) #?as_hms()
library(RODBC)
library(knitr)
library(wesanderson)
```


# Feather River Carcass Data

## Description of Monitoring Data

**Timeframe:** 
  
**Video Season:** 
  
**Completeness of Record throughout timeframe:** 
  
**Sampling Location:**
  
**Data Contact:** 
  
Any additional info?
  
## Access Cloud Data
  
```{r, include=FALSE}
# Run Sys.setenv() to specify GCS_AUTH_FILE and GCS_DEFAULT_BUCKET before running 
# getwd() to see how to specify paths 
# Open object from google cloud storage
# Set your authentication using gcs_auth

gcs_auth(json_file = Sys.getenv("GCS_AUTH_FILE"))
# Set global bucket 
gcs_global_bucket(bucket = Sys.getenv("GCS_DEFAULT_BUCKET"))

# git data and save as xlsx
```

```{r, include=FALSE}
gcs_get_object(object_name = "adult-holding-redd-and-carcass-surveys/feather-river/data-raw/carcass/Carcass_2008.mdb",
               bucket = gcs_get_global_bucket(),
               saveToDisk = "data-raw/qc-markdowns/adult-holding-redd-and-carcass-surveys/feather-river/feather_carcass_2008.mdb",
               overwrite = TRUE)

filepath <- "data-raw/qc-markdowns/adult-holding-redd-and-carcass-surveys/feather-river/feather_carcass_2008.mdb"

operating_system <- ifelse(grepl("Mac", Sys.info()['nodename']) | grepl("MBP", Sys.info()['nodename']), "mac", "pc")

# Mac and PC need to run different code to pull data from Access db
if(operating_system == "pc") {
  DRIVERINFO <- "Driver={Microsoft Access Driver (*.mdb, *.accdb)};"
  PATH <- paste0(DRIVERINFO, "DBQ=", filepath)
  con <- odbcDriverConnect(PATH)
  # sqlTables(con)$TABLE_NAME
  ChopChannel <- sqlFetch(con, "ChopChannelTBL1")
  ChopRecov <- sqlFetch(con, "ChopRecovTBL")
  ChopHeader <- sqlFetch(con, "ChopHeaderTBL")
  cwt <- sqlFetch(con, "CWTTagTBL")
  cwt_header <- sqlFetch(con, "CWTHeaderTBL")
} else{
  library(Hmisc)
  mdb.get(filepath, tables = TRUE) # check for name differences
  ChopChannel <- mdb.get(filepath, "ChopChannelTBL1")
  ChopRecov <- mdb.get(filepath, "ChopRecovTBL")
  ChopHeader <- mdb.get(filepath, "ChopHeaderTBL")
  cwt <- mdb.get(filepath, "CWTTagTBL")
  cwt_header <- mdb.get(filepath, "CWTHeaderTBL")
  
  # FL by sex is empty
  # TagColLU_06 contains metadata about tag color
  # headtag is empty
  # ChopHallprintTBL contains TagID, sect, fork length, sex, clip, carc_stat, headerID, hallprint1, hallprint2, headtag, otolith, scale
  # ScaleSPLs is empty
  detach(package:Hmisc)
}
```

```{r}
write_csv(ChopChannel, here::here("data-raw", "qc-markdowns", "adult-holding-redd-and-carcass-surveys", "feather-river", "ChopChannel_2008.csv"))
write_csv(ChopRecov, here::here("data-raw", "qc-markdowns", "adult-holding-redd-and-carcass-surveys", "feather-river", "ChopRecov_2008.csv"))
write_csv(ChopHeader, here::here("data-raw", "qc-markdowns", "adult-holding-redd-and-carcass-surveys", "feather-river", "ChopHeader_2008.csv"))
write_csv(cwt, here::here("data-raw", "qc-markdowns", "adult-holding-redd-and-carcass-surveys", "feather-river", "CWTTag_2008.csv"))
write_csv(cwt_header, here::here("data-raw", "qc-markdowns", "adult-holding-redd-and-carcass-surveys", "feather-river", "CWTHeader_2008.csv"))
```



## Raw Data Glimpse: {.tabset}

### ChopChannel_raw
```{r}
ChopChannel_raw <- read_csv(here::here("data-raw", "qc-markdowns",
                                 "adult-holding-redd-and-carcass-surveys",
                                 "feather-river", "ChopChannel_2008.csv")) |> 
  glimpse()
```

### ChopHeader_raw

```{r}
ChopHeader_raw <- read_csv(here::here("data-raw", "qc-markdowns",
                                 "adult-holding-redd-and-carcass-surveys",
                                 "feather-river", "ChopHeader_2008.csv")) |> 
  glimpse()
```

### ChopRecov_raw
```{r}
ChopRecov_raw <- read_csv(here::here("data-raw", "qc-markdowns",
                                 "adult-holding-redd-and-carcass-surveys",
                                 "feather-river", "ChopRecov_2008.csv")) |> 
  glimpse()
```
### cwt_raw
```{r}
cwt_raw <- read_csv(here::here("data-raw", "qc-markdowns",
                                 "adult-holding-redd-and-carcass-surveys",
                                 "feather-river", "CWTTag_2008.csv")) |> 
  glimpse()
```

### cwt_header_raw

```{r}
cwt_header_raw <- read_csv(here::here("data-raw", "qc-markdowns",
                                 "adult-holding-redd-and-carcass-surveys",
                                 "feather-river", "CWTHeader_2008.csv")) |> 
  glimpse()
```



## Data transformations: {.tabset}

### Counts

The `chop_channel` table contains carcass counts by chop/tagged based on clips


```{r}
#1. chopchannel table (with dates and tag color)
chop_channel_join <- full_join(ChopHeader_raw |> 
                                 select(HeaderID = headerID, TagCol, Date, Time),
                               ChopChannel_raw, 
                               by = "HeaderID") |> 
  clean_names()
```

### Recovery

The `chop_recovery` table contains recovered carcass counts by color

```{r}
# 2. choprecovery table (with dates)
# should join headerID to chopchannel headerID, and then chanID from chop channel to ChopRecovery
# HeaderID connects ChopChannel to ChopHeader; ChanID joins ChopChannel to ChopRecov
chop_recovery_join <- full_join(chop_channel_join |> 
                                  select(date, time, sect, chan, min, chan_id, header_id,
                                         tag_col), ChopRecov_raw |> 
                                  rename(chan_id = ChanID), 
                                by = "chan_id") |> 
  clean_names() |> 
  glimpse()

# chop_recovery_join <- full_join(ChopHeader_raw |> 
#                                   select(ID, Date, Time),
#                                 ChopRecov_raw |> 
#                                   rename(ID = RecovID), by = "ID")  |> 
#   clean_names()

```

### Survey

The `chop_header` table contains survey metadata and covariates

```{r}
chop_header <- ChopHeader_raw |> 
  clean_names()
```

### CWT
The `cwt` table contains coded wire tag information. 

```{r}
cwt <- full_join(cwt_raw |> clean_names(), cwt_header_raw |> clean_names(), 
                 by = "header_id") |>  
  glimpse()
```


## Explore Numeric Variables: {.tabset}

### Chop Channel Variable: `header_id`, `chan_id`, `sect`, `min`
```{r}
# Filter clean data to show only numeric variables 
# We only get chops and tags for this dataset. Not much additional data
chop_channel_join |> 
  select_if(is.numeric) |>
  colnames()
```

```{r}
summary(chop_channel_join$header_id)
```
```{r}
summary(chop_channel_join$chan_id)
```
```{r}
summary(chop_channel_join$sect)
```

```{r}
summary(chop_channel_join$min)
```

### Chop Channel Variable: `chops`, `tags`

```{r}
summary(chop_channel_join$chops)
```

```{r}
summary(chop_channel_join$tags)
```

**NA and Unknown Values**
Provide a stat on NA or unknown values.

```{r}
round(sum(is.na(chop_channel_join$chops))/nrow(chop_channel_join), 3) * 100
round(sum(is.na(chop_channel_join$tags))/nrow(chop_channel_join), 3) * 100
```
* `r round(sum(is.na(chop_channel_join$chops))/nrow(chop_channel_join), 3) * 100` % of values in the `chops` column are NA.
* `r round(sum(is.na(chop_channel_join$tags))/nrow(chop_channel_join), 3) * 100` % of values in the `tags` column are NA.

**Plotting chops over Period of Record**

```{r}
chop_channel_join |> 
  group_by(date) |> 
  summarise(chops = sum(chops)) |> 
  ggplot(aes(x = date, y = chops)) +
  geom_col(fill = "blue") + 
  labs(x = "Date", 
       y = "Chops") +
  theme_minimal() + 
  theme(text = element_text(size = 15)) 
```


**Plotting tags over Period of Record**

```{r}
chop_channel_join |> 
  group_by(date) |> 
  summarise(tags = sum(tags)) |> 
  ggplot(aes(x = date, y = tags)) +
  geom_col(fill = "red") + 
  labs(x = "Date", 
       y = "Tags") +
  theme_minimal() + 
  theme(text = element_text(size = 15)) 
```

**Comparing tags and chops**
```{r}
chop_channel_join |> 
  pivot_longer(cols = c(chops, tags), names_to = "tags_or_chops", values_to = "count") |> 
  ggplot(aes(x = date, y = count, fill = tags_or_chops)) +
  geom_col() + 
  theme_minimal() +
  scale_fill_manual(values = wes_palette("Moonrise2"))
```

Tags appear to be less commonly applied compared to chops.


### Chop Recovery Variable: `recov_`id`, `chan_id`, `recov_count`
```{r}
# Filter clean data to show only numeric variables 
chop_recovery_join |> 
  select_if(is.numeric) |>
  colnames()
```

```{r}
summary(chop_recovery_join$recov_id)
```
```{r}
summary(chop_recovery_join$recov_count)
```

* `r round(sum(is.na(chop_recovery_join$recov_count))/nrow(chop_recovery_join$recov_count), 3) * 100` % of values in the `recov_count` column are NA.

Note: no recov_count have dates associated with it

### Chop Header Variable: `header_id`

```{r}
chop_header |> 
  select_if(is.numeric) |> 
  colnames()
```
```{r}
summary(chop_header$header_id)
```
```{r}
summary(chop_header$tag_col)
```

### CWT Variable: `tag_id`, `sect`, `fl`, `header_id`, `week_num`
```{r}
cwt |> 
  select_if(is.numeric) |> 
  colnames()
```
```{r}
summary(cwt$tag_id)
```
```{r}
summary(cwt$sect)
```
```{r}
summary(cwt$fl)
```
* `r round(sum(is.na(cwt$tag_id))/nrow(cwt), 3) * 100` % of values in the `tag_id` column are NA.
* `r round(sum(is.na(cwt$sect))/nrow(cwt), 3) * 100` % of values in the `sect` column are NA.
* `r round(sum(is.na(cwt$fl))/nrow(cwt), 3) * 100` % of values in the `fl` column are NA.

```{r}
#Create a cwt_count column
#Pivot table to expand sex column to female_cwt, male_cwt, and unknown_cwt 
cwt_count <- cwt |> 
  mutate(count = 1) |>
  mutate(sex = case_when(sex == "ND"|is.na(sex)|sex =="UK" ~ "U",
                         TRUE ~ sex)) |> 
  pivot_wider(names_from = sex, values_from = count, values_fill = 0) |> 
  # unnest() |> 
  rename("male_cwt" = M,
         "female_cwt" = F,
         "unknown_cwt" = U) |> glimpse()

total_cwt_summary <- cwt_count |> 
  mutate(male_cwt = ifelse(is.na(male_cwt), 0, male_cwt), # fill na
         female_cwt = ifelse(is.na(female_cwt), 0, female_cwt),
         unknown_cwt = ifelse(is.na(unknown_cwt), 0, unknown_cwt),
         total_cwt = unknown_cwt + male_cwt + female_cwt) |> 
  group_by(month(date)) |> 
  summarise(total_cwt = sum(total_cwt),
            male_cwt = sum(male_cwt),
            female_cwt = sum(female_cwt),
            unknown_cwt = sum(unknown_cwt))
```

```{r}
total_cwt_summary |> 
  pivot_longer(cols = c(male_cwt, female_cwt, unknown_cwt), names_to = "sex", values_to = "count") |> 
  mutate(proportions = (count / total_cwt)) |> 
  ggplot(aes(x = `month(date)`, y = proportions, fill = sex)) + 
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(name = "chops", 
                    labels = c("CWT Male", "CWT Female", "CWT Unknown")) +
  theme_minimal() + 
  labs(y = "Proportion", x = "Month") +
  scale_fill_manual(values = wes_palette("Moonrise2"))
```


**Plotting fork length of each sex**

```{r}
cwt |> 
  mutate(sex = case_when(sex == "ND"|is.na(sex)|sex =="UK" ~ "Unknown",
                         TRUE ~ sex))|> 
  ggplot(aes(x = sex, y = fl)) + 
  geom_boxplot() + 
  theme_minimal() + 
  labs(y = "FL", x = "Sex")
```


## Explore Categorical variables: {.tabset}

### Chop Channel Clean Data

Fix inconsistencies with spelling, capitalization, and dates

```{r}
chop_channel_join |> 
  select_if(is.character) |>
  colnames()
```
```{r}
unique(chop_channel_join$chan)
```

```{r}
chop_channel_cleaner <- chop_channel_join |>
  mutate(date = as_date(date)) |>
  mutate_if(is.character, str_to_lower) |> 
  select(-c(time)) |> glimpse()
```
### Chop Recovery Clean Data

Fix inconsistencies with spelling, capitalization, and dates

```{r}
chop_recovery_join |> 
  select_if(is.character) |> 
  colnames()
```

```{r}
unique(chop_recovery_join$recov_color) # recovery color encoded as numerical
```
```{r}
chop_recovery_cleaner <- chop_recovery_join |> 
  mutate(date = as_date(date)) |>
  mutate_if(is.character, str_to_lower) |> 
  select(-c(time)) |> 
  glimpse()
```

### Chop Header Clean Data

```{r}
chop_header |> 
  select_if(is.character) |> 
  colnames()
```
```{r}
unique(chop_header$crew)
```
```{r}
unique(chop_header$recorder)
```
```{r}
unique(chop_header$weather)
```



```{r}
chop_header_cleaner <- chop_header |>
  mutate(date = as_date(date)) |>
  mutate_if(is.character, str_to_lower) |> 
  mutate(crew = str_replace_all(crew, " ", ","),
         crew = str_replace_all(crew, ",,", ","),
         weather = case_when(weather == "ran" ~ "rain",
                             weather == "cld" ~ "cloudy",
                             TRUE ~ weather)) |> 
  glimpse()
```

### CWT Clean Data

```{r}
cwt |> 
  select_if(is.character) |> 
  colnames()
```

```{r}
unique(cwt$spawn)
```
```{r}
unique(cwt$clip)
```
```{r}
unique(cwt$samp_type)
```
```{r}
unique(cwt$tag_col)
```

```{r}
unique(cwt$run)
```

```{r}
cwt_cleaner <- cwt |> 
  mutate_if(is.character, str_to_lower) |> 
  mutate(crew = str_replace_all(crew, " ", ","),
         crew = str_replace_all(crew, ",,", ","),
         spawn = case_when(spawn %in% c("no data", "uk") ~ NA_character_,
                           TRUE ~ spawn),
         clip = case_when(clip %in% c("no data", "uk") ~ NA_character_,
                          clip == "y" ~ "yes",
                          clip == "n" ~ "no", 
                          TRUE ~ clip
                          ),
         samp_type = ifelse(samp_type == "none", NA, samp_type)) |> 
  glimpse()
```


## Comments
* The carcass count table (chop_channel) only records chops and tags.
* Some changes to the columns of CWT table 

## Data Dictionaries

# Channel

```{r}
percent_na <- chop_channel_cleaner |>
  summarise_all(list(name = ~sum(is.na(.))/length(.))) |>
  pivot_longer(cols = everything())


counts_data_dictionary <- tibble(variables = colnames(chop_channel_cleaner),
                          description = c("Header ID",
                                          "Color of tag applied to carcass",
                                          "Date of survey",
                                          "Channel ID",
                                          "Sect", 
                                          "Chan", 
                                          "Min", 
                                          "Carcass that were chopped",
                                          "Carcass that were tagged"),
                          percent_na = round(percent_na$value*100))

kable(counts_data_dictionary)
```

### Recovery

```{r}
percent_na <- chop_recovery_cleaner |>
  summarise_all(list(name = ~sum(is.na(.))/length(.))) |>
  pivot_longer(cols = everything())


recovery_data_dictionary <- tibble(variables = colnames(chop_recovery_cleaner),
                          description = c("Date of Survey",
                                          "Sect",
                                          "Chan",
                                          "Min",
                                          "Chan ID",
                                          "Header ID",
                                          "Color of tag recovered from carcass",
                                          "Count of recovery",
                                          "Color of recovery tag", 
                                          "Count of recvered tags"),
                          percent_na = round(percent_na$value*100))

kable(recovery_data_dictionary)
```

### Survey

```{r}

percent_na <- chop_header_cleaner |>
  summarise_all(list(name = ~sum(is.na(.))/length(.))) |>
  pivot_longer(cols = everything())
# 
header_data_dictionary <- tibble(variables = colnames(chop_header_cleaner),
                          description = c("Header ID",
                                          "Color of tag of carcass",
                                          "Date of survey",
                                          "Crew memeber initials that collected",
                                          "Time",
                                          "Individual of crew member who recorded",
                                          "Weather",
                                          "Comments",
                                          "Week number"),
                          percent_na = round(percent_na$value*100))
# 
kable(header_data_dictionary)
```

### CWT
```{r}
percent_na <- cwt_cleaner |>
  summarise_all(list(name = ~sum(is.na(.))/length(.))) |>
  pivot_longer(cols = everything())

cwt_data_dictionary <- tibble(variables = colnames(cwt_cleaner),
                          description = c("ID",
                                          "Sect",
                                          "Fork length",
                                          "Sex",
                                          "Spawn",
                                          "Clip",
                                          "Sample type",
                                          "Sample number",
                                          "Head tag",
                                          "Comment",
                                          "Header ID",
                                          "Hall print 1",
                                          "Hall print 2",
                                          "Scale sample",
                                          "Run",
                                          "Date",
                                          "Crew",
                                          "Week number",
                                          "Tag colour"),
                          percent_na = round(percent_na$value*100))

kable(cwt_data_dictionary)
```
## Save cleaned data back to google cloud (TBA)

```{r}
#Ignore chop recovery as its 100% NA
feather_carcass_chops_and_tags_2008 <- chop_channel_cleaner |> glimpse()
feather_carcass_cwt_2008 <- cwt_cleaner |> glimpse()
feather_carcass_chop_header_2008 <- chop_header_cleaner |> glimpse()
```


```{r, include=FALSE}
f <- function(input, output) write_csv(input, file = output)

gcs_upload(feather_carcass_chops_and_tags_2008,
           object_function = f,
           type = "csv",
           name = "adult-holding-redd-and-carcass-surveys/feather-river/data/feather_carcass_chops_and_tags_2008.csv")
gcs_upload(feather_carcass_cwt_2008,
           object_function = f,
           type = "csv",
           name = "adult-holding-redd-and-carcass-surveys/feather-river/data/feather_carcass_cwt_2008.csv")
gcs_upload(feather_carcass_chop_header_2008,
           object_function = f,
           type = "csv",
           name = "adult-holding-redd-and-carcass-surveys/feather-river/data/feather_carcass_chop_header_2008.csv")
```
