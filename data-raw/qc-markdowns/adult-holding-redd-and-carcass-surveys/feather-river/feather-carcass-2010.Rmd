---
title: "Feather Carcass QC 2010"
author: "Jonathan Fernandez"
date: "06/17/2022"
output: rmarkdown::github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, fig.width=15, fig.height=10)

library(tidyverse)
library(lubridate)
library(googleCloudStorageR)
library(ggplot2)
library(scales)
library(readxl)
library(janitor)
library(hms) #?as_hms()
library(RODBC)
library(knitr)

```

# [Watershed] [Data type long version]

## Description of Monitoring Data

**Timeframe:** 

**Video Season:** 

**Completeness of Record throughout timeframe:** 

**Sampling Location:**

**Data Contact:** 

Any additional info?

## Access Cloud Data

```{r, eval=FALSE}
# Run Sys.setenv() to specify GCS_AUTH_FILE and GCS_DEFAULT_BUCKET before running 
# getwd() to see how to specify paths 
# Open object from google cloud storage
# Set your authentication using gcs_auth
gcs_auth(json_file = Sys.getenv("GCS_AUTH_FILE"))
# Set global bucket 
gcs_global_bucket(bucket = Sys.getenv("GCS_DEFAULT_BUCKET"))

# git data and save as xlsx
```

Read in data from google cloud, glimpse raw data and domain description sheet: 
```{r}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

# Google Cloud Set up
# Sys.setenv("GCS_AUTH_FILE" = "config.json")
# Sys.setenv("GCS_DEFAULT_BUCKET" = "jpe-dev-bucket")
# gcs_auth(json_file = Sys.getenv("GCS_AUTH_FILE"))
# gcs_global_bucket(bucket = Sys.getenv("GCS_DEFAULT_BUCKET"))
# gcs_get_object(object_name = "adult-holding-redd-and-carcass-surveys/feather-river/data-raw/carcass/ChopChannelTBL1.xlsx",
#                bucket = gcs_get_global_bucket(),
#                saveToDisk = "ChopChannelTBL1.xlsx",
#                overwrite = TRUE)
# 
# gcs_get_object(object_name = "adult-holding-redd-and-carcass-surveys/feather-river/data-raw/carcass/ChopHeaderTBL.xlsx",
#                bucket = gcs_get_global_bucket(),
#                saveToDisk = "ChopHeaderTBL.xlsx",
#                overwrite = TRUE)
# 
# gcs_get_object(object_name = "adult-holding-redd-and-carcass-surveys/feather-river/data-raw/carcass/ChopRecovTBL.xlsx",
#                bucket = gcs_get_global_bucket(),
#                saveToDisk = "CÃ§",
#                overwrite = TRUE)

# Read Data
ChopChannel_raw <- read_excel("ChopChannelTBL1.xlsx") %>% 
  rename("ID" = HeaderID)
ChopHeader_raw <- read_excel("ChopHeaderTBL.xlsx") %>% 
  rename("ID" = headerID)
ChopRecov_raw <-read_excel("ChopRecovTBL.xlsx")
```
Read in data from Microsoft Access, glimpse raw data and domain description sheet: 

```{r}
# TODO: Attempt, but not needed
library(Hmisc) 

# List of all available tables
mdb.get("CAMP_Escapement_20210412.mdb")

# Code to read in the CatchRaw table
carcasschops <- mdb.get("CAMP_DB_for_FlowWest/CAMP_Escapement_20210412.mdb", tables = "CarcassChops")

feather_camp <- odbcConnectAccess2007("CAMP_Escapement_20210412.mdb")
```
## Data transformations

```{r}
# Checking Join
# chopTBL_test1 <- left_join(ChopChannel_raw, ChopHeader_raw, by = "ID")
# chopTBL_test2 <- full_join(chopTBL_test1, ChopRecov_raw, by = "ChanID")

# Join Tables
chopTBL <- left_join(ChopChannel_raw, ChopHeader_raw, by = "ID") %>%
  full_join(ChopRecov_raw, by = "ChanID")

cleaner_chopTBL <- chopTBL %>% 
  clean_names() %>% 
  glimpse()

# TODO: Any columns to remove? Check in with Ashley on this.
 #  select(-sect,chan,crew,week_num) %>%
 #  glimpse()
```

## Data Dictionary
```{r}
percent_na <- cleaner_chopTBL %>%
  summarise_all(list(name = ~sum(is.na(.))/length(.))) %>%
  pivot_longer(cols = everything())
  
data_dictionary <- tibble(variables = colnames(cleaner_chopTBL),
                          description = c("Channel ID", # TODO: Identify linkage, Lat/long?
                                          "Section", # TODO: Identify encoding
                                          "Channel", # TODO: Identify encoding
                                          "Minimum", # What exactly?
                                          "Head ID", # TODO: Rename to head_ID
                                          "Observed unknown sex chops",
                                          "Observed unknown sex tags",
                                          "Observed male chops",
                                          "Observed female chops",
                                          "Observed female tags",
                                          "Observed male tags",
                                          "Color of tag applied to carcass", # color?
                                          "Date",
                                          "Initials of crew conducting survey", 
                                          "Time of Day",
                                          "Initials of person recording data",
                                          "Weather (sunny, cloudy, rainy)",
                                          "Comments",
                                          "Week Number",
                                          "Recovery ID",
                                          "Recovery color",
                                          "Recovery count"),
                          percent_na = round(percent_na$value*100))
kable(data_dictionary)
```

## Explore Numeric Variables: {.tabset}

```{r}
# Filter clean data to show only numeric variables 
cleaner_chopTBL %>% 
  select_if(is.numeric) %>%
  colnames()
```

### Variable: `female_chop`, `male_chop`,`unknown_chop`

**Numeric Summary of `female_chop`, `male_chop`,`unknown_chops` over Period of Record**

```{r}
summary(cleaner_chopTBL$female_chop)
```

```{r}
summary(cleaner_chopTBL$male_chop)
```

```{r}
summary(cleaner_chopTBL$unknown_chops)
```

**NA and Unknown Values**

Provide a stat on NA or unknown values

NA and Unknown Values
  - <1 % of values in the female_chop column are NA.
  - <1 % of values in the male_chop column are NA.
  - <1 % of values in the unknown_chops column are NA.

**Plotting female_chop over Period of Record**

### TODO: compare Male, female, unknowntogether -> histogram?

```{r}
# Make whatever plot is appropriate 
filter(cleaner_chopTBL) %>% 
  ggplot(aes(x = female_chop, y = date)) +
  geom_point(size = 1.4, alpha = .5, color = "blue") + 
  labs(x = "Female Chop", 
       y = "Date") +
  theme_minimal() + 
  theme(text = element_text(size = 15)) 
```


**Plotting male_chop over Period of Record**
```{r}
# Make whatever plot is appropriate 
filter(cleaner_chopTBL) %>% 
  ggplot(aes(x = male_chop, y = date)) +
  geom_point(size = 1.4, alpha = .5, color = "red") + 
  labs(x = "Male Chop", 
       y = "Date") +
  theme_minimal() + 
  theme(text = element_text(size = 15)) 
```

**Plotting unknown_chops over Period of Record**
```{r}
# Make whatever plot is appropriate 
filter(cleaner_chopTBL) %>% 
  ggplot(aes(x = unknown_chops, y = date)) +
  geom_point(size = 1.4, alpha = .5, color = "black") + 
  labs(x = "Unknown Chops", 
       y = "Date") +
  theme_minimal() + 
  theme(text = element_text(size = 15)) 
```

**Plotting Total chops over Period of Record**

```{r}
cleaner_chopTBL %>% glimpse()

# Percentage by Gender of Daily Chops
# Address NA values for chops
total_chopsTBL <- cleaner_chopTBL %>%
  mutate(male_chop = ifelse(is.na(male_chop), 0, male_chop), # fill na
         female_chop = ifelse(is.na(female_chop), 0, female_chop),
         unknown_chop = ifelse(is.na(unknown_chops), 0, unknown_chops),
         total_chops = unknown_chops + male_chop + female_chop) %>% 
  select(date, male_chop, female_chop, unknown_chops, total_chops)

# Case check: checking for duplicates
total_chops_test <- total_chopsTBL %>% # get total chops
  filter(date == as_date("2010-09-07"))

# Check if NAs introduced in creating total chop columns
nrow(total_chops_test) == (sum(total_chops_test$total_chops == (total_chops_test$male_chop + total_chops_test$female_chop + total_chops_test$unknown_chops)))

# total number of chops for the day
total_chopsTBL <- total_chopsTBL %>%
  group_by(date) %>%
  summarise(total_chops = sum(total_chops, na.rm = T),
            male_chops = sum(male_chop, na.rm = T),
            female_chops = sum(female_chop, na.rm = T),
            unknown_chops = sum(unknown_chops, na.rm = T))

# TODO: Look into NA in date. Why are there date gaps?
# Potential issue: Reading in excel can introduce NA (not case here)
# Potential issue: Joins introduces NA (the case)
# Potential issue: Could just be missing (not missing, but just periodically collected 2-3 weekdays of the week no specific day)

# check if NAs are introduced in merge
A = left_join(ChopChannel_raw, ChopHeader_raw, by = "ID")$ChanID
B = ChopRecov_raw$ChanID
sum(B %in% A) # they are

# TODO: Resolve missing dates?
# Plot to identify proportions by sex for each day
total_chopsTBL %>% 
  pivot_longer(cols = c(male_chops, female_chops, unknown_chops), names_to = "sex", values_to = "count") %>% 
  mutate(proportions = (count / total_chops)) %>% 
  ggplot(aes(x = date, y = proportions, fill = sex)) +
  geom_bar(stat = "identity", position = "stack")

# TODO: Check why some plots are above 100%
proportion_irregularities <- total_chopsTBL %>%
  pivot_longer(cols = c(male_chops, female_chops, unknown_chops), names_to = "sex", values_to = "count") %>%
  mutate(proportions = (count / total_chops)) %>% 
  group_by(date) %>%
  summarise(date = date,
            proportion_sum = sum(proportions)) %>% 
  mutate(need_to_check = ifelse((proportion_sum > 1), TRUE, FALSE)) %>% 
  filter(need_to_check == TRUE)

# Explore the irregularities
proportion_irregularities_date = proportion_irregularities$date
proportion_irregularities_date_index = total_chopsTBL$date %in% proportion_irregularities_date
total_chopsTBL %>% 
  filter(proportion_irregularities_date_index) %>% 
  mutate(proportion = (male_chops + female_chops + unknown_chops) / (total_chops))
# It seems is just significance level

# TODO: Make Graph Prettier
total_chopsTBL %>% 
  pivot_longer(cols = c(male_chops, female_chops, unknown_chops), names_to = "sex", values_to = "count") %>% 
  mutate(proportions = (count / total_chops)) %>% 
  ggplot(aes(x = date, y = proportions, fill = sex)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(values = c("Blue","Red", "Black"), 
                    name = "Sex", 
                    labels = c("Female", "Male", "Unknown")) +
  theme_minimal() + 
  labs(y = "Proportion", x = "Date")

# TODO: Look into chan_id

```
This plot shows the gender proportion of chops for each day over the the period of 2010-09-07 to 2010-12-22. The data gaps that we see are a result of the data collection process in which the data was collected 2-4 days each week (with no specific period day of week) over the 4 month period. We can also observe some of the proportions exceed 1 which was a result of rounding/significant figure sums, so these can be ignored. Also, it was interesting to see the unknown sex account for most of the chops towards the latter periods.

**Plotting female_tag over Period of Record**

```{r}
# Make whatever plot is appropriate 
filter(cleaner_chopTBL) %>% 
  ggplot(aes(x = female_tag, y = date)) +
  geom_point(size = 1.4, alpha = .5, color = "blue") + 
  labs(x = "Female Tag", 
       y = "Date") +
  theme_minimal() + 
  theme(text = element_text(size = 15)) 
```

**Plotting male_tag over Period of Record**

```{r}
# Make whatever plot is appropriate 
filter(cleaner_chopTBL) %>% 
  ggplot(aes(x = male_tag, y = date)) +
  geom_point(size = 1.4, alpha = .5, color = "red") + 
  labs(x = "Male Tag", 
       y = "Date") +
  theme_minimal() + 
  theme(text = element_text(size = 15)) 
```

**Plotting unknown_tags over Period of Record**
```{r}
# Make whatever plot is appropriate 
filter(cleaner_chopTBL) %>% 
  ggplot(aes(x = unknown_tags, y = date)) +
  geom_point(size = 1.4, alpha = .5, color = "black") + 
  labs(x = "Unknown Tags", 
       y = "Date") +
  theme_minimal() + 
  theme(text = element_text(size = 15)) 
```


**Plotting Total Tags over Period of Record**
```{r}
# Percentage by Gender of Daily Chops
# Address NA values for chops
total_tagsTBL <- cleaner_chopTBL %>%
  mutate(male_tag = ifelse(is.na(male_tag), 0, male_tag), # fill na
         female_tag = ifelse(is.na(female_tag), 0, female_tag),
         unknown_tags = ifelse(is.na(unknown_tags), 0, unknown_tags),
         total_tags = unknown_tags + male_tag + female_tag) %>% 
  select(date, male_tag, female_tag, unknown_tags, total_tags)

# total number of chops for the day
total_tagsTBL <- total_tagsTBL %>%
  group_by(date) %>%
  summarise(total_tags = sum(total_tags, na.rm = T),
            male_tags = sum(male_tag, na.rm = T),
            female_tags = sum(female_tag, na.rm = T),
            unknown_tags = sum(unknown_tags, na.rm = T))

# Plot to identify proportions by sex for each day
total_tagsTBL %>% 
  pivot_longer(cols = c(male_tags, female_tags, unknown_tags), names_to = "sex", values_to = "count") %>% 
  mutate(proportions = (count / total_tags)) %>% 
  ggplot(aes(x = date, y = proportions, fill = sex)) +
  geom_bar(stat = "identity", position = "stack")

# TODO: Make Graph Prettier
total_tagsTBL %>% 
  pivot_longer(cols = c(male_tags, female_tags, unknown_tags), names_to = "sex", values_to = "count") %>% 
  mutate(proportions = (count / total_tags)) %>% 
  ggplot(aes(x = date, y = proportions, fill = sex)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(values = c("Blue","Red", "Black"), 
                    name = "Sex", 
                    labels = c("Female", "Male", "Unknown")) +
  theme_minimal() + 
  labs(y = "Proportion", x = "Date")

#check why period of graph is cut short
# cleaner_chopTBL %>% filter(date > "2010-11-01") %>% 
#   select(date, male_tag, female_tag, unknown_tags)
# 
# #check why there is such a big gap
# cleaner_chopTBL %>% filter(date < "2010-10-01") %>% 
#   select(date, male_tag, female_tag, unknown_tags)
```
This plot shows the gender proportion of chops for each day over the the period of 2010-09-07 to 2010-12-22. The period appears to be shorter, because the tags recorded during the december period are 0. The data gaps that we see are a result of the data collection process in which the data was collected 2-4 days each week (with no specific period day of week) over the 4 month period. In comparison to the chops, we can see the tags tend to be more identifiable in terms of gender. The observed data gap is a result of reporting to be 0.

# TODO : Male to Female to Unkown (proportion)
## Explore Categorical variables: {.tabset}

General notes: If there is an opportunity to turn yes no into boolean do so, but not if you loose value 

```{r}
# Filter clean data to show only categorical variables
cleaner_chopTBL %>% 
  select_if(is.character) %>%
  colnames()
```


### Variable: `characters`
```{r}
# Frequencies
table(cleaner_chopTBL$chan)
table(cleaner_chopTBL$crew)
table(cleaner_chopTBL$weather)
table(cleaner_chopTBL$comment)
table(cleaner_chopTBL$recov_color)
```

Fix inconsistencies with spelling, capitalization, and abbreviations. 

```{r}
# Fix any inconsistencies with categorical variables
cleaner_chopTBL <- cleaner_chopTBL %>% 
  mutate_if(is.character, str_to_lower)

# Frequencies
table(cleaner_chopTBL$chan)
table(cleaner_chopTBL$crew)
table(cleaner_chopTBL$weather)
table(cleaner_chopTBL$comment)
table(cleaner_chopTBL$recov_color)
```

## Save cleaned data back to google cloud 

```{r}
# TODO: Request Permission Access
# Write to google cloud 
# Name file [watershed]_[data type].csv
```
