---
title: "Feather Carcass QC 2013"
author: "Inigo Peng"
date: '2022-07-21'
output: rmarkdown::github_document
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, fig.width=15, fig.height=10)

library(tidyverse)
library(lubridate)
library(googleCloudStorageR)
library(ggplot2)
library(scales)
library(readxl)
library(janitor)
library(hms) #?as_hms()
library(RODBC)
library(knitr)
library(wesanderson)
```


# Feather River Carcass Data

## Description of Monitoring Data

**Timeframe:** 
  
**Video Season:** 
  
**Completeness of Record throughout timeframe:** 
  
**Sampling Location:**
  
**Data Contact:** 
  
Any additional info?
  
## Access Cloud Data

```{r, include=FALSE}
# Run Sys.setenv() to specify GCS_AUTH_FILE and GCS_DEFAULT_BUCKET before running 
# getwd() to see how to specify paths 
# Open object from google cloud storage
# Set your authentication using gcs_auth

gcs_auth(json_file = Sys.getenv("GCS_AUTH_FILE"))
# Set global bucket 
gcs_global_bucket(bucket = Sys.getenv("GCS_DEFAULT_BUCKET"))

# git data and save as xlsx
```
```{r, include=FALSE}
gcs_get_object(object_name = "adult-holding-redd-and-carcass-surveys/feather-river/data-raw/carcass/Carcass_2013.accdb",
               bucket = gcs_get_global_bucket(),
               saveToDisk = "data-raw/qc-markdowns/adult-holding-redd-and-carcass-surveys/feather-river/feather_carcass_2013.mdb",
               overwrite = TRUE)

filepath <- "data-raw/qc-markdowns/adult-holding-redd-and-carcass-surveys/feather-river/feather_carcass_2013.mdb"

operating_system <- ifelse(grepl("Mac", Sys.info()['nodename']) | grepl("MBP", Sys.info()['nodename']), "mac", "pc")

# Mac and PC need to run different code to pull data from Access db
if(operating_system == "pc") {
  DRIVERINFO <- "Driver={Microsoft Access Driver (*.mdb, *.accdb)};"
  PATH <- paste0(DRIVERINFO, "DBQ=", filepath)
  con <- odbcDriverConnect(PATH)
  # sqlTables(con)$TABLE_NAME
  ChopHeader_raw <- sqlFetch(con, "Chop Header")
  Chops_raw <- sqlFetch(con, "Chops")
  cwt_raw <- sqlFetch(con, "CWT")
  cwt_header_raw <- sqlFetch(con, "CWT Header")
} else{
  library(Hmisc)
  mdb.get(filepath, tables = TRUE) # check for name differences
  # Otoliths, Switchboard Items, and Sample Weeks are empty. Paste Errors table not relevant.
  Chops_raw <- mdb.get(filepath, "Chops")
  ChopHeader_raw <- mdb.get(filepath, "Chop Header")
  cwt_raw <- mdb.get(filepath, "CWT")
  cwt_header_raw <- mdb.get(filepath, "CWT Header")
  detach(package:Hmisc)
}

write_csv(ChopHeader_raw, here::here("data-raw", "qc-markdowns", "adult-holding-redd-and-carcass-surveys", "feather-river", "ChopHeader_2013.csv"))
write_csv(Chops_raw, here::here("data-raw", "qc-markdowns", "adult-holding-redd-and-carcass-surveys", "feather-river", "Chops_2013.csv"))
write_csv(cwt_raw, here::here("data-raw", "qc-markdowns", "adult-holding-redd-and-carcass-surveys", "feather-river", "CWT_2013.csv"))
write_csv(cwt_header_raw, here::here("data-raw", "qc-markdowns", "adult-holding-redd-and-carcass-surveys", "feather-river", "CWTHeader_2013.csv"))
```

## Raw Data Glimpse: {.tabset}

### Chop_raw
```{r}
Chops_raw <- read_csv(here::here("data-raw", "qc-markdowns", "adult-holding-redd-and-carcass-surveys", "feather-river", "Chops_2013.csv")) |> 
  rename(Header.ID = `Chop.Header.ID`) |> 
  select(-`Chop.ID`) |> 
  glimpse()
```

### ChopHeader_raw

```{r}
ChopHeader_raw <- read_csv(here::here("data-raw", "qc-markdowns", "adult-holding-redd-and-carcass-surveys", "feather-river", "ChopHeader_2013.csv")) |> 
  rename(Header.ID = `Chop.Header.ID`) |>
  glimpse()
```

### cwt_raw
```{r}
cwt_raw <- read_csv(here::here("data-raw", "qc-markdowns", "adult-holding-redd-and-carcass-surveys", "feather-river", "CWT_2013.csv")) |> 
  rename(Header.ID = CWT.Header.ID)

# column names appeared to be shifted one to the right when read in from the
# access database (i.e. fork length was orders of magnitude larger)
# so the following code renames columns based on assumed order and type of
# column values expected

colnames(cwt_raw) <- c("CWT.ID", "Header.ID", "River.Section", "Tag.ID", "Recapture.or.Chop", "Sex",
                       "Spawning.Condition", "Adipose.Fin.Clipped", "Samples.Collected",
                       "Fork.Length", "Head.Tag.Number", "Scales", "Otoliths", "Hallprint.Color", 
                       "Hallprint", "Comments", "Tag")

cwt_raw |> glimpse()

```

### cwt_header_raw

```{r}
cwt_header_raw <- read_csv(here::here("data-raw", "qc-markdowns", "adult-holding-redd-and-carcass-surveys", "feather-river", "CWTHeader_2013.csv")) |> 
  rename(Header.ID = `CWT.Header.ID` ) |> 
  glimpse()
```

## Data transformations: {.tabset}

### Counts

The `chop` table contains carcass counts by chop/tagged based on clips


```{r}
# Note: for 2011-2016 data, the Access relationships are as follows:
# CWT$HeaderID jins to CWTHeader$HeaderID, which joins to SampleWeeks$WeekNumber, which joins to ChopHeader$WeekNumber. ChopHeader$HeaderID joins to Chops$HeaderID.

#1. chop table (with dates and tag color)
chop_join <- full_join(ChopHeader_raw |> 
                                 select(Header.ID, Date),
                               Chops_raw,
                       by = "Header.ID") |> 
  clean_names() |> 
  rename(sect = "section",
         min = "minutes",
         count = "total_count") |> 
  mutate(sect = as.numeric(sect)) |> glimpse()
```

### Survey

The `chop_header` table contains survey metadata and covariates

```{r}
chop_header <- ChopHeader_raw |> 
  clean_names() |> glimpse()
```

### CWT
The `cwt` table contains coded wire tag information. 

```{r}
cwt <- full_join(cwt_raw |> clean_names(), cwt_header_raw |> clean_names(),
                 by = "header_id") |> 
  glimpse()
```

## Explore Numeric Variables: {.tabset}

### Chop Join Variable: `header_id`, `min`
```{r}
chop_join |> 
  select_if(is.numeric) |>
  colnames()
```


```{r}
summary(chop_join$header_id)
```

```{r}
summary(chop_join$min)
```

**NA and Unknown Values**
Provide a stat on NA or unknown values.

```{r}
round(sum(is.na(chop_join$id))/nrow(chop_join), 3) * 100
round(sum(is.na(chop_join$min))/nrow(chop_join), 3) * 100
```

* `r round(sum(is.na(chop_join$id))/nrow(chop_join), 3) * 100` % of values in the `id` column are NA.
* `r round(sum(is.na(chop_join$min))/nrow(chop_join), 3) * 100` % of values in the `min` column are NA.

### Chop Join Variable: `count`
```{r}
summary(chop_join$count)
```

* `r round(sum(is.na(chop_join$count))/nrow(chop_join), 3) * 100` % of values in the `count` column are NA.

**Plotting count over Period of Record**

```{r}
chop_join |>
  group_by(date) |>
  summarise(total_count = sum(count, na.rm = T)) |>
  ggplot(aes(x = date, y = total_count)) +
  geom_col() +
  theme_minimal()
```

### Chop Header Variable: `header_id`

```{r}
chop_header |> 
  select_if(is.numeric) |> 
  colnames()
```
```{r}
summary(chop_header$header_id)
```

### CWT Variable: `cwt_id`, `sect`, `fl`, `header_id`, `week_num`

```{r}
cwt |> 
  select_if(is.numeric) |> 
  colnames()
```
```{r}
summary(cwt$fork_length)
```
```{r}
summary(cwt$river_section)
```

* `r round(sum(is.na(cwt$fl))/nrow(cwt), 3) * 100` % of values in the `fl` column are NA.
* `r round(sum(is.na(cwt$river_section))/nrow(cwt), 3) * 100` % of values in the `sect` column are NA.

```{r}
#Create a cwt_count column
#Pivot table to expand sex column to female_cwt, male_cwt, and unknown_cwt 
cwt_count <- cwt |> 
  mutate(count = 1) |>
  mutate(sex = case_when(sex == "ND"|is.na(sex)|sex =="UK" ~ "U",
                         TRUE ~ sex)) |> 
  pivot_wider(names_from = sex, values_from = count, values_fill = 0) |> 
  # unnest() |> 
  rename("male_cwt" = M,
         "female_cwt" = F,
         "unknown_cwt" = U) |> glimpse()

total_cwt_summary <- cwt_count |> 
  mutate(male_cwt = ifelse(is.na(male_cwt), 0, male_cwt), # fill na
         female_cwt = ifelse(is.na(female_cwt), 0, female_cwt),
         unknown_cwt = ifelse(is.na(unknown_cwt), 0, unknown_cwt),
         total_cwt = unknown_cwt + male_cwt + female_cwt) |> 
  group_by(month(date)) |> 
  summarise(total_cwt = sum(total_cwt),
            male_cwt = sum(male_cwt),
            female_cwt = sum(female_cwt),
            unknown_cwt = sum(unknown_cwt))
```

```{r}
total_cwt_summary |> 
  pivot_longer(cols = c(male_cwt, female_cwt, unknown_cwt), names_to = "sex", values_to = "count") |> 
  mutate(proportions = (count / total_cwt)) |> 
  ggplot(aes(x = `month(date)`, y = proportions, fill = sex)) + 
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(name = "chops", 
                    labels = c("CWT Male", "CWT Female", "CWT Unknown")) +
  theme_minimal() + 
  labs(y = "Proportion", x = "Month") +
  scale_fill_manual(values = wes_palette("Moonrise2"))
```


**Plotting fork length of each sex**

```{r}
cwt |> 
  mutate(sex = case_when(sex == "ND"|is.na(sex)|sex =="UK" ~ "Unknown",
                         TRUE ~ sex))|> 
  filter(fork_length < 600) |> # TODO: outlier (data entry error?) = 750
  ggplot(aes(x = sex, y = fork_length)) + 
  geom_boxplot() + 
  theme_minimal() + 
  labs(y = "FL", x = "Sex")
```




## Explore Categorical variables: {.tabset}

### Chop Clean Data

Fix inconsistencies with spelling, capitalization, and dates

```{r}
chop_join |> 
  select_if(is.character) |>
  colnames()
```

### Chop Header Clean Data

```{r}
chop_header |> 
  select_if(is.character) |> 
  colnames()
```
```{r}
unique(chop_header$crew)
```
```{r}
unique(chop_header$weather)
```



```{r}
chop_header_cleaner <- chop_header |>
  mutate(date = as_date(date)) |>
  mutate_if(is.character, str_to_lower) |> 
  mutate(crew = str_replace_all(crew, " ", ","),
         crew = str_replace_all(crew, ",,", ","),
         weather = case_when(weather == "cld" ~ "cloudy",
                             weather %in% c("cld / rain", "cld/rain") ~ "rain",
                             weather %in% c("sun/cld", "sun / cld", "sun/ cld") ~ "sun,cloudy",
                             weather == "clr" ~ "sun",
                             TRUE ~ weather),
         weather = str_replace_all(weather, " ", "")) |> 
  select(-c(time)) |> glimpse()
```
```{r}
cwt |> 
  select_if(is.character) |> 
  colnames()
```
```{r}
unique(cwt$spawning_condition)
```

```{r}
unique(cwt$adipose_fin_clipped)
```

```{r}
unique(cwt$crew)
```

```{r}
unique(cwt$tag_color)
```

```{r}
#Dropping sectiongroup and morale
cwt_cleaner <- cwt |> 
  mutate_if(is.character, str_to_lower) |> 
  mutate(crew = str_replace_all(crew, " ", ","),
         crew = str_replace_all(crew, ",,", ","),
         sex = case_when(is.na(sex) ~ "unknown",
                         TRUE ~ sex),
         tag_color = case_when(str_detect(tag_color, "d=") ~ "decay",
                               str_detect(tag_color, "silver") ~ "silver",
                               tag_color == "blue tag" ~ "blue",
                               tag_color == "d in comment = decayed" ~ "decay",
                               TRUE ~ tag_color),
         recapture_or_chop = case_when(recapture_or_chop == "t" ~ "tagged",
                                       recapture_or_chop == "r" ~ "recapture",
                                       recapture_or_chop == "c" ~ "chop",
                                       recapture_or_chop == "t/c" ~ "recapture,chop",
                                       TRUE ~ recapture_or_chop),
         adipose_fin_clipped = case_when(adipose_fin_clipped == "uk" ~ "unknown",
                                         adipose_fin_clipped == "y" ~ "yes",
                                         adipose_fin_clipped == "n" ~ "no",
                                         TRUE ~ adipose_fin_clipped),
         hallprint_color = case_when(hallprint_color == "one oti" ~ NA_character_,
                                     TRUE ~ hallprint_color),
         spawning_condition = case_when(spawning_condition %in% c("uk", "u") ~ "unknown",
                                        TRUE ~ spawning_condition)) |> 
  select(-c(morale, section_group_1_10, section_group_11_15, 
            section_group_16_21, section_group_22_38, tag)) |> # tag column is all NAs
  glimpse()
```


## Data Dictionaries

# Count
```{r}
percent_na <- chop_cleaner |>
  summarise_all(list(name = ~sum(is.na(.))/length(.))) |>
  pivot_longer(cols = everything())


counts_data_dictionary <- tibble(variables = colnames(chop_cleaner),
                          description = c("Header ID",
                                          "Date of the survey",
                                          "Sect", 
                                          "Min", 
                                          "Count"),
                          percent_na = round(percent_na$value*100))

kable(counts_data_dictionary)
```
### Survey

```{r}

percent_na <- chop_header_cleaner |>
  summarise_all(list(name = ~sum(is.na(.))/length(.))) |>
  pivot_longer(cols = everything())
# 
chop_header_data_dictionary <- tibble(variables = colnames(chop_header_cleaner),
                          description = c("Date of survey",
                                          "Week of survey",
                                          "Weather",
                                          "Initials of crew members collecting",
                                          "Comments",
                                          "Header ID"),
                          percent_na = round(percent_na$value*100))
# 
kable(chop_header_data_dictionary)
```

### CWT
```{r}
percent_na <- cwt_cleaner |>
  summarise_all(list(name = ~sum(is.na(.))/length(.))) |>
  pivot_longer(cols = everything())

cwt_data_dictionary <- tibble(variables = colnames(cwt_cleaner),
                          description = c("CWT ID",
                                          "Header ID",
                                          "River section",
                                          "Tag ID number",
                                          "Tag recapture or chop",
                                          "Sex",
                                          "Spawning condition",
                                          "Adipose fin clipped",
                                          "Samples collected",
                                          "Fork length",
                                          "Head tag number",
                                          "Scales",
                                          "Otoliths",
                                          "Hallprint color",
                                          "Hallprint",
                                          "Comments",
                                          "Date",
                                          "Crew",
                                          "Week number",
                                          "Tag colour"),
                          percent_na = round(percent_na$value*100))

kable(cwt_data_dictionary)
```
## Save cleaned data back to google cloud (TBA)

```{r}
feather_carcass_chops_2013 <- chop_cleaner |> glimpse()
feather_carcass_cwt_2013 <- cwt_cleaner |> glimpse()
feather_carcass_chop_header_2013 <- chop_header_cleaner |> glimpse()
```
```{r, include=FALSE}
f <- function(input, output) write_csv(input, file = output)

gcs_upload(feather_carcass_chops_2013,
           object_function = f,
           type = "csv",
           name = "adult-holding-redd-and-carcass-surveys/feather-river/data/feather_carcass_chops_and_tags_2013.csv")
gcs_upload(feather_carcass_cwt_2013,
           object_function = f,
           type = "csv",
           name = "adult-holding-redd-and-carcass-surveys/feather-river/data/feather_carcass_cwt_2013.csv")
gcs_upload(feather_carcass_chop_header_2013,
           object_function = f,
           type = "csv",
           name = "adult-holding-redd-and-carcass-surveys/feather-river/data/feather_carcass_chop_header_2013.csv")
```
