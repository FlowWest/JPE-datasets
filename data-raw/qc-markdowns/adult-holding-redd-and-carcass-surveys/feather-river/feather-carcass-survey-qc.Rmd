---
title: "Feather Carcass QC "
author: "Inigo Peng"
date: '2022-08-18'
output: rmarkdown::github_document
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, fig.width=15, fig.height=10)

library(tidyverse)
library(lubridate)
library(googleCloudStorageR)
library(ggplot2)
library(scales)
library(readxl)
library(janitor)
library(hms) #?as_hms()
library(RODBC)
library(knitr)
library(wesanderson)
```

TODO
* fork length
* week number
* recov_id vs recover_id vs reov_tag_id
* tag_id vs disc_tag_applied
* ad_fin_clip_status vs adipose_fin_clip vs adipose_fin_clipped

# Feather River Carcass Data

## Description of Monitoring Data
The Feather River Carcass monitoring program has slightly differing methodology and data entry across the period of record (2000-2020). 

According to later sampling protocol (and meetings indicate this hasn't changed too much over the years), one of three processes occurs when a carcass is encountered: if the carcass is fresh and not tagged, it is tagged and returned to the river (this is a `tagged` carcass); if the carcass is not fresh and not tagged, it is chopped (`chopped`); finally, if the carcass is tagged and fresh, the carcass is recovered and re-released (`recovered`/`recaptured`) or recovered and chopped (`recovered, chopped` or `chopped`). 

Generally, the table layout/structure is similar across four periods: 
* 2000-2001: `RecovTag`, `ChopRecov`, `CWT`, `TagData`
* 2002-2009: `ChopChannel`, `ChopRecov`, `CWT`
* 2010-2016: `Chops`, `CWT` (`ChopRecov` only in 2010)
* 2017-2020: `Chops`, `ChopRecov`, `CWT`

Though the naming changes across these periods, each year generally has a table of individual carcass samples with biological sampling data like `adipose_fin_clip`, `sex`, and `fork_length`; a bulk chops table that contains bulk chop counts without individual sampling information; and sometimes a chop recovery table that contains recovered carcass data.

To standardize across these periods, we created a `source_table` variable to track the different tables and a `disposition` column to track whether the carcass was `chopped`, `tagged`, or `recovered`/`recaptured`. 

The goal is to use the data in a modified Cormack Jolly Seber model, which requires three tables as input:
* Individual carcasses and their recapture history
* Bulk chops by week
* Covariates (fork length, sex, etc.)

The CAMP database creates these tables automatically, but data contacts created their own version of these tables in Excel prior to 2017.


**Timeframe:** 2000 to 2020
  
**Video Season:** 
  
**Completeness of Record throughout timeframe:** 
Data is complete across years. Methodology and data storage differs.
  
**Sampling Location:** Various sampling locations on Feather River. Some river miles have a different protocol wherein carcasses are not individually sampled but are always chopped.
  
**Data Contact:** 
Casey Campos


## Access Cloud Data

```{r, eval=FALSE}
# Run Sys.setenv() to specify GCS_AUTH_FILE and GCS_DEFAULT_BUCKET before running 
# getwd() to see how to specify paths 
# Open object from google cloud storage
# Set your authentication using gcs_auth
gcs_auth(json_file = Sys.getenv("GCS_AUTH_FILE"))
# Set global bucket 
gcs_global_bucket(bucket = Sys.getenv("GCS_DEFAULT_BUCKET"))

# git data and save as xlsx
```


```{r}
read_from_cloud <- function(carcass_data_type, year){
  gcs_get_object(object_name = paste0("adult-holding-redd-and-carcass-surveys/feather-river/data/feather_carcass_",carcass_data_type, "_",year, ".csv"),
               bucket = gcs_get_global_bucket(),
               saveToDisk = paste0("data-raw/qc-markdowns/adult-holding-redd-and-carcass-surveys/feather-river/feather_carcass_",carcass_data_type,"_",year, ".csv"),
               overwrite = TRUE)
  data <- read.csv(paste0("data-raw/qc-markdowns/adult-holding-redd-and-carcass-surveys/feather-river/feather_carcass_",carcass_data_type, "_", year, ".csv"))  
}
```

## All Carcasses

## 2000
* rename `ht_num` to `head_tag`
* rename `egg_ret` to `spawn`
```{r, message = FALSE}
feather_carcass_2000 <- read_from_cloud("all_carcasses", 2000) |>  
  rename(head_tag = ht_num,
         spawn = egg_ret) |> 
  mutate(date = as.Date(date)) |> 
  glimpse() 
```

## 2001
* rename `ht_num` to `head_tag`
* rename `egg_ret` to `spawn`
```{r, message = FALSE}
feather_carcass_2001 <- read_from_cloud("all_carcasses", 2001) |> 
  mutate(date = as.Date(date)) |> 
  rename(head_tag = ht_num,
         spawn = egg_ret) |> 
  glimpse() 
```

## 2002
```{r, message = FALSE}
feather_carcass_2002 <- read_from_cloud("all_carcasses", 2002) |> 
  mutate(date = as.Date(date)) |> 
  glimpse() 
```

## 2003
```{r, message = FALSE}
feather_carcass_2003 <- read_from_cloud("all_carcasses", 2003)  |> 
  mutate(date = as.Date(date)) |> 
  glimpse() 
```

## 2004
* recast `head_tag` to integer
```{r, message = FALSE}
feather_carcass_2004 <- read_from_cloud("all_carcasses", 2004) |> 
  mutate(head_tag = as.integer(head_tag),
         date = as.Date(date)) |> 
  glimpse() 
```

## 2005
```{r, message = FALSE}
feather_carcass_2005 <- read_from_cloud("all_carcasses", 2005) |>
  mutate(date = as.Date(date)) |> 
  glimpse() 
```

## 2006
* recast `tag_col` to character
```{r, message = FALSE}
feather_carcass_2006 <- read_from_cloud("all_carcasses", 2006) |> 
  mutate(date = as.Date(date),
         tag_col = as.character(tag_col),
         recov_color = as.character(recov_color)) |> 
  glimpse() 
```

## 2007
* recast `tag_col` to character
```{r, message = FALSE}
feather_carcass_2007 <- read_from_cloud("all_carcasses", 2007) |> 
  mutate(date = as.Date(date),
         tag_col = as.character(tag_col),
         recov_color = as.character(recov_color)) |> 
  glimpse() 
```

## 2008
* recast `tag_col` to character
```{r, message = FALSE}
feather_carcass_2008 <- read_from_cloud("all_carcasses", 2008) |> 
  mutate(date = as.Date(date),
         tag_col = as.character(tag_col),
         recov_color = as.character(recov_color)) |> 
  glimpse() 
```

## 2009
* recast `tag_col` to character
```{r, message = FALSE}
feather_carcass_2009 <- read_from_cloud("all_carcasses", 2009) |> 
  mutate(date = as.Date(date),
         tag_col = as.character(tag_col),
         recov_color = as.character(recov_color)) |> 
  glimpse() 
```

## 2010
* recast `tag_col` to character
```{r, message = FALSE}
feather_carcass_2010 <- read_from_cloud("all_carcasses", 2010) |> 
  mutate(date = as.Date(date),
         tag_col = as.character(tag_col),
         recov_color = as.character(recov_color)) |> 
  glimpse() 
```

## 2011
```{r, message = FALSE}
feather_carcass_2011 <- read_from_cloud("all_carcasses", 2011) |> 
  mutate(date = as.Date(date)) |> 
  rename(tag_col = tag_color,
         recov_color = tag_recap_chop_color) |> 
  glimpse() 
```

## 2012
```{r, message = FALSE}
feather_carcass_2012 <- read_from_cloud("all_carcasses", 2012) |> 
  mutate(date = as.Date(date),
         hallprint = as.character(hallprint)) |> 
  rename(tag_col = tag_color) |> 
  glimpse() 
```

## 2013
* rename `head_tag_number` to `head_tag`
```{r, message = FALSE}
feather_carcass_2013 <- read_from_cloud("all_carcasses", 2013) |> 
  mutate(date = as.Date(date),
         hallprint = as.character(hallprint)) |> 
  rename(head_tag = head_tag_number,
         tag_col = tag_color) |> 
  glimpse() 
```

## 2014
* rename `head_tag_number` to `head_tag`

```{r, message = FALSE}
feather_carcass_2014 <- read_from_cloud("all_carcasses", 2014) |> 
  mutate(date = as.Date(date),
         hallprint = as.character(hallprint)) |> 
  rename(head_tag = head_tag_number,
         tag_col = tag_color) |> 
  glimpse() 
```

## 2015
* rename `head_tag_number` to `head_tag`

```{r, message = FALSE}
feather_carcass_2015 <- read_from_cloud("all_carcasses", 2015) |> 
  mutate(date = as.Date(date)) |> 
  rename(head_tag = head_tag_number,
         tag_col = tag_color) |> 
  glimpse() 
```

## 2016
* rename `head_tag_number` to `head_tag`

```{r, message = FALSE}
feather_carcass_2016 <- read_from_cloud("all_carcasses", 2016) |> 
  mutate(date = as.Date(date)) |> 
  rename(head_tag = head_tag_number,
         tag_col = tag_color) |> 
  glimpse() 
```

## 2017
```{r, message = FALSE}
feather_carcass_2017 <- read_from_cloud("all_carcasses", 2017) |>
  mutate(date = as.Date(date),
         adipose_fin_clipped = case_when(ad_fin_clip_status %in% c("unknown", "not recorded") ~ "NA", 
                                         ad_fin_clip_status == "yes" ~ "TRUE",
                                         ad_fin_clip_status == "no" ~ "FALSE",
                                         TRUE ~ ad_fin_clip_status),
         ad_fin_clip_status = as.logical(ad_fin_clip_status)) |>
  select(-adipose_fin_clipped) |>  
  glimpse() 
```

## 2018
```{r, message = FALSE}
feather_carcass_2018 <- read_from_cloud("all_carcasses", 2018) |> 
  mutate(date = as.Date(date),
         adipose_fin_clipped = case_when(ad_fin_clip_status %in% c("unknown", "not recorded") ~ "NA", 
                                         ad_fin_clip_status == "yes" ~ "TRUE",
                                         ad_fin_clip_status == "no" ~ "FALSE",
                                         TRUE ~ ad_fin_clip_status),
         ad_fin_clip_status = as.logical(ad_fin_clip_status)) |>
  select(-adipose_fin_clipped) |> 
  glimpse() 
```

## 2019
```{r, message = FALSE}
feather_carcass_2019 <- read_from_cloud("all_carcasses", 2019) |> 
  mutate(date = as.Date(date),
         adipose_fin_clipped = case_when(ad_fin_clip_status %in% c("unknown", "not recorded") ~ "NA", 
                                         ad_fin_clip_status == "yes" ~ "TRUE",
                                         ad_fin_clip_status == "no" ~ "FALSE",
                                         TRUE ~ ad_fin_clip_status),
         ad_fin_clip_status = as.logical(ad_fin_clip_status)) |>
  select(-adipose_fin_clipped) |>
  glimpse() 
```

## 2020
```{r, message = FALSE}
feather_carcass_2020 <- read_from_cloud("all_carcasses", 2020) |>
  mutate(date = as.Date(date),
         adipose_fin_clipped = case_when(ad_fin_clip_status %in% c("unknown", "not recorded") ~ "NA", 
                                         ad_fin_clip_status == "yes" ~ "TRUE",
                                         ad_fin_clip_status == "no" ~ "FALSE",
                                         TRUE ~ ad_fin_clip_status),
         ad_fin_clip_status = as.logical(ad_fin_clip_status)) |>
  select(-adipose_fin_clipped) |> 
  glimpse() 
```

## Combine all years
```{r}
feather_carcass_combined_raw <- 
  bind_rows(feather_carcass_2000,
            feather_carcass_2001,
            feather_carcass_2002,
            feather_carcass_2003,
            feather_carcass_2004,
            feather_carcass_2005,
            feather_carcass_2006,
            feather_carcass_2007,
            feather_carcass_2008,
            feather_carcass_2009,
            feather_carcass_2010,
            feather_carcass_2011,
            feather_carcass_2012,
            feather_carcass_2013,
            feather_carcass_2014,
            feather_carcass_2015,
            feather_carcass_2016,
            feather_carcass_2017,
            feather_carcass_2018,
            feather_carcass_2019,
            feather_carcass_2020) |> glimpse()
```
### Remove variables that are uninformative
* filter out `NA` dates
* create `year` column
* Carcasses in the `feather_carcass_combined` dataset are marked as `tagged`,
`recovered`, `chopped`, `chopped_recovered`/`recaptured, chopped`, `recaptured`/`recovered`, or `NA`. The differences in naming conventions come from different years and source tables.
* we standardize the `disposition` variable here

```{r}
feather_carcass_combined <- feather_carcass_combined_raw |> 
  select(-c(tag_env_id, rel_loc2, recorder, chop_env_id, number_spawned,
            cwt_id, tag1, tag2, tag_comp, flow, week_num, vis, weather,
            samp_type, samp_num, scale_sample, crew, comments, tag, chop_id,
            time, survey_meta_id, chops_id, survey_id, data_recorder,
            creation_time, editor, edit_time, section_id, boat, time_in,
            time_out, field_recorder, individual_id, cwt_cd)) |> 
  mutate(year = year(date),
         disposition = case_when(disposition == "recaptured, chopped" ~ "chopped_recovered",
                                 disposition == "recaptured" ~ "recovered",
                                 TRUE ~ disposition)) |> 
  filter(!is.na(date)) |> 
  glimpse()
```

### Summarization of variables by year
```{r} 
# number of observations
feather_carcass_combined |> 
  count(year) |> print(n=Inf)

# print nas
feather_carcass_combined |> 
  group_by(year) |> 
  summarize_all(funs(sum(is.na(.)) / length(.))) |> 
  print(n=Inf)

```
### Data Transformation

### Counts

The `feather_carcass_combined` table has carcass counts stored in the `count` variable.

## Explore Numeric Variables: {.tabset}

### Variable: `header_id`, `survey_id`, `chan_id`, `sec`, `min`, `unit`, `tag_num`,
`fl`

```{r}
feather_carcass_combined %>% 
  select_if(is.numeric) %>%
  colnames()
```

```{r}
numeric_cols <- feather_carcass_combined |>  
  select_if(is.numeric) |> 
  colnames()
sapply(feather_carcass_combined[,numeric_cols], summary)
```

### Carcass counts

```{r}
summary(feather_carcass_combined$count)
```


**NA and Unknown Values**
Provide a stat on NA or unknown values.

```{r}
round(sum(is.na(feather_carcass_combined$count))/nrow(feather_carcass_combined), 3) * 100

```
* `r round(sum(is.na(feather_carcass_combined$count))/nrow(feather_carcass_combined), 3) * 100` % of values in the `count` column are NA.

**Plotting chops over Period of Record**

```{r}
feather_carcass_combined |> 
  ggplot(aes(x = date, y = count)) +
  geom_col() +
  facet_wrap(~year, scales = "free") +
  scale_x_date(labels = date_format("%b"), date_breaks = "1 month")+
  theme_minimal() +
  theme(axis.text.x = element_text(size = 10,angle = 90, vjust = 0.5, hjust=0.1)) +
  theme(axis.text.y = element_text(size = 8))+
  labs(title = "Daily Carcass count from 2000 to 2020")
```

### Carcass variables: `adipose_fin_clip`, `sex`, `disposition`, `fork_length`

**Plotting total adult chops over period of record**

STOPPED HERE 2-21-2023 TODO

```{r}
total_adult_chops <- feather_carcass_combined |> 
  filter(disposition != "tagged") |>
  filter(!is.na(date)) |> 
  mutate(fake_date = paste0("1970-", month(date), "-", day(date)),
         fake_date = ymd(fake_date),
         year = year(date)) |> 
  select(fake_date, year, count, disposition, sex) |> 
  glimpse()

total_adult_chops_summary <- total_adult_chops |> 
  group_by(fake_date, year, sex) |> 
  summarise(total_adult_chops = sum(count, na.rm = T)) |> 
  glimpse()
```

```{r}
total_adult_chops_summary |> 
  ggplot(aes(x = fake_date, y = total_adult_chops, fill = sex)) + 
  geom_bar(stat = "identity", position = position_fill()) +
  labs(y = "Proportion", x = "Date") +
  theme_minimal() + 
  facet_wrap(~year) +
  scale_fill_manual(values = wes_palette("Moonrise2"))
```
This plot shows the sex proportion of adult chops (no `tagged` or `pre_carcass_survey` carcasses) for each day over the period of `r min(feather_carcass_combined$date, na.rm = T)` to `r max(feather_carcass_combined$date, na.rm = T)`. The plot is faceted by `year.` The data gaps that we see are a result of the data collection process in which the data was collected 2-4 days each week (with no specific period day of week) over the 4 month period.

**Plotting all carcasses over Period of Record**

```{r}
total_carcasses_summary <- feather_carcass_combined |> 
  filter(!is.na(date)) |> 
  mutate(fake_date = paste0("1970-", month(date), "-", day(date)),
         fake_date = ymd(fake_date),
         year = year(date)) |> 
  group_by(fake_date, year, disposition) |> 
  summarise(total_carcasses = sum(count, na.rm = T)) |> 
  glimpse()
```

```{r}
total_carcasses_summary |> 
  ggplot(aes(x = fake_date, y = total_carcasses, fill = disposition)) + 
  facet_wrap(~year) +
  geom_bar(stat = "identity", position = position_fill()) + 
  theme_minimal() + 
  labs(y = "Proportion", x = "Date") +
  scale_fill_manual(values = c(wes_palette("Moonrise2"), "#eeb7d0"))
```
This plot shows the proportion of carcasses by `disposition` by `date`, faceted by `year`. `chopped_recovered` dominates 2000 and 2001, likely due to naming conventions. Across all years, the proportion of `chopped` carcasses tends increase as the sampling seasons goes on, and the proportion of `chopped` carcasses tends to decrease. A small proportion of carcasses across all years are `recovered`. 

### Individual-level sampling information

**Plotting fork length of each sex**
```{r}
summary(feather_carcass_combined$fl_mm)
```

** Upload to google bucket - TODO
```{r, include = FALSE}
f <- function(input, output) write_csv(input, file = output)

# all carcasses
gcs_upload(feather_carcass_combined,
           object_function = f,
           type = "csv",
           name = "adult-holding-redd-and-carcass-surveys/feather-river/data/feather_carcass.csv",
           predefinedAcl = "bucketLevel")
```