---
title: "Yuba River Redd Survey QC"
author: "Maddee Rubenson"
date: "08/30/2022"
output: rmarkdown::github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, fig.width=15, fig.height=10)
library(tidyverse)
library(lubridate)
library(googleCloudStorageR)
library(ggplot2)
library(scales)
```

# [Watershed] [Data type long version]

## Description of Monitoring Data

**Timeframe:** 

**Video Season:** 

**Completeness of Record throughout timeframe:** 
* 2017 data is missing redd_id

**Sampling Location:**

**Data Contact:** 

Any additional info?

## Access Cloud Data

```{r, eval=FALSE}
Sys.setenv('GCS_AUTH_FILE' = 'config.json')
Sys.setenv('GCS_DEFAULT_BUCKET'= 'jpe-dev-bucket')


gcs_auth(json_file = Sys.getenv('GCS_AUTH_FILE'))
gcs_global_bucket(bucket = Sys.getenv('GCS_DEFAULT_BUCKET'))

# # git data and save as xlsx
# get_data <- function(path, name, save) {
#   gcs_get_object(object_name = paste0(path, name, ".xlsx"),
#                  bucket = gcs_get_global_bucket(),
#                  saveToDisk = paste0(save, name, ".xlsx"),
#                  overwrite = TRUE)
# }
# 
# # data pull ####
# yuba_redd_files <- tibble(path = "adult-holding-redd-and-carcass-surveys/yuba-river/data-raw/yuba_Redd data request Aug2022",
#                        name = c(""),
#                        save = "data/redd-carcass-holding/yuba_redd")
# 
# pmap(yuba_redd_files, get_data)

sheets <- readxl::excel_sheets('yuba_Redd data request Aug2022.xlsx')
raw_yuba_redd <- readxl::read_excel('yuba_Redd data request Aug2022.xlsx')
```

Read in data from google cloud, glimpse raw data and domain description sheet: 
```{r}
# read in data to clean 

sheets %>%
  purrr::map(function(sheet){ # iterate through each sheet name
  assign(x = paste0('redd_',sheet),
         value = readxl::read_xlsx(path = 'yuba_Redd data request Aug2022.xlsx', sheet = sheet) %>% janitor::clean_names(),
         envir = .GlobalEnv)
})
```

## Data transformations

```{r}

clean_redd_2008 <- redd_2008 %>% 
  mutate(across(where(is.character), str_remove_all, pattern = fixed(" "))) %>%
  mutate(latitude = as.numeric(latitude),
         longitude = as.numeric(longitude),
         latitude = latitude/10000,
         longitude = longitude/10000 * -1,
         year = 2008) %>%
  glimpse

clean_redd_2009 <- redd_2009 %>% 
  mutate(year = 2009) %>%
  glimpse

clean_redd_2010 <- redd_2010 %>% 
  select(-c(pl:x80_percent_depth, imposition_potential:percent_silt_clay_1, morphological_unit)) %>%
  rename(redd_id = redd_i_d) %>%
  mutate(year = 2010) %>%
  glimpse

clean_redd_2011 <- redd_2011 %>% 
  rename(redd_id = redd_i_d) %>%
  select(-c(imposition_potential, distance_to_cover, cover_type, 
           comments:tail_spill_width_2, nose_velocity_0_15m)) %>%
  mutate(year = 2011) %>%
  glimpse

clean_redd_2012 <- redd_2012 %>% 
  rename(redd_id = redd_i_d) %>%
  select(-c(crew_a_or, num_of_fis:tail_spi_2, adcp_veloc:comments2)) %>%
  mutate(year = 2012) %>%
  glimpse

clean_redd_2013 <- redd_2013 %>% 
  rename(redd_id = redd_i_d) %>%
  select(-c(imposition_potential:tail_spill_width_2)) %>%
  mutate(year = 2013) %>%
  glimpse

clean_redd_2014 <- redd_2014 %>% 
  rename(redd_id = redd_i_d) %>%
  select(-c(imposition_potential:tail_spill_width_2)) %>%
  glimpse

clean_redd_2015 <- redd_2015 %>% 
  rename(redd_id = redd_i_d,
         depth_m = depth) %>%
  select(names(clean_redd_2014)) %>%
  mutate(year = 2015) %>%
  glimpse

clean_redd_2016 <- redd_2016 %>% 
  rename(redd_id = redd_i_d,
         depth_m = depth) %>%
  select(names(clean_redd_2014)) %>%
  mutate(year = 2016) %>%
  glimpse

# skipping 2017

clean_redd_2018 <- redd_2018 %>% 
  rename(redd_id = redd_i_d,
         depth_m = depth) %>%
  select(names(clean_redd_2014)) %>%
  mutate(year = 2018) %>%
  glimpse

clean_redd_2019 <- redd_2019 %>% 
  rename(redd_id = redd_i_d,
         depth_m = depth) %>%
  select(names(clean_redd_2014)) %>%
  mutate(year = 2019) %>%
  glimpse

clean_redd_2020 <- redd_2020 %>% 
  rename(redd_id = redd_i_d,
         depth_m = depth) %>%
  select(names(clean_redd_2014)) %>%
  mutate(year = 2020) %>%
  glimpse

all_yuba_redd <- bind_rows(clean_redd_2008, 
                           clean_redd_2009,
                           clean_redd_2010, 
                           clean_redd_2011, 
                           clean_redd_2012, 
                           clean_redd_2013, 
                           clean_redd_2014, 
                           clean_redd_2015, 
                           clean_redd_2016, 
                           clean_redd_2018, 
                           clean_redd_2019, 
                           clean_redd_2020) %>%
  # take average velocity 
  mutate(mean_velocity = rowMeans(.[grep("^vel", names(.))], na.rm = TRUE)) %>% 
  select(-c(velocity_20_depth:velocity_80_percent_depth)) %>% 
  rename(velocity = mean_velocity) %>% 
  glimpse

```

```{r}
# Snake case, 
# Columns are appropriate types
# Remove redundant columns
```

## Explore Numeric Variables: {.tabset}

```{r}
# Filter clean data to show only numeric variables 
```

### Variable: `[name]`

**Plotting [Variable] over Period of Record**

```{r}
# Make whatever plot is appropriate 
# maybe 2+ plots are appropriate
```

**Numeric Summary of [Variable] over Period of Record**

```{r}
# Table with summary statistics
```

**NA and Unknown Values**

Provide a stat on NA or unknown values

## Explore Categorical variables: {.tabset}

General notes: If there is an opportunity to turn yes no into boolean do so, but not if you loose value 

```{r}
# Filter clean data to show only categorical variables
```


### Variable: `[name]`
```{r}
#table() 
```

Fix inconsistencies with spelling, capitalization, and abbreviations. 

```{r}
# Fix any inconsistencies with categorical variables
```

**Create lookup rda for [variable] encoding:** 
```{r}
# Create named lookup vector
# Name rda [watershed]_[data type]_[variable_name].rda
# save rda to data/ 
```

**NA and Unknown Values**

Provide a stat on NA or unknown values

## Summary of identified issues

* List things that are funcky/bothering us but that we don't feel like should be changed without more investigation

## Save cleaned data back to google cloud 

```{r}
# Write to google cloud 
# Name file [watershed]_[data type].csv
```
