---
title: "Mill Creek Adult Upstream Passage Estimate QC"
author: "Inigo Peng"
date: "10/19/2021"
output: rmarkdown::github_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
library(tidyverse)
library(lubridate)
library(googleCloudStorageR)
library(ggplot2)
library(scales)
library (RColorBrewer)
```

# Mill Creek Adult Upstream Passage Estimate Data 2012 to 2023

**Description of Monitoring Data**

Adult spring run daily passage estimate is based on data recorded at Ward Dam via video monitoring.

**Timeframe:** 

2012 to 2023

**Completeness of Record throughout timeframe:**

* Few missing values for passage_estimate
* 10 - 15 % missing values for physical variables

**Sampling Location:** 

* Ward Dam   

**Data Contact:** [Matt Johnson](mailto:Matt.Johnson@wildlife.ca.gov)

## Access Cloud Data

```{r, eval=FALSE}
# Run Sys.setenv() to specify GCS_AUTH_FILE and GCS_DEFAULT_BUCKET before running
# Open object from google cloud storage
# Set your authentication using gcs_auth
gcs_auth(json_file = Sys.getenv("GCS_AUTH_FILE"))
# Set global bucket 
gcs_global_bucket(bucket = Sys.getenv("GCS_DEFAULT_BUCKET"))
gcs_list_objects()
# git data and save as xlsx
gcs_get_object(object_name = "adult-upstream-passage-monitoring/mill-creek/data-raw/Mill Creek SRCS Daily Video Passage Estimates 2012-2020.xlsx",
               bucket = gcs_get_global_bucket(),
               saveToDisk = "data-raw/qc-markdowns/adult-upstream-passage-monitoring/mill-creek/mill_creek_passage_estimate_raw.xlsx")

# 2020-2021 passage data
gcs_get_object(object_name = "adult-upstream-passage-monitoring/mill-creek/data-raw/Copy of MCVS 2021-22 spring FINAL 8-17-22.xlsx",
               bucket = gcs_get_global_bucket(),
               saveToDisk = "data-raw/qc-markdowns/adult-upstream-passage-monitoring/mill-creek/mill_creek_passage_counts_2021.xlsx",
               overwrite = TRUE)
# 2022-2023 passage data
gcs_get_object(object_name = "adult-upstream-passage-monitoring/mill-creek/data-raw/MCVS 2022-23 spring 8-26-23.xlsx",
               bucket = gcs_get_global_bucket(),
               saveToDisk = "data-raw/qc-markdowns/adult-upstream-passage-monitoring/mill-creek/mill_creek_passage_counts_2022.xlsx",
               overwrite = TRUE)

```

Data for each year is in a separate sheet
```{r, message=FALSE, warning=FALSE}
sheets <- readxl::excel_sheets('mill_creek_passage_estimate_raw.xlsx')
list_all <- lapply(sheets, function(x) readxl::read_excel(path = "mill_creek_passage_estimate_raw.xlsx", sheet = x, col_types = c("text", "numeric", "numeric", "numeric", "text")))
```

```{r, message = FALSE, warning = FALSE}
# read in 2020-2021
mill_counts_2021_2022_raw <- readxl::read_xlsx("data-raw/qc-markdowns/adult-upstream-passage-monitoring/mill-creek/mill_creek_passage_counts_2021.xlsx", 
                                         sheet = "MILL-21-22", 
                                         skip = 5)

mill_counts_2022_2023_raw <- readxl::read_xlsx("data-raw/qc-markdowns/adult-upstream-passage-monitoring/mill-creek/mill_creek_passage_counts_2022.xlsx", 
                                         sheet = "MILL-22-23", 
                                         skip = 5)
```
Bind the sheets into one file

```{r, message=FALSE, warning=FALSE}
raw_data <- dplyr::bind_rows(list_all)  |> 
  glimpse()
```

## Data Transformations

### Original data file (2012-2020)

```{r}
all_mill_data <- raw_data  |> 
  set_names(tolower(colnames(raw_data)))  |> 
  select(-"...5")  |> #comments describe dates
  rename("passage_estimate" =  'adult spring-run passing ward dam',
         "flow" = "avg daily flow below ward dam",
         "temperature"= "avg daily h2o temp below ward dam")  |> 
  filter(date != "Totals:", date != "Total:")  |>
  mutate(date = case_when(
    str_length(date) == 5 ~ as.Date(as.numeric(date), origin="1899-12-30"),
    str_detect(date, '[/]') ~ as.Date(date, "%m/%d/%Y"))
    # TRUE ~ as.Date(date))
  )  |> 
  glimpse()
```

### New data files (2021-2023)

```{r}
mill_counts_2021_2023 <- bind_rows(mill_counts_2021_2022_raw |> 
                                     mutate(`UP Salmon` = as.numeric(`UP Salmon`)), mill_counts_2022_2023_raw) |> 
  mutate(time = format(`Start Time`, "%H:%M:%S")) |> 
  select(date = Date, time, salmon_up = `UP Salmon`, salmon_down = `DN Salmon`, jacks_up = `UP Jacks less 24"`, jacks_down = `DN Jacks less 24"`, view_adjust = `Viewing Adjust`) |> 
  pivot_longer(salmon_up:jacks_down,
               names_to = "direction", 
               values_to = "count") |> 
  mutate(jack = ifelse(str_detect(direction, "jack"), TRUE, FALSE),
         direction = ifelse(str_detect(direction, "up"), "up", "down"),
         count = ifelse(is.na(count), 0, count),
         view_adjust = case_when(view_adjust == 1 ~ "turbid",
                                 view_adjust == 2 ~ "weir down",
                                 view_adjust == 3 ~ "equipment fail",
                                 view_adjust == 4 ~ "DIDSON/Aris",
                                 TRUE ~ as.character(view_adjust))) |> 
  glimpse()
```

### Bind all years together
```{r}
all_mill_data <- bind_rows(cleaner_data, 
                           mill_counts_2021_2023 |> 
                             rename(passage_estimate = count)) |> 
  glimpse()
```
## Data Dictionary

The following table describes the variables included in this dataset and the percent that do not include data. 

```{r data_dictionary}
percent_na <- all_mill_data  |>
  summarise_all(list(name = ~sum(is.na(.))/length(.)))  |>
  pivot_longer(cols = everything())
  
data_dictionary <- tibble(variables = colnames(all_mill_data),
                          description = c("Date of sampling",
                                          "Passage estimate or counts of Spring Run Chinook",
                                          "Flow in CFS",
                                          "Temperature (F) we convert to C", "Time of sampling", "Reason camera needed to be adjusted", "Direction of passage", "Whether or not the fish was less than 24 inches (jack size)"),
                          
                          percent_na = round(percent_na$value*100)
                          
)
knitr::kable(data_dictionary)
```


## Explore `date`

Check for outlier and NA values

```{r}
summary(all_mill_data$date)
```

**NA and Unknown Values**  

*  `r round(sum(is.na(all_mill_data$date))/nrow(all_mill_data), 3)*100` % of values in the `date` column are NA.

## Explore Numerical Values

### Variable:`passage_estimate` 
```{r}
all_mill_data  |>
  filter(date != is.na(date))  |>
  mutate(year = as.factor(year(date)))  |> 
  # glimpse()
  ggplot(aes(x=date, y = passage_estimate))+
  geom_line()+
  facet_wrap(~year, scales = "free")+
  theme_minimal()+
  labs(title = "Daily Passage Estimate From 2012 - 2023")
```


```{r}
all_mill_data  |> 
  filter(date != is.na(date))  |>
  mutate(year = as.factor(year(date)))  |>
  # glimpse()
  group_by(year)  |> 
  summarise(total = sum(passage_estimate, na.rm  = TRUE))  |>
  # glimpse()
  ggplot(aes(x = year, y = total, group = 1))+
  geom_line()+
  geom_point(aes(x=year, y = total))+
  theme_minimal()+
  labs(title = "Total Annual Passage Estimate from 2012 - 2023",
       y = "Total passage_estimate")
```

**Numeric Summary of passage_estimate From 2012 to 2020**
```{r}
summary(all_mill_data$passage_estimate)
```
Note: there is a negative estimate in one of the days - need to remove that

**NA and Unknown Values**  

*  `r round(sum(is.na(all_mill_data$passage_estimate))/nrow(all_mill_data), 3)*100` % of values in the `passage_estimate` column are NA.

### Variable:`flow`

Flow in cfs

```{r fig.height=8, fig.width=8}
all_mill_data  |> 
  filter(date != is.na(date))  |>
  group_by(date)  |>
  mutate(avg_flow = mean(flow, na.rm = T))  |>
  ungroup()  |> 
  mutate(year = as.factor(year(date)),
         fake_year = 1900,
         fake_date = as.Date(paste0(fake_year,"-", month(date), "-", day(date))))  |> 
  ggplot(aes(x = fake_date, y = avg_flow, color = year)) + 
  scale_color_brewer(palette = "Dark2")+
  geom_point(alpha = .25) + 
  scale_x_date(labels = date_format("%b"), date_breaks = "1 month") + 
  theme_minimal() + 
  theme(text = element_text(size = 15),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
  labs(title = "Daily Water Flow (colored by year)",
       y = "Average Daily Flow", 
       x = "Date")  
```
```{r fig.height=8, fig.width=8}
all_mill_data  |> 
  mutate(year = as.factor(year(date)))  |> 
  ggplot(aes(x=flow, fill = year))+
  scale_fill_brewer(palette = "Dark2")+
  geom_histogram()+
  theme_minimal()+
  labs(title = "Distribution of Flow")
```

**Numeric Summary of flow From 2012 to 2020**
```{r}
summary(all_mill_data$flow)
```

**NA and Unknown Values**  

*  `r round(sum(is.na(all_mill_data$flow))/nrow(all_mill_data), 3)*100` % of values in the `flow` column are NA.

### Variable:`temperature`

Temperature in F, convert to C below 

```{r fig.height=8, fig.width=8}
all_mill_data  |> 
  filter(date != is.na(date))  |>
  group_by(date)  |>
  mutate(avg_temp = mean(temperature, na.rm = T))  |>
  ungroup()  |> 
  mutate(year = as.factor(year(date)),
         fake_year = 1900,
         fake_date = as.Date(paste0(fake_year,"-", month(date), "-", day(date))))  |> 
  ggplot(aes(x = fake_date, y = avg_temp, color = year)) + 
  scale_color_brewer(palette = "Dark2")+
  geom_point(alpha = .25) + 
  scale_x_date(labels = date_format("%b"), date_breaks = "1 month") + 
  theme_minimal() + 
  theme(text = element_text(size = 15),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
  labs(title = "Daily Water Temperature (colored by year)",
       y = "Average Daily Temperature", 
       x = "Date")  
```

```{r fig.height=8, fig.width=8}
all_mill_data  |> 
  filter(date != is.na(date))  |>
  mutate(year = as.factor(year(date)))  |> 
  ggplot(aes(x=temperature, fill = year))+
  scale_fill_brewer(palette = "Dark2")+
  geom_histogram(bins = 10)+
  theme_minimal()+
  labs(title = "Distribution of Temperature")
```

**Numeric Summary of temperature From 2012 to 2020**
```{r}
summary(all_mill_data$temperature)
```

**NA and Unknown Values**  

*  `r round(sum(is.na(all_mill_data$temperature))/nrow(all_mill_data), 3)*100` % of values in the `temperature` column are NA.

### Notes and Issues

* passage_estimate drops significantly in 2023
* We are treating these as counts (in standard format, rename passage estimates to counts) - are these passage estimates for the earlier data?
* Temperature in F, convert to C below 

```{r}
all_mill_data <- all_mill_data  |>
  mutate(temperature = (temperature - 32) * (5/9))
```


### Add cleaned data back onto google cloud

```{r}
mill_upstream_estimate <- all_mill_data  |> glimpse()
```

```{r, evaluate = FALSE}
f <- function(input, output) write_csv(input, file = output)
gcs_upload(mill_upstream_estimate,
           object_function = f,
           type = "csv",
           name = "adult-upstream-passage-monitoring/mill-creek/data/mill_upstream_passage_estimate.csv")
