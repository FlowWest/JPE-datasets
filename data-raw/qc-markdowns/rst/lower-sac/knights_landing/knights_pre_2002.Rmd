---
title: "Knights Landing Pre 2002"
output: html_document
date: "2022-11-07"
---

```{r, include = F}
library(tidyverse)
library(foreign)
library(googleCloudStorageR)
library(readxl)

root.dir <- rprojroot::find_rstudio_root_file()
knitr::opts_knit$set(root.dir)
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = F}
gcs_auth(json_file = Sys.getenv("GCS_AUTH_FILE"))
gcs_global_bucket(bucket = Sys.getenv("GCS_DEFAULT_BUCKET"))
```

# 1996

TODO - Need to figure out what codes for lifestage, race, traptype

```{r, include = F}
gcs_get_object(object_name = "rst/lower-sac-river/data-raw/knights-landing/KLSUM96.DBF",
                 bucket = gcs_get_global_bucket(),
                 saveToDisk = "data-raw/qc-markdowns/rst/lower-sac/knights_landing/sum96.DBF",
                 overwrite = TRUE)

gcs_get_object(object_name = "rst/lower-sac-river/data-raw/knights-landing/MARK96.DBF",
                 bucket = gcs_get_global_bucket(),
                 saveToDisk = "data-raw/qc-markdowns/rst/lower-sac/knights_landing/mark96.DBF",
                 overwrite = TRUE)

gcs_get_object(object_name = "rst/lower-sac-river/data-raw/knights-landing/RSTFL96.DBF",
                 bucket = gcs_get_global_bucket(),
                 saveToDisk = "data-raw/qc-markdowns/rst/lower-sac/knights_landing/rst96.DBF",
                 overwrite = TRUE)
```

- sum table: date, trapid, time, effrt_time, rpm_averag, pt_vel
- mark table: date, trapid, traptype, dye_type, n0_dyed, recap_type n0_recap
- rst table: date, time, trapid, traptype, fl, ww, lifestage, rage, clip

```{r}
path <- "data-raw/qc-markdowns/rst/lower-sac/knights_landing/"

sum96 <- read.dbf(paste0(path, "sum96.DBF")) %>% glimpse()
mark96 <- read.dbf(paste0(path, "mark96.DBF")) %>% glimpse()
rst96 <- read.dbf(paste0(path, "rst96.DBF")) %>% glimpse()
#1996: adfl, sum, mark

rst96 %>% group_by(LIFESTAGE) %>% tally()
rst96 %>% group_by(RACE) %>% tally()
```

```{r}
trap96_clean <- sum96 %>% 
  janitor::clean_names() %>% 
  select(date, trapid, time, effrt_time, rpm_averag, pt_vel) %>% 
  rename(effort = effrt_time,
         avg_rpm = rpm_averag,
         velocity = pt_vel)

efficiency96_clean <- mark96 %>% 
  janitor::clean_names() %>% 
  select(date, n0_dyed, no_recap) %>% 
  group_by(date) %>% 
  summarise(number_marked = sum(n0_dyed, na.rm = T),
            number_recaptured = sum(no_recap, na.rm = T))

rst96_clean <- rst96 %>% 
  janitor::clean_names() %>% 
  select(date, time, trapid, fl, ww, lifestage, race, clip)
```

# 1997

```{r, include = F}
gcs_get_object(object_name = "rst/lower-sac-river/data-raw/knights-landing/97KLSUMT.DBF",
                 bucket = gcs_get_global_bucket(),
                 saveToDisk = "data-raw/qc-markdowns/rst/lower-sac/knights_landing/sum97.DBF",
                 overwrite = TRUE)

gcs_get_object(object_name = "rst/lower-sac-river/data-raw/knights-landing/KLFL97T.DBF",
                 bucket = gcs_get_global_bucket(),
                 saveToDisk = "data-raw/qc-markdowns/rst/lower-sac/knights_landing/rst97.DBF",
                 overwrite = TRUE)
```

```{r}
sum97 <- read.dbf(paste0(path, "sum97.DBF")) %>% glimpse()
rst97 <- read.dbf(paste0(path, "rst97.DBF")) %>% glimpse()

```

```{r}
trap97_clean <- sum97 %>% 
  janitor::clean_names() %>% 
  select(date, trapid, time, effrt_time, rpm_averag, pt_vel) %>% 
  rename(effort = effrt_time,
         avg_rpm = rpm_averag,
         velocity = pt_vel)

rst97_clean <- rst97 %>% 
  janitor::clean_names() %>% 
  select(date, time, trapid, fl, ww, lifestage, race, mark)
```

# 1998

```{r, include = F}
gcs_get_object(object_name = "rst/lower-sac-river/data-raw/knights-landing/KLSUM98.DBF",
                 bucket = gcs_get_global_bucket(),
                 saveToDisk = "data-raw/qc-markdowns/rst/lower-sac/knights_landing/sum98.DBF",
                 overwrite = TRUE)

gcs_get_object(object_name = "rst/lower-sac-river/data-raw/knights-landing/KLFL98.DBF",
                 bucket = gcs_get_global_bucket(),
                 saveToDisk = "data-raw/qc-markdowns/rst/lower-sac/knights_landing/rst98.DBF",
                 overwrite = TRUE)
```

```{r}
sum98 <- read.dbf(paste0(path, "sum98.DBF")) %>% glimpse()
rst98 <- read.dbf(paste0(path, "rst98.DBF")) %>% glimpse()

```

```{r}
trap98_clean <- sum98 %>% 
  janitor::clean_names() %>% 
  select(date, trapid, time, effrt_time, rpm_averag, pt_vel) %>% 
  rename(effort = effrt_time,
         avg_rpm = rpm_averag,
         velocity = pt_vel)

rst98_clean <- rst98 %>% 
  janitor::clean_names() %>% 
  select(date, time, trapid, fl, ww, lifestage, race, mark, mort)
```

# 1999

```{r, include = F}
gcs_get_object(object_name = "rst/lower-sac-river/data-raw/knights-landing/KLSUM99.DBF",
                 bucket = gcs_get_global_bucket(),
                 saveToDisk = "data-raw/qc-markdowns/rst/lower-sac/knights_landing/sum99.DBF",
                 overwrite = TRUE)

gcs_get_object(object_name = "rst/lower-sac-river/data-raw/knights-landing/KLFL99.DBF",
                 bucket = gcs_get_global_bucket(),
                 saveToDisk = "data-raw/qc-markdowns/rst/lower-sac/knights_landing/rst99.DBF",
                 overwrite = TRUE)

gcs_get_object(object_name = "rst/lower-sac-river/data-raw/knights-landing/STAIN99.DBF",
                 bucket = gcs_get_global_bucket(),
                 saveToDisk = "data-raw/qc-markdowns/rst/lower-sac/knights_landing/stain99.DBF",
                 overwrite = TRUE)
```

```{r}
sum99 <- read.dbf(paste0(path, "sum99.DBF")) %>% glimpse()
rst99 <- read.dbf(paste0(path, "rst99.DBF")) %>% glimpse()
stain99 <- read.dbf(paste0(path, "stain99.DBF")) %>% glimpse()
```

```{r}
trap99_clean <- sum99 %>% 
  janitor::clean_names() %>% 
  select(date, trapid, time, effrt_time, rpm_averag, pt_vel) %>% 
  rename(effort = effrt_time,
         avg_rpm = rpm_averag,
         velocity = pt_vel)

rst99_clean <- rst99 %>% 
  janitor::clean_names() %>% 
  select(date, time, trapid, fl, ww, lifestage, race, mark, mort)

mark99_clean <- stain99 %>% 
  janitor::clean_names() %>% 
  select(date_relea, time_relea, cs_release) %>% 
  filter(!is.na(date_relea)) %>% 
  rename(date_released = date_relea,
         time_released = time_relea,
         number_released = cs_release)
```


# 2000

```{r, include = F}
gcs_get_object(object_name = "rst/lower-sac-river/data-raw/knights-landing/SUM00.DBF",
                 bucket = gcs_get_global_bucket(),
                 saveToDisk = "data-raw/qc-markdowns/rst/lower-sac/knights_landing/sum00.DBF",
                 overwrite = TRUE)

gcs_get_object(object_name = "rst/lower-sac-river/data-raw/knights-landing/CSFL00.DBF",
                 bucket = gcs_get_global_bucket(),
                 saveToDisk = "data-raw/qc-markdowns/rst/lower-sac/knights_landing/rst00.DBF",
                 overwrite = TRUE)

gcs_get_object(object_name = "rst/lower-sac-river/data-raw/knights-landing/csstaind00.dbf",
                 bucket = gcs_get_global_bucket(),
                 saveToDisk = "data-raw/qc-markdowns/rst/lower-sac/knights_landing/stain00.DBF",
                 overwrite = TRUE)

gcs_get_object(object_name = "rst/lower-sac-river/data-raw/knights-landing/EFFORT00.DBF",
                 bucket = gcs_get_global_bucket(),
                 saveToDisk = "data-raw/qc-markdowns/rst/lower-sac/knights_landing/effort00.DBF",
                 overwrite = TRUE)

gcs_get_object(object_name = "rst/lower-sac-river/data-raw/knights-landing/CSBISBRN00.DBF",
                 bucket = gcs_get_global_bucket(),
                 saveToDisk = "data-raw/qc-markdowns/rst/lower-sac/knights_landing/bisbrn00.DBF",
                 overwrite = TRUE)
```

```{r}
sum00 <- read.dbf(paste0(path, "sum00.DBF")) %>% glimpse()
rst00 <- read.dbf(paste0(path, "rst00.DBF")) %>% glimpse()
stain00 <- read.dbf(paste0(path, "stain00.DBF")) %>% glimpse()
bisbrn00 <- read.dbf(paste0(path, "bisbrn00.DBF")) %>% glimpse()
# decided we don't need this because info is in the sum table
effort00 <- read.dbf(paste0(path, "effort00.DBF")) %>% glimpse() 
```

```{r}
trap00_clean <- sum00 %>% 
  janitor::clean_names() %>% 
  select(date, trapid, time, effrt_time, rpm_averag, pt_vel) %>% 
  rename(effort = effrt_time,
         avg_rpm = rpm_averag,
         velocity = pt_vel)

rst00_clean <- rst00 %>% 
  janitor::clean_names() %>% 
  select(date, time, trapid, fl, ww, lifestage, race, mark, mort, id_num)

mark00_clean <- stain00 %>% 
  janitor::clean_names() %>% 
  select(date, no_cs_rel) %>% 
  filter(!is.na(date)) %>% 
  rename(date_released = date,
         number_released = no_cs_rel)

recap00_clean <- bisbrn00 %>% 
  janitor::clean_names() %>% 
  select(date, time, trapid, fl, ww, lifestage, race)
```

# 2001

```{r, include = F}
gcs_get_object(object_name = "rst/lower-sac-river/data-raw/knights-landing/KL01SUM.mdb",
                 bucket = gcs_get_global_bucket(),
                 saveToDisk = "data-raw/qc-markdowns/rst/lower-sac/knights_landing/sum01.mdb",
                 overwrite = TRUE)

gcs_get_object(object_name = "rst/lower-sac-river/data-raw/knights-landing/KL01CSFL.DBF",
                 bucket = gcs_get_global_bucket(),
                 saveToDisk = "data-raw/qc-markdowns/rst/lower-sac/knights_landing/rst01.DBF",
                 overwrite = TRUE)

gcs_get_object(object_name = "rst/lower-sac-river/data-raw/knights-landing/2001_RECAP.XLS",
                 bucket = gcs_get_global_bucket(),
                 saveToDisk = "data-raw/qc-markdowns/rst/lower-sac/knights_landing/efficiency01.xls",
                 overwrite = TRUE)
```

```{r}
operating_system <- ifelse(grepl("Mac", Sys.info()['nodename']) | grepl("MBP", Sys.info()['nodename']), "mac", "pc")

if(operating_system == "pc") {
  library(RODBC)
  sum01 <- sqlFetch(paste0(path, "sum01.mdb"), "KL01SUM1")
  } else{
    library(Hmisc)
    sum01 <- mdb.get(paste0(path, "sum01.mdb"), tables = "KL01SUM1") %>% glimpse()
  }

rst01 <- read.dbf(paste0(path, "rst01.DBF")) %>% glimpse()
efficiency01 <- read_excel(paste0(path, "efficiency01.xls"), sheet = 2) %>% glimpse()

rst01 %>% group_by(RACE) %>% tally()
```

```{r}
trap01_clean <- sum01 %>% 
  janitor::clean_names() %>% 
  select(date, trap, efft) %>% 
  rename(trapid = trap,
         effort = efft)

rst01_clean <- rst01 %>% 
  janitor::clean_names() %>% 
  select(date, trapid, fl, ww, stage, race, mort, id) %>% 
  rename(lifestage = stage,
         id_num = id)

efficiency01_clean <- efficiency01 %>% 
  janitor::clean_names() %>% 
  select(week, number_marked, number_recovered) %>% 
  filter(week != "Total") %>% 
  mutate(year = 2001) %>% 
  rename(number_recaptured = number_recovered)
```

# Combine 1996-2001

trap: date, time, trapid, effort, avg_rpm, velocity
rst: date, trapid, fl, ww, lifestage, race, mort, clip, mark, id_num
efficiency: date, week, year, number_marked, number_recaptured
marked: date_released, time_released, number_released
recaptured: date, time, trapid, fl, ww, lifestage, race