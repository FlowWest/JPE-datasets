---
title: "Tisdale CAMP Data Pull"
output: html_document
date: "2022-09-02"
---

This document queries the CAMP database provided by Drew Honeycutt (09/01/2022) to extract
RST catch data for Tisdale trap. Previous files QC'd Excel files provided by
Drew Honeycutt. This script updates the data originally provided.

If this file doesn't run, make sure operating system is being set correctly. 
Depending on the operating system this script will run either the query_tisdale_camp 
'4pc' or '4mac'

*Important to filter releaseID == 0 or releasedID == 255 to exclude recaptures*

```{r}
library(tidyverse)
library(knitr)
library(lubridate)
library(googleCloudStorageR)
root.dir <- rprojroot::find_rstudio_root_file()
knitr::opts_knit$set(root.dir)
```

```{r}
gcs_auth(json_file = Sys.getenv("GCS_AUTH_FILE"))
gcs_global_bucket(bucket = Sys.getenv("GCS_DEFAULT_BUCKET"))
```

# Pull in Access db from Google Cloud

```{r}
gcs_get_object(object_name = "rst/CAMP/tisdale/tisdale_CAMP.mdb",
               bucket = gcs_get_global_bucket(),
               saveToDisk = here::here("data-raw", "qc-markdowns", "rst", "lower-sac", "tisdale", "CAMP.mdb"),
               overwrite = TRUE)
```

# Query data tables

```{r}
# runs the mac or pc version of the query tables file depending on operating system
operating_system <- ifelse(grepl("Mac", Sys.info()['nodename']), "mac", "pc")

if(operating_system == "pc") {
  source(here::here("data-raw", "qc-markdowns", "rst", "lower-sac", "tisdale", "query_tisdale_camp_4pc.R"))
  } else{
    source(here::here("data-raw", "qc-markdowns", "rst", "lower-sac", "tisdale", "query_tisdale_camp_4mac.R"))
  }
```

# Site

Joins site and subsite table

```{r}
site_subsite <- full_join(site_lu, subsite_lu)
```

# Catch (not including recaptures)

```{r}
detach(package:Hmisc)
# select relevant column
selected_trap_visit <- trap_visit %>%
  select(trapVisitID, visitTime, visitTime2, visitTypeID) %>%
  left_join(visit_type_lu, by = c("visitTypeID" = "visitTypeID")) %>% 
  select(-visitTypeID)

selected_mark_existing <- mark %>% 
  select(catchRawID, markTypeID, markColorID, markPositionID) %>% 
  left_join(mark_type_lu, by = c("markTypeID" = "markTypeID")) %>% 
  left_join(color_lu, by = c("markColorID" = "colorID")) %>% 
  left_join(body_part_lu, by = c("markPositionID" = "bodyPartID")) %>% 
  select(-c(markTypeID, markColorID, markPositionID))

# pull in both atcapturerun and finalrun to make sure all information is captured
# and finalrun is not mostly NA
selected_catch <- catch_raw %>% 
  select(catchRawID, taxonID, atCaptureRunID, atCaptureRunMethodID, finalRunID, finalRunMethodID, fishOriginID, lifeStageID, forkLength, weight, n, trapVisitID, releaseID, mortID) %>% 
  left_join(taxon_lu, by = c("taxonID" = "taxonID")) %>%
  # filter(commonName == "Chinook salmon") %>% 
  left_join(run_lu, by = c("finalRunID" = "runID")) %>%
  rename(final_run = run) %>% 
  left_join(run_lu, by = c("atCaptureRunID" = "runID")) %>%
  left_join(run_method_lu, by = c("finalRunMethodID" = "runMethodID")) %>%
  rename(final_run_method = runMethod) %>% 
  left_join(run_method_lu, by = c("atCaptureRunMethodID" = "runMethodID")) %>%
  left_join(lifestage_lu %>% 
              select(-lifeStageCAMPID), by = c("lifeStageID" = "lifeStageID")) %>%
  left_join(origin_lu, by = c("fishOriginID" = "fishOriginID")) %>%
  left_join(no_yes_lu, by = c("mortID" = "noYesID")) %>% 
  rename(dead = noYes) %>% 
  select(-lifeStageID, -finalRunMethodID, -finalRunID, -atCaptureRunMethodID, -atCaptureRunID, -taxonID, -fishOriginID, - mortID) %>%
  # add existing mark data
  left_join(selected_mark_existing, by = c("catchRawID" = "catchRawID")) %>% 
  left_join(selected_trap_visit) %>%
  # filter out marked and recapture fish by selecting for only fish where release trial does not exist
  filter(releaseID == 0 | releaseID == 255) %>% 
  glimpse

# Save data to google cloud
f <- function(input, output) write_csv(input, file = output)
gcs_upload(selected_catch,
           object_function = f,
           type = "csv",
           name = "rst/lower-sac-river/data-raw/tisdale/tisdale_catch_camp.csv",
           predefinedAcl = "bucketLevel")

```

# Recaptures

```{r}
trap_visit_recaptures <- trap_visit %>%
  select(trapVisitID, visitTime, visitTime2, visitTypeID, halfConeID) %>%
  left_join(visit_type_lu, by = c("visitTypeID" = "visitTypeID")) %>% 
  mutate(halfCone = ifelse(halfConeID == 1, T, F)) %>% 
  select(-visitTypeID, -halfConeID)

# add atcapturerun
selected_recaptured <- catch_raw %>% 
  select(catchRawID, taxonID, atCaptureRunID, atCaptureRunMethodID, finalRunID, finalRunMethodID, fishOriginID, lifeStageID, forkLength, weight, n, trapVisitID, releaseID, mortID) %>% 
  left_join(taxon_lu, by = c("taxonID" = "taxonID")) %>%
  # filter(commonName == "Chinook salmon") %>% 
  left_join(run_lu, by = c("finalRunID" = "runID")) %>%
  rename(final_run = run) %>% 
  left_join(run_lu, by = c("atCaptureRunID" = "runID")) %>%
  left_join(run_method_lu, by = c("finalRunMethodID" = "runMethodID")) %>%
  rename(final_run_method = runMethod) %>% 
  left_join(run_method_lu, by = c("atCaptureRunMethodID" = "runMethodID")) %>%
  left_join(lifestage_lu %>% 
              select(-lifeStageCAMPID), by = c("lifeStageID" = "lifeStageID")) %>%
  left_join(origin_lu, by = c("fishOriginID" = "fishOriginID")) %>%
  left_join(no_yes_lu, by = c("mortID" = "noYesID")) %>% 
  rename(dead = noYes) %>% 
  select(-lifeStageID, -finalRunMethodID, -finalRunID, -atCaptureRunMethodID, -atCaptureRunID, -taxonID, -fishOriginID, - mortID) %>%
  left_join(trap_visit_recaptures) %>%
  # filter out marked and recapture fish by selecting for only fish where release trial does not exist
  filter(releaseID != 0 & releaseID != 255) %>% 
  glimpse

f <- function(input, output) write_csv(input, file = output)
gcs_upload(selected_recaptured,
           object_function = f,
           type = "csv",
           name = "rst/lower-sac-river/data-raw/tisdale/tisdale_recaptures_camp.csv",
           predefinedAcl = "bucketLevel")
```
# Releases

```{r}
# removed releasepurposeID because they are all trap efficiency tests
# think about summing the nmort columns
selected_release <- release %>% 
  filter(releaseID != 255 & releaseID  != 0) %>% 
  select(releaseID, markedTaxonID, markedRunID, markedFishOriginID, sourceOfFishSiteID, releaseSiteID, releaseSubSiteID, nMortWhileHandling, nMortAtCheck, nReleased, releaseTime, releaseLightConditionID, testDays) %>% 
  left_join(taxon_lu, by = c("markedTaxonID" = "taxonID")) %>%
  # filter(commonName == "Chinook salmon") %>% 
  left_join(run_lu, by = c("markedRunID" = "runID")) %>%
  left_join(origin_lu, by = c("markedFishOriginID" = "fishOriginID")) %>%
  left_join(site_lu, by = c("sourceOfFishSiteID" = "siteID")) %>% 
  rename(site_fish_source = siteName) %>% 
  left_join(site_lu, by = c("releaseSiteID" = "siteID")) %>% 
  rename(release_site = siteName) %>% 
  left_join(subsite_lu, by = c("releaseSubSiteID" = "subSiteID")) %>% 
  left_join(light_condition_lu, by = c("releaseLightConditionID" = "lightConditionID")) %>% 
  select(-c(markedTaxonID, markedRunID, markedFishOriginID, sourceOfFishSiteID, releaseSiteID, releaseSubSiteID, releaseLightConditionID))
  
f <- function(input, output) write_csv(input, file = output)
gcs_upload(selected_release,
           object_function = f,
           type = "csv",
           name = "rst/lower-sac-river/data-raw/tisdale/tisdale_releases_camp.csv",
           predefinedAcl = "bucketLevel")
```

# Trap
```{r}
# all NA
filter(trap_visit, !is.na(timeSampleStarted))
filter(trap_visit, !is.na(timeSampleEnded))
filter(trap_visit, !is.na(coneDepthAtStart))
filter(trap_visit, !is.na(coneDepthAtEnd))
filter(trap_visit, !is.na(debrisVolume))

# not NA
filter(trap_visit, !is.na(inThalwegID))
filter(trap_visit, !is.na(sampleGearID))

# select relevant variables from trapvisit table
trap_visit_format <- trap_visit %>% 
  select(trapVisitID, trapPositionID, visitTime, visitTime2, visitTypeID, fishProcessedID, sampleGearID, inThalwegID, trapFunctioningID, counterAtStart, counterAtEnd, rpmRevolutionsAtStart, rpmRevolutionsAtEnd, halfConeID, debrisVolumeCatID, comments) %>% 
  left_join(site_subsite, by = c("trapPositionID" = "subSiteID")) %>% 
  left_join(visit_type_lu) %>% 
  left_join(processed_lu) %>% 
  left_join(sample_gear_lu) %>% 
  left_join(no_yes_lu, by = c("inThalwegID" = "noYesID")) %>% 
  rename(inThalweg = noYes) %>% 
  left_join(trap_function_lu) %>% 
  left_join(debris_volume_lu) %>% 
  mutate(halfCone = ifelse(halfConeID == 1, T, F)) %>% 
  select(-c(trapPositionID, visitTypeID, fishProcessedID, sampleGearID, inThalwegID, trapFunctioningID, debrisVolumeCatID, halfConeID, siteID))

# Save data to google cloud
f <- function(input, output) write_csv(input, file = output)
gcs_upload(trap_visit_format,
           object_function = f,
           type = "csv",
           name = "rst/lower-sac-river/data-raw/tisdale/tisdale_trap_camp.csv",
           predefinedAcl = "bucketLevel")
```

# Environmental

```{r}
# all NA
filter(environmental, !is.na(waterVelReadingStart))
filter(environmental, !is.na(waterVelReadingEnd))
filter(environmental, !is.na(waterVelTime))
filter(environmental, !is.na(airTemp))
filter(environmental, !is.na(cloudCover))
filter(environmental, !is.na(weather))

# contains data
filter(environmental, !is.na(discharge))
filter(environmental, !is.na(dischargeUnitID))
filter(environmental, !is.na(dischargeSampleGearID))
filter(environmental, !is.na(waterDepth))
filter(environmental, !is.na(waterVel))
filter(environmental, !is.na(waterTemp))
filter(environmental, !is.na(lightPenetration))
filter(environmental, !is.na(turbidity))
filter(environmental, !is.na(dissolvedOxygen))
filter(environmental, !is.na(conductivity))
filter(environmental, !is.na(barometer))

# select relevant variables from envDataRaw table

discharge <- environmental %>% 
  select(trapVisitID, envDataRawID, discharge, dischargeUnitID, dischargeSampleGearID) %>% 
  rename(value = discharge,
         unitID = dischargeUnitID,
         sampleGearID = dischargeSampleGearID) %>% 
  mutate(parameter = "discharge")

depth <- environmental %>% 
  select(trapVisitID, envDataRawID, waterDepth, waterDepthUnitID, waterDepthSampleGearID) %>% 
  rename(value = waterDepth,
         unitID = waterDepthUnitID,
         sampleGearID = waterDepthSampleGearID) %>% 
  mutate(parameter = "water depth")

velocity <- environmental %>% 
  select(trapVisitID, envDataRawID, waterVel, waterVelUnitID, waterVelSampleGearID) %>% 
  rename(value = waterVel,
         unitID = waterVelUnitID,
         sampleGearID = waterVelSampleGearID) %>% 
  mutate(parameter = "velocity")

temperature <- environmental %>% 
  select(trapVisitID, envDataRawID, waterTemp, waterTempUnitID, waterTempSampleGearID) %>% 
  rename(value = waterTemp,
         unitID = waterTempUnitID,
         sampleGearID = waterTempSampleGearID) %>% 
  mutate(parameter = "temperature")

light <- environmental %>% 
  select(trapVisitID, envDataRawID,  lightPenetration, lightPenetrationUnitID, lightPenetrationSampleGearID) %>% 
  rename(value = lightPenetration,
         unitID = lightPenetrationUnitID,
         sampleGearID = lightPenetrationSampleGearID) %>% 
  mutate(parameter = "light penetration")

turbidity <- environmental %>% 
  select(trapVisitID, envDataRawID,  turbidity, turbidityUnitID, turbiditySampleGearID) %>% 
  rename(value = turbidity,
         unitID = turbidityUnitID,
         sampleGearID = turbiditySampleGearID) %>% 
  mutate(parameter = "turbidity")

oxygen <- environmental %>% 
  select(trapVisitID, envDataRawID,  dissolvedOxygen, dissolvedOxygenUnitID, dissolvedOxygenSampleGearID) %>% 
  rename(value = dissolvedOxygen,
         unitID = dissolvedOxygenUnitID,
         sampleGearID = dissolvedOxygenSampleGearID) %>% 
  mutate(parameter = "dissolved oxygen")

conductivity <- environmental %>% 
  select(trapVisitID, envDataRawID,  conductivity, conductivityUnitID, conductivitySampleGearID) %>% 
  rename(value = conductivity,
         unitID = conductivityUnitID,
         sampleGearID = conductivitySampleGearID) %>% 
  mutate(parameter = "conductivity")

barometer <- environmental %>% 
  select(trapVisitID, envDataRawID,  barometer, barometerUnitID, barometerSampleGearID) %>% 
  rename(value = barometer,
         unitID = barometerUnitID,
         sampleGearID = barometerSampleGearID) %>% 
  mutate(parameter = "barometer")

trap_visit_subsite <- trap_visit %>%
  select(trapVisitID, visitTime, visitTime2, trapPositionID) %>%
  left_join(site_subsite, by = c("trapPositionID" = "subSiteID")) %>% 
  select(-trapPositionID, -siteID) %>% 
  rename(site = siteName,
         subsite = subSiteName) %>% 
  mutate(site = tolower(site),
         subsite = tolower(subsite))

environmental_format <- bind_rows(discharge,
                                  depth,
                                  velocity,
                                  temperature,
                                  light,
                                  turbidity,
                                  oxygen,
                                  conductivity,
                                  barometer) %>% 
  left_join(trap_visit_subsite) %>% 
  left_join(unit_lu) %>% 
  left_join(sample_gear_lu) %>% 
  select(-c(unitID, sampleGearID, visitTime2)) %>% 
  rename(date = visitTime,
         sample_gear = sampleGear) %>% 
  mutate(unit = case_when(is.na(unit) & !is.na(value) ~ "not recorded", 
                          is.na(unit) & is.na(value) ~ NA_character_,
                          T ~ unit),
         sample_gear = case_when(is.na(sample_gear) & !is.na(value) ~ "not recorded", 
                          is.na(sample_gear) & is.na(value) ~ NA_character_,
                          T ~ sample_gear))

# Save data to google cloud
f <- function(input, output) write_csv(input, file = output)
gcs_upload(environmental_format,
           object_function = f,
           type = "csv",
           name = "rst/lower-sac-river/data-raw/tisdale/tisdale_environmental_camp.csv",
           predefinedAcl = "bucketLevel")
```