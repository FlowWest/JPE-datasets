---
title: "Combine Feather River Snorkel Data"
author: "Liz Stebbins"
date: "5/2/2024"
output: rmarkdown::github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, fig.width=15, fig.height=10)
library(tidyverse)
library(googleCloudStorageR)
library(knitr)
color_pal <- c("#9A8822",  "#F8AFA8", "#FDDDA0", "#74A089", "#899DA4", "#446455", "#DC863B", "#C93312")

gcs_auth(json_file = Sys.getenv("GCS_AUTH_FILE"))
gcs_global_bucket(bucket = Sys.getenv("GCS_DEFAULT_BUCKET"))
```

## Adult Redd Data Standardization

FlowWest received snorkel data for Feather River in two separate Access databases: one for pre-2004 data and one for 2004-2020 data. These are processed in separate markdowns.
  
```{r, message = FALSE, warning = FALSE}
gcs_get_object(object_name = 
                 "juvenile-rearing-monitoring/seine-and-snorkel-data/feather-river/data-raw/pre_2004_snorkel.csv",
               bucket = gcs_get_global_bucket(),
               saveToDisk = here::here("data-raw", "qc-markdowns", "seine-snorkel-data", "feather-river", "snorkel_pre_2004.csv"),
               overwrite = TRUE)
gcs_get_object(object_name = 
                 "juvenile-rearing-monitoring/seine-and-snorkel-data/feather-river/data-raw/post_2004_snorkel.csv",
               bucket = gcs_get_global_bucket(),
               saveToDisk = here::here("data-raw", "qc-markdowns", "seine-snorkel-data", "feather-river", "snorkel_post_2004.csv"),
               overwrite = TRUE)

snorkel_pre_2004 <- read_csv(here::here("data-raw", "qc-markdowns", "seine-snorkel-data", "feather-river", "snorkel_pre_2004.csv"))
snorkel_post_2004 <- read_csv(here::here("data-raw", "qc-markdowns", "seine-snorkel-data", "feather-river", "snorkel_post_2004.csv"))

```

## Standard format for Adult All Redd Data

## Read in data {.tabset}
  
Below we read in the snorkel data from the different databases and rename or select columns so that we can join all the monitoring datasets together in the section below.

### Pre-2004

#### Columns Removed

- `flow` and `adj_flow` - sparsely recorded and values not on the same scale as `river_flow`
- `fish_depth` seemed redundant with `river_depth`
- `max_fork_length` seemed redundant with `fork_length`

columns created/renamed:
- `river_flow` renamed to `velocity`
- `river_depth` renamed to `water_depth_m`
- `huc_unit` renamed to `unit_type`

```{r}
clean_snorkel_pre_2004 <- snorkel_pre_2004 |> 
  select(-c(flow, adj_flow, fish_depth, max_fork_length)) |> 
  rename(velociy = river_flow,
         water_depth_m = river_depth,
         unit_type = huc_unit) |> 
  glimpse()
```

### Post-2004

#### Columns Removed

- `survey_comments` and `observation_comments` - not necessary for final dataset
- `time_of_temperature`, `observation_id`, `lwd_number` - not necessary for final dataset

columns created/renamed:
- `flow` renamed to `velocity`
- `weather_code` renamed to `weather`
- `hydrology_code` renamed to `hydrology`
- 

```{r}
# get lookup tables from pre-2004 table for some codes
db_filepath <- here::here("data-raw", "qc-markdowns", "seine-snorkel-data", "feather-river", "feather-river-db.mdb")
library(Hmisc)
lookup_HUC_cover <- mdb.get(db_filepath, "HUCcoverLU")
lookup_HUC_o_cover <- mdb.get(db_filepath, "HUCOcoverLU")
lookup_HUC_substrate <- mdb.get(db_filepath, "HUCsubstrateLU")
detach(package:Hmisc)

# TODO still need to do instream cover codes and substrate - they are complicated and time consuming

# first join the lookup tables
clean_snorkel_post_2004_lu <- snorkel_post_2004 |> 
  left_join(lookup_HUC_o_cover, by = c("overhead_cover" = "CoverCode")) |> 
    mutate(Cover = case_when(overhead_cover == 12 ~ "Overhead Object/Veg. 0 - 0.5m, Overhead Object/Veg. 0.5 - 2m",
                           overhead_cover == 13 ~ "Overhead Object/Veg. 0 - 0.5m, Submerged Aquatic Veg/Algae",
                           overhead_cover == 4 ~ "unknown (code 4)",
                           TRUE ~ Cover),
           Cover = str_to_lower(Cover)) |> 
  select(-c(overhead_cover)) |> 
  rename(overhead_cover = Cover) |> 
  glimpse()

clean_snorkel_post_2004 <- clean_snorkel_post_2004_lu |> 
  select(-c(survey_comments, observation_comments, time_of_temperature,
            observation_id, lwd_number)) |> 
  rename(velocity = flow,
         weather = weather_code,
         hydrology = hydrology_code) |> 
  mutate(hydrology = str_to_lower(hydrology),
         substrate = as.character(substrate)) |> 
  glimpse()
```


## Combine data:

```{r}
all_snorkel_data <- bind_rows(clean_snorkel_post_2004, 
                           clean_snorkel_pre_2004)  |> glimpse()
```

## Standardization of combined data

### Location

This code was written by Maddee and pulled in on 3-11-2024:

```{r}
all_snorkel_data_section_names <- all_snorkel_data |> 
  mutate(section_name = case_when(section_name == "Eye" ~ "Eye Riffle",
                                 section_name %in% c("Hatchery Side Ditch") ~ "Hatchery Ditch",
                                 section_name == "Hatchery Side Channel" ~ "Hatchery Riffle", 
                                 section_name == "Gridley Side Channel" ~ "Gridley Riffle", 
                                 section_name %in% c("Robinson", "Lower Robinson") ~ "Robinson Riffle",
                                 section_name == "Goose" ~ "Goose Riffle", 
                                 section_name == "Auditorium" ~ "Auditorium Riffle",
                                 section_name %in% c("Matthews", "Mathews", "Mathews Riffle") ~ "Matthews Riffle",
                                 section_name %in% c("G95 Side Channel", "G95 West Side Channel", "G95 Side West", "G95 Side") ~ "G95", 
                                 section_name %in% c("Vance West Riffle", "Vance West", "Vance W Riffle") ~ "Vance West",
                                 section_name %in% c("Moes", "Moes Ditch") ~ "Mo's Ditch",
                                 section_name == "Aleck" ~ "Aleck Riffle",
                                 section_name == "Lower Mcfarland" ~ "McFarland",
                                 section_name %in% c("Bed Rock Riffle", "Bedrock", "Bedrock Park") ~ "Bedrock Park Riffle",
                                 section_name == "Steep" ~ "Steep Riffle",
                                 section_name %in% c("Keister", "Keister Riffle") ~ "Kiester Riffle",
                                 section_name == "Junkyard" ~ "Junkyard Riffle",
                                 section_name == "Gateway" ~ "Gateway Riffle",
                                 section_name == "Trailer Park" ~ "Trailer Park Riffle",
                                 section_name %in% c("Hatchery Ditch And Moes", "Hatchery Ditch Moes Ditch", 
                                                            "Hatchery Side Channel Moes Ditch", 
                                                            "Hatchery Ditch And Moes Ditch", 
                                                            "Hatchery Side Channel And Moes Ditch", 
                                                            "Hatchery Ditch Moes") ~ "Hatchery Ditch and Mo's Ditch", 
                                        section_name %in% c("Hatchery And Moes Side Channels", "Hatchery Side Ch Moes Side Ch", 
                                                            "Hatchery Side Channel And Moes") ~ "Hatchery and Mo's Riffles", 
                                        .default = as.character(section_name))) |> 
  glimpse()
```

```{r, message = FALSE}
# map to section_number from standard_reach_lookup file
gcs_get_object(
  object_name = "jpe-model-data/standard_reach_lookup.csv",
  bucket = gcs_get_global_bucket(),
  saveToDisk = here::here("data", "standard-format-data", "standard-reach-lookup.csv"),
  overwrite = TRUE
)

standard_reach_lookup_feather <- read_csv(here::here("data", "standard-format-data", "standard-reach-lookup.csv")) |> 
  select(stream, reach, standardized_reach, reach_description) |> 
  filter(stream == "feather river") |> 
  glimpse()

# map the section name to a section number (where applicable)
all_snorkel_data_final <- all_snorkel_data_section_names |> 
  mutate(section_number = case_when(section_name == "Aleck Riffle" ~ 14,
                                    section_name == "Auditorium Riffle" ~ 6,
                                    section_name == "Bedrock Park Riffle" ~ 10,
                                    section_name == "Bedrock Riffle" ~ 10,
                                    section_name == "Big Riffle" ~ 25,
                                    section_name == "Eye Riffle" ~ 20,
                                    section_name == "G95" ~ 27,
                                    section_name == "Gateway Riffle" ~ 21,
                                    section_name == "Goose Riffle" ~ 33,
                                    section_name == "Hatchery and Mo's Riffles" ~ 5,
                                    section_name == "Hatchery Ditch" ~ 17,
                                    section_name == "Hatchery Ditch and Mo's Ditch" ~ 17,
                                    section_name == "Hatchery Ditch Lower Moes Ditch Upper" ~ 5,
                                    section_name == "Hatchery Riffle" ~ 4,
                                    section_name == "Matthews Riffle" ~ 12,
                                    section_name == "McFarland" ~ 36,
                                    section_name == "Mo's Ditch" ~ 5,
                                    section_name == "Robinson Riffle" ~ 16,
                                    section_name == "Steep Riffle" ~ 18,
                                    section_name == "Trailer Park Riffle" ~ 11,
                                    section_name == "Upper Mcfarland" ~ 36,
                                    section_name == "Vance East" ~ 23,
                                    section_name == "Vance West" ~ 22,
                                    TRUE ~ NA))

```

## Save Cleaned Data to Google Cloud

```{r}
knitr::kable(all_snorkel_data  |> head())
```

```{r, eval=FALSE}
#write_csv(all_snorkel_data, #here::here("data","redd-carcass-holding","standard_all_redd_data.csv"))
```

```{r, eval=FALSE}
# f <- function(input, output) write_csv(input, file = output)
# gcs_upload(all_snorkel_data,
#            object_function = f,
#            type = "csv",
#            name = "standard-format-data/standard_daily_redd.csv",
#            predefinedAcl = "bucketLevel")
```
