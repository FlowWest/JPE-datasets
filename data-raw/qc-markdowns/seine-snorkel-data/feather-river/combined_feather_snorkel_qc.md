Combine Feather River Snorkel Data
================
Liz Stebbins
5/2/2024

## Adult Redd Data Standardization

FlowWest received snorkel data for Feather River in two separate Access
databases: one for pre-2004 data and one for 2004-2020 data. These are
processed in separate markdowns.

``` r
gcs_get_object(object_name = 
                 "juvenile-rearing-monitoring/seine-and-snorkel-data/feather-river/data-raw/pre_2004_snorkel.csv",
               bucket = gcs_get_global_bucket(),
               saveToDisk = here::here("data-raw", "qc-markdowns", "seine-snorkel-data", "feather-river", "snorkel_pre_2004.csv"),
               overwrite = TRUE)
```

    ## [1] TRUE

``` r
gcs_get_object(object_name = 
                 "juvenile-rearing-monitoring/seine-and-snorkel-data/feather-river/data-raw/post_2004_snorkel.csv",
               bucket = gcs_get_global_bucket(),
               saveToDisk = here::here("data-raw", "qc-markdowns", "seine-snorkel-data", "feather-river", "snorkel_post_2004.csv"),
               overwrite = TRUE)
```

    ## [1] TRUE

``` r
snorkel_pre_2004 <- read_csv(here::here("data-raw", "qc-markdowns", "seine-snorkel-data", "feather-river", "snorkel_pre_2004.csv"))
snorkel_post_2004 <- read_csv(here::here("data-raw", "qc-markdowns", "seine-snorkel-data", "feather-river", "snorkel_post_2004.csv"))
```

## Standard format for Adult All Redd Data

## Read in data

Below we read in the snorkel data from the different databases and
rename or select columns so that we can join all the monitoring datasets
together in the section below.

### Pre-2004

#### Columns Removed

- `flow` and `adj_flow` - sparsely recorded and values not on the same
  scale as `river_flow`
- `fish_depth` seemed redundant with `river_depth`
- `max_fork_length` seemed redundant with `fork_length`

columns created/renamed: - `river_flow` renamed to `velocity` -
`river_depth` renamed to `water_depth_m` - `huc_unit` renamed to
`unit_type`

``` r
clean_snorkel_pre_2004 <- snorkel_pre_2004 |> 
  select(-c(flow, adj_flow, fish_depth, max_fork_length)) |> 
  rename(velociy = river_flow,
         water_depth_m = river_depth,
         unit_type = huc_unit) |> 
  glimpse()
```

    ## Rows: 3,884
    ## Columns: 20
    ## $ survey_id      <dbl> 5, 6, 7, 7, 7, 7, 7, 8, 8, 8, 8, 8, 9, 10, 10, 11, 11, …
    ## $ date           <date> 1999-07-01, 1999-07-01, 1999-07-01, 1999-07-01, 1999-0…
    ## $ location       <chr> "Mcfarland Bend", "Big Riffle", "Lower Hour Riffle", "L…
    ## $ unit           <chr> "451", "423", "353", "355", "355", "358", "358", "217",…
    ## $ survey_type    <chr> "unit", "unit", "unit", "unit", "unit", "unit", "unit",…
    ## $ section_type   <chr> "permanent", "random", "random", "random", "random", "r…
    ## $ count          <dbl> 3, 1, 1, 1, 3, 4, 1, 4, 4, 3, 2, 1, 1, 0, 0, 0, 0, 5, 2…
    ## $ species        <chr> "chinook", "chinook", "chinook", "chinook", "chinook", …
    ## $ run            <chr> "fall", "fall", "fall", "fall", "fall", "fall", "fall",…
    ## $ fork_length    <dbl> 90, 75, 80, 80, 80, 95, 80, 100, 100, 60, 100, 105, 600…
    ## $ water_depth_m  <dbl> 1.00, 1.60, 0.70, 0.40, 0.60, 0.65, 0.80, 0.25, 0.20, N…
    ## $ velociy        <dbl> 8050, 8050, 8050, 8050, 8050, 8050, 8050, 620, 620, 620…
    ## $ bank_distance  <dbl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, 0, NA, …
    ## $ unit_type      <chr> "glide", "pool", "glide", "riffle", "riffle edgewater",…
    ## $ instream_cover <chr> NA, "no apparent  cover", NA, "no apparent  cover", "no…
    ## $ overhead_cover <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
    ## $ substrate      <chr> "sand (.05-2 mm)", "sand (.05-2 mm)", "sand (.05-2 mm)"…
    ## $ visibility     <dbl> 1.5, 1.5, NA, NA, NA, NA, NA, 3.5, 3.5, 3.5, 3.5, 3.5, …
    ## $ temperature    <dbl> 65.0, 64.0, 64.5, 64.5, 64.5, 64.5, 64.5, 64.5, 64.5, 6…
    ## $ weather        <chr> "sunny", "sunny", "sunny", "sunny", "sunny", "sunny", "…

### Post-2004

#### Columns Removed

- `survey_comments` and `observation_comments` - not necessary for final
  dataset
- `time_of_temperature`, `observation_id`, `lwd_number` - not necessary
  for final dataset

columns created/renamed: - `flow` renamed to `velocity` - `weather_code`
renamed to `weather` - `hydrology_code` renamed to `hydrology` -

``` r
# get lookup tables from pre-2004 table for some codes
db_filepath <- here::here("data-raw", "qc-markdowns", "seine-snorkel-data", "feather-river", "feather-river-db.mdb")
library(Hmisc)
```

    ## 
    ## Attaching package: 'Hmisc'

    ## The following objects are masked from 'package:dplyr':
    ## 
    ##     src, summarize

    ## The following objects are masked from 'package:base':
    ## 
    ##     format.pval, units

``` r
lookup_HUC_cover <- mdb.get(db_filepath, "HUCcoverLU")
lookup_HUC_o_cover <- mdb.get(db_filepath, "HUCOcoverLU")
lookup_HUC_substrate <- mdb.get(db_filepath, "HUCsubstrateLU")
detach(package:Hmisc)

# TODO still need to do instream cover codes and substrate - they are complicated and time consuming

# first join the lookup tables
clean_snorkel_post_2004_lu <- snorkel_post_2004 |> 
  left_join(lookup_HUC_o_cover, by = c("overhead_cover" = "CoverCode")) |> 
    mutate(Cover = case_when(overhead_cover == 12 ~ "Overhead Object/Veg. 0 - 0.5m, Overhead Object/Veg. 0.5 - 2m",
                           overhead_cover == 13 ~ "Overhead Object/Veg. 0 - 0.5m, Submerged Aquatic Veg/Algae",
                           overhead_cover == 4 ~ "unknown (code 4)",
                           TRUE ~ Cover),
           Cover = str_to_lower(Cover)) |> 
  select(-c(overhead_cover)) |> 
  rename(overhead_cover = Cover) |> 
  glimpse()
```

    ## Rows: 2,753
    ## Columns: 27
    ## $ survey_id            <dbl> 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3…
    ## $ date                 <date> 2007-06-27, 2007-06-27, 2007-06-27, 2007-06-27, …
    ## $ flow                 <dbl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ weather_code         <chr> NA, NA, NA, NA, "clear", "clear", "clear", "clear…
    ## $ turbidity            <dbl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ temperature          <dbl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ time_of_temperature  <time> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
    ## $ start_time           <time>       NA,       NA,       NA,       NA, 10:00:00…
    ## $ end_time             <time>       NA,       NA,       NA,       NA, 14:00:00…
    ## $ section_name         <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ units_covered        <chr> NA, NA, NA, NA, "26,33,30,31,31a,32,32a", "26,33,…
    ## $ survey_comments      <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ observation_id       <dbl> 79, 81, 84, 86, 96, 98, 99, 100, 104, 107, 108, 1…
    ## $ unit                 <chr> "169", "173", "185", "215B", "26", "33", "33", "3…
    ## $ count                <dbl> 50, 4, 15, 7, 0, 3, 30, 1, NA, 15, NA, 70, 14, 24…
    ## $ size_class           <chr> "III", "I", "III", "III", NA, "II", "III", NA, NA…
    ## $ est_size             <dbl> NA, NA, NA, NA, NA, 50, 75, 100, NA, 100, NA, 75,…
    ## $ substrate            <dbl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ instream_cover       <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ hydrology_code       <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ water_depth_m        <dbl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ lwd_number           <dbl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ observation_comments <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ run                  <chr> "unknown", "unknown", "unknown", "unknown", "unkn…
    ## $ tagged               <lgl> FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, …
    ## $ clipped              <lgl> FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, …
    ## $ overhead_cover       <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…

``` r
clean_snorkel_post_2004 <- clean_snorkel_post_2004_lu |> 
  select(-c(survey_comments, observation_comments, time_of_temperature,
            observation_id, lwd_number)) |> 
  rename(velocity = flow,
         weather = weather_code,
         hydrology = hydrology_code) |> 
  mutate(hydrology = str_to_lower(hydrology),
         substrate = as.character(substrate)) |> 
  glimpse()
```

    ## Rows: 2,753
    ## Columns: 22
    ## $ survey_id      <dbl> 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 4, 4…
    ## $ date           <date> 2007-06-27, 2007-06-27, 2007-06-27, 2007-06-27, 2007-0…
    ## $ velocity       <dbl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
    ## $ weather        <chr> NA, NA, NA, NA, "clear", "clear", "clear", "clear", "cl…
    ## $ turbidity      <dbl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
    ## $ temperature    <dbl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
    ## $ start_time     <time>       NA,       NA,       NA,       NA, 10:00:00, 10:0…
    ## $ end_time       <time>       NA,       NA,       NA,       NA, 14:00:00, 14:0…
    ## $ section_name   <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
    ## $ units_covered  <chr> NA, NA, NA, NA, "26,33,30,31,31a,32,32a", "26,33,30,31,…
    ## $ unit           <chr> "169", "173", "185", "215B", "26", "33", "33", "33", "3…
    ## $ count          <dbl> 50, 4, 15, 7, 0, 3, 30, 1, NA, 15, NA, 70, 14, 245, 3, …
    ## $ size_class     <chr> "III", "I", "III", "III", NA, "II", "III", NA, NA, NA, …
    ## $ est_size       <dbl> NA, NA, NA, NA, NA, 50, 75, 100, NA, 100, NA, 75, 75, 7…
    ## $ substrate      <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
    ## $ instream_cover <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
    ## $ hydrology      <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
    ## $ water_depth_m  <dbl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
    ## $ run            <chr> "unknown", "unknown", "unknown", "unknown", "unknown", …
    ## $ tagged         <lgl> FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE,…
    ## $ clipped        <lgl> FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE,…
    ## $ overhead_cover <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…

## Combine data:

``` r
all_snorkel_data <- bind_rows(clean_snorkel_post_2004, 
                           clean_snorkel_pre_2004)  |> glimpse()
```

    ## Rows: 6,637
    ## Columns: 31
    ## $ survey_id      <dbl> 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 4, 4…
    ## $ date           <date> 2007-06-27, 2007-06-27, 2007-06-27, 2007-06-27, 2007-0…
    ## $ velocity       <dbl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
    ## $ weather        <chr> NA, NA, NA, NA, "clear", "clear", "clear", "clear", "cl…
    ## $ turbidity      <dbl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
    ## $ temperature    <dbl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
    ## $ start_time     <time>       NA,       NA,       NA,       NA, 10:00:00, 10:0…
    ## $ end_time       <time>       NA,       NA,       NA,       NA, 14:00:00, 14:0…
    ## $ section_name   <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
    ## $ units_covered  <chr> NA, NA, NA, NA, "26,33,30,31,31a,32,32a", "26,33,30,31,…
    ## $ unit           <chr> "169", "173", "185", "215B", "26", "33", "33", "33", "3…
    ## $ count          <dbl> 50, 4, 15, 7, 0, 3, 30, 1, NA, 15, NA, 70, 14, 245, 3, …
    ## $ size_class     <chr> "III", "I", "III", "III", NA, "II", "III", NA, NA, NA, …
    ## $ est_size       <dbl> NA, NA, NA, NA, NA, 50, 75, 100, NA, 100, NA, 75, 75, 7…
    ## $ substrate      <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
    ## $ instream_cover <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
    ## $ hydrology      <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
    ## $ water_depth_m  <dbl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
    ## $ run            <chr> "unknown", "unknown", "unknown", "unknown", "unknown", …
    ## $ tagged         <lgl> FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE,…
    ## $ clipped        <lgl> FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE,…
    ## $ overhead_cover <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
    ## $ location       <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
    ## $ survey_type    <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
    ## $ section_type   <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
    ## $ species        <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
    ## $ fork_length    <dbl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
    ## $ velociy        <dbl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
    ## $ bank_distance  <dbl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
    ## $ unit_type      <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
    ## $ visibility     <dbl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…

## Save Cleaned Data to Google Cloud

``` r
knitr::kable(all_snorkel_data  |> head())
```

| survey_id | date       | velocity | weather | turbidity | temperature | start_time | end_time | section_name | units_covered          | unit | count | size_class | est_size | substrate | instream_cover | hydrology | water_depth_m | run     | tagged | clipped | overhead_cover | location | survey_type | section_type | species | fork_length | velociy | bank_distance | unit_type | visibility |
|----------:|:-----------|---------:|:--------|----------:|------------:|:-----------|:---------|:-------------|:-----------------------|:-----|------:|:-----------|---------:|:----------|:---------------|:----------|--------------:|:--------|:-------|:--------|:---------------|:---------|:------------|:-------------|:--------|------------:|--------:|--------------:|:----------|-----------:|
|         2 | 2007-06-27 |       NA | NA      |        NA |          NA | NA         | NA       | NA           | NA                     | 169  |    50 | III        |       NA | NA        | NA             | NA        |            NA | unknown | FALSE  | FALSE   | NA             | NA       | NA          | NA           | NA      |          NA |      NA |            NA | NA        |         NA |
|         2 | 2007-06-27 |       NA | NA      |        NA |          NA | NA         | NA       | NA           | NA                     | 173  |     4 | I          |       NA | NA        | NA             | NA        |            NA | unknown | FALSE  | FALSE   | NA             | NA       | NA          | NA           | NA      |          NA |      NA |            NA | NA        |         NA |
|         2 | 2007-06-27 |       NA | NA      |        NA |          NA | NA         | NA       | NA           | NA                     | 185  |    15 | III        |       NA | NA        | NA             | NA        |            NA | unknown | FALSE  | FALSE   | NA             | NA       | NA          | NA           | NA      |          NA |      NA |            NA | NA        |         NA |
|         2 | 2007-06-27 |       NA | NA      |        NA |          NA | NA         | NA       | NA           | NA                     | 215B |     7 | III        |       NA | NA        | NA             | NA        |            NA | unknown | FALSE  | FALSE   | NA             | NA       | NA          | NA           | NA      |          NA |      NA |            NA | NA        |         NA |
|         3 | 2007-07-16 |       NA | clear   |        NA |          NA | 10:00:00   | 14:00:00 | NA           | 26,33,30,31,31a,32,32a | 26   |     0 | NA         |       NA | NA        | NA             | NA        |            NA | unknown | FALSE  | FALSE   | NA             | NA       | NA          | NA           | NA      |          NA |      NA |            NA | NA        |         NA |
|         3 | 2007-07-16 |       NA | clear   |        NA |          NA | 10:00:00   | 14:00:00 | NA           | 26,33,30,31,31a,32,32a | 33   |     3 | II         |       50 | NA        | NA             | NA        |            NA | unknown | FALSE  | FALSE   | NA             | NA       | NA          | NA           | NA      |          NA |      NA |            NA | NA        |         NA |

``` r
#write_csv(all_snorkel_data, #here::here("data","redd-carcass-holding","standard_all_redd_data.csv"))
```

``` r
# f <- function(input, output) write_csv(input, file = output)
# gcs_upload(all_snorkel_data,
#            object_function = f,
#            type = "csv",
#            name = "standard-format-data/standard_daily_redd.csv",
#            predefinedAcl = "bucketLevel")
```
