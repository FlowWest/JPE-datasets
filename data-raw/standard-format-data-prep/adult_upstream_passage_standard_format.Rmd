---
title: "Standardize Adult Upstream Passage Datasets"
author: "Erin Cain"
date: '2022-05-03'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, fig.width=15, fig.height=10)
library(tidyverse)
library(googleCloudStorageR)
color_pal <- c("#9A8822",  "#F8AFA8", "#FDDDA0", "#74A089", "#899DA4", "#446455", "#DC863B", "#C93312")
```

## Adult Upstream Passage Data Standardization

FlowWest received Adult Upstream Passage data from 5 monitoring programs:

-   Battle Creek
-   Clear Creek
-   Deer Creek
-   Mill Creek
-   Yuba River

Butte collects this data but has not been acquired (database lost?). Feather River started adult video monitoring in 2022.

## Standard format for Adult Upstream Passage Data

Data dictionary for standard format:

(B - Battle Creek, C - Clear Creek,  
D - Deer Creek, M - Mill Creek, Y - Yuba River)

| column name        | tributary collects | definition                                                                                             |
|:------------------|:------------------|:---------------------------------|
| stream           | **B, C, D, M, Y**  | which Spring Run JPE stream is the data from                                                           |
| date               | **B, C, D, M, Y**  | date of video footage                                                                                  |
| time               | **B, C, Y**        | time of video footage                                                                                  |
| count              | **B, C, D, M, Y**  | number of fish observed                                                                                |
| adipose_clipped    | **B, C, Y**        | if adipose fin is clipped (TRUE/FALSE)                                                                 |
| run                | **B, C, D, M**     | run designation                                                                                        |
| passage_direction  | **B, C, Y**        | direction of fish passage                                                                              |
| sex                | **C**              | sex of fish observed                                                                                   |
| viewing_condition  | **C**              | direction of fish observed (normal, readable, not readable, weir is flooded)                           |
| spawning_condition | **C**              | description of spawning status based on coloration (none, energetic, spawning colors, fungus, unknown) |
| jack_size          | **C**              | If the fish is jack sized or not                                                                       |
| ladder             | **Y**              | describes which ladder the fish was seen traveling up                                                  |
| hours              | **Y**              | number of hours viewed by day                                                                          |
| flow               | **D, M**           | flow in cfs at the weir                                                                                |
| temperature        | **D, M**           | temperature in C at the weir                                                                           |

## Read in data {.tabset}

Below we read in the adult upstream passage data for each monitoring program and rename or select columns so that we can join all the monitoring datasets together in the section below.

### Battle Creek

#### Columns Removed

No columns are removed from battle creek upstream passage video data.

```{r}
# Set your authentication using gcs_auth
# gcs_auth(json_file = Sys.getenv("GCS_AUTH_FILE"))
# # Set global bucket
# gcs_global_bucket(bucket = Sys.getenv("GCS_DEFAULT_BUCKET"))
# download file as csv
# gcs_get_object(object_name = "adult-upstream-passage-monitoring/battle-creek/data/battle_passage_video.csv",
#                bucket = gcs_get_global_bucket(),
#                saveToDisk = "../../data/adult-upstream-passage-monitoring/battle_adult_upstream.csv",
#                overwrite = TRUE)

battle_upstream_passage <- read_csv("../../data/adult-upstream-passage-monitoring/battle_adult_upstream.csv") %>% 
  mutate(stream = "Battle Creek") %>% 
  filter(count != 0) %>% # occurs when catch of non chinook fish
  glimpse

```

### Clear Creek

#### Columns Removed

-   **time_block**: Time block was removed because it refers to the time block being viewed and this is not relevant if we only care specifically about when the fish passes. We retained the time_passed column instead to keep this information

    These were the original definitions given for viewing condition

-   Normal (good visibility, clear water, all equipment working, no obstructions);

-   Readable but confidence lower due to turbidity or partial loss of video equipment, obstructions (note specifics in comments);

-   Not readable due to turbidity or equipment failure;

-   Weir is flooded (note if footage is readable or note in comments)

    These were the original definitions given for spawn condition

-   "Energetic; bright or silvery; no spawning coloration or developed secondary sex characteristics.",

-   "Energetic, can tell sex from secondary characteristics (kype) silvery or bright coloration but may have some hint of spawning colors.",

-   "Spawning colors, defined kype, some tail wear or small amounts of fungus.",

-   "Fungus, lethargic, wandering; " Zombie fish". Significant tail wear in females to indicate the spawning process has already occurred.",

-   "Unable to make distinction."

```{r}
# download file as csv
# gcs_get_object(object_name = "adult-upstream-passage-monitoring/clear-creek/data/clear_passage.csv",
#                bucket = gcs_get_global_bucket(),
#                saveToDisk = "../../data/adult-upstream-passage-monitoring/clear_adult_upstream.csv",
#                overwrite = TRUE)

clear_upstream_passage <- read_csv("../../data/adult-upstream-passage-monitoring/clear_adult_upstream.csv") %>% 
  select(-time_block) %>%
  rename(time = time_passed) %>% 
  mutate(stream = "Clear Creek",
         viewing_condition = case_when( 
           viewing_condition == 1 ~ "normal",  
           viewing_condition == 2 ~ "readable",  
           viewing_condition == 3 ~ "not readable",
           viewing_condition == 4 ~"weir is flooded"),
         spawning_condition = case_when(
           spawning_condition == 1 ~ "no spawn coloration", 
           spawning_condition == 2 ~ "some spawn coloration",
           spawning_condition == 3 ~ "full spawn coloration",
           spawning_condition == 4 ~ "post spawn",
           spawning_condition == 5 ~ "unknown"
         )) %>% 
  filter(count != 0) %>% # occurs when catch of non chinook fish
  glimpse
```

### Deer Creek

#### Columns Removed

No columns are removed from battle creek upstream passage video data.

```{r}
# download file as csv
# gcs_get_object(object_name = "adult-upstream-passage-monitoring/deer-creek/data/deer_upstream_passage_estimate.csv",
#                bucket = gcs_get_global_bucket(),
#                saveToDisk = "../../data/adult-upstream-passage-monitoring/deer_adult_upstream.csv",
#                overwrite = TRUE)

deer_upstream_passage <- read_csv("../../data/adult-upstream-passage-monitoring/deer_adult_upstream.csv") %>% 
    rename(count = passage_estimate) %>% # confirm with matt johnson that this is a count not a modeled passage
    mutate(stream = "Deer Creek") %>% 
    glimpse
```

### Mill Creek

#### Columns Removed

No columns are removed from battle creek upstream passage video data.

```{r}

# download file as csv
# gcs_get_object(object_name = "adult-upstream-passage-monitoring/mill-creek/data/mill_upstream_passage_estimate.csv",
#                 bucket = gcs_get_global_bucket(),
#                 saveToDisk = "../../data/adult-upstream-passage-monitoring/mill_adult_upstream.csv",
#                 overwrite = TRUE)

mill_upstream_passage <- read_csv("../../data/adult-upstream-passage-monitoring/mill_adult_upstream.csv") %>% 
  rename(count = passage_estimate) %>% # confirm with matt johnson that this is a count not a modeled passage
  mutate(stream = "Mill Creek") %>% 
  glimpse
```

### Yuba River

#### Columns Removed

The following columns were removed from the Yuba River dataset. There was no clear methodology on how these columns were generated or how they should be used so we removed from dataset.

-   category

-   length_cm

-   speed_m\_per_s

-   depth_m

-   position_in_frame

```{r}

# download file as csv
# gcs_get_object(object_name = "adult-upstream-passage-monitoring/yuba-river/data/yuba_upstream_passage.csv",
#                 bucket = gcs_get_global_bucket(),
#                 saveToDisk = "../../data/adult-upstream-passage-monitoring/yuba_adult_upstream.csv",
#                 overwrite = TRUE)

yuba_upstream_passage <- read_csv("../../data/adult-upstream-passage-monitoring/yuba_adult_upstream.csv") %>% 
  select(-category, -speed_m_per_s, -length_cm, 
         -depth_m, -position_in_frame) %>% # No clear methodology shared by yuba on these data and how they should be used  
  mutate(stream = "Yuba River") %>% 
  distinct() %>%
  glimpse
View(yuba_upstream_passage)
```

## Combine data:

```{r}
combined_upstream_passage <- bind_rows(battle_upstream_passage, clear_upstream_passage, 
                                       deer_upstream_passage, mill_upstream_passage, 
                                       yuba_upstream_passage) %>% 
  rename(adipose_clipped = adipose) %>%
  relocate(stream, date, time, count, run, adipose_clipped, sex, passage_direction, 
           viewing_condition, spawning_condition, jack_size, ladder, flow, temperature, hours) %>%
  glimpse
```

## Explore Varibles{.tabset}

### stream

```{r}
unique(combined_upstream_passage$stream)
```

### date

```{r}
combined_upstream_passage %>% ggplot() + 
  geom_point(aes(x = date, y = stream, color = stream), alpha = .1) +
  scale_color_manual(values = color_pal) +
  theme_minimal() + 
  theme(legend.position = "bottom", 
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
```

### time

Mill and Deer do not give passage time they give daily passage only.

```{r}
combined_upstream_passage %>% ggplot() + 
  geom_point(aes(x = time, y = stream, color = stream), alpha = .1) +
  scale_color_manual(values = color_pal) +
  theme_minimal() + 
  theme(legend.position = "bottom", 
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
```

### count

Group by day to see distribution of daily count values

```{r}
daily <- combined_upstream_passage %>% 
  group_by(stream, date) %>%
  summarize(count = sum(count, na.rm = T)) 

summary(daily$count)


daily %>% ggplot() + 
  geom_boxplot(aes(x = count,y = stream,  color = stream), 
                 alpha = .5, binwidth  = 1) + 
  scale_color_manual(values = color_pal) +
  theme_minimal() + 
  theme(legend.position = "bottom", 
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
```

### run

Clear and Battle Creeks datasets include spring run, fall run, late full run, winter run, and unknown chinook salmon

Deer and Mill Creek datasets only report spring run values

```{r}
 unique(combined_upstream_passage$run)
```

Change the run names to be consistent with the other monitoring types

```{r}
combined_upstream_passage <- combined_upstream_passage %>% 
  mutate(run = case_when(run == "SR" ~ "spring",
                         run == "LF" ~ "late fall",
                         run == "WR" ~ "winter", 
                         run == "FR" ~ "fall", 
                         run == "unknown" ~ "unknown"),
         run = ifelse(stream %in% c("Mill Creek", "Deer Creek"), "spring", run))

combined_upstream_passage %>% 
  group_by(stream) %>%
  summarise(run = unique(run) %>% base::paste(collapse = ', '))

unique(combined_upstream_passage$run)

```

### adipose_clipped

Look at unique values for adipose_clipped

```{r}
unique(combined_upstream_passage$adipose_clipped)
```


```{r}
combined_upstream_passage <- combined_upstream_passage %>% 
  mutate(adipose_clipped = case_when(adipose_clipped == "absent" ~ TRUE, 
                                     adipose_clipped == "present" ~ FALSE, 
                                     adipose_clipped == "clipped" ~ TRUE))

combined_upstream_passage %>% 
  group_by(stream) %>%
  summarise(origin = unique(adipose_clipped) %>% base::paste(collapse = ', ')) 
```

### sex

Clear Creek is the only stream that reports data on the sex of fish

```{r}
combined_upstream_passage %>% 
  group_by(stream) %>%
  summarise(sex = unique(sex) %>% base::paste(collapse = ', ')) 

unique(combined_upstream_passage$sex)

```

### passage_direction

```{r}
combined_upstream_passage %>% 
  group_by(stream) %>%
  summarise(passage_direction = unique(passage_direction) %>% base::paste(collapse = ', '))
```

### viewing_condition

Only clear creek provides a viewing condition

```{r}
combined_upstream_passage %>% 
  group_by(stream) %>%
  summarise(viewing_condition = unique(viewing_condition) %>% base::paste(collapse = ', ')) 

```

### spawning_condition

Only clear creek provides a spawning condition

```{r}
combined_upstream_passage %>% 
  group_by(stream) %>%
  summarise(spawning_condition = unique(spawning_condition) %>% base::paste(collapse = ', ')) 

```

### jack_size

Only clear creek provides a jack size

```{r}
combined_upstream_passage %>% 
  group_by(stream) %>%
  summarise(jack_size = unique(jack_size) %>% base::paste(collapse = ', ')) 

```

### ladder

Only yuba river gives a ladder variable to describe which ladder the fish is seen on

```{r}
combined_upstream_passage %>% 
  group_by(stream) %>%
  summarise(ladder = unique(ladder) %>% base::paste(collapse = ', ')) 

```

### hours

Only yuba river gives a hours variable to describe how many of 24 hours in a day are accounted for in the data, typically this value is 24 with some exceptions

Our assumption is that all other locations attempt to view all 24 hours of video footage however we do not have a way to calculate actual hours viewed from the data provided 

```{r}
combined_upstream_passage %>% 
  ggplot() +
  geom_histogram(aes(x = hours, fill = stream), binwidth = 1) + 
  scale_fill_manual(values = color_pal) +
  theme_minimal() + 
  theme(legend.position = "bottom", 
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
```

### flow

Only mill and deer creek give daily flow and temperature values attached to their data

```{r}
combined_upstream_passage %>% 
  ggplot() +
  geom_histogram(aes(x = flow, fill = stream), 
                 binwidth = 30, alpha = .5, position = "identity") + 
  scale_fill_manual(values = color_pal) +
  theme_minimal() + 
  theme(legend.position = "bottom", 
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
```

```{r}
combined_upstream_passage %>% 
  filter(stream %in% c("Mill Creek", "Deer Creek")) %>%
  ggplot() +
  geom_line(aes(x = date, y = flow, color = stream), size = 1) + 
  scale_color_manual(values = color_pal) +
  theme_minimal() + 
  theme(legend.position = "bottom", 
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
```

### temperature

Only mill and deer creek give daily flow and temperature values attached to their data

```{r}
combined_upstream_passage %>% 
  ggplot() +
  geom_histogram(aes(x = temperature, fill = stream), binwidth = 1, alpha = .5, position = "identity") + 
   scale_fill_manual(values = color_pal) +
  theme_minimal() + 
  theme(legend.position = "bottom", 
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
```

```{r}
combined_upstream_passage %>% 
  filter(stream %in% c("Mill Creek", "Deer Creek")) %>%
  ggplot() +
  geom_line(aes(x = date, y = temperature, color = stream), size = 1) + 
  scale_color_manual(values = color_pal) +
  theme_minimal() + 
  theme(legend.position = "bottom", 
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
```

## Save Cleaned Data to Google Cloud

```{r}
clean_passage <- combined_upstream_passage

knitr::kable(clean_passage %>% head)
```

```{r, eval=FALSE}
# Write to google cloud 
# Name file [watershed]_[data type].csv
write_csv(clean_passage, "../../data/standard-format-data/standard_adult_upstream_passage.csv")
f <- function(input, output) write_csv(input, file = output)
gcs_upload(clean_passage,
           object_function = f,
           type = "csv",
           name = "standard-format-data/standard_adult_upstream_passage.csv")
```
