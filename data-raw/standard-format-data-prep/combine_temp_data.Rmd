---
title: "combine temp data for trap locations"
output: 
  html_document:
  theme: flatly
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, fig.width=15, fig.height=10, 
                      root.dir = rprojroot::find_rstudio_root_file())
Sys.setenv("GCS_AUTH_FILE" = "config.json")
Sys.setenv("GCS_DEFAULT_BUCKET" = "jpe-dev-bucket")
library(tidyverse)
library(googleCloudStorageR)
```

# Combine Temperature Data 

#TODO add a quick description
#TODO create table with data source for each tributary

# Pull in data and format {.tabset}

## Battle

```{r}
ubc_temp_raw <- readxl::read_excel(here::here("data-raw", "standard-format-data-prep", "temp_data", "battle_clear_temp.xlsx"), sheet = 4)

battle_format <- ubc_temp_raw %>% 
  rename(date = DT,
         temp_c = TEMP_C) %>%
  mutate(stream = "battle creek", 
         site = "ubc",
         date = as.Date(date),
         source = "FWS") %>%
  group_by(date, stream, site, source) %>%
  summarise(mean_temp_degC = mean(temp_c)) %>% 
  filter(mean_temp_degC > 0) %>%
  glimpse


battle_format %>% ggplot() + 
  geom_line(aes(x = date, y = mean_temp_degC), color = "gray") + 
  # geom_point(aes(x = date, y = mean_temp_degC), size = .001) +
  theme_minimal()

```

## Butte

```{r}
# source CDEC
butte <- read_rds(here::here("data-raw", "standard-format-data-prep","temp_data", "butte_temp.rds"))
butte_format <- butte %>%
  mutate(site = "adams dam") %>%
  bind_rows(butte %>%
              mutate(site = "okie dam")) %>%
  mutate(stream = "butte creek",
         source = "CDEC BCK") %>%
  filter(mean_temp_degC > 0 & mean_temp_degC < 35) %>% # Filter out outliners TODO confirm with ashley that this is an appropriate range
glimpse()

butte_format %>% ggplot() + 
  geom_line(aes(x = date, y = mean_temp_degC), color = "gray") + 
  # geom_point(aes(x = date, y = mean_temp_degC), size = .001) +
  theme_minimal()
```

## Clear

```{r}
ucc_temp_raw <- readxl::read_excel(here::here("data-raw", "standard-format-data-prep", "temp_data", "battle_clear_temp.xlsx"), sheet = 2)

ucc_temp <- ucc_temp_raw %>% 
  rename(date = DT,
         temp_c = TEMP_C) %>%
  mutate(stream = "clear creek", 
         site = "ucc",
         date = as.Date(date)) %>%
  glimpse

lcc_temp_raw <- readxl::read_excel(here::here("data-raw", "standard-format-data-prep", "temp_data", "battle_clear_temp.xlsx"), sheet = 3)
lcc_temp <- lcc_temp_raw %>% 
  rename(date = DT,
         temp_c = TEMP_C) %>% 
  mutate(stream = "clear creek", 
         site = "lcc",
         date = as.Date(date)) %>%
  glimpse

clear_format <- bind_rows(lcc_temp, ucc_temp) %>% 
  group_by(date, stream, site) %>%
  summarise(mean_temp_degC = mean(temp_c)) %>% 
  mutate(source = "FWS") %>% glimpse

clear_format %>% ggplot() + 
  geom_line(aes(x = date, y = mean_temp_degC, color = site)) + 
  # geom_point(aes(x = date, y = mean_temp_degC), size = .001) +
  theme_minimal()
```

## Deer

```{r}
# source USGS
deer <- read_rds(here::here("data-raw", "standard-format-data-prep","temp_data", "deer_temp.rds"))
deer_format <- deer %>%
  mutate(stream = "deer creek",
         site = stream,
         source = "CDEC DCV") %>%
  filter(mean_temp_degC > 0 & mean_temp_degC < 35) %>% 
  glimpse()

deer_format %>% ggplot() + 
  geom_line(aes(x = date, y = mean_temp_degC), color = "gray") + 
  # geom_point(aes(x = date, y = mean_temp_degC), size = .001) +
  theme_minimal()
```

## Feather

```{r}
# TODO figure out gage to use for hfc and lfc 
# use maps of gages and RST (exploratory analysis shiny app) to figure out the best gage for each location
# We will likely new to do air to water temp modeling for this if no or not enough temp gage data
```

## Mill

```{r}
# source USGS
mill <- read_rds(here::here("data-raw", "standard-format-data-prep","temp_data", "mill_temp.rds"))
mill_format <- mill %>%
  mutate(stream = "mill creek",
         site = stream, 
         source = "CDEC MLM") %>%
   filter(mean_temp_degC > 0 & mean_temp_degC < 35) %>% 
glimpse()

mill_format %>% ggplot() + 
  geom_line(aes(x = date, y = mean_temp_degC), color = "gray") + 
  # geom_point(aes(x = date, y = mean_temp_degC), size = .001) +
  theme_minimal()
```

## Sacramento

```{r}
# TODO Big data gap for Sacramento gage data, need to do air temp modeling, check temperature_data_prep for potential gages (if not there use noaa data)
```

## Yuba

```{r}
#TODO need to do air temp modeling, check temperature_data_prep for potential gages (if not there use noaa data)
```

# Combine flow data {.tabset}

```{r}
combined_temp <- bind_rows(battle_format,
                           butte_format,
                           clear_format,
                           deer_format,
                           # feather_hfc_format,
                           # feather_lfc_format,
                           mill_format,
                           # yuba_format,
                           # knights_format,
                           # tisdale_format
                           ) %>%
  rename(mean_daily_temp_c  = mean_temp_degC) %>%
  glimpse()
```
## QA/QC

```{r}
unique(combined_temp$stream)
unique(combined_temp$site)
ggplot(combined_temp, aes(x = date, y = mean_daily_temp_c, color = site)) +
  theme_minimal() +
  geom_line() +
  facet_wrap(~stream)
filter(combined_temp, is.na(date))
combined_flow_clean <- filter(combined_temp, !is.na(date))
```

#TODO save to cloud in standard format data 

```{r, eval = FALSE}
# f <- function(input, output) write_csv(input, file = output)
# gcs_auth(json_file = Sys.getenv("GCS_AUTH_FILE"))
# gcs_global_bucket(bucket = Sys.getenv("GCS_DEFAULT_BUCKET"))
# gcs_upload(combined_flow_clean,
#            object_function = f,
#            type = "csv",
#            name = "standard-format-data/standard_temp.csv",
#            predefinedAcl = "bucketLevel")
# write_csv(combined_flow_clean, "../../data/standard-format-data/standard_temp.csv")
```
