---
title: "Covariate processing for stock recruit model"
output: html_document
date: "2023-12-21"
---

```{r setup, include=FALSE}
root.dir <- rprojroot::find_rstudio_root_file()
knitr::opts_knit$set(root.dir)
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(zoo)
```

# Overview

The goal of this document is to process covariates for use in SR JPE stock recruitment modeling. Initial literature review and planning has been completed to outline covariates that are expected to be important based on past research. This work can be found here: https://docs.google.com/spreadsheets/d/1Q4VUBE72KdPq0x65y_vUoDMj5dDHp8XwOyDNIyIJKpE/edit#gid=0

# Temperature

Temperature has been found to influence spawning and rearing. Therefore it is expected to affect the translation from stock to recruit. Temperature can be included in multiple different formats including:

- Number of degree days
- Day of year when 7DADM drops below 13 C
- Maximum weekly stream temperature
- Emergence date (calculated from degree days and median spawning date)

```{r, include=F}
# google cloud set up
gcs_auth(json_file = Sys.getenv("GCS_AUTH_FILE"))
gcs_global_bucket(bucket = Sys.getenv("GCS_DEFAULT_BUCKET"))

gcs_get_object(object_name = "standard-format-data/standard_temperature.csv",
               bucket = gcs_get_global_bucket(),
               saveToDisk = "data/standard-format-data/standard_temperature.csv",
               overwrite = TRUE)
standard_temperature <- read_csv("data/standard-format-data/standard_temperature.csv")
```

## Number of degree days (we are skipping this part for now)
DD= ((Tmax + Tmin / 2) - T0), where Tmax and Tmin are daily ambient temps, and T0 is the base or threshold temp
Citation: Chezik, Kyle & Lester, Nigel & Venturelli, Paul. (2014). Fish growth and degree-days I: Selecting a base temperature for a within-population study. Canadian Journal of Fisheries and Aquatic Sciences. 71. 47-55. 10.1139/cjfas-2013-0295. 
```{r}
# We are stating with Butte data because its ok and would be a good placeholder

butte_std_temp <- read.csv(here::here("data-raw", "standard-format-data-prep", "temp_data", "standard_temperature.csv")) |>
  filter(stream == "butte creek")


butte_std_temp$date <- as.Date(butte_std_temp$date)
glimpse(butte_std_temp)

#setting up by water years
butte_dd <- butte_std_temp |> 
  mutate(month= month(date), 
         wyear= ifelse(month %in% (10:12), year(date)+1, year(date))) |>  
  filter(month>=11 | month<=4) |> 
  mutate(degdays=((mean_daily_temp_c + max_daily_temp_c) / 2) - 2) 

butte_dd_sum <- butte_dd |> 
  group_by(wyear) |> 
  summarise(totalddays=sum(degdays))

#plotting
ggplot(butte_dd, aes(as.factor(wyear), degdays))+
  geom_boxplot()
ggplot(butte_dd_sum, aes(wyear, totalddays)) +
  geom_col()
?water_year_indices
```

## Day of year when 7DADM drops above/below 13 C
 
```{r}
# 1. hypothesized for spawning so select spawning time period 
# 2. calculate the 7DADM
# 3. identify the min date when drops below/above 13 C

std_temp_7dadm <- standard_temperature |> 
  filter(statistic == "max") |>  # can only calculate using the max temperature
  filter(month(date) %in% c(8:12)) |> 
  mutate(year = year(date)) |> # need to add year as grouping so that the rollingmean will apply to each year separately
  group_by(year, date, stream, site, subsite) |> 
  distinct() |> # there may be multiple records due to different data sources, this should be fixed in the data prep
  arrange(stream, site, subsite, date) |> 
  reframe(rolling_7DADM = rollmean(value, k = 7, align = "center", fill = "extend"))

# check resulting data
ck <- std_temp_7dadm |>
  group_by(stream, site, subsite) |>
  tally() |>
  left_join(
    standard_temperature |>
      filter(statistic == "max") |>  # can only calculate using the max temperature
      filter(month(date) %in% c(8:12)) |>
      group_by(stream, site, subsite) |>
      distinct() |> 
      tally() |>
      rename(n_check = n)
  )
filter(ck, n != n_check)

std_temp_7dadm_above_13 <- std_temp_7dadm |> 
  filter(rolling_7DADM > 13) |> 
  group_by(year, stream) |> 
  slice_min(date)

std_temp_7dadm_below_13 <- std_temp_7dadm |> 
  filter(rolling_7DADM < 13) |> 
  group_by(year, stream) |> 
  slice_min(date)



```

## Max temperature

```{r}
std_temp_weekly <- standard_temperature |> 
  filter(statistic == "max") |>  # can only calculate using the max temperature
  filter(month(date) %in% c(8:12)) |> 
```

## Emergence date

# Flow
Precipitation and streamflow have been found to influence spawning and rearing. Therefore it is expected to affect the translation from stock to recruit. Streamflow can be included in multiple different formats including:
- Mean precipitation (or streamflow)
- Max monthly precipitation (or streamflow)

TODO update this section with more information about sources if do literature review or add additional types

```{r, include=F}
# Flow data pull
# 1. Review ~/data-raw/standard-format-data-prep/flow_data_prep_files/flow_data_prep.Rmd
# 2. Source data prep
# source(knitr::purl(here::here("data-raw", "standard-format-data-prep", "flow_data_prep_files", "flow_data_prep.Rmd"), quiet=TRUE)) # after reviewing we will likely just source the data prep file here so you have access to all the data objects
```


## Mean flow

## Max flow


