---
title: "Covariate processing for stock recruit model"
output: html_document
date: "2023-12-21"
---

```{r setup, include=FALSE}
root.dir <- rprojroot::find_rstudio_root_file()
knitr::opts_knit$set(root.dir)
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(zoo)
```

# Overview

The goal of this document is to process covariates for use in SR JPE stock recruitment modeling. Initial literature review and planning has been completed to outline covariates that are expected to be important based on past research. This work can be found here: https://docs.google.com/spreadsheets/d/1Q4VUBE72KdPq0x65y_vUoDMj5dDHp8XwOyDNIyIJKpE/edit#gid=0

# Temperature

Temperature has been found to influence spawning and rearing. Therefore it is expected to affect the translation from stock to recruit. Temperature can be included in multiple different formats including:

- Number of degree days
- Day of year when 7DADM drops below 13 C
- Maximum weekly stream temperature
- Emergence date (calculated from degree days and median spawning date)

```{r, include=F}
# google cloud set up
gcs_auth(json_file = Sys.getenv("GCS_AUTH_FILE"))
gcs_global_bucket(bucket = Sys.getenv("GCS_DEFAULT_BUCKET"))

gcs_get_object(object_name = "standard-format-data/standard_temperature.csv",
               bucket = gcs_get_global_bucket(),
               saveToDisk = "data/standard-format-data/standard_temperature.csv",
               overwrite = TRUE)
standard_temperature <- read_csv("data/standard-format-data/standard_temperature.csv")
```

## Number of degree days (we are skipping this part for now)
DD= ((Tmax + Tmin / 2) - T0), where Tmax and Tmin are daily ambient temps, and T0 is the base or threshold temp
Citation: Chezik, Kyle & Lester, Nigel & Venturelli, Paul. (2014). Fish growth and degree-days I: Selecting a base temperature for a within-population study. Canadian Journal of Fisheries and Aquatic Sciences. 71. 47-55. 10.1139/cjfas-2013-0295. 
```{r}
# We are stating with Butte data because its ok and would be a good placeholder

# butte_std_temp <- read.csv(here::here("data-raw", "standard-format-data-prep", "temp_data", "standard_temperature.csv")) |>
#   filter(stream == "butte creek")
# 
# 
# butte_std_temp$date <- as.Date(butte_std_temp$date)
# glimpse(butte_std_temp)
# 
# #setting up by water years
# butte_dd <- butte_std_temp |> 
#   mutate(month= month(date), 
#          wyear= ifelse(month %in% (10:12), year(date)+1, year(date))) |>  
#   filter(month>=11 | month<=4) |> 
#   mutate(degdays=((mean_daily_temp_c + max_daily_temp_c) / 2) - 2) 
# 
# butte_dd_sum <- butte_dd |> 
#   group_by(wyear) |> 
#   summarise(totalddays=sum(degdays))
# 
# #plotting
# ggplot(butte_dd, aes(as.factor(wyear), degdays))+
#   geom_boxplot()
# ggplot(butte_dd_sum, aes(wyear, totalddays)) +
#   geom_col()
# ?water_year_indices
```

## Day of year when 7DADM drops above/below 13 C

- Includes day of the year and week when the 7DADM is above 13C
- Data are not filtered to the spawning time period (Aug-Dec) as this threshold is typically met before August
- Below 13C is not included as this does not make sense in terms of impact on salmon. Temperatures are rarely below 13C during the spawning time period and if they are, unlikely to be significantly cold enough to have an impact
- TODO - Currently do not have max daily temperatures for the Sacramento so mainstem is not included
 
```{r, include = F}
# 1. hypothesized for spawning so select spawning time period 
# 2. calculate the 7DADM
# 3. identify the min date when drops below/above 13 C

std_temp_7dadm <- standard_temperature |> 
  filter(statistic == "max") |>  # can only calculate using the max temperature
  #filter(month(date) %in% c(8:12)) |> 
  mutate(year = year(date)) |> # need to add year as grouping so that the rollingmean will apply to each year separately
  group_by(year, stream, site, subsite) |> 
  arrange(stream, site, subsite, date) |> 
  mutate(roll_7 = rollapply(value, 7, mean, align = "center", fill = NA))

# Use this to summarize rolling mean by week to fill in Nas
std_temp_7dadm_week <- std_temp_7dadm |> 
  mutate(week = week(date)) |> 
  group_by(week, stream, site, subsite, year) |> 
  summarize(mean_7dadm = mean(roll_7, na.rm = T))

# Fill in Nas with weekly mean
std_temp_7dadm_interpolated <- std_temp_7dadm |> 
  mutate(week = week(date)) |> 
  left_join(std_temp_7dadm_week) |> 
  mutate(roll_7 = ifelse(is.na(roll_7), mean_7dadm, roll_7))

#ck <- filter(std_temp_7dadm_interpolated, is.na(roll_7))
std_temp_7dadm_above_13 <- std_temp_7dadm_interpolated |> 
  filter(roll_7 > 13) |> 
  group_by(year, stream) |> 
  slice_min(date) |> 
  select(date, year, week, stream) |> 
  rename(above_13 = week)

std_temp_7dadm_below_13 <- std_temp_7dadm_interpolated |> 
  filter(roll_7 < 13) |> 
  group_by(year, stream) |> 
  slice_min(date) |> 
  select(date, year, week, stream) |> 
  rename(below_13 = week)
```

**Plot of week where threshold is met (above or below 13) for all years and streams**

```{r}
# Explore data
std_temp_7dadm_threshold <- full_join(std_temp_7dadm_above_13, 
                                      std_temp_7dadm_below_13) |> 
  pivot_longer(cols = c(above_13, below_13), values_to = "week", names_to = "threshold")
ggplot(std_temp_7dadm_threshold, aes(x = year, y = week, color = threshold)) +
  geom_point() +
  facet_wrap(~stream)
```

```{r}
std_temp_7dadm_final <- std_temp_7dadm_above_13 |> 
  rename(week = above_13) |> 
  mutate(day = yday(date)) |> 
  select(stream, date, day, week, year)
```

## Max temperature

- Summarizes the weekly maximum temperature for each stream (meaning it finds the max across all sites/subsites) across years. Note that the Sacramento River temperature data does not currently include a daily maximum so the weekly max is the max of the daily mean.
- Summarize the weekly max for each stream and year by finding the mean, median, and max.

```{r, include = F}
std_temp_weekly <- standard_temperature |> 
  filter(month(date) %in% c(8:12)) |> 
  mutate(week = week(date),
         year = year(date)) |> 
  group_by(week, year, stream) |> 
  summarize(w_max = max(value, na.rm = T)) |>  # find the max weekly temperature
  ungroup() |>
  group_by(stream, year) |> 
  summarize(max = max(w_max, na.rm = T),
            mean = mean(w_max, na.rm = T),
            median = median(w_max, na.rm = T)) |> 
  pivot_longer(cols = c(max, mean, median), names_to = "statistic", values_to = "weekly_max_temperature")
  
```
**Plot of mean, median, max of the maximum weekly temperature**

```{r}
std_temp_weekly |> 
  ggplot(aes(x = year, y = weekly_max_temperature, color = statistic)) +
  geom_line() +
  facet_wrap(~stream)
```

## Emergence date

# Flow
Precipitation and streamflow have been found to influence spawning and rearing. Therefore it is expected to affect the translation from stock to recruit. Streamflow can be included in multiple different formats including:
- Mean precipitation (or streamflow)
- Max monthly precipitation (or streamflow)

TODO update this section with more information about sources if do literature review or add additional types

```{r, include=F}
# Flow data pull
# 1. Review ~/data-raw/standard-format-data-prep/flow_data_prep_files/flow_data_prep.Rmd
# 2. Source data prep
# source(knitr::purl(here::here("data-raw", "standard-format-data-prep", "flow_data_prep_files", "flow_data_prep.Rmd"), quiet=TRUE)) # after reviewing we will likely just source the data prep file here so you have access to all the data objects
```


## Mean flow

## Max flow


