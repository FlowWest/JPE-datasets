---
title: "Covariate processing for stock recruit model"
output: html_document
date: "2023-12-21"
---

```{r setup, include=FALSE}
root.dir <- rprojroot::find_rstudio_root_file()
knitr::opts_knit$set(root.dir)
knitr::opts_chunk$set(echo = TRUE)
```

               
               
# Overview
Describe goal of document
Insert table of covariates and citations

# Temperature
Temperature has been found to influence spawning and rearing. Therefore it is expected to affect the translation from stock to recruit. Temperature can be included in multiple different formats including:
- Number of degree days
- Day of year when 7DADM drops below 13 C
- Maximum weekly stream temperature
- Emergence date (calculated from degree days and median spawning date)

TODO update this section with more information about sources if do literature review or add additional types

```{r, include=F}
# Temperature data pull
# 1. Review ~/data-raw/qc-markdowns/temperature_data_prep.Rmd
# 2. Source data prep
source(knitr::purl(here::here("data-raw", "qc-markdowns", "temperature_data_prep.Rmd"), quiet=TRUE)) # after reviewing we will likely just source the data prep file here so you have access to all the data objects

```

```{r}
# google cloud set up
gcs_auth(json_file = Sys.getenv("GCS_AUTH_FILE"))
gcs_global_bucket(bucket = Sys.getenv("GCS_DEFAULT_BUCKET"))

# get data from google cloud
gcs_get_object(object_name = "gs://jpe-dev-bucket/standard-format-data/standard_temperature.csv",
               bucket = gcs_get_global_bucket(),
               saveToDisk =  here::here("data-raw", "standard-format-data-prep", "standard_temperature.csv"),
               overwrite = TRUE)
#saving data
strd_temp <- read.csv(here::here("data-raw", "standard-format-data-prep", "temp_data", "standard_temperature.csv"))
glimpse(strd_temp)
```

```{r}
# #For now, pulling Temp data from jpe-dev-bucket
# source(knitr::purl(here::here("data-raw", "standard-format-data-prep", "temp_data", "standard_temperature.csv"), quiet=TRUE))


```

## Number of degree days (we are skipping this part for now)
DD= ((Tmax + Tmin / 2) - T0), where Tmax and Tmin are daily ambient temps, and T0 is the base or threshold temp
Citation: Chezik, Kyle & Lester, Nigel & Venturelli, Paul. (2014). Fish growth and degree-days I: Selecting a base temperature for a within-population study. Canadian Journal of Fisheries and Aquatic Sciences. 71. 47-55. 10.1139/cjfas-2013-0295. 
```{r}
# We are stating with Butte data because its ok and would be a good placeholder

butte_std_temp <- read.csv(here::here("data-raw", "standard-format-data-prep", "temp_data", "standard_temperature.csv")) |>
  filter(stream == "butte creek")


butte_std_temp$date <- as.Date(butte_std_temp$date)
glimpse(butte_std_temp)

#setting up by water years
butte_dd <- butte_std_temp |> 
  mutate(month= month(date), 
         wyear= ifelse(month %in% (10:12), year(date)+1, year(date))) |>  
  filter(month>=11 | month<=4) |> 
  mutate(degdays=((mean_daily_temp_c + max_daily_temp_c) / 2) - 2) 

butte_dd_sum <- butte_dd |> 
  group_by(wyear) |> 
  summarise(totalddays=sum(degdays))

#plotting
ggplot(butte_dd, aes(as.factor(wyear), degdays))+
  geom_boxplot()
ggplot(butte_dd_sum, aes(wyear, totalddays)) +
  geom_col()
?water_year_indices
```


## Day of year when 7DADM drops below 13 C
#Butte Creek
```{r}
#Filtering Butte data 
butte_std_temp <- read.csv(here::here("data-raw", "standard-format-data-prep", "temp_data", "standard_temperature.csv")) |>
  filter(stream == "butte creek")

#Changing "date" field into date format
butte_std_temp$date <- as.Date(butte_std_temp$date)
glimpse(butte_std_temp)

#Extracting spawning months (Aug-Dec)
butte_std_temp <- butte_std_temp |> 
  mutate(month = format(date, "%m"))
spawning_months <- c("08", "09", "10", "11", "12")

butte_spawn_temps <- butte_std_temp |> 
  filter(month%in%spawning_months) |> 
  filter(date!= as.Date("2000-12-09"))  #removes one day with NA max temp 

#Making sure we only have the months we need 
table(butte_spawn_temps$month)

#Delete "month field" 
butte_spawn_temps |> select(-month)

#Calculating Butte 7DADM
butte_7dadm <-  butte_spawn_temps |> 
  mutate(rolling_7DADM = zoo::rollmean(max_daily_temp_c, k = 7, align = "center", fill = NA)) #There are 6 N/A values corresponding to the first and last three values that are unable to calculate rollmean 


glimpse(butte_spawn_temps)

#Filtering days when 7DADM is below 13C
filter(butte_7dadm, rolling_7DADM < 13)

#plotting 

```
#Battle
```{r}
#Filtering  data 
battle_std_temp <- read.csv(here::here("data-raw", "standard-format-data-prep", "temp_data", "standard_temperature.csv")) |>
  filter(stream == "battle creek")

#Changing "date" field into date format
battle_std_temp$date <- as.Date(battle_std_temp$date)
glimpse(battle_std_temp)

#Extracting spawning months (Aug-Dec)
battle_std_temp <- battle_std_temp |> 
  mutate(month = format(date, "%m"))
spawning_months <- c("08", "09", "10", "11", "12")

battle_spawn_temps <- battle_std_temp |> 
  filter(month %in% spawning_months) 

#Making sure we only have the months we need 
table(battle_spawn_temps$month)

#Delete "month field" TODO
#  butte_spawn_temps |> select(-month)
# glimpse(butte_spawn_temps)

#Calculating Butte 7DADM
battle_7dadm <-  battle_spawn_temps |> 
  mutate(rolling_7DADM = zoo::rollmean(max_daily_temp_c, k = 7, align = "center", fill = NA))

glimpse(butte_7dadm)
#TODO check why NAs are happening on 7DADM

#Filtering days when 7DADM is below 13C
filter(battle_7dadm, rolling_7DADM < 13)
```
#Clear Creek
```{r}
#Filtering  data 
clear_std_temp <- read.csv(here::here("data-raw", "standard-format-data-prep", "temp_data", "standard_temperature.csv")) |>
  filter(stream == "battle creek")

#Changing "date" field into date format
clear_std_temp$date <- as.Date(clear_std_temp$date)
glimpse(battle_std_temp)

#Extracting spawning months (Aug-Dec)
clear_std_temp <- clear_std_temp |> 
  mutate(month = format(date, "%m"))
spawning_months <- c("08", "09", "10", "11", "12")

clear_spawn_temps <- clear_std_temp |> 
  filter(month %in% spawning_months) 

#Making sure we only have the months we need 
table(clear_spawn_temps$month)

#Delete "month field" TODO
#  butte_spawn_temps |> select(-month)
# glimpse(butte_spawn_temps)

#Calculating Butte 7DADM
clear_7dadm <-  clear_spawn_temps |> 
  mutate(rolling_7DADM = zoo::rollmean(max_daily_temp_c, k = 7, align = "center", fill = NA))

glimpse(clear_7dadm)
#TODO check why NAs are happening on 7DADM
clear_7dadm <- sum(is.na(clear_7dadm$rolling_7DADM))

#Filtering days when 7DADM is below 13C
filter(clear_7dadm, rolling_7DADM < 13)
```

## Max temperature

```{r}

```

## Emergence date

# Flow
Precipitation and streamflow have been found to influence spawning and rearing. Therefore it is expected to affect the translation from stock to recruit. Streamflow can be included in multiple different formats including:
- Mean precipitation (or streamflow)
- Max monthly precipitation (or streamflow)

TODO update this section with more information about sources if do literature review or add additional types

```{r, include=F}
# Flow data pull
# 1. Review ~/data-raw/standard-format-data-prep/flow_data_prep_files/flow_data_prep.Rmd
# 2. Source data prep
# source(knitr::purl(here::here("data-raw", "standard-format-data-prep", "flow_data_prep_files", "flow_data_prep.Rmd"), quiet=TRUE)) # after reviewing we will likely just source the data prep file here so you have access to all the data objects
```


## Mean flow

## Max flow


