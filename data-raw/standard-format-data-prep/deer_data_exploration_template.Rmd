---
title: "[Watershed] [Data type] [QC]"
author: "Badhia Yunes Katz"
date: "01/25/2024"
output: rmarkdown::github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, fig.width=15, fig.height=10)
library(tidyverse)
library(lubridate)
library(googleCloudStorageR)
library(ggplot2)
library(scales)
library(RODBC)
library(chron)
library(weathermetrics)
library(CDECRetrieve)
library(hms)
library(dplyr)
```

# Deer Creek [Data type long version]

## Description of Monitoring Data

**Timeframe:** CDEC- 1998-2024, Logger- 2001-2018

**Video Season:** 

**Completeness of Record throughout timeframe:** 
Missing years from logger: 2003, 2004, 2005
Missing years from CDEC: 1997

**Sampling Location:** Deer Creek

**Data Contact:** 

Any additional info?

## Access Cloud Data

```{r, eval=FALSE}
# Run Sys.setenv() to specify GCS_AUTH_FILE and GCS_DEFAULT_BUCKET before running 
# getwd() to see how to specify paths 
# Open object from google cloud storage
# Set your authentication using gcs_auth
gcs_auth(json_file = Sys.getenv("GCS_AUTH_FILE"))
# Set global bucket 
gcs_global_bucket(bucket = Sys.getenv("GCS_DEFAULT_BUCKET"))

```

Read in data from google cloud, glimpse raw data and domain description sheet: 
```{r}
# read in data to clean 

gcs_get_object(object_name = "environmental/data-raw/MASTER_TEMPERATURE.mdb",
               bucket = gcs_get_global_bucket(),
               saveToDisk = "MASTER_TEMPERATURE.mdb",
               overwrite = TRUE)

master_temp_deer_mill <- odbcConnectAccess2007(here::here("data-raw", "standard-format-data-prep", "MASTER_TEMPERATURE.mdb"))


```

## Data transformations

```{r, include=FALSE}
# Pulling all Deer tables from logger 

tables <- sqlTables(master_temp_deer_mill)


deer_1 <- sqlFetch(master_temp_deer_mill,"Deer 9-0 Mouth") |> 
  mutate(date = as_date(Date)) |>                                            #Transforming columns to appropriate types
  mutate(temperature = fahrenheit.to.celsius(Temperature, round = 1)) |> 
  mutate(year = lubridate::year(Date)) |> 
  select(-Date, -Time, -"Primary ID", -"Sort ID", -"Logger ID", -"Place ID") # Remove redundant columns
# Finding Logger mean "Deer 9-0 Mouth"
deer_1_monthly_mean <- deer_1 |> 
  group_by(month = month(date),
           year = year(date)) |> 
  mutate(month = factor(month)) |> 
  summarise(mean_temp = mean(temperature, na.rm = TRUE))

deer_2 <- sqlFetch(master_temp_deer_mill, "Deer 9-1 VIDEO Station SV Dam")|> 
  mutate(date = as_date(Date)) |> 
  mutate(temperature = fahrenheit.to.celsius(Temperature, round = 1)) |> 
  mutate(year = lubridate::year(Date)) |> 
  select(-Date, -Time, -"Primary ID", -"Sort ID", -"Logger ID", -"Place ID")
# Finding Logger mean "Deer 9-1 VIDEO Station SV Dam"
deer_2_monthly_mean <- deer_2 |> 
  group_by(month = month(date),
           year = year(date)) |> 
  mutate(month = factor(month)) |>
  summarise(mean_temp = mean(temperature, na.rm = TRUE))

deer_3 <- sqlFetch(master_temp_deer_mill, "Deer 9-2 Trail 2E17")|> 
  mutate(date = as_date(Date)) |> 
  mutate(temperature = fahrenheit.to.celsius(Temperature, round = 1)) |> 
  mutate(year = lubridate::year(Date)) |> 
  select(-Date, -Time, -"Primary ID", -"Sort ID", -"Logger ID", -"Place ID")
# Finding Logger mean "Deer 9-2 Trail 2E17"
deer_3_monthly_mean <- deer_3 |> 
  group_by(month = month(date),
           year = year(date)) |> 
  mutate(month = factor(month)) |>
  summarise(mean_temp = mean(temperature, na.rm = TRUE))  

deer_4 <- sqlFetch(master_temp_deer_mill, "Deer 9-3 Beaver Cr")|> 
  mutate(date = as_date(Date)) |> 
  mutate(temperature = fahrenheit.to.celsius(Temperature, round = 1)) |> 
  mutate(year = lubridate::year(Date)) |> 
  select(-Date, -Time, -"Primary ID", -"Sort ID", -"Logger ID", -"Place ID")
# Finding Logger mean "Deer 9-3 Beaver Cr"
deer_4_monthly_mean <- deer_4 |> 
  group_by(month = month(date),
           year = year(date)) |> 
  mutate(month = factor(month)) |>
  summarise(mean_temp = mean(temperature, na.rm = TRUE)) 
  
deer_5 <- sqlFetch(master_temp_deer_mill, "Deer 9-4 Murphy Trail")|> 
  mutate(date = as_date(Date)) |> 
  mutate(temperature = fahrenheit.to.celsius(Temperature, round = 1)) |> 
  mutate(year = lubridate::year(Date)) |> 
  select(-Date, -Time, -"Primary ID", -"Sort ID", -"Logger ID", -"Place ID")
# Finding Logger mean "Deer 9-4 Murphy Trail"
deer_5_monthly_mean <- deer_5 |> 
   group_by(month = month(date),
           year = year(date)) |> 
  mutate(month = factor(month)) |>
  summarise(mean_temp = mean(temperature, na.rm = TRUE))  
  
deer_6 <- sqlFetch(master_temp_deer_mill, "Deer 9-5 Wilson Cove")|> 
  mutate(date = as_date(Date)) |> 
  mutate(temperature = fahrenheit.to.celsius(Temperature, round = 1)) |> 
  mutate(year = lubridate::year(Date)) |> 
  select(-Date, -Time, -"Primary ID", -"Sort ID", -"Logger ID", -"Place ID")
# Finding Logger mean "Deer 9-5 Wilson Cove"
deer_6_monthly_mean <- deer_6 |> 
  group_by(month = month(date),
           year = year(date)) |> 
  mutate(month = factor(month)) |>
  summarise(mean_temp = mean(temperature, na.rm = TRUE))  

deer_7 <- sqlFetch(master_temp_deer_mill, "Deer 9-6 C-Pool")|> 
  mutate(date = as_date(Date)) |> 
  mutate(temperature = fahrenheit.to.celsius(Temperature, round = 1)) |> 
  mutate(year = lubridate::year(Date)) |> 
  select(-Date, -Time, -"Primary ID", -"Sort ID", -"Logger ID", -"Place ID")
# Finding Logger mean "Deer 9-6 C-Pool"
deer_7_monthly_mean <- deer_7 |> 
  group_by(month = month(date),
           year = year(date)) |> 
  mutate(month = factor(month)) |>
  summarise(mean_temp = mean(temperature, na.rm = TRUE)) 

deer_8 <- sqlFetch(master_temp_deer_mill, "Deer 9-7 Upper Falls")|> 
  mutate(date = as_date(Date)) |> 
  mutate(temperature = fahrenheit.to.celsius(Temperature, round = 1)) |> 
  mutate(year = lubridate::year(Date)) |> 
  select(-Date, -Time, -"Primary ID", -"Sort ID", -"Logger ID", -"Place ID")
# Finding Logger mean "Deer 9-6 C-Pool"
deer_8_monthly_mean <- deer_8 |> 
  group_by(month = month(date),
           year = year(date)) |> 
  mutate(month = factor(month)) |>
  summarise(mean_temp = mean(temperature, na.rm = TRUE))

#There are these tables too that we won't use to compare data because they are from CDEC stations
#Deer 9-05 DVD lower CDEC, Deer 9-15 DVC upper CDEC
# deer_logger_cdec <- sqlFetch(deer_mill, "Deer 9-15 DCV upper CDEC")|> 
#   mutate(date = as_date(Date))
# deer_logger_cdec2 <- sqlFetch(deer_mill, "Deer 9-05 DVD lower CDEC")|> 
#   mutate(date = as_date(Date))

combined_table <- bind_rows(deer_1, deer_2, deer_3 ,deer_4, deer_5, deer_6, deer_7, deer_8, .id = "deer_site")

#adding CDEC data to plot with it and compare
DCV_CDEC <- cdec_query(station = "DCV", dur_code = "H", sensor_num = "25", start_date = "1995-01-01")

DCV_hourly_temps <- DCV_CDEC |> 
  mutate(date = as_date(datetime),
         temp_degC = fahrenheit.to.celsius(parameter_value, round = 1)) |>
  filter(temp_degC < 37, temp_degC > 0) |> #Filtered out outliers using temp range of 0-37 degrees Celsius 
  rename(temperature = temp_degC)

```


Data is missing for the following years:
  - 2003
  - 2004
  - 2005

```{r, include=FALSE}
#From Loggers
combined_table$year <- year(combined_table$date)

unique_years <- unique(combined_table$year)

all_years <- 2001:2018


missing_years <- setdiff(all_years, unique_years)

if (length(missing_years) == 0) {
  print("No missing years, dataset covers all years from 1997 to 2020.")
} else {
  print(paste("Missing years:", missing_years))
}

```

## Explore Numeric Variables: {.tabset}

### Variable: `Temperature`

**Plotting Temperature over Period of Record**

Checking Deer data sites from logger:

  - Data gap from 2003-2006
  - No concerning outliers
  - Temperature ranges between 0-30 degree Celcius 
  
```{r, echo=FALSE}
#checking temporal coverage across deer sites from logger
deer_plot_logger <- ggplot(combined_table, aes(x = date, y = temperature, color = "Logger data")) +
  geom_line(color = "darkred") +
  labs(title = "Deer temp plot from Logger data", y = "Temperature (deg C)", color = "Data Source") +
  scale_x_date(date_breaks = "2 years", date_labels = "%Y")

print(deer_plot_logger)
```

This plot shows the coverage of all logger data from Deer sites and CDEC

Red color shows logger data and blue shows CDEC data

```{r, echo=TRUE}
# Create the combined plot of all logger Deer sites and CDEC
combined_CDEC_logger_plot <- deer_plot_logger +
   geom_line(data = DCV_hourly_temps, aes(x = date, y = temperature, color = "CDEC data")) +
   scale_color_manual(values = c("blue", "darkred")) +
   labs(title = "Combined Plot to See Temporal coverage - Deer Logger and CDEC Data", y = "Temperature (deg C)", color = "Data Source")
print(combined_CDEC_logger_plot)
```


Plot showing CDEC (DVC station) mean temperatures

```{r, echo=FALSE}
#CDEC mean temp
DCV_mean_temp <- DCV_hourly_temps |> 
  group_by(month = month(date),
           year = format(date, "%Y")) |> 
  summarise(mean_temp = mean(temperature, na.rm = TRUE))

#Checking if data in all years from CDEC
unique_years_CDEC <- unique(DCV_mean_temp$year)

# Generate a sequence of years from 1997 to 2020
all_years_CDEC <- 1997:2020

# Check which years from 1997 to 2020 are missing in the dataset
missing_years_CDEC <- setdiff(all_years_CDEC, unique_years_CDEC)

# Print out the missing years, if any
if (length(missing_years_CDEC) == 0) {
  print("No missing years, dataset covers all years from 1997 to 2020.")
} else {
  print(paste("Missing years:", missing_years_CDEC))
}

```
## Plot comparing CDEC DCV mean temperature and logger data from Deer 9-0 Mouth (2013-2018)

Comments: 


  
Recommendation: 



```{r, echo=FALSE}
#For context, DCV Station is lower than Dillon Cove and 9-2 trail, on an elevation of ~520'

#plotting means from Deer 9-0 Mouth + CDEC 
DCV_filtered1 <- DCV_mean_temp |> 
  mutate(month = factor(month)) |> 
  filter(year >= 2013, year <= 2018)
ggplot() +
  geom_boxplot(data = DCV_filtered1, aes(x = month, y = mean_temp)) +
  labs(title = "Monthly Mean Temperatures Comparison CDEC and Deer 9-0 Mouth (2013-2018)",
       y = "Mean Temperature (deg C)",
       x = "Month") +
  geom_boxplot(data = deer_1_monthly_mean, aes(x = month, y = mean_temp), fill = "red")
#Logger data similar to CDEC, however this might be lower in the stream, closer to the Sacramento confluence. Recommendation is to use logger from higher up, where adult fish spawn
```



## Plot comparing CDEC DCV mean temperature and logger data from Deer 9-1 VIDEO Station SV Dam (2014-2018)

Comments: 


  
Recommendation: 

```{r, echo=FALSE}
#plotting means from Deer 9-1 VIDEO Station SV Dam + CDEC 
DCV_filtered2 <- DCV_mean_temp |> 
  mutate(month = factor(month)) |> 
  filter(year >= 2014, year <= 2018)
ggplot() +
  geom_boxplot(data = DCV_filtered2, aes(x = month, y = mean_temp)) +
  labs(title = "Monthly Mean Temperatures Comparison CDEC and Deer 9-1 VIDEO Station SV Dam (2014-2018)",
       y = "Mean Temperature (deg C)",
       x = "Month") +
  geom_boxplot(data = deer_2_monthly_mean, aes(x = month, y = mean_temp), fill = "red")
#Plot shows very similar data ranges than CDEC data. However, interquartile range is higher than other logger sites, and CDEC, which could make this dataset a little less reliable.
```



## Plot comparing CDEC DCV mean temperature and logger data from Deer 9-2 Trail 2E17 (2001-2018)

Comments: 


  
Recommendation: 

```{r, echo=FALSE}
#plotting means from "Deer 9-2 Trail 2E17" + CDEC 
DCV_filtered3 <- DCV_mean_temp |> 
  mutate(month = factor(month)) |> 
  filter(year >= 2001, year <= 2018)
ggplot()+
  geom_boxplot(data = DCV_filtered3, aes(x = month, y = mean_temp)) +
  labs(title = "Monthly Mean Temperatures Comparison CDEC and Deer 9-2 Trail 2E17 (2001-2018)",
       y = "Mean Temperature (deg C)",
       x = "Month") +
  geom_boxplot(data = deer_3_monthly_mean, aes(x = month, y = mean_temp), fill = "red")
#Logger temperatures are slightly lower than CDEC, there is a consistent range temperature difference. The widest temperature difference is during the summer (Jun, Jul, Aug) with about mean temperature difference of ~ 3.5 degrees C. This Lower temperature is expected since the elevation change is of over 1000'.
#Suggestion: this data could be used to represent higher up the stream from CDEC
```



## Plot comparing CDEC DCV mean temperature and logger data from Deer 9-3 Beaver Cr (2001-2018)

Comments: 


  
Recommendation: 

```{r, echo=FALSE}
#plotting means from "Deer 9-3 Beaver Cr" + CDEC 
DCV_filtered4 <- DCV_mean_temp |> 
  mutate(month = factor(month)) |> 
  filter(year >= 2001, year <= 2018)
ggplot()+
  geom_boxplot(data = DCV_filtered4, aes(x = month, y = mean_temp)) +
  labs(title = "Monthly Mean Temperatures Comparison CDEC and Deer 9-3 Beaver Cr (2001-2018)",
       y = "Mean Temperature (deg C)",
       x = "Month") +
  geom_boxplot(data = deer_4_monthly_mean, aes(x = month, y = mean_temp), fill = "red")
#Logger temperatures are lower than CDEC, there temperature range difference is a bit inconsistent throughout the year. Summer month ranges are the most different than the logger (Jun, Jul, Aug, Sept). However, temperatures for February seem to have a relatively small range (>1 degree C), which suggests some data in from that month might be inaccurate.
#Suggestion: This logger can be used to represent higher up the stream from CDEC, or used as complement to Murphy Trail site, depending on the purpose of data use, due to their proximity.
```



## Plot comparing CDEC DCV mean temperature and logger data from Deer 9-4 Murphy Trail (2001-2018)

Comments: 


  
Recommendation: 

```{r, echo=FALSE}
#plotting means from "Deer 9-4 Murphy Trail" + CDEC 
DCV_filtered5 <- DCV_mean_temp |> 
  mutate(month = factor(month)) |> 
  filter(year >= 2001, year <= 2018)
ggplot()+
  geom_boxplot(data = DCV_filtered5, aes(x = month, y = mean_temp)) +
  labs(title = "Monthly Mean Temperatures Comparison CDEC and Deer 9-4 Murphy Trail (2001-2018)",
       y = "Mean Temperature (deg C)",
       x = "Month") +
  geom_boxplot(data = deer_5_monthly_mean, aes(x = month, y = mean_temp), fill = "red")
#The overall temperature ranges starts to become significantly smaller than the overall temperature range from CDEC. The mean max temperature is ~20 degrees C, and the mean min is ~3.4 degrees C. CDEC's range is ~4.16 C to 25.5 C
```



## Plot comparing CDEC DCV mean temperature and logger data from Deer 9-5 Wilson Cove (2001-2018)

Comments: 


  
Recommendation: 

```{r, echo=FALSE}
#plotting means from "Deer 9-5 Wilson Cove" + CDEC 
DCV_filtered6 <- DCV_mean_temp |> 
  mutate(month = factor(month)) |> 
  filter(year >= 2001, year <= 2018)
ggplot()+
  geom_boxplot(data = DCV_filtered6, aes(x = month, y = mean_temp)) +
  labs(title = "Monthly Mean Temperatures Comparison CDEC and Deer 9-5 Wilson Cove (2001-2018)",
       y = "Mean Temperature (deg C)",
       x = "Month") +
  geom_boxplot(data = deer_6_monthly_mean, aes(x = month, y = mean_temp), fill = "red")
#The overall temperature ranges starts to become significantly smaller than the overall temperature range from CDEC. This is reasonable as this station continues to be higher up the stream. The mean max temperature is ~18 degrees C, and the mean min is ~2.7 degrees C. CDEC's range is ~4.16 C to 25.5 C. 
#Recommend to use this logger data since coverage is different than CDEC and does not seem to have unreasonable overall temperature values, also the area where data was collected is were adult fish spawning happens
```



## Plot comparing CDEC DCV mean temperature and logger data from Deer 9-6 C-Pool (2001-2018)

Comments: 


  
Recommendation: 

```{r, echo=FALSE}
#plotting means from "Deer 9-6 C-Pool" + CDEC 
DCV_filtered7 <- DCV_mean_temp |> 
  mutate(month = factor(month)) |> 
  filter(year >= 2001, year <= 2018)
ggplot()+
  geom_boxplot(data = DCV_filtered7, aes(x = month, y = mean_temp)) +
  labs(title = "Monthly Mean Temperatures Comparison CDEC and Deer 9-6 C-Pool (2001-2018)",
       y = "Mean Temperature (deg C)",
       x = "Month") +
  geom_boxplot(data = deer_7_monthly_mean, aes(x = month, y = mean_temp), fill = "red")

#The overall temperature ranges starts to become significantly smaller than the overall temperature range from CDEC. This is reasonable as this station continues to be higher up the stream. The mean max temperature is ~18 degrees C, and the mean min is ~2.7 degrees C. CDEC's range is ~2.87 C to 17.3 C. 
#Recommend to use this logger data since coverage is different than CDEC and does not seem to have unreasonable overall temperature values, also the area where data was collected is were adult fish spawning happens
```



## Plot comparing CDEC DCV mean temperature and logger data from Upper Falls (2013-2018)

Comments: 


  
Recommendation: 

```{r, echo=FALSE}
#plotting means from "Deer 9-7 Upper Falls" + CDEC 
DCV_filtered8 <- DCV_mean_temp |> 
  mutate(month = factor(month)) |> 
  filter(year >= 2013, year <= 2018)
ggplot() +
  geom_boxplot(data = DCV_filtered8, aes(x = month, y = mean_temp)) +
  labs(title = "Monthly Mean Temperatures Comparison CDEC and Upper Falls (2013-2018)",
       y = "Mean Temperature (deg C)",
       x = "Month") +
  geom_boxplot(data = deer_8_monthly_mean, aes(x = month, y = mean_temp), fill = "red")
## Observations: Upper Falls appears to have much lower temperatures compared to other logger sites and also CDEC data, we can assume that this due to the location of Upper Falls, higher up in the Feather river system where altitude is higher than closer to Sacramento confluence. 
#Temperature ranges are generally smaller than data from other logger sites. The highest summer temps are ~14 C and the highest temps during winter (Dec, Jan, Feb) are below 5 degrees C
#Recommend to use this logger data since it is in area of adult fish spawning
```

**Numeric Summary of [Variable] over Period of Record**

```{r}
# Table with summary statistics
```

**NA and Unknown Values**

Provide a stat on NA or unknown values
```{r}
combined_means_deer <- bind_rows(deer_1_monthly_mean, deer_2_monthly_mean, deer_3_monthly_mean, deer_4_monthly_mean, deer_5_monthly_mean, deer_6_monthly_mean, deer_7_monthly_mean, deer_8_monthly_mean, .id = "mill_site")

sum(is.na(combined_means_deer$mean_temp)) #no NA's

sum(is.na(DCV_mean_temp$mean_temp)) #no NA's
```



### Variable: `[name]`
```{r}
#table() 
```

Fix inconsistencies with spelling, capitalization, and abbreviations. 

```{r}
# Fix any inconsistencies with categorical variables
```

**Create lookup rda for [variable] encoding:** 
```{r}
# Create named lookup vector
# Name rda [watershed]_[data type]_[variable_name].rda
# save rda to data/ 
```

**NA and Unknown Values**

Provide a stat on NA or unknown values

## Summary of identified issues

* List things that are funcky/bothering us but that we don't feel like should be changed without more investigation

## Save cleaned data back to google cloud 

```{r}
# Write to google cloud 
# Name file [watershed]_[data type].csv
```