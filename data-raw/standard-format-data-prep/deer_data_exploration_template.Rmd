---
title: "[Watershed] [Data type] [QC]"
author: "Badhia Yunes Katz"
date: "01/25/2024"
output: rmarkdown::github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, fig.width=15, fig.height=10)
library(tidyverse)
library(lubridate)
library(googleCloudStorageR)
library(ggplot2)
library(scales)
library(RODBC)
library(chron)
library(weathermetrics)
library(CDECRetrieve)
library(hms)
library(dplyr)
```

# Deer Creek [Data type long version]

## Description of Monitoring Data

**Timeframe:** 1998-2019

**Video Season:** 

**Completeness of Record throughout timeframe:** no data gaps

**Sampling Location:** Deer Creek

**Data Contact:** 

Any additional info?

## Access Cloud Data

```{r, eval=FALSE}
# Run Sys.setenv() to specify GCS_AUTH_FILE and GCS_DEFAULT_BUCKET before running 
# getwd() to see how to specify paths 
# Open object from google cloud storage
# Set your authentication using gcs_auth
gcs_auth(json_file = Sys.getenv("GCS_AUTH_FILE"))
# Set global bucket 
gcs_global_bucket(bucket = Sys.getenv("GCS_DEFAULT_BUCKET"))

```

Read in data from google cloud, glimpse raw data and domain description sheet: 
```{r}
# read in data to clean 

gcs_get_object(object_name = "environmental/data-raw/MASTER_TEMPERATURE.mdb",
               bucket = gcs_get_global_bucket(),
               saveToDisk = "MASTER_TEMPERATURE.mdb",
               overwrite = TRUE)

master_temp_deer_mill <- odbcConnectAccess2007(here::here("data-raw", "standard-format-data-prep", "MASTER_TEMPERATURE.mdb"))


```

## Data transformations

```{r}
# Pulling all Deer tables from logger 

tables <- sqlTables(master_temp_deer_mill)


deer_1 <- sqlFetch(master_temp_deer_mill,"Deer 9-0 Mouth") |> 
  mutate(date = as_date(Date)) |>                                            #Transforming columns to appropriate types
  mutate(temperature = fahrenheit.to.celsius(Temperature, round = 1)) |> 
  mutate(year = lubridate::year(Date)) |> 
  select(-Date, -Time, -"Primary ID", -"Sort ID", -"Logger ID", -"Place ID") # Remove redundant columns
# Finding Logger mean "Deer 9-0 Mouth"
deer_1_monthly_mean <- deer_1 |> 
  group_by(month = format(date, "%Y-%m"),
           year = format(date, "%Y")) |> 
  summarise(mean_temp = mean(temperature, na.rm = TRUE))

deer_2 <- sqlFetch(master_temp_deer_mill, "Deer 9-1 VIDEO Station SV Dam")|> 
  mutate(date = as_date(Date)) |> 
  mutate(temperature = fahrenheit.to.celsius(Temperature, round = 1)) |> 
  mutate(year = lubridate::year(Date)) |> 
  select(-Date, -Time, -"Primary ID", -"Sort ID", -"Logger ID", -"Place ID")
# Finding Logger mean "Deer 9-1 VIDEO Station SV Dam"
deer_2_monthly_mean <- deer_2 |> 
  group_by(month = format(date, "%Y-%m"),
           year = format(date, "%Y")) |> 
  summarise(mean_temp = mean(temperature, na.rm = TRUE))

deer_3 <- sqlFetch(master_temp_deer_mill, "Deer 9-2 Trail 2E17")|> 
  mutate(date = as_date(Date)) |> 
  mutate(temperature = fahrenheit.to.celsius(Temperature, round = 1)) |> 
  mutate(year = lubridate::year(Date)) |> 
  select(-Date, -Time, -"Primary ID", -"Sort ID", -"Logger ID", -"Place ID")
# Finding Logger mean "Deer 9-2 Trail 2E17"
deer_3_monthly_mean <- deer_3 |> 
  group_by(month = format(date, "%Y-%m"),
           year = format(date, "%Y")) |> 
  summarise(mean_temp = mean(temperature, na.rm = TRUE))  

deer_4 <- sqlFetch(master_temp_deer_mill, "Deer 9-3 Beaver Cr")|> 
  mutate(date = as_date(Date)) |> 
  mutate(temperature = fahrenheit.to.celsius(Temperature, round = 1)) |> 
  mutate(year = lubridate::year(Date)) |> 
  select(-Date, -Time, -"Primary ID", -"Sort ID", -"Logger ID", -"Place ID")
# Finding Logger mean "Deer 9-3 Beaver Cr"
deer_4_monthly_mean <- deer_4 |> 
  group_by(month = format(date, "%Y-%m"),
           year = format(date, "%Y")) |> 
  summarise(mean_temp = mean(temperature, na.rm = TRUE))  
  
deer_5 <- sqlFetch(master_temp_deer_mill, "Deer 9-4 Murphy Trail")|> 
  mutate(date = as_date(Date)) |> 
  mutate(temperature = fahrenheit.to.celsius(Temperature, round = 1)) |> 
  mutate(year = lubridate::year(Date)) |> 
  select(-Date, -Time, -"Primary ID", -"Sort ID", -"Logger ID", -"Place ID")
# Finding Logger mean "Deer 9-4 Murphy Trail"
deer_5_monthly_mean <- deer_5 |> 
  group_by(month = format(date, "%Y-%m"),
           year = format(date, "%Y")) |> 
  summarise(mean_temp = mean(temperature, na.rm = TRUE))  
  
deer_6 <- sqlFetch(master_temp_deer_mill, "Deer 9-5 Wilson Cove")|> 
  mutate(date = as_date(Date)) |> 
  mutate(temperature = fahrenheit.to.celsius(Temperature, round = 1)) |> 
  mutate(year = lubridate::year(Date)) |> 
  select(-Date, -Time, -"Primary ID", -"Sort ID", -"Logger ID", -"Place ID")
# Finding Logger mean "Deer 9-5 Wilson Cove"
deer_6_monthly_mean <- deer_6 |> 
  group_by(month = format(date, "%Y-%m"),
           year = format(date, "%Y")) |> 
  summarise(mean_temp = mean(temperature, na.rm = TRUE))  

deer_7 <- sqlFetch(master_temp_deer_mill, "Deer 9-6 C-Pool")|> 
  mutate(date = as_date(Date)) |> 
  mutate(temperature = fahrenheit.to.celsius(Temperature, round = 1)) |> 
  mutate(year = lubridate::year(Date)) |> 
  select(-Date, -Time, -"Primary ID", -"Sort ID", -"Logger ID", -"Place ID")
# Finding Logger mean "Deer 9-6 C-Pool"
deer_7_monthly_mean <- deer_7 |> 
  group_by(month = format(date, "%Y-%m"),
           year = format(date, "%Y")) |> 
  summarise(mean_temp = mean(temperature, na.rm = TRUE)) 

deer_8 <- sqlFetch(master_temp_deer_mill, "Deer 9-7 Upper Falls")|> 
  mutate(date = as_date(Date)) |> 
  mutate(temperature = fahrenheit.to.celsius(Temperature, round = 1)) |> 
  mutate(year = lubridate::year(Date)) |> 
  select(-Date, -Time, -"Primary ID", -"Sort ID", -"Logger ID", -"Place ID")
# Finding Logger mean "Deer 9-6 C-Pool"
deer_8_monthly_mean <- deer_8 |> 
  group_by(month = format(date, "%Y-%m"),
           year = format(date, "%Y")) |> 
  summarise(mean_temp = mean(temperature, na.rm = TRUE)) 

#There are these tables too that we won't use to compare data because they are from CDEC stations
#Deer 9-05 DVD lower CDEC, Deer 9-15 DVC upper CDEC
# deer_logger_cdec <- sqlFetch(deer_mill, "Deer 9-15 DCV upper CDEC")|> 
#   mutate(date = as_date(Date))
# deer_logger_cdec2 <- sqlFetch(deer_mill, "Deer 9-05 DVD lower CDEC")|> 
#   mutate(date = as_date(Date))

combined_table <- bind_rows(deer_1, deer_2, deer_3 ,deer_4, deer_5, deer_6, deer_7, deer_8, .id = "deer_site")

#adding CDEC data to plot with it and compare
DCV_CDEC <- cdec_query(station = "DCV", dur_code = "H", sensor_num = "25", start_date = "1995-01-01")

DCV_hourly_temps <- DCV_CDEC |> 
  mutate(date = as_date(datetime),
         temp_degC = fahrenheit.to.celsius(parameter_value, round = 1)) |>
  filter(temp_degC < 37, temp_degC > 0) |> #Filtered out outliers using temp range of 0-37 degrees Celsius 
  rename(temperature = temp_degC)

```

```{r}
# Snake case, 

# Remove redundant columns

```

## Explore Numeric Variables: {.tabset}

```{r}
# Filter clean data to show only numeric variables 

```

### Variable: `[name]`

**Plotting Temperature over Period of Record**

```{r}
# Make whatever plot is appropriate 

#checking temporal coverage across deer sites from logger
deer_plot_logger <- ggplot(combined_table, aes(x = date, y = temperature, color = "Logger data")) +
  geom_line(color = "darkred") +
  labs(title = "Deer temp plot from Logger data", y = "Temperature (deg C)", color = "Data Source")


# Create the combined plot of all logger Deer sites and CDEC
combined_CDEC_logger_plot <- deer_plot_logger +
   geom_line(data = DCV_hourly_temps, aes(x = date, y = temperature, color = "CDEC data")) +
   scale_color_manual(values = c("blue", "darkred")) +
   labs(title = "Combined Plot to See Temporal coverage - Deer Logger and CDEC Data", y = "Temperature (deg C)", color = "Data Source")
print(combined_CDEC_logger_plot)

#CDEC mean temp
DCV_mean_temp <- DCV_hourly_temps |> 
  group_by(month = format(date, "%Y-%m"),
           year = format(date, "%Y")) |> 
  summarise(mean_temp = mean(temperature, na.rm = TRUE))


# #combining and plotting both means
# ggplot() +
#   geom_bar(data = DCV_mean_temp, aes(x = month, y = mean_temp),
#            stat = "identity", position = "dodge", width = 0.7, fill = "orange") +
#   labs(title = "Monthly Mean Temperatures Comparison",
#        y = "Mean Temperature (deg C)",
#        x = "Month",
#        fill = "Dataset") +
#   geom_bar(data = deer_1_monthly_mean, aes(x = month, y = mean_temp),
#            stat = "identity", position = "dodge", width = 0.5, fill = "blue") +
#   labs(title = "Monthly Mean Temperatures Comparison",
#        y = "Mean Temperature (deg C)",
#        x = "Month",
#        fill = "Dataset")

#plotting means from Deer_1 + CDEC 2001-2018
DCV_filtered1 <- DCV_mean_temp |> 
  filter(year >= 2013, year <= 2018)
ggplot() +
  geom_bar(data = DCV_filtered1, aes(x = month, y = mean_temp, label = "CDEC"),
           stat = "identity", position = "dodge", width = 0.7, fill = "orange") +
  labs(title = "Monthly Mean Temperatures Comparison CDEC and Deer 9-0 Mouth (2013-2018)",
       y = "Mean Temperature (deg C)",
       x = "Month") +
  geom_bar(data = deer_1_monthly_mean, aes(x = month, y = mean_temp, label = "Logger"),
           stat = "identity", position = "dodge", width = 0.35, fill = "blue") +
  labs(title = "Monthly Mean Temperatures Comparison (2013-2018)",
       y = "Mean Temperature (deg C)",
       x = "Month")
#plotting means from Deer 9-1 VIDEO Station SV Dam + CDEC 
DCV_filtered2 <- DCV_mean_temp |> 
  filter(year >= 2014, year <= 2018)
ggplot() +
  geom_bar(data = DCV_filtered2, aes(x = month, y = mean_temp, label = "CDEC"),
           stat = "identity", position = "dodge", width = 0.7, fill = "orange") +
  labs(title = "Monthly Mean Temperatures Comparison CDEC and Deer 9-1 VIDEO Station SV Dam (2014-2018)",
       y = "Mean Temperature (deg C)",
       x = "Month") +
  geom_bar(data = deer_2_monthly_mean, aes(x = month, y = mean_temp, label = "Logger"),
           stat = "identity", position = "dodge", width = 0.35, fill = "blue") +
  labs(title = "Monthly Mean Temperatures Comparison CDEC and Deer 9-1 VIDEO Station SV Dam (2014-2018)",
       y = "Mean Temperature (deg C)",
       x = "Month")
#plotting means from "Deer 9-2 Trail 2E17" + CDEC 
DCV_filtered3 <- DCV_mean_temp |> 
  filter(year >= 2001, year <= 2018)
ggplot() +
  geom_bar(data = DCV_filtered3, aes(x = month, y = mean_temp, label = "CDEC"),
           stat = "identity", position = "dodge", width = 0.7, fill = "orange") +
  labs(title = "Monthly Mean Temperatures Comparison CDEC and Deer 9-2 Trail 2E17 (2001-2018)",
       y = "Mean Temperature (deg C)",
       x = "Month") +
  geom_bar(data = deer_3_monthly_mean, aes(x = month, y = mean_temp, label = "Logger"),
           stat = "identity", position = "dodge", width = 0.35, fill = "blue") +
  labs(title = "Monthly Mean Temperatures Comparison CDEC and Deer 9-2 Trail 2E17 (2001-2018)",
       y = "Mean Temperature (deg C)",
       x = "Month")

#plotting means from "Deer 9-3 Beaver Cr" + CDEC 
DCV_filtered4 <- DCV_mean_temp |> 
  filter(year >= 2001, year <= 2018)
ggplot() +
  geom_bar(data = DCV_filtered4, aes(x = month, y = mean_temp, label = "CDEC"),
           stat = "identity", position = "dodge", width = 0.7, fill = "orange") +
  labs(title = "Monthly Mean Temperatures Comparison CDEC and Deer 9-3 Beaver Cr (2001-2018)",
       y = "Mean Temperature (deg C)",
       x = "Month") +
  geom_bar(data = deer_4_monthly_mean, aes(x = month, y = mean_temp, label = "Logger"),
           stat = "identity", position = "dodge", width = 0.35, fill = "blue") +
  labs(title = "Monthly Mean Temperatures Comparison CDEC and Deer 9-3 Beaver Cr (2001-2018)",
       y = "Mean Temperature (deg C)",
       x = "Month")

#plotting means from "Deer 9-4 Murphy Trail" + CDEC 
DCV_filtered5 <- DCV_mean_temp |> 
  filter(year >= 2001, year <= 2018)
ggplot() +
  geom_bar(data = DCV_filtered5, aes(x = month, y = mean_temp, label = "CDEC"),
           stat = "identity", position = "dodge", width = 0.7, fill = "orange") +
  labs(title = "Monthly Mean Temperatures Comparison CDEC and Deer 9-4 Murphy Trail (2001-2018)",
       y = "Mean Temperature (deg C)",
       x = "Month") +
  geom_bar(data = deer_5_monthly_mean, aes(x = month, y = mean_temp, label = "Logger"),
           stat = "identity", position = "dodge", width = 0.35, fill = "blue") +
  labs(title = "Monthly Mean Temperatures Comparison CDEC and Deer 9-4 Murphy Trail (2001-2018)",
       y = "Mean Temperature (deg C)",
       x = "Month")

#plotting means from "Deer 9-5 Wilson Cove" + CDEC 
DCV_filtered6 <- DCV_mean_temp |> 
  filter(year >= 2001, year <= 2018)
ggplot() +
  geom_bar(data = DCV_filtered6, aes(x = month, y = mean_temp, label = "CDEC"),
           stat = "identity", position = "dodge", width = 0.7, fill = "orange") +
  labs(title = "Monthly Mean Temperatures Comparison CDEC and Deer 9-5 Wilson Cove (2001-2018)",
       y = "Mean Temperature (deg C)",
       x = "Month") +
  geom_bar(data = deer_6_monthly_mean, aes(x = month, y = mean_temp, label = "Logger"),
           stat = "identity", position = "dodge", width = 0.35, fill = "blue") +
  labs(title = "Monthly Mean Temperatures Comparison CDEC and Deer 9-5 Wilson Cove (2001-2018)",
       y = "Mean Temperature (deg C)",
       x = "Month")

#plotting means from "Deer 9-6 C-Pool" + CDEC 
DCV_filtered7 <- DCV_mean_temp |> 
  filter(year >= 2001, year <= 2018)
ggplot() +
  geom_bar(data = DCV_filtered7, aes(x = month, y = mean_temp, label = "CDEC"),
           stat = "identity", position = "dodge", width = 0.7, fill = "orange") +
  labs(title = "Monthly Mean Temperatures Comparison CDEC and Deer 9-6 C-Pool (2001-2018)",
       y = "Mean Temperature (deg C)",
       x = "Month") +
  geom_bar(data = deer_7_monthly_mean, aes(x = month, y = mean_temp, label = "Logger"),
           stat = "identity", position = "dodge", width = 0.35, fill = "blue") +
  labs(title = "Monthly Mean Temperatures Comparison CDEC and Deer 9-6 C-Pool (2001-2018)",
       y = "Mean Temperature (deg C)",
       x = "Month")

#plotting means from "Deer 9-7 Upper Falls" + CDEC 
DCV_filtered8 <- DCV_mean_temp |> 
  filter(year >= 2001, year <= 2018)
ggplot() +
  geom_bar(data = DCV_filtered8, aes(x = month, y = mean_temp, label = "CDEC"),
           stat = "identity", position = "dodge", width = 0.7, fill = "orange") +
  labs(title = "Monthly Mean Temperatures Comparison CDEC and Deer 9-7 Upper Falls (2001-2018)",
       y = "Mean Temperature (deg C)",
       x = "Month") +
  geom_bar(data = deer_8_monthly_mean, aes(x = month, y = mean_temp, label = "Logger"),
           stat = "identity", position = "dodge", width = 0.35, fill = "blue") +
  labs(title = "Monthly Mean Temperatures Comparison CDEC and Deer 9-7 Upper Falls (2001-2018)",
       y = "Mean Temperature (deg C)",
       x = "Month")
```

**Numeric Summary of [Variable] over Period of Record**

```{r}
# Table with summary statistics
```

**NA and Unknown Values**

Provide a stat on NA or unknown values



### Variable: `[name]`
```{r}
#table() 
```

Fix inconsistencies with spelling, capitalization, and abbreviations. 

```{r}
# Fix any inconsistencies with categorical variables
```

**Create lookup rda for [variable] encoding:** 
```{r}
# Create named lookup vector
# Name rda [watershed]_[data type]_[variable_name].rda
# save rda to data/ 
```

**NA and Unknown Values**

Provide a stat on NA or unknown values

## Summary of identified issues

* List things that are funcky/bothering us but that we don't feel like should be changed without more investigation

## Save cleaned data back to google cloud 

```{r}
# Write to google cloud 
# Name file [watershed]_[data type].csv
```