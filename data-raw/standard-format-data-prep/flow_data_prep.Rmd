---
title: "pull flow data for trap locations"
output: 
  html_document:
  theme: flatly
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, fig.width=15, fig.height=10)
library(tidyverse)
library(CDECRetrieve)
library(dataRetrieval)
library(hms)
```

# Trap location and flow gage lookup

```{r}
# We need flow data for each of the sites included in the trap_locations table
# for all of the years listed.
# We do not need to go to subsite scale of resolution.
# For now this table is for reference to find the years that data is needed.
# This table is also helpful for understanding years where we need flow data for each location:
# https://github.com/FlowWest/JPE-datasets/tree/main/data-raw/qc-markdowns/rst

trap_locations_raw <- read_csv("data-raw/standard-format-data-prep/rst_sites.csv")

trap_locations <- trap_locations_raw %>%
  select(tributary, site_name, river_location, latitude, longitude, year) %>%
  distinct()

gage_locations_raw <- read_csv("data-raw/standard-format-data-prep/gage_sites.csv")

# Pull flow data from each of the gage sites here 
gage_locations <- gage_locations_raw %>%
  filter(flow_gage == T) %>%
  select(tributary, site_name, agency, latitude, longitude, identifier) %>%
  distinct() %>%
  rename(gage_latitude = latitude,
         gage_longitude = longitude)
```

# Pull in flow data {.tabset}

## Battle Creek

### CDEC data

```{r}
# Determine what data are available for the CDEC gauge vs the USGS gauge and how that
# matches with the years needed (reference trap_locations table for years)

# If both gauges offer similar data, is one at a finer scale (hourly vs daily)?

# Choose the gauge with the most data at the finest scale. If years don't overlap, could use
# combination of both
```

### USGS data

```{r}

```

## Butte Creek

### CDEC data

```{r}
# Determine what data are available for the CDEC gauge vs the USGS gauge and how that
# matches with the years needed (reference trap_locations table for years)

# If both gauges offer similar data, is one at a finer scale (hourly vs daily)?

# Choose the gauge with the most data at the finest scale. If years don't overlap, could use
# combination of both
```

### USGS data

```{r}

```

## Clear Creek

### CDEC data

```{r}
# Determine what data are available for the CDEC gauge vs the USGS gauge and how that
# matches with the years needed (reference trap_locations table for years)

# If both gauges offer similar data, is one at a finer scale (hourly vs daily)?

# Choose the gauge with the most data at the finest scale. If years don't overlap, could use
# combination of both
```

### USGS data

```{r}

```

## Deer Creek

### CDEC data

```{r}
# Determine what data are available for the CDEC gauge vs the USGS gauge and how that
# matches with the years needed (reference trap_locations table for years)

# If both gauges offer similar data, is one at a finer scale (hourly vs daily)?

# Choose the gauge with the most data at the finest scale. If years don't overlap, could use
# combination of both
```

### USGS data

```{r}

```

## Feather River

### High flow channel sites

```{r}
# We already identified the code for the CDEC gage of interest here: GRL
# Use this code to see what data are available
cdec_datasets("GRL") 
# For reference - this mapping tool shows CDEC sites: https://cdec.water.ca.gov/webgis/?appid=cdecstation

# Use this code to pull the data from CDEC. 
gridley_CDEC <- cdec_query(station = "GRL", dur_code = "H", sensor_num = "20", start_date = "1996-01-01")

# Format data
gridley_hourly_flows <- gridley_CDEC %>%
  mutate(date = as_date(datetime),
         time = as_hms(datetime),
         flow_cfs = parameter_value)
  
```

#### QA/QC 

It looks like there are some negative values. We should make these NA.

It would be important to note any gaps in data collection.

```{r}
ggplot(gridley_hourly_flows, aes(x = datetime, y = flow_cfs)) +
  geom_line()
```
#### Clean data

```{r}
gridley_hourly_flows_clean <- gridley_hourly_flows %>%
  mutate(flow_cfs = ifelse(flow_cfs < 0, NA_real_, flow_cfs))
```


### Low flow channel sites

```{r}
# For reference - this mapping tool shows USGS sites: https://maps.waterdata.usgs.gov/mapper/index.html
# You can use the mapper to search for sites and find the right parameter code. I use 0060 below for daily discharge. 
# Hourly or instaneous would be better but it is not available.
# Documentation for dataRetrieval: https://github.com/USGS-R/dataRetrieval

oroville_USGS <- readNWISdv(11407000, "00060")

# Format to make tidier
oroville_daily_flows <- oroville_USGS %>%
  select(Date, flow_cfs =  X_00060_00003) %>%
  filter(lubridate::year(Date) >= 1996) %>%
  as_tibble() %>% 
  rename(date = Date)
```


#### QA/QC

```{r}
ggplot(oroville_daily_flows, aes(x = date, y = flow_cfs)) +
  geom_line()
```

## Mill Creek

### CDEC data

```{r}
# Determine what data are available for the CDEC gauge vs the USGS gauge and how that
# matches with the years needed (reference trap_locations table for years)

# If both gauges offer similar data, is one at a finer scale (hourly vs daily)?

# Choose the gauge with the most data at the finest scale. If years don't overlap, could use
# combination of both
```

### USGS data

```{r}

```

## Yuba River

### CDEC data

```{r}
# Determine what data are available for the CDEC gauge vs the USGS gauge and how that
# matches with the years needed (reference trap_locations table for years)

# If both gauges offer similar data, is one at a finer scale (hourly vs daily)?

# Choose the gauge with the most data at the finest scale. If years don't overlap, could use
# combination of both
```

### USGS data

```{r}

```

## Sacramento River - Knights Landing

### CDEC data

```{r}
# Determine what data are available for the CDEC gauge vs the USGS gauge and how that
# matches with the years needed (reference trap_locations table for years)

# If both gauges offer similar data, is one at a finer scale (hourly vs daily)?

# Choose the gauge with the most data at the finest scale. If years don't overlap, could use
# combination of both
```

### USGS data

```{r}

```

## Sacramento River - Tisdale

### CDEC data

```{r}
# Only CDEC data is available for Tisdale

```

#### QA/QC

```{r}
# plots to check the quality of data. no data below zero.
```







