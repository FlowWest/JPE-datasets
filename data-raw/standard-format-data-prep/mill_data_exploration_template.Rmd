---
title: "[Watershed] [Data type] [QC]"
author: "Badhia Yunes Katz"
date: "01/25/2024"
output: rmarkdown::github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, fig.width=15, fig.height=10)
library(tidyverse)
library(lubridate)
library(googleCloudStorageR)
library(ggplot2)
library(scales)
library(RODBC)
library(chron)
library(weathermetrics)
library(CDECRetrieve)
library(hms)
library(dplyr)
```

# Mill Creek [Data type long version]

## Description of Monitoring Data

**Timeframe:** 

**Video Season:** 

**Completeness of Record throughout timeframe:** no data gaps

**Sampling Location:** Mill Creek

**Data Contact:** 

Any additional info?

## Access Cloud Data

```{r, eval=FALSE}
# Run Sys.setenv() to specify GCS_AUTH_FILE and GCS_DEFAULT_BUCKET before running 
# getwd() to see how to specify paths 
# Open object from google cloud storage
# Set your authentication using gcs_auth
gcs_auth(json_file = Sys.getenv("GCS_AUTH_FILE"))
# Set global bucket 
gcs_global_bucket(bucket = Sys.getenv("GCS_DEFAULT_BUCKET"))

```

Read in data from google cloud, glimpse raw data and domain description sheet: 
```{r}
# read in data to clean 
gcs_get_object(object_name = "environmental/data-raw/MASTER_TEMPERATURE.mdb",
               bucket = gcs_get_global_bucket(),
               saveToDisk = "MASTER_TEMPERATURE.mdb",
               overwrite = TRUE)


master_temp_deer_mill <- odbcConnectAccess2007(here::here("data-raw", "standard-format-data-prep", "MASTER_TEMPERATURE.mdb"))

```

## Data transformations

```{r}
# For different excel sheets for each year read in and combine years here

tables <- sqlTables(master_temp_deer_mill)


mill_1 <- sqlFetch(master_temp_deer_mill,"Mill 8-0 Mouth") |> 
  mutate(date = as_date(Date)) |>                                            #Transforming columns to appropriate types
  mutate(temperature = fahrenheit.to.celsius(Temperature, round = 1)) |> 
  mutate(year = lubridate::year(Date)) |> 
  select(-Date, -Time, -"Primary ID", -"Sort ID", -"Logger ID", -"Place ID") # Remove redundant columns
# Finding Logger mean "Mill 8-0 Mouth"
mill_1_monthly_mean <- mill_1 |> 
  group_by(month = month(date),
           year = year(date)) |> 
  mutate(month = factor(month)) |> 
  summarise(mean_temp = mean(temperature, na.rm = TRUE))


mill_2 <- sqlFetch(master_temp_deer_mill, "Mill 8-1 VIDEO Station")|> 
    mutate(date = as_date(Date)) |>                                            
  mutate(temperature = fahrenheit.to.celsius(Temperature, round = 1)) |> 
  mutate(year = lubridate::year(Date)) |> 
  select(-Date, -Time, -"Primary ID", -"Sort ID", -"Logger ID", -"Place ID") 
# Finding Logger mean "Mill 8-1 VIDEO Station"
mill_2_monthly_mean <- mill_2 |> 
  group_by(month = month(date),
           year = year(date)) |> 
  mutate(month = factor(month)) |> 
  summarise(mean_temp = mean(temperature, na.rm = TRUE))


mill_3 <- sqlFetch(master_temp_deer_mill, "Mill 8-2 Little Mill Confluence")|> 
  mutate(date = as_date(Date)) |>                                            
  mutate(temperature = fahrenheit.to.celsius(Temperature, round = 1)) |> 
  mutate(year = lubridate::year(Date)) |> 
  select(-Date, -Time, -"Primary ID", -"Sort ID", -"Logger ID", -"Place ID") 
# Finding Logger mean "Mill 8-1 VIDEO Station"
mill_3_monthly_mean <- mill_3 |> 
  group_by(month = month(date),
           year = year(date)) |> 
  mutate(month = factor(month)) |> 
  summarise(mean_temp = mean(temperature, na.rm = TRUE))



mill_4 <- sqlFetch(master_temp_deer_mill, "Mill 8-3 Rancheria")|>
  mutate(date = as_date(Date)) |>                                            
  mutate(temperature = fahrenheit.to.celsius(Temperature, round = 1)) |> 
  mutate(year = lubridate::year(Date)) |> 
  select(-Date, -Time, -"Primary ID", -"Sort ID", -"Logger ID", -"Place ID") 
# Finding Logger mean "Mill 8-3 Rancheria"
mill_4_monthly_mean <- mill_4 |> 
  group_by(month = month(date),
           year = year(date)) |> 
  mutate(month = factor(month)) |> 
  summarise(mean_temp = mean(temperature, na.rm = TRUE))


mill_5 <- sqlFetch(master_temp_deer_mill, "Mill 8-4 Black Rock")|> 
  mutate(date = as_date(Date)) |>                                            
  mutate(temperature = fahrenheit.to.celsius(Temperature, round = 1)) |> 
  mutate(year = lubridate::year(Date)) |> 
  select(-Date, -Time, -"Primary ID", -"Sort ID", -"Logger ID", -"Place ID") 
# Finding Logger mean "Mill 8-4 Black Rock"
mill_5_monthly_mean <- mill_5 |> 
  group_by(month = month(date),
           year = year(date)) |> 
  mutate(month = factor(month)) |> 
  summarise(mean_temp = mean(temperature, na.rm = TRUE))



mill_6 <- sqlFetch(master_temp_deer_mill, "Mill 8-5 Sooner")|>
  mutate(date = as_date(Date)) |>                                            
  mutate(temperature = fahrenheit.to.celsius(Temperature, round = 1)) |> 
  mutate(year = lubridate::year(Date)) |> 
  select(-Date, -Time, -"Primary ID", -"Sort ID", -"Logger ID", -"Place ID") 
# Finding Logger mean "Mill 8-5 Sooner"
mill_6_monthly_mean <- mill_6 |> 
  group_by(month = month(date),
           year = year(date)) |> 
  mutate(month = factor(month)) |> 
  summarise(mean_temp = mean(temperature, na.rm = TRUE))




mill_7 <- sqlFetch(master_temp_deer_mill, "Mill 8-6 Canyon Camp")|> 
  mutate(date = as_date(Date)) |>                                            
  mutate(temperature = fahrenheit.to.celsius(Temperature, round = 1)) |> 
  mutate(year = lubridate::year(Date)) |> 
  select(-Date, -Time, -"Primary ID", -"Sort ID", -"Logger ID", -"Place ID") 
# Finding Logger mean "Mill 8-6 Canyon Camp"
mill_7_monthly_mean <- mill_7 |> 
  group_by(month = month(date),
           year = year(date)) |> 
  mutate(month = factor(month)) |> 
  summarise(mean_temp = mean(temperature, na.rm = TRUE))


mill_8 <- sqlFetch(master_temp_deer_mill, "Mill 8-7 Hole in Ground")|> 
  mutate(date = as_date(Date)) |>                                            
  mutate(temperature = fahrenheit.to.celsius(Temperature, round = 1)) |> 
  mutate(year = lubridate::year(Date)) |> 
  select(-Date, -Time, -"Primary ID", -"Sort ID", -"Logger ID", -"Place ID") 
# Finding Logger mean "Mill 8-7 Hole in Ground"
mill_8_monthly_mean <- mill_8 |> 
  group_by(month = month(date),
           year = year(date)) |> 
  mutate(month = factor(month)) |> 
  summarise(mean_temp = mean(temperature, na.rm = TRUE))


mill_9 <- sqlFetch(master_temp_deer_mill, "Mill 8-8 Little Hole in Ground")|> 
  mutate(date = as_date(Date)) |>                                            
  mutate(temperature = fahrenheit.to.celsius(Temperature, round = 1)) |> 
  mutate(year = lubridate::year(Date)) |> 
  select(-Date, -Time, -"Primary ID", -"Sort ID", -"Logger ID", -"Place ID") 
# Finding Logger mean "Mill 8-8 Little Hole in Ground"
mill_9_monthly_mean <- mill_9 |> 
  group_by(month = month(date),
           year = year(date)) |> 
  mutate(month = factor(month)) |> 
  summarise(mean_temp = mean(temperature, na.rm = TRUE))


#There are these tables too that we won't use to compare data because they are from CDEC stations
#Mill 8-05 MCH lower CDEC, Mill 8-15 MLM upper CDEC

combined_table_mill <- bind_rows(mill_1, mill_2, mill_3 ,mill_4, mill_5, mill_6, mill_7, mill_8, mill_9, .id = "mill_site")

#adding CDEC data (with removed outliers from CDEC using 0-40C range)
MLM_CDEC <- cdec_query(station = "MLM", dur_code = "H", sensor_num = "25", start_date = "1996-01-01")


MLM_hourly_temps <- MLM_CDEC |> 
  mutate(date = as_date(datetime),
         temp_degC = fahrenheit.to.celsius(parameter_value, round = 1)) |>
  filter(temp_degC < 37, temp_degC > 0) |> #Filtered out outliers using temp range of 0-37 degrees Celsius 
  rename(temperature = temp_degC)


```

```{r}
# Snake case, 
# Columns are appropriate types



# Remove redundant columns

```

## Explore Numeric Variables: {.tabset}

```{r}
# Filter clean data to show only numeric variables 
#checking temporal coverage across deer sites from logger
mill_plot_logger <- ggplot(combined_table_mill, aes(x = date, y = temperature, color = "Logger data")) +
  geom_line(color = "darkred") +
  labs(title = "Mill temp plot from Logger data", y = "Temperature (deg C)", color = "Data Source")
glimpse(mill_plot_logger)

print(mill_plot_logger)

```

### Variable: `Temperature`

**Plotting [Variable] over Period of Record**


```{r}
# Create the combined plot of all logger Mill sites and CDEC
combined_CDEC_logger_plot <- mill_plot_logger +
   geom_line(data = MLM_hourly_temps, aes(x = date, y = temperature, color = "CDEC data")) +
   scale_color_manual(values = c("blue", "darkred")) +
   labs(title = "Combined Plot to See Temporal coverage - Mill Logger and CDEC Data", y = "Temperature (deg C)", color = "Data Source")
print(combined_CDEC_logger_plot)

#CDEC mean temp
MLM_mean_temp <- MLM_hourly_temps |> 
  group_by(month = month(date),
           year = format(date, "%Y")) |> 
  summarise(mean_temp = mean(temperature, na.rm = TRUE))
```

```{r}
#plotting means from Mill 8-0 Mouth + CDEC 
MLM_filtered1 <- MLM_mean_temp |> 
  mutate(month = factor(month)) |> 
  filter(year >= 2013, year <= 2018)
ggplot() +
  geom_boxplot(data = MLM_filtered1, aes(x = month, y = mean_temp)) +
  labs(title = "Monthly Mean Temperatures Comparison CDEC and Mill 8-0 Mouth (2013-2018)",
       y = "Mean Temperature (deg C)",
       x = "Month") +
  geom_boxplot(data = mill_1_monthly_mean, aes(x = month, y = mean_temp), fill = "red")
#Comments:
#This logger data is at the mouth of Mill creek, therefore we can see that temperatures tend to be slightly higher than CDEC's. This could be due to the proximity to the Sac river. One thing to note is the really high temperature variability during fall (August-October)  
#The monthly mean temperatures on January (~8 degrees) are too similar, higher than December and February, which suggest might be inaccurate
#Winter lowest temperatures (Nov, Dec, Feb) don't go lower than ~7 degrees C and the highest is ~25 degrees C during August


#plotting means from Mill 8-1 VIDEO Station + CDEC 
ggplot() +
  geom_boxplot(data = MLM_filtered1, aes(x = month, y = mean_temp)) +
  labs(title = "Monthly Mean Temperatures Comparison CDEC and Mill 8-1 VIDEO Station",
       y = "Mean Temperature (deg C)",
       x = "Month") +
  geom_boxplot(data = mill_2_monthly_mean, aes(x = month, y = mean_temp), fill = "red")
#TODO check data from this logger, it seems like Jul, Aug, Sept, data might have something wrong 


#plotting means from Mill 8-2 Little Mill Confluence + CDEC 
ggplot() +
  geom_boxplot(data = MLM_filtered1, aes(x = month, y = mean_temp)) +
  labs(title = "Monthly Mean Temperatures Comparison CDEC and Mill 8-2 Little Mill Confluence",
       y = "Mean Temperature (deg C)",
       x = "Month") +
  geom_boxplot(data = mill_3_monthly_mean, aes(x = month, y = mean_temp), fill = "red")
#Comments:
#Temperature ranges fluctuate less than at other point of the logger and has a consistent increase from Jan-Jul, and a consistent drop Jul-Dec
#Winter lowest temperatures ~6 degrees C
#The highest temps are during July ~23 degrees C


#plotting means from Mill 8-3 Rancheria + CDEC 
ggplot() +
  geom_boxplot(data = MLM_filtered1, aes(x = month, y = mean_temp)) +
  labs(title = "Monthly Mean Temperatures Comparison CDEC and Mill 8-3 Rancheria",
       y = "Mean Temperature (deg C)",
       x = "Month") +
  geom_boxplot(data = mill_4_monthly_mean, aes(x = month, y = mean_temp), fill = "red")
#Comments:
#The range of mean temperatures throughout the months is a bid wider than CDEC (and other sites from logger)
#Winter months don't vary so much from CDEC, but fall and summer do. The mean temperature is lower during those seasons with a high of ~18 degrees C during summer

#plotting means from Mill 8-4 Black Rock + CDEC 
ggplot() +
  geom_boxplot(data = MLM_filtered1, aes(x = month, y = mean_temp)) +
  labs(title = "Monthly Mean Temperatures Comparison CDEC and Mill 8-4 Black Rock",
       y = "Mean Temperature (deg C)",
       x = "Month") +
  geom_boxplot(data = mill_5_monthly_mean, aes(x = month, y = mean_temp), fill = "red")
#Comments:
#The decrease on mean temperatures in general (compared to CDEC) is reasonable due to the location higher up in the stream, and the elevation change 



#plotting means from Mill 8-5 Sooner + CDEC 
ggplot() +
  geom_boxplot(data = MLM_filtered1, aes(x = month, y = mean_temp)) +
  labs(title = "Monthly Mean Temperatures Comparison CDEC and Mill 8-5 Sooner",
       y = "Mean Temperature (deg C)",
       x = "Month") +
  geom_boxplot(data = mill_6_monthly_mean, aes(x = month, y = mean_temp), fill = "red")


#plotting means from Mill 8-6 Canyon Camp  + CDEC 
ggplot() +
  geom_boxplot(data = MLM_filtered1, aes(x = month, y = mean_temp)) +
  labs(title = "Monthly Mean Temperatures Comparison CDEC and Mill 8-6 Canyon Camp",
       y = "Mean Temperature (deg C)",
       x = "Month") +
  geom_boxplot(data = mill_7_monthly_mean, aes(x = month, y = mean_temp), fill = "red")


#plotting means from Mill 8-7 Hole in Ground + CDEC 
ggplot() +
  geom_boxplot(data = MLM_filtered1, aes(x = month, y = mean_temp)) +
  labs(title = "Monthly Mean Temperatures Comparison CDEC and Mill 8-7 Hole in Ground",
       y = "Mean Temperature (deg C)",
       x = "Month") +
  geom_boxplot(data = mill_8_monthly_mean, aes(x = month, y = mean_temp), fill = "red")


#plotting means from Mill 8-8 Little Hole in Ground + CDEC 
ggplot() +
  geom_boxplot(data = MLM_filtered1, aes(x = month, y = mean_temp)) +
  labs(title = "Monthly Mean Temperatures Comparison CDEC and Mill 8-8 Little Hole in Ground",
       y = "Mean Temperature (deg C)",
       x = "Month") +
  geom_boxplot(data = mill_9_monthly_mean, aes(x = month, y = mean_temp), fill = "red")
#Comments;
#This logger data has data from the highest point of the stream. Therefore, it is expected that mean temperatures don't go over ~17 degrees C throughout the year
#The lowest temperatures are in December and January and they go as low as ~3 degrees C

#CDEC station is significantly lower down the stream, closer to the Sac River confluence. 
#The lowest data location point from the logger is at mouth, then the next one is at little Mill Creek confluence (much higher upstream, in relation to CDEC MLM station)

# TODO analyze plots. Check for location of the data coming from logger and see if any relationship on temp variability/logger sampled location
```

**Numeric Summary of [Variable] over Period of Record**

```{r}
# Table with summary statistics
```

**NA and Unknown Values**

Provide a stat on NA or unknown values

## Explore Categorical variables: {.tabset}

General notes: If there is an opportunity to turn yes no into boolean do so, but not if you loose value 

```{r}
# Filter clean data to show only categorical variables
```


### Variable: `Temperature`
```{r}
#table() 
```

Fix inconsistencies with spelling, capitalization, and abbreviations. 

```{r}
# Fix any inconsistencies with categorical variables
```

**Create lookup rda for [variable] encoding:** 
```{r}
# Create named lookup vector
# Name rda [watershed]_[data type]_[variable_name].rda
# save rda to data/ 
```

**NA and Unknown Values**

Provide a stat on NA or unknown values

## Summary of identified issues

* List things that are funcky/bothering us but that we don't feel like should be changed without more investigation

## Save cleaned data back to google cloud 

```{r}
# Write to google cloud 
# Name file [watershed]_[data type].csv
```