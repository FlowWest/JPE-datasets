---
title: "Create standard format for RST catch data"
output: html_document
---

```{r, include = F}
library(dtplyr)
library(data.table)
library(tidyverse)
library(lubridate)
library(googleCloudStorageR)
library(knitr)
library(hms)

root.dir <- rprojroot::find_rstudio_root_file()
knitr::opts_knit$set(root.dir)
knitr::opts_chunk$set(echo = TRUE)
```

Data were checked and cleaned in scripts available [here](https://github.com/FlowWest/JPE-datasets/tree/main/scripts/rst)

```{r, data_pull, include = F, echo = F, eval = F}
# # Data pull ---------------------------------------------------------------
gcs_auth(json_file = Sys.getenv("GCS_AUTH_FILE"))
gcs_global_bucket(bucket = Sys.getenv("GCS_DEFAULT_BUCKET"))

# define files to pull in (in some cases there is just one catch file while others
# have sample and environmental data)
files_battle <- tibble(path = rep("rst/battle-creek/data/battle_",4),
                       name = c("rst_catch","rst_environmental","rst_passage_estimates", "mark_reacpture"),
                       save = rep(here::here("data","rst", "battle_rst_"), 4))
files_butte <- tibble(path = "rst/butte-creek/data/butte_rst",
                      name = c(""),
                      save = here::here("data","rst", "butte_rst"))
files_butte_camp <- tibble(path = rep("rst/butte-creek/data-raw/butte_",3),
                        name = c("catch_camp","trap_camp", "environmental_camp"),
                        save = rep(here::here("data","rst", "butte_"), 3))
files_clear <- tibble(path = rep("rst/clear-creek/data/clear_",4),
                      name = c("rst_catch","rst_environmental","rst_passage_estimates", "mark_reacpture"),
                      save = rep(here::here("data", "rst", "clear_rst_"), 4))
files_deer <- tibble(path = "rst/deer-creek/data/deer_rst",
                     name = c(""),
                     save = here::here("data","rst", "deer_rst"))
files_feather <- tibble(path = rep("rst/feather-river/data/feather_rst",2),
                        name = c("","_effort"),
                        save = rep(here::here("data","rst", "feather_rst"), 2))
files_feather_camp <- tibble(path = rep("rst/feather-river/data-raw/feather_",3),
                        name = c("catch_camp","trap_camp", "environmental_camp"),
                        save = rep(here::here("data","rst", "feather_"), 3))
files_knights <- tibble(path = rep("rst/lower-sac-river/data-raw/knights-landing/knights_",2),
                        name = c("catch_camp", "trap_camp"),
                        save = rep(here::here("data","rst", "knights_"), 2))
files_knights_pre2006 <- tibble(path = rep("rst/lower-sac-river/data/knights-landing/knl_",2),
                        name = c("combine_rst_clean", "combine_sampling_effort_clean"),
                        save = rep(here::here("data","rst", "knights_"), 2))
files_tisdale <- tibble(path = "rst/lower-sac-river/data/tisdale/rst_clean",
                        name = c(""),
                        save = here::here("data","rst", "tisdale_rst"))
files_tisdale_camp <- tibble(path = "rst/lower-sac-river/data-raw/tisdale/tisdale_",
                        name = c("catch_camp", "trap_camp"),
                        save = here::here("data","rst", "tisdale_rst_"))
files_mill <- tibble(path = "rst/mill-creek/data/mill_rst",
                     name = c(""),
                     save = here::here("data","rst", "mill_rst"))
files_yuba <- tibble(path = "rst/yuba-river/data/yuba_rst",
                     name = c(""),
                     save = here::here("data","rst", "yuba_rst"))
# function to save file to disk
get_data <- function(path, name, save) {
  gcs_get_object(object_name = paste0(path, name, ".csv"),
                 bucket = gcs_get_global_bucket(),
                 saveToDisk = paste0(save, name, ".csv"),
                 overwrite = TRUE)
}
# apply function to each set of files
pmap(files_battle, get_data)
pmap(files_butte, get_data)
pmap(files_butte_camp, get_data)
pmap(files_clear, get_data)
pmap(files_deer, get_data)
pmap(files_feather, get_data)
pmap(files_feather_camp, get_data)
pmap(files_knights, get_data)
pmap(files_knights_pre2006, get_data)
pmap(files_tisdale, get_data)
pmap(files_tisdale_camp, get_data)
pmap(files_mill, get_data)
pmap(files_yuba, get_data)
```

```{r, read_csv}
# load in data
# catch data
battle_rst <- read_csv(here::here("data", "rst", "battle_rst_catch.csv"))
butte_rst <- read_csv(here::here("data", "rst", "butte_rst.csv")) # contains trap data too
butte_rst_camp <- read_csv(here::here("data", "rst", "butte_catch_camp.csv"))
clear_rst <- read_csv(here::here("data", "rst", "clear_rst_catch.csv"))
deer_rst <- read_csv(here::here("data", "rst", "deer_rst.csv")) # contains trap data too
feather_rst <- read_csv(here::here("data", "rst", "feather_rst.csv"))
feather_rst_camp <- read_csv(here::here("data", "rst", "feather_catch_camp.csv"))
knights_landing_rst <- read_csv(here::here("data", "rst", "knights_catch_camp.csv"))
knights_landing_pre2006 <- read_csv(here::here("data", "rst", "knights_combine_rst_clean.csv"))
tisdale_rst <- read_csv(here::here("data", "rst", "tisdale_rst.csv"))
tisdale_rst_camp <- read_csv(here::here("data", "rst", "tisdale_rst_catch_camp.csv"))
mill_rst <- read_csv(here::here("data", "rst", "mill_rst.csv")) # contains trap data too
yuba_rst <- read_csv(here::here("data", "rst", "yuba_rst.csv"))

# sampling effort and environmental
battle_environmental <- read_csv(here::here("data","rst", "battle_rst_environmental.csv"))
battle_mark_recapture <- read_csv(here::here("data","rst", "battle_rst_mark_reacpture.csv"))
butte_trap_camp <- read_csv(here::here("data", "rst", "butte_trap_camp.csv"))
clear_environmental <- read_csv(here::here("data", "rst", "clear_rst_environmental.csv"))
clear_mark_recapture <- read_csv(here::here("data", "rst", "clear_rst_mark_reacpture.csv"))
feather_effort <- read_csv(here::here("data", "rst", "feather_rst_effort.csv"))
feather_trap_camp <- read_csv(here::here("data", "rst", "feather_trap_camp.csv"))
knights_effort <- read_csv(here::here("data", "rst", "knights_trap_camp.csv"))
knights_effort_pre2006 <- read_csv(here::here("data", "rst", "knights_combine_sampling_effort_clean.csv"))
tisdale_trap_camp <- read_csv(here::here("data", "rst", "tisdale_rst_trap_camp.csv"))
```


```{r, include = F}
gcs_get_object(object_name = "rst/RiverLAD.csv",
               bucket = gcs_get_global_bucket(),
               saveToDisk = here::here("data", "river_lad.csv"),
               overwrite = TRUE)
lad <- read_csv(here::here("data", "river_lad.csv"))
```

# Data formatting {.tabset}

We format, check, and clean catch data for each stream individually because their
raw format varies. After formatting all streams we combine and apply additional
cleaning and formatting.

Battle, Clear, Feather, and Knights Landing provided trap operations/environmental
data separate from catch. In some cases, there may be trap operations/environmental
data but no catch observations for that day. In those cases, we assume that catch was 
zero and was not recorded. To capture all data (including zero catch) we combine
dates with trap operations/environmental with catch data and assume zero catch
if that date did not exist in the catch data.

```{r, helpers}
# standard encoding fixes for run
# These functions use data.table because it performs faster
run_encoding_dt <- function(dat) {
  dat[, run := fcase(
    count == 0, NA_character_,
    (count > 0 & is.na(run)) | run == "not recorded" |  run == "not applicable (n/a)" | run == "unknown", "not recorded",
    run == "outlier salmon", "unknown",
    run == "fall", "fall",
    run == "winter", "winter",
    run == "spring", "spring",
    run == "late fall", "late fall")
    ]
}

run_method_encoding_dt <- function(dat) {
  dat[, run_method := fcase(
    count == 0, NA_character_,
    (count > 0 & is.na(run_method)) | run_method == "not recorded", "not recorded",
    run_method == "length-at-date criteria", "length-at-date criteria",
    run_method == "hatchery attribute", "hatchery attribute",
    run_method == "appearance", "appearance")
    ]
}

# note that there is only one "yoy (young of the year)"
# Older juveniles only existed in the excel spreadsheets provided by Knights Landing
# We only use the spreadsheets for sampling before 2006 because the rest is in CAMP
# There are no older juveniles before 2006

lifestage_encoding_dt <- function(dat) {
  dat[, lifestage := fcase(
  count == 0, NA_character_,
  lifestage %in% c("not recorded", "not provided") | (count != 0 & is.na(lifestage)), "not recorded",
  lifestage %in% c("yolk-sac fry", "yolk sac fry (alevin)", "yolk sac fry"), "yolk sac fry",
  lifestage %in% c("silvery parr", "fingerling", "pre-smolt"), "silvery parr",
  lifestage %in% c("unknown", "yoy (young of the year)", "juvenile"), "unknown",
  
  lifestage == "parr", "parr",
  lifestage %in% c("fry", "button-up fry", "fry (button-up)"), "fry",
  lifestage == "smolt", "smolt",
  lifestage == "adult", "adult",
  lifestage %in% c("yearling", "older juvenile"), "yearling"
 )]
}
```

## Battle Creek

```{r, battle_data_dictionary}
battle_data_dictionary <- read_rds(here::here("data-raw", 
                                              "qc-markdowns", "rst", "data-dictionaries", "battle_rst_data_dictionary.rds"))
kable(battle_data_dictionary)
```

```{r, battle_clean}
### Catch #####
battle_rst %>% glimpse
unique(battle_rst$run)
unique(battle_rst$lifestage)
filter(battle_rst, is.na(fork_length), count > 0) %>% glimpse
filter(battle_rst, is.na(run)) %>% glimpse

battle_rst %>% group_by(date, run, fork_length, lifestage, dead, interpolated) %>% count() %>% filter(n > 1)

filter(battle_rst, date == "2003-12-28")

# notes to include
# some data may be interpolated (~1% may be interpolated)
# run is not filtered
# TODO compare mean observed v interpolated to decide if we should use
# Origin - Natural because trap is above that hatchery
# run method: fWS_race (Sheila Greene LAD with adjustments, all fall run are spring run)

battle_rst_clean <- battle_rst %>%
  select(-c(sample_id)) %>%
  group_by(date, run, fork_length, lifestage, dead, interpolated) %>%
  summarize(count = sum(count, na.rm = T))

battle_rst_min <- battle_rst_clean %>% 
  mutate(wy = ifelse(month(date) %in% 10:12, year(date) + 1, year(date))) %>% 
  group_by(wy) %>% 
  summarize(min = min(date))

# Trap operations and environmental data was captured separately
# Need to check that if data in environmental it is also in catch data
# e.g. make sure that if no catch then 0 in catch data

battle_trap_clean <- battle_environmental %>%
  # use sample date because this is the date the trap would have been checked
  select(sample_date) %>% 
  distinct()

battle_trap_min <- battle_trap_clean %>% 
  mutate(wy = ifelse(month(sample_date) %in% 10:12, year(sample_date) + 1, year(sample_date))) %>% 
  group_by(wy) %>% 
  summarize(trap_min = min(sample_date))

# when comparing min dates in rst and environmental data, they differ
# this means that we need to add in zero catch data
battle_min_date_compare <- full_join(battle_rst_min, battle_trap_min)

# select recaptured fish to add to full catch table
battle_recapture <- battle_mark_recapture %>% 
  select(release_date, caught_day_1, caught_day_2, caught_day_3, caught_day_4, caught_day_5, origin) %>% 
  mutate(stream = "battle creek",
         site = "ubc",
         subsite = "ubc",
         release_id = paste0("BAT", row_number())) %>%
  pivot_longer(cols = caught_day_1:caught_day_5, names_to = "date", values_to = "count") %>%
  mutate(date = case_when(date == "caught_day_1" ~ release_date + 1, 
                                    date == "caught_day_2" ~ release_date + 2,
                                    date == "caught_day_3" ~ release_date + 3,
                                    date == "caught_day_4" ~ release_date + 4,
                                    date == "caught_day_5" ~ release_date + 5),
         adipose_clipped = case_when(origin == "natural" ~ F,
                                     origin == "hatchery" ~ T),
         species = "chinook salmon",
         run = "not recorded",
         lifestage = "not recorded",
         run_method = "not recorded") %>% 
  select(-release_date, -origin) %>% 
  filter(count > 0 & !is.na(count))
  
# This contains ALL data
# Assumption is that if date is in environmental data but not catch data there was zero catch
battle_rst_clean_final <- full_join(battle_rst_clean, 
                                    battle_trap_clean %>% 
                                      rename(date = sample_date)) %>% 
  mutate(count = ifelse(is.na(count), 0, count),
         stream = "battle creek",
         site = "ubc",
         subsite = "ubc",
         adipose_clipped = F,
         run_method = "adjusted length-at-date",
         species = "chinook salmon",
         release_id = NA) %>% 
  bind_rows(battle_recapture)

# convert to data table for faster mutation
setDT(battle_rst_clean_final)
# THIS CODE MODIFIES battle_rst_clean_final using functions that
# mutate using data.table package
battle_rst_clean_final %>% 
  run_encoding_dt() %>% 
  lifestage_encoding_dt()
```

### Variables removed

- sample_id: unable to connect this to any additional data so it is not relevant
to include


## Butte Creek

All data pre 2015 was shared with us in excel spreadsheets. Post 2015 data is stored and shared using the CAMP platform. 

```{r, butte_data_dictionary}
butte_data_dictionary <- read_rds(here::here("data-raw", "qc-markdowns", "rst", 
                                             "data-dictionaries", "butte_rst_data_dictionary.rds"))
kable(butte_data_dictionary)
```

```{r, butte_clean}
# Run was filtered to spring (or only spring is collected) prior to sharing data
# According to methods (https://www.calfish.org/ProgramsData/ConservationandManagement/CentralValleyMonitoring/SacramentoValleyTributaryMonitoring/ButteCreek.aspx)
# the trapping site is downstream of spring run spawning habitat but upstream of fall run spawning habitat
# TODO uncertainty associated with trapping spring - what percentage may be fall?
butte_rst %>% glimpse
unique(butte_rst$station)
unique(butte_rst$mark_code)
unique(butte_rst$gear_id)
unique(butte_rst$lifestage)
ck <- filter(butte_rst, gear_id == "diversion fyke trap 1")
filter(butte_rst, is.na(fork_length), count > 0) %>% glimpse
filter(butte_rst, is.na(mark_code)) %>% tally()

butte_rst_clean_pre_2015 <- butte_rst %>%
  select(date, station, dead, count, fork_length, weight, mark_code, lifestage) %>%
  rename(adipose_clipped = mark_code, 
         subsite = station) %>%
  mutate(stream = "butte creek",
         site = case_when(grepl("Okie Dam", subsite) ~ "okie dam",
                          T ~ tolower(subsite)),
         subsite = tolower(subsite),
         run = "spring",
         adipose_clipped = case_when(adipose_clipped == "none" ~ F,
                            adipose_clipped == "adclipped" ~ T),
         run_method = "not recorded",
         species = "chinook salmon") %>%
  group_by(date, site, subsite, dead, fork_length, weight, adipose_clipped, lifestage, stream, run, run_method, species) %>%
  summarize(count = sum(count, na.rm = T)) 

```

Prep data from CAMP to combine with RST clean
```{r, butte_camp_clean}
butte_rst_clean_camp <- butte_rst_camp %>%
  # removing existing mark for now. will add all those in later
  select(-c(catchRawID, trapVisitID, visitTime2, markType_1, markColor_1, markPosition_1, markCode_1)) %>%
  # combine atcapture and final run
  mutate(run = ifelse(!is.na(finalRun), finalRun, atCaptureRun),
         runMethod = ifelse(!is.na(finalRunMethod), finalRunMethod, atCaptureRunMethod)) %>% 
  select(-c(atCaptureRun, atCaptureRunMethod, finalRun, finalRunMethod)) %>% 
  rename(fork_length = forkLength,
         adipose_clipped = fishOrigin,
         species = commonName,
         lifestage = lifeStage,
         date = visitTime,
         run_method = runMethod,
         site = siteName,
         subsite = subSiteName,
         release_id = releaseID,
         dead = mort) %>%
  group_by(date, species, fork_length, weight, lifestage, dead, run, adipose_clipped, run_method, site, subsite, release_id) %>%
  summarize(count = sum(n, na.rm = T)) %>%
  mutate(stream = "butte creek",
         # TODO update sites and subsites
         site = ifelse(site == "Okie RST", "okie dam", tolower(site)),
         subsite = tolower(subsite),
         adipose_clipped = case_when(adipose_clipped == "Natural" ~ F,
                                     adipose_clipped == "Hatchery" ~ T),
         lifestage = tolower(lifestage),
         species = tolower(species),
         run_method = tolower(run_method),
         run = tolower(run),
         dead = ifelse(dead == "Yes", T, F),
         release_id = as.character(ifelse(release_id == 0 | release_id == 255, NA, release_id))) |> glimpse()

```

Combine butte pre 2015 (excel) and post 2015 (CAMP). No temporal overlap in datasets so we can just bind rows
```{r, combine_butte}
# bind rows
butte_rst_clean <- bind_rows(butte_rst_clean_pre_2015, butte_rst_clean_camp) |> glimpse()

```

Check that all days trap running have catch rows
```{r}
butte_rst_min <- butte_rst_clean %>% 
  mutate(wy = ifelse(month(date) %in% 10:12, year(date) + 1, year(date))) %>% 
  group_by(wy) %>% 
  summarize(min = min(date))

# pre 2015 all catch and trap stored in one spot
butte_trap_pre_2015 <- butte_rst %>% 
  select(date) %>% 
  mutate(wy = ifelse(month(date) %in% 10:12, year(date) + 1, year(date))) %>% 
  group_by(wy) %>% 
  summarize(min = min(date))

butte_trap_camp_dates <-  butte_trap_camp |>
  mutate(wy = ifelse(month(visitTime) %in% 10:12, year(visitTime) + 1, year(visitTime))) %>% 
  group_by(wy) %>% 
  summarize(min = min(visitTime))

butte_trap_combined <- bind_rows(butte_trap_pre_2015, butte_trap_camp_dates) |>  rename(trap_min = min)

# min date in catch and trap aligns 
butte_min_date_compare <- full_join(butte_rst_min, butte_trap_combined)
```


```{r, final_butte_edits}

setDT(butte_rst_clean)
# THIS CODE MODIFIES battle_rst_clean_final using functions that
# mutate using data.table package
butte_rst_clean %>% 
  # run mutate not applied because all spring
  lifestage_encoding_dt()
```




### Variables removed

- trap_status, gear_id, north_brush, south_brush, debris, comments, trap_revolutions, rpms_start, rpms_end: included in operations table
- weather, temperature, turbidity, secchi, velocity: included in environmental table
- time is removed because this is captured in trap operations table

## Clear Creek

```{r, clear_data_dictionary}
clear_data_dictionary <- read_rds(here::here("data-raw", "qc-markdowns", "rst",
                                             "data-dictionaries", "clear_rst_data_dictionary.rds"))
kable(clear_data_dictionary)
```

```{r, clear_clean}
clear_rst %>%glimpse
unique(clear_rst$run)
unique(clear_rst$lifestage)
# only one with missing run designation
filter(clear_rst, is.na(run)) %>% tally()
# notes to include
# some data may be interpolated (less than 1% may be interpolated)
# all runs included
# no variable for mark code so assume all unmarked
# locations are unique locations
# run method: fWS_race (Sheila Greene LAD with adjustments, all fall run are spring run)
unique(clear_rst$station_code)

clear_rst_clean <- clear_rst %>%
  select(-c(sample_id)) %>%
  rename(site = station_code) %>%
  group_by(date, site, run, fork_length, lifestage, dead, interpolated) %>%
  summarize(count = sum(count, na.rm = T)) 

clear_rst_min <- clear_rst_clean %>% 
  mutate(wy = ifelse(month(date) %in% 10:12, year(date) + 1, year(date))) %>% 
  group_by(wy) %>% 
  summarize(min = min(date))

# Trap operations and environmental data was captured separately
# Need to check that if data in environmental it is also in catch data
# e.g. make sure that if no catch then 0 in catch data

clear_trap_clean <- clear_environmental %>%
  rename(site = station_code) %>%
  # use sample date because this is the date the trap would have been checked
  select(site, sample_date) %>% 
  distinct()

clear_trap_min <- clear_trap_clean %>% 
  mutate(wy = ifelse(month(sample_date) %in% 10:12, year(sample_date) + 1, year(sample_date))) %>% 
  group_by(wy) %>% 
  summarize(trap_min = min(sample_date))

# when comparing min dates in rst and environmental data, they differ
# this means that we need to add in zero catch data
clear_min_date_compare <- full_join(clear_rst_min, clear_trap_min)

# select recaptured fish to add to full catch table
clear_recapture <- clear_mark_recapture %>% 
  select(release_date, release_site, caught_day_1, caught_day_2, caught_day_3, caught_day_4, caught_day_5) %>% 
  mutate(stream = "clear creek",
         release_id = paste0("CLR", row_number()), 
         site = case_when(release_site == "CCRB" ~ "ucc", 
                          release_site == "VB" ~ "lcc"),
         subsite = site) %>%
  select(-release_site) %>% 
  pivot_longer(cols = caught_day_1:caught_day_5, names_to = "date", values_to = "count") %>%
  mutate(date = case_when(date == "caught_day_1" ~ release_date + 1, 
                                    date == "caught_day_2" ~ release_date + 2,
                                    date == "caught_day_3" ~ release_date + 3,
                                    date == "caught_day_4" ~ release_date + 4,
                                    date == "caught_day_5" ~ release_date + 5),
         species = "chinook salmon",
         run = "not recorded",
         lifestage = "not recorded",
         run_method = "not recorded") %>% 
  select(-release_date) %>% 
  filter(count > 0 & !is.na(count))
  
# This contains ALL data
# Assumption is that if date is in environmental data but not catch data there was zero catch
clear_rst_clean_final <- full_join(clear_rst_clean, 
                                    clear_trap_clean %>% 
                                      rename(date = sample_date)) %>% 
  mutate(count = ifelse(is.na(count), 0, count),
         stream = "clear creek",
         site = tolower(site),
         subsite = site,
         adipose_clipped = F,
         run_method = "adjusted length-at-date",
         species = "chinook salmon") %>% 
  bind_rows(clear_recapture) %>% 
  # there is one obs in recapture data missing site/subsite. filled in with ucc
  mutate(site = ifelse(is.na(site), "ucc", site),
         subsite = ifelse(is.na(subsite), "ucc", subsite))

# THIS CODE MODIFIES battle_rst_clean_final using functions that
# mutate using data.table package
setDT(clear_rst_clean_final)
clear_rst_clean_final %>% 
  run_encoding_dt() %>% 
  lifestage_encoding_dt()
  
```

### Variables removed

- sample_id: unable to connect this to any additional data so it is not relevant
to include


## Deer Creek

```{r, deer_data_dictionary}
deer_data_dictionary <- read_rds(here::here("data-raw", "qc-markdowns", "rst", 
                                            "data-dictionaries", "deer_rst_data_dictionary.rds"))
kable(deer_data_dictionary)
```

```{r, deer_clean}
deer_rst %>% glimpse
unique(deer_rst$location)
filter(deer_rst, is.na(fork_length), count > 0) %>% glimpse

deer_rst_clean <- deer_rst %>%
  select(date, location, count, fork_length, weight) %>%
  group_by(date, fork_length, weight) %>%
  summarize(count = sum(count, na.rm = T)) %>%
  mutate(stream = "deer creek",
         site = stream,
         subsite = site,
         run = "not recorded",
         run_method = "not recorded",
         adipose_clipped = F,
         lifestage = "not recorded",
         species = "chinook salmon")
```

### Variables removed

- flow, turbidity, weather, water_temperature_celsius: included in environmental table
- tubs_of_debris, trap_condition_code, comments, time_for_10_revolutions: included in operations table

## Feather River

```{r, feather_data_dictionary}
feather_data_dictionary <- read_rds(here::here("data-raw", "qc-markdowns", "rst", 
                                               "data-dictionaries", "feather_rst_data_dictionary.rds"))
kable(feather_data_dictionary)
```

There are differences between the original excel spreadsheet provided and the
CAMP database. There are 400+ cases where there are small discrepancies between
count when grouped by date, site and run.

There are many cases where run is "not recorded" in CAMP and few cases in the
original excel files. Decided to use the run recorded in CAMP because no information
how run was being assigned in the excel files. Run can be filled in using the
standard length at date model.

To the best of our knowledge, Feather uses CAMP to store their data so CAMP
should be the most reliable data source.

```{r, compare_feather}
feather_excel_test <- feather_rst %>% 
  group_by(date, site_name, run) %>% 
  summarize(count = sum(count, na.rm = T)) %>% 
  rename(site = site_name,
         excel = count) 
  

feather_camp_test <- feather_rst_camp %>% 
  select(-c(catchRawID, trapVisitID, releaseID, visitTime2)) %>%
  #combine atcapture and final run
  mutate(run = ifelse(!is.na(finalRun) & finalRun != "Not recorded", finalRun, atCaptureRun),
         runMethod = ifelse(!is.na(finalRunMethod), finalRunMethod, atCaptureRunMethod)) %>%
  select(-c(finalRun, finalRunMethod, atCaptureRun, atCaptureRunMethod)) %>%
  filter(commonName == "Chinook salmon") %>% 
  rename(fork_length = forkLength,
         lifestage = lifeStage,
         date = visitTime,
         site = siteName) %>%
  group_by(date, site, run) %>%
  summarize(count = sum(n, na.rm = T)) %>% 
  rename(camp = count) %>% 
  mutate(run = tolower(run))

compare <- full_join(feather_excel_test, feather_camp_test)
filter(compare, excel != camp)
filter(compare, run == "not recorded") %>% group_by(year(date)) %>% tally()
filter(feather_excel_test, is.na(run)) %>% group_by(year(date)) %>% tally()
```

```{r, feather_clean}
feather_rst %>% glimpse
feather_rst_camp %>% glimpse
# same dates for the excel sheets vs CAMP so use CAMP
min(feather_rst$date)
min(feather_rst_camp$visitTime)
ck <- filter(feather_rst_camp, is.na(visitTime))
# many obs where run is NA
unique(feather_rst_camp$run)
#filter(feather_rst_camp, is.na(run), commonName == "Chinook salmon", n >0)
unique(feather_rst_camp$commonName)
unique(feather_rst_camp$fishOrigin)
unique(feather_rst_camp$markType)
filter(feather_rst_camp, visitTime != visitTime2)

# organize feather subsites by high flow channel and low flow channel to make easier to understand
lfc <- c("eye riffle_north", "eye riffle_side channel", "gateway main 400' up river", "gateway_main1", "gateway_rootball", "gateway_rootball_river_left", "#steep riffle_rst", "steep riffle_10' ext", "steep side channel")
hfc <- c("herringer_east", "herringer_upper_west", "herringer_west", "live oak", "shawns_east", "shawns_west", "sunset east bank", "sunset west bank")

feather_rst_clean <- feather_rst_camp %>%
  # removing existing mark for now. will add all those in later
  select(-c(catchRawID, trapVisitID, visitTime2, markType_1, markColor_1, markPosition_1, markCode_1)) %>%
  # combine atcapture and final run
  mutate(run = ifelse(!is.na(finalRun), finalRun, atCaptureRun),
         runMethod = ifelse(!is.na(finalRunMethod), finalRunMethod, atCaptureRunMethod)) %>% 
  select(-c(atCaptureRun, atCaptureRunMethod, finalRun, finalRunMethod)) %>% 
  rename(fork_length = forkLength,
         adipose_clipped = fishOrigin,
         species = commonName,
         lifestage = lifeStage,
         date = visitTime,
         run_method = runMethod,
         site = siteName,
         subsite = subSiteName,
         release_id = releaseID,
         dead = mort) %>%
  group_by(date, species, fork_length, weight, lifestage, dead, run, adipose_clipped, run_method, site, subsite, release_id) %>%
  summarize(count = sum(n, na.rm = T)) %>%
  mutate(stream = "feather river",
         subsite = tolower(subsite),
         site = case_when(subsite %in% lfc ~ "upper feather lfc",
                          subsite %in% hfc ~ "upper feather hfc"),
         adipose_clipped = case_when(adipose_clipped == "Natural" ~ F,
                                     adipose_clipped == "Hatchery" ~ T),
         lifestage = tolower(lifestage),
         species = tolower(species),
         run_method = tolower(run_method),
         run = tolower(run),
         dead = ifelse(dead == "Yes", T, F),
         release_id = as.character(ifelse(release_id == 0 | release_id == 255, NA, release_id))) 

feather_rst_min <- feather_rst_clean %>% 
  mutate(wy = ifelse(month(date) %in% 10:12, year(date) + 1, year(date))) %>% 
  group_by(wy) %>% 
  summarize(min = min(date))

feather_trap_clean <- feather_trap_camp %>%
  rename(date = visitTime) %>%
  distinct(date, siteName)

feather_trap_min <- feather_trap_clean %>% 
  mutate(wy = ifelse(month(date) %in% 10:12, year(date) + 1, year(date))) %>% 
  group_by(wy) %>% 
  summarize(trap_min = min(date))

# when comparing min dates in rst and environmental data, they differ
# this means that we need to add in zero catch data
# no difference for feather
feather_min_date_compare <- full_join(feather_rst_min, feather_trap_min)

setDT(feather_rst_clean)
feather_rst_clean %>% 
  run_encoding_dt() %>% 
  run_method_encoding_dt() %>% 
  lifestage_encoding_dt()
```

## Mill Creek

```{r, mill_data_dictionary}
mill_data_dictionary <- read_rds(here::here("data-raw", "qc-markdowns", "rst", 
                                            "data-dictionaries", "mill_rst_data_dictionary.rds"))
kable(mill_data_dictionary)
```

```{r, mill_clean}
# No hours fishing data available
# Run is not collected
mill_rst %>% glimpse
unique(mill_rst$location)
filter(mill_rst, is.na(fork_length), count > 0) %>% glimpse
filter(mill_rst, is.na(count))

mill_rst_clean <- mill_rst %>%
  select(date, count, fork_length) %>%
  group_by(date, fork_length) %>%
  summarize(count = sum(count, na.rm = T)) %>%
  mutate(stream = "mill creek",
         site = stream,
         subsite = site,
         run = "not recorded",
         run_method = "not recorded",
         adipose_clipped = F,
         lifestage = "not recorded",
         species = "chinook salmon")
```

### Variables removed

- flow, water_temperature, turbidity, weather: included in environmental table
- tubs_of_debris, trap_condition_code, comments, time_for_10_revolutions: included in operations table

## Yuba River

```{r, yuba_data_dictionary}
yuba_data_dictionary <- read_rds(here::here("data-raw", "qc-markdowns", "rst", 
                                            "data-dictionaries", "yuba_rst_data_dictionary.rds"))
kable(yuba_data_dictionary)
```

```{r, yuba_clean}
yuba_rst %>% glimpse
unique(yuba_rst$location)
unique(yuba_rst$run)
ck <- filter(yuba_rst, is.na(run), !is.na(count), count > 0)
# all are CHN
unique(yuba_rst$organism_code)
unique(yuba_rst$lifestage)
# note that run designation is a combination of run and lifestage.
# run not filtered
# sites are names for traps at the same location and should be summed

filter(yuba_rst, is.na(fork_length), count > 0) %>% glimpse
filter(yuba_rst, is.na(run), count > 0) %>% glimpse
filter(yuba_rst, run == "unknown") %>% glimpse

yuba_rst_clean<- yuba_rst %>%
  select(date, fork_length, weight, lifestage, count, run, location) %>%
  mutate(site = ifelse(location == "Yuba River", "yuba river", "hallwood"),
         date = as_date(date),
         subsite = case_when(location == "Yuba River" ~ "yub",
                             location == "5 foot RST at Hallwood" ~ "hal3",
                             location == "RST 1 at Hallwood on Yuba River" ~ "hal",
                             location == "RST 2 at Hallwood" ~ "hal2")) %>%
  group_by(date, fork_length, weight, lifestage, run, site, subsite) %>%
  summarize(count = sum(count, na.rm = T)) %>%
  mutate(stream = "yuba river",
         adipose_clipped = F,
         run_method = "not recorded",
         species = "chinook salmon") 
# THIS CODE MODIFIES battle_rst_clean_final using functions that
# mutate using data.table package
setDT(yuba_rst_clean)
yuba_rst_clean %>% 
  run_encoding_dt() %>% 
  lifestage_encoding_dt()
```

### Variables removed

- method, trap_status, debris, comments, trap_revolutions, trap_revolutions2, rpms_before, rpms_after: included in operations table
- temperature, turbidity, velocity: included in environmental table
- organism_code removed because all are CHN
- time removed because this is captured in trap operations

## Lower Sacramento - Knights Landing

```{r, knights_clean}
unique(knights_landing_rst$commonName)
unique(knights_landing_rst$fishOrigin)
unique(knights_landing_rst$run)
#filter(knights_landing_rst, run == "Not applicable (n/a)") %>% glimpse
filter(knights_landing_rst, is.na(forkLength), n > 0) %>% glimpse
#unique(knights_landing_rst$runMethod)
unique(knights_landing_rst$lifeStage)
unique(knights_landing_pre2006$lifestage)
filter(knights_landing_pre2006, lifestage == "older juvenile") %>% tally()
# check missing trap days
filter(knights_effort, visitTime == "2014-02-15")

# 1,603 unknown, 2 not recorded
filter(knights_landing_rst, fishOrigin == "Unknown") %>% tally()

knights_rst_clean_camp <- knights_landing_rst %>%
  select(-c(catchRawID, trapVisitID, visitTime2, visitType, markCode_1, markType_1, markColor_1, markPosition_1, markType_2, markColor_2, markPosition_2, markCode_2, markType_3, markColor_3, markPosition_3, markCode_3)) %>%
  # combine atcapture and final run
  mutate(run = ifelse(!is.na(finalRun), finalRun, atCaptureRun),
         runMethod = ifelse(!is.na(finalRunMethod), finalRunMethod, atCaptureRunMethod)) %>% 
  select(-c(atCaptureRun, atCaptureRunMethod, finalRun, finalRunMethod)) %>% 
  rename(count = n,
         date = visitTime,
         fork_length = forkLength,
         adipose_clipped = fishOrigin,
         species = commonName,
         run_method = runMethod,
         lifestage = lifeStage,
         release_id = releaseID,
         subsite = subSiteName,
         dead = mort) %>%
  group_by(fork_length, weight, species, run, run_method, lifestage, adipose_clipped, date, release_id, subsite, dead) %>%
  summarize(count = sum(count, na.rm = T)) %>% 
  mutate(stream = "sacramento river",
         site = "knights landing",
         subsite = tolower(subsite),
         adipose_clipped = case_when(adipose_clipped == "Natural" ~ F,
                                     adipose_clipped == "Hatchery" ~ T),
         lifestage = tolower(lifestage),
         species = tolower(species),
         run_method = tolower(run_method),
         run = tolower(run),
         dead = ifelse(dead == "Yes", T, F),
         release_id = as.character(ifelse(release_id == 0 | release_id == 255, NA, release_id)))

filter(knights_landing_pre2006, species == "Steelhead", count > 0)
filter(knights_landing_pre2006, species == "Chinook", is.na(at_capture_run), count > 0)
filter(knights_landing_pre2006, date < "2006-10-02", lifestage == "older juvenile", count > 0)

knights_rst_clean_pre2006 <- knights_landing_pre2006 %>% 
  # filter to only include data before 2006 (CAMP stores data 2006 to present)
  filter(date < "2006-10-02") %>% 
  select(-c(start_date, stop_date, location, fork_length_max_mm, fork_length_min_mm, cpue)) %>% 
  rename(run = at_capture_run,
         adipose_clipped = marked) %>% 
  mutate(count = ifelse(is.na(count), 0, count),
         subsite = "knights landing", # data not disaggregated by trap
         # this likely happened from reshaping of data
         remove = case_when(is.na(run) & species == "Chinook" & count == 0 ~ "remove",
                            T ~ "keep")) %>% 
  filter(remove != "remove") %>% 
  select(-remove) %>% 
  group_by(date, species, run, lifestage, adipose_clipped, subsite) %>% 
  summarise(count = sum(count))

knights_rst_clean <- bind_rows(knights_rst_clean_camp,
                           knights_rst_clean_pre2006) 

knights_rst_min <- knights_rst_clean %>% 
  mutate(wy = ifelse(month(date) %in% 10:12, year(date) + 1, year(date))) %>% 
  group_by(wy) %>% 
  summarize(min = min(date))

# Trap operations and environmental data was captured separately
# Need to check that if data in environmental it is also in catch data
# e.g. make sure that if no catch then 0 in catch data

# visitTime = visitTime2
filter(knights_effort, visitTime != visitTime2)

knights_trap_clean_camp <- knights_effort %>%
  # use sample date because this is the date the trap would have been checked
  select(visitTime) %>% 
  rename(date = visitTime) %>% 
  distinct()

knights_trap_pre2006 <- knights_effort_pre2006 %>% 
  # filter to only include data before 2006 (CAMP stores data 2006 to present)
  filter(date < "2006-10-02") %>% 
  select(date) %>% 
  distinct()

knights_trap_clean <- bind_rows(knights_trap_clean_camp, knights_trap_pre2006)

knights_trap_min <- knights_trap_clean %>% 
  mutate(wy = ifelse(month(date) %in% 10:12, year(date) + 1, year(date))) %>% 
  group_by(wy) %>% 
  summarize(trap_min = min(date))

# when comparing min dates in rst and environmental data, they differ
# this means that we need to add in zero catch data
knights_min_date_compare <- full_join(knights_rst_min, knights_trap_min)

# This contains ALL data
# Assumption is that if date is in environmental data but not catch data there was zero catch
knights_rst_clean_final <- full_join(knights_rst_clean, 
                                    knights_trap_clean) %>% 
  mutate(count = ifelse(is.na(count), 0, count),
         stream = "sacramento river",
         site = "knights landing",
         date = as_date(date),
         adipose_clipped = case_when(adipose_clipped == "Natural" ~ F,
                                     adipose_clipped == "Hatchery" ~ T),
         run_method = tolower(run_method),
         species = tolower(species),
         species = ifelse(species == "chinook", "chinook salmon", species),
         lifestage = tolower(lifestage),
         run = tolower(run)) 
# THIS CODE MODIFIES knights_clean_final using functions that
# mutate using data.table package
setDT(knights_rst_clean_final)
knights_rst_clean_final %>% 
  run_encoding_dt() %>% 
  run_method_encoding_dt() %>% 
  lifestage_encoding_dt()
```

### Variables removed

- catchRawID, trapVisitID, lifeStageCAMPID removed because outside of CAMP this doesn't link well
- visitTime2 is typically the same as visitTime and is included in effort table
- visitType is included in operations table


## Lower Sacramento - Tisdale

```{r, tisdale_data_dictionary}
tisdale_data_dictionary <- read_rds(here::here("data-raw", "qc-markdowns", "rst", 
                                               "data-dictionaries", "lower_sac_tisdale_rst_data_dictionary.rds"))
kable(tisdale_data_dictionary)
```

```{r, tisdale_clean}
tisdale_rst %>% glimpse
tisdale_rst_camp %>% glimpse
# same dates for the excel sheets vs CAMP so use CAMP
min(tisdale_rst$date)
min(tisdale_rst_camp$visitTime)
# many obs where run is NA
unique(tisdale_rst_camp$run)
#filter(tisdale_rst_camp, is.na(run), commonName == "Chinook salmon", n >0)
unique(tisdale_rst_camp$commonName)
unique(tisdale_rst_camp$fishOrigin)
unique(tisdale_rst_camp$markType)
filter(tisdale_rst_camp, visitTime != visitTime2)
tisdale_rst_clean <- tisdale_rst_camp %>%
  # removing existing mark for now. will add all those in later
  select(-c(catchRawID, trapVisitID, visitTime2, visitType, markCode_1, markType_1, markColor_1, markPosition_1)) %>%
  # combine atcapture and final run
  mutate(run = ifelse(!is.na(finalRun), finalRun, atCaptureRun),
         runMethod = ifelse(!is.na(finalRunMethod), finalRunMethod, atCaptureRunMethod)) %>% 
  select(-c(atCaptureRun, atCaptureRunMethod, finalRun, finalRunMethod)) %>% 
  rename(fork_length = forkLength,
         adipose_clipped = fishOrigin,
         species = commonName,
         lifestage = lifeStage,
         date = visitTime,
         run_method = runMethod, 
         subsite = subSiteName,
         release_id = releaseID,
         dead = mort) %>%
  group_by(date, species, fork_length, weight, lifestage, dead, run, adipose_clipped, run_method, stream, site, subsite, release_id,) %>%
  summarize(count = sum(n, na.rm = T)) %>%
  mutate(subsite = tolower(subsite),
         adipose_clipped = case_when(adipose_clipped == "Natural" ~ F,
                                     adipose_clipped == "Hatchery" ~ T),
         lifestage = tolower(lifestage),
         species = tolower(species),
         run_method = tolower(run_method),
         run = tolower(run),
         dead = ifelse(dead == "Yes", T, F),
         release_id = as.character(ifelse(release_id == 0 | release_id == 255, NA, release_id))) 

tisdale_rst_min <- tisdale_rst_clean %>% 
  mutate(wy = ifelse(month(date) %in% 10:12, year(date) + 1, year(date))) %>% 
  group_by(wy) %>% 
  summarize(min = min(date))

tisdale_trap_clean <- tisdale_trap_camp %>%
  rename(date = visitTime) %>%
  distinct()

tisdale_trap_min <- tisdale_trap_clean %>% 
  mutate(wy = ifelse(month(date) %in% 10:12, year(date) + 1, year(date))) %>% 
  group_by(wy) %>% 
  summarize(trap_min = min(date))

# when comparing min dates in rst and environmental data, they differ
# this means that we need to add in zero catch data
# no difference for tisdale
tisdale_min_date_compare <- full_join(tisdale_rst_min, tisdale_trap_min)

setDT(tisdale_rst_clean)
tisdale_rst_clean %>% 
  run_encoding_dt() %>% 
  run_method_encoding_dt() %>% 
  lifestage_encoding_dt()
```

### Variables removed

- fish_processed: included in operations table
- run is a combination of at_capture_run and final_run (replaces at_capture_run with final_run when final_run exists)
- release_id is an ID column from CAMP and doesn't link well outside of CAMP
- mark_type, mark_position, mark_color removed because little information (35 obs) and rearing includes the fin clip marking

# Standard format {.tabset}

## River Length At Date

Process LAD to find range of fork lengths assigned to run on given day

```{r}
lad_spring <- filter(lad, LENGTHRUN == "S") %>%
  rename(s_start = STARTFL,
         s_end = ENDFL) %>%
  select(-LENGTHRUN) %>%
  group_by(SAMPLEMONTH, SAMPLEDAY) %>%
  mutate(count = n()) 
lad_spring_2 <- filter(lad_spring, count > 1) %>% 
  slice_min(s_start) %>%
  rename(s_start_1 = s_start,
         s_end_1 = s_end) %>%
  left_join(filter(lad_spring, count > 1) %>% 
  slice_max(s_start) %>%
  rename(s_start_2 = s_start,
         s_end_2 = s_end)) %>%
  select(-count)
lad_spring_format <- filter(lad_spring, count == 1) %>%
  select(-count) %>%
  rename(s_start_1 = s_start,
         s_end_1 = s_end) %>%
  bind_rows(lad_spring_2)

# Format fall run. There may be multiple criteria for one date
lad_fall <- filter(lad, LENGTHRUN == "F") %>%
  rename(f_start = STARTFL,
         f_end = ENDFL) %>%
  select(-LENGTHRUN) %>%
  group_by(SAMPLEMONTH, SAMPLEDAY) %>%
  mutate(count = n()) 
lad_fall_2 <- filter(lad_fall, count > 1) %>% 
  slice_min(f_start) %>%
  rename(f_start_1 = f_start,
         f_end_1 = f_end) %>%
  left_join(filter(lad_fall, count > 1) %>% 
  slice_max(f_start) %>%
  rename(f_start_2 = f_start,
         f_end_2 = f_end)) %>%
  select(-count)
lad_fall_format <- filter(lad_fall, count == 1) %>%
  select(-count) %>%
  rename(f_start_1 = f_start,
         f_end_1 = f_end) %>%
  bind_rows(lad_fall_2)

# Format winter run. There may be multiple criteria for one date.
lad_winter <- filter(lad, LENGTHRUN == "W") %>%
  rename(w_start = STARTFL,
         w_end = ENDFL) %>%
  select(-LENGTHRUN) %>%
  group_by(SAMPLEMONTH, SAMPLEDAY) %>%
  mutate(count = n()) 
lad_winter_2 <- filter(lad_winter, count > 1) %>% 
  slice_min(w_start) %>%
  rename(w_start_1 = w_start,
         w_end_1 = w_end) %>%
  left_join(filter(lad_winter, count > 1) %>% 
  slice_max(w_start) %>%
  rename(w_start_2 = w_start,
         w_end_2 = w_end)) %>%
  select(-count)
lad_winter_format <- filter(lad_winter, count == 1) %>%
  select(-count) %>%
  rename(w_start_1 = w_start,
         w_end_1 = w_end) %>%
  bind_rows(lad_winter_2)

# Format late fall run. There may be multiple criteria for one date.
lad_latefall <- filter(lad, LENGTHRUN == "L") %>%
  rename(l_start = STARTFL,
         l_end = ENDFL) %>%
  select(-LENGTHRUN) %>%
  group_by(SAMPLEMONTH, SAMPLEDAY) %>%
  mutate(count = n()) 
lad_latefall_2 <- filter(lad_latefall, count > 1) %>% 
  slice_min(l_start) %>%
  rename(l_start_1 = l_start,
         l_end_1 = l_end) %>%
  left_join(filter(lad_latefall, count > 1) %>% 
  slice_max(l_start) %>%
  rename(l_start_2 = l_start,
         l_end_2 = l_end)) %>%
  select(-count)
lad_latefall_format <- filter(lad_latefall, count == 1) %>%
  select(-count) %>%
  rename(l_start_1 = l_start,
         l_end_1 = l_end) %>%
  bind_rows(lad_latefall_2)

lad_format <- full_join(lad_spring_format, lad_fall_format) %>%
  full_join(lad_winter_format) %>%
  full_join(lad_latefall_format) %>%
  rename(month = SAMPLEMONTH,
         day = SAMPLEDAY)
```

```{r, combined}
# TODO fill in run method - this will involve outreach with monitoring programs
# improve performance by using data.table
combined_rst <- bind_rows(battle_rst_clean_final,
                          butte_rst_clean,
                          clear_rst_clean_final,
                          deer_rst_clean,
                          feather_rst_clean,
                          mill_rst_clean,
                          yuba_rst_clean,
                          knights_rst_clean_final,
                          tisdale_rst_clean) %>% 
  as_tibble() %>% 
  mutate(date = as.Date(date),
         month = month(date), # add to join with lad
         day = day(date)) %>% # add to join with lad
  left_join(lad_format) %>% 
  # if run is not recorded (e.g. mill and deer) replace with river model LAD
  mutate(run_lad_rivermodel = case_when((fork_length >= s_start_1 & fork_length < s_end_1) |
                                      (fork_length >= s_start_2 & fork_length < s_end_2) ~ "spring",
                                    (fork_length >= f_start_1 & fork_length < f_end_1) |
                                      (fork_length >= f_start_2 & fork_length < f_end_2) ~ "fall",
                                    (fork_length >= w_start_1 & fork_length < w_end_1) |
                                      (fork_length >= w_start_2 & fork_length < w_end_2) ~ "winter",
                                    (fork_length >= l_start_1 & fork_length < l_end_1) |
                                      (fork_length >= l_start_2 & fork_length < l_end_2) ~ "late fall"),
         run = ifelse(run == "not recorded", run_lad_rivermodel, run),
         run_method = ifelse(run == "not recorded", "length-at-date criteria", run_method)) %>% 
  select(date, run, fork_length, lifestage, dead, interpolated, count, stream, site, subsite, adipose_clipped, run_method, species, release_id, weight)

unique(combined_rst$run)
unique(combined_rst$lifestage)
unique(combined_rst$site)
unique(combined_rst$stream)
```

## Data dictionary

```{r, data_dictionary_prep, include = F}
colnames(combined_rst)

rst_catch_data_dictionary <- tibble(variable_name = colnames(combined_rst),
                                    description = c("Date trap was checked.",
                                                    "Designated run of fish using method in run_method. Some locations did not designate a run; in these cases the river model length at date criteria were applied. NA when count is 0.",
                                                    "Fork length of fish in mm.",
                                                    "Life stage of fish. NA when count is 0.",
                                                    "Describes if fish were dead when observed (T/F).",
                                                    "Describes if data were interpolated (T/F).",
                                                    "Number of fish caught.",
                                                    "Mainstem/tributary location of trap.",
                                                    "Site of trap within location. Some locations do not have multiples sites in which stream = site. Site names are specific to the tributary.",
                                                    "Name of trap where fish were caught.",
                                                    "Describes if adipose fin is clipped (T/F). This is used to determine if the fish is natural or hatchery origin. In some cases this information may be unknown.",
                                                    "Method used to designate run. NA if count is 0.",
                                                    "Species of fish.",
                                                    "Release group that recaptured fish is part of. If fish is not a recaptured fish, release_id is NA.",
                                                    "Weight in grams."
                                                    ),
                                    
                                    encoding = c(NA,
                                                 "late fall, spring, fall, winter, not recorded, unknown",
                                                 NA,
                                                 "smolt, fry, yolk sac fry, not recorded, parr, silvery parr, adult, unknown, yearling",
                                                 "TRUE, FALSE",
                                                 "TRUE, FALSE",
                                                 NA,
                                                 "battle creek, butte creek, clear creek, deer creek, feather river, mill creek, yuba river, sacramento river",
                                                 "battle creek, okie dam, adams dam, lcc, ucc, deer creek, eye riffle, live oak, herringer riffle, steep riffle, sunset pumps, shawns beach, gateway riffle, mill creek, yuba river, hallwood, knights landing, tisdale",
                                                 "see readme",
                                                 "TRUE, FALSE",
                                                 "not recorded, length-at-date criteria, appearance, hatchery attribute",
                                                 "chinook salmon as well as other species caught in trap",
                                                 "NA if not recapture fish",
                                                 NA
                                                 ),
                                    collected = c("All",
                                                       "All but Deer, Mill",
                                                       "All",
                                                       "All but Deer, Mill",
                                                       "All but Deer, Mill, Yuba",
                                                       "Battle, Clear",
                                                       "All",
                                                       "All",
                                                       "All",
                                                       "All",
                                                       "Butte, Feather, Knights, Tisdale",
                                                       "Battle, Clear, Feather, Knights, Tisdale",
                                                       "Feather, Knights, Tisdale",
                                                  "Battle, Clear, Feather, Knights, Tisdale",
                                                       "Butte, Deer, Feather, Knights, Tisdale, Yuba"))
```

```{r, data_dictionary}
kable(rst_catch_data_dictionary)
# write_csv(rst_catch_data_dictionary, "rst_catch_data_dictionary.csv")
```

## Exploratory plots

Boxplots of lifestage and fork length to verify lifestage encodings

```{r}
ggplot(combined_rst, aes(x = lifestage, y = fork_length)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45))
```

Yolk sac fry categories

```{r}
# check category mappings
# yolk sac fry
ggplot(filter(combined_rst, lifestage %in% c("yolk-sac fry", "yolk sac fry (alevin)", "yolk sac fry")), aes(x = lifestage, y = fork_length)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45))
```

Silvery fry categories 

Fingerling and pre-smolt added to silvery parr because of similar fork lengths.

```{r}
# silvery parr
ggplot(filter(combined_rst, lifestage %in% c("silvery parr", "fingerling", "pre-smolt")), aes(x = lifestage, y = fork_length)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45))
```

Juvenile and unknown

Only one "yoy (young of the year)" and two juvenile. These are added to unknown (there is 1 unknown).

```{r}
# unknown
ggplot(filter(combined_rst, lifestage %in% c("unknown", "yoy (young of the year)", "juvenile")), aes(x = lifestage, y = fork_length)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45))

filter(combined_rst, lifestage == "yoy (young of the year)") %>% tally()
filter(combined_rst, lifestage == "juvenile") %>% tally()
filter(combined_rst, lifestage == "unknown") %>% tally()
```

Parr

Pre-smolt fits better with silvery parr

```{r}
# parr
ggplot(filter(combined_rst, lifestage %in% c("parr", "pre-smolt")), aes(x = lifestage, y = fork_length)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45))
```

Fry

Button up fry and fry are similar fork lengths

```{r}
# fry
ggplot(filter(combined_rst,  lifestage %in% c("fry", "button-up fry", "fry (button-up)")), aes(x = lifestage, y = fork_length)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45))
```


# QA/QC {.tabset}

## run

Run is not recorded for Mill and Deer. Butte only has spring run.

Figure below shows the percentage by run for each tributary and year.

```{r, run_qaqc}
unique(combined_rst$run)

total_count <- combined_rst %>%
  mutate(year = year(date)) %>%
  group_by(stream, year) %>%
  summarize(total = sum(count, na.rm = T))

combined_rst %>%
  mutate(year = year(date)) %>%
  group_by(stream, year, run) %>%
  summarize(count = sum(count, na.rm = T)) %>%
  left_join(total_count) %>%
  mutate(percent = (count/total)*100) %>%
  ggplot(aes(x = year, y = percent, fill = run)) +
  geom_col() +
  facet_wrap(~stream, scales = "free_y") +
  theme_minimal() +
  theme(legend.position = "bottom")
```

## fork_length

Figure below shows the percent of total fish counted that have a fork length measurement.

```{r, forklength_qaqc}
combined_rst %>%
  filter(!is.na(fork_length)) %>%
  mutate(year = year(date)) %>%
  group_by(stream, year) %>%
  summarize(count = sum(count, na.rm = T)) %>%
  left_join(total_count) %>%
  mutate(percent = (count/total)*100) %>%
  ggplot(aes(x = year, y = percent)) +
  geom_col() +
  facet_wrap(~stream)
  
```

## lifestage

Deer and Mill do not recored lifestage. Data is spotty for Butte and Yuba.

Figure below shows the percentage by lifestage for each tributary and year.

```{r, lifestage_qaqc}
combined_rst %>%
  mutate(year = year(date)) %>%
  group_by(stream, year, lifestage) %>%
  summarize(count = sum(count, na.rm = T)) %>%
  left_join(total_count) %>%
  mutate(percent = (count/total)*100) %>%
  ggplot(aes(x = year, y = percent, fill = lifestage)) +
  geom_col() +
  facet_wrap(~stream, scales = "free_y") +
  theme_minimal() +
  theme(legend.position = "bottom")
```
## count

Note that there are 72 observations for Mill Creek where count is NA. Count could be 0, 1, or more than 1. 

```{r, count_qaqc}
filter(combined_rst, is.na(count)) %>% glimpse()
```

## dead

Figure below shows percent of fish observed that were marked as dead. Note that some
locations do not record this information.

```{r, dead_qaqc}
combined_rst %>%
  filter(dead == T) %>%
  mutate(year = year(date)) %>%
  group_by(stream, year) %>%
  summarize(count = sum(count, na.rm = T)) %>%
  left_join(total_count) %>%
  mutate(percent = (count/total)*100) %>%
  ggplot(aes(x = year, y = percent)) +
  geom_col() +
  facet_wrap(~stream)
```

## interpolated

Battle and Clear include interpolated values.

Figure below shows percent of fish observed that were interpolated. Interpolated
counts do not include values for fork length.

```{r, interpolated_qaqc}
combined_rst %>%
  filter(interpolated == T) %>%
  mutate(year = year(date)) %>%
  group_by(stream, year) %>%
  summarize(count = sum(count, na.rm = T)) %>%
  left_join(total_count) %>%
  mutate(percent = (count/total)*100) %>%
  ggplot(aes(x = year, y = percent)) +
  geom_col() +
  facet_wrap(~stream)

combined_rst %>%
  filter(stream %in% c("battle creek", "clear creek")) %>%
  group_by(stream, date, interpolated) %>%
  summarize(count = sum(count, na.rm = T)) %>%
  ggplot(aes(x = date, y = count, color = interpolated)) +
  geom_line() +
  facet_wrap(~stream, scales = "free_y")
```

## adipose_clipped

Origin is mostly natural. Only Butte Creek, Knights Landing, Tisdale included data
for origin. For other locations it is not relevant or was already filtered.

```{r, origin_qaqc}
combined_rst %>%
  mutate(year = year(date)) %>%
  group_by(stream, year, adipose_clipped) %>%
  summarize(count = sum(count, na.rm = T)) %>%
  left_join(total_count) %>%
  mutate(percent = (count/total)*100) %>%
  ggplot(aes(x = year, y = percent, fill = origin)) +
  geom_col() +
  facet_wrap(~stream, scales = "free_y") +
  theme_minimal() +
  theme(legend.position = "bottom")
```

## weight

Figure below shows the percent of total fish counted that have a weight measurement.

```{r, weight_qaqc}
combined_rst %>%
  filter(!is.na(weight)) %>%
  mutate(year = year(date)) %>%
  group_by(stream, year) %>%
  summarize(count = sum(count, na.rm = T)) %>%
  left_join(total_count) %>%
  mutate(percent = (count/total)*100) %>%
  ggplot(aes(x = year, y = percent)) +
  geom_col() +
  facet_wrap(~stream)
```
## run_method

Only Knights Landing recorded this information. Method is assumed to be length-at-date
for all others. 

```{r, runmethod_qaqc}
combined_rst %>%
  mutate(year = year(date)) %>%
  group_by(stream, year, run_method) %>%
  summarize(count = sum(count, na.rm = T)) %>%
  left_join(total_count) %>%
  mutate(percent = (count/total)*100) %>%
  ggplot(aes(x = year, y = percent, fill = run_method)) +
  geom_col() +
  facet_wrap(~stream, scales = "free_y") +
  theme_minimal() +
  theme(legend.position = "bottom")
```

# Save data

```{r, save_data}
f <- function(input, output) write_csv(input, file = output)

gcs_upload(combined_rst,
           object_function = f,
           type = "csv",
           name = "standard-format-data/standard_rst_catch.csv",
           predefinedAcl = "bucketLevel")
```
