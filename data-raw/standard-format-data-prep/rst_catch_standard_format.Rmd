---
title: "Create standard format for RST catch data"
output: html_document
---

```{r, include = F}
library(tidyverse)
library(lubridate)
library(googleCloudStorageR)
library(knitr)
library(hms)

Sys.setenv("GCS_AUTH_FILE" = "config.json")
Sys.setenv("GCS_DEFAULT_BUCKET" = "jpe-dev-bucket")
```

Data were checked and cleaned in scripts available [here](https://github.com/FlowWest/JPE-datasets/tree/main/scripts/rst)
Cleaned data were saved on the jpe-dev-bucket on google cloud with the exception
of Knights Landing data from CAMP which has not yet been saved to google cloud.

```{r, data_pull, include = F, echo = F}
# # Data pull ---------------------------------------------------------------

# Set your authentication using gcs_auth

gcs_auth(json_file = Sys.getenv("GCS_AUTH_FILE"))
# Set global bucket
gcs_global_bucket(bucket = Sys.getenv("GCS_DEFAULT_BUCKET"))

# define files to pull in (in some cases there is just one catch file while others
# have sample and environmental data)
files_battle <- tibble(path = rep("rst/battle-creek/data/battle_rst_",3),
                       name = c("catch","environmental","passage_estimates"),
                       save = rep("data/rst/battle_rst_",3))
files_butte <- tibble(path = "rst/butte-creek/data/butte_rst",
                      name = c(""),
                      save = "data/rst/butte_rst")
files_clear <- tibble(path = rep("rst/clear-creek/data/clear_rst_",3),
                      name = c("catch","environmental","passage_estimates"),
                      save = rep("data/rst/clear_rst_",3))
files_deer <- tibble(path = "rst/deer-creek/data/deer_rst",
                     name = c(""),
                     save = "data/rst/deer_rst")
files_feather <- tibble(path = rep("rst/feather-river/data/feather_rst",2),
                        name = c("","_effort"),
                        save = rep("data/rst/feather_rst",2))
# files_knights <- tibble(path = rep("rst/lower-sac-river/data/knights-landing/knl_combine_",2),
#                         name = c("rst_clean","sampling_effort_clean"),
#                         save = rep("data/rst/knights_",2))
files_tisdale <- tibble(path = "rst/lower-sac-river/data/tisdale/rst_clean",
                        name = c(""),
                        save = "data/rst/tisdale_rst")
files_mill <- tibble(path = "rst/mill-creek/data/mill_rst",
                     name = c(""),
                     save = "data/rst/mill_rst")
files_yuba <- tibble(path = "rst/yuba-river/data/yuba_rst",
                     name = c(""),
                     save = "data/rst/yuba_rst")
# function to save file to disk
get_data <- function(path, name, save) {
  gcs_get_object(object_name = paste0(path, name, ".csv"),
                 bucket = gcs_get_global_bucket(),
                 saveToDisk = paste0(save, name, ".csv"),
                 overwrite = TRUE)
}
# apply function to each set of files
pmap(files_battle, get_data)
pmap(files_butte, get_data)
pmap(files_clear, get_data)
pmap(files_deer, get_data)
pmap(files_feather, get_data)
# pmap(files_knights, get_data)
pmap(files_tisdale, get_data)
pmap(files_mill, get_data)
pmap(files_yuba, get_data)

# load in data
# catch data
battle_rst <- read_csv("data/rst/battle_rst_catch.csv")
butte_rst <- read_csv("data/rst/butte_rst.csv") # contains trap data too
clear_rst <- read_csv("data/rst/clear_rst_catch.csv")
deer_rst <- read_csv("data/rst/deer_rst.csv") # contains trap data too
feather_rst <- read_csv("data/rst/feather_rst.csv")
# knights_rst <- read_csv("data/rst/knights_rst_clean.csv") # contains cpue info
tisdale_rst <- read_csv("data/rst/tisdale_rst.csv")
mill_rst <- read_csv("data/rst/mill_rst.csv") # contains trap data too
yuba_rst <- read_csv("data/rst/yuba_rst.csv")

# sampling effort and environmental
battle_environmental <- read_csv("data/rst/battle_rst_environmental.csv")
clear_environmental <- read_csv("data/rst/clear_rst_environmental.csv")
feather_effort <- read_csv("data/rst/feather_rst_effort.csv")
knights_effort <- read_csv("data/rst/knights_sampling_effort_clean.csv")

# Knights landing data pulled from camp
# TODO add to cloud (this dataset was shared later and has not yet been added to cloud)
knights_landing_rst <- read_rds("data/rst/knights_landing_raw_catch.rds")
```

# Data formatting {.tabset}

We format, check, and clean catch data for each stream individually because their
raw format varies. After formatting all streams we combine and apply additional
cleaning and formatting.

Battle, Clear, Feather, and Knights Landing provided trap operations/environmental
data separate from catch. In some cases, there may be trap operations/environmental
data but no catch observations for that day. In those cases, we assume that catch was 
zero and was not recorded. To capture all data (including zero catch) we combine
dates with trap operations/environmental with catch data and assume zero catch
if that date did not exist in the catch data.

```{r, helpers}
# standard encoding fixes for run
run_encoding <- function(dat) {
  dat %>%
    mutate(run = case_when(is.na(run) | run == "Not recorded" |  run == "Not applicable (n/a)" ~ "not recorded",
                           run == "outlier salmon" ~ "unknown",
                         count == 0  ~ NA_character_,
                         T ~ tolower(run)))
}

# note that there is only one "yoy (young of the year)"
lifestage_encoding <- function(dat) {
  dat %>%
    mutate(lifestage = case_when(count == 0 ~ NA_character_,
                                 lifestage %in% c("yolk-sac fry", "yolk sac fry (alevin)", "yolk sac fry") ~ "yolk sac fry",
                                 lifestage %in% c("silvery parr", "fingerling", "pre-smolt") ~ "silvery parr",
                                 lifestage %in% c("unknown", "yoy (young of the year)", "juvenile") ~ "unknown",
                                 lifestage %in% c("not recorded", "not provided") | is.na(lifestage) ~ "not recorded",
                                 lifestage == "parr" ~ "parr",
                                 lifestage %in% c("fry", "button-up fry", "fry (button-up)") ~ "fry",
                                 lifestage == "smolt" ~ "smolt",
                                 lifestage == "adult" ~ "adult",
                                 lifestage == "yearling" ~ "yearling"))
}
```

## Battle Creek

```{r, battle_data_dictionary}
battle_data_dictionary <- read_rds("data/rst/battle_rst_data_dictionary.rds")
kable(battle_data_dictionary)
```

```{r, battle_clean}
### Catch #####
battle_rst %>% glimpse
unique(battle_rst$run)
unique(battle_rst$lifestage)
filter(battle_rst, is.na(fork_length), count > 0) %>% glimpse
filter(battle_rst, is.na(run)) %>% glimpse

battle_rst %>% group_by(date, run, fork_length, lifestage, dead, interpolated) %>% count() %>% filter(n > 1)

filter(battle_rst, date == "2003-12-28")

# notes to include
# some data may be interpolated (~1% may be interpolated)
# run is not filtered
# TODO compare mean observed v interpolated to decide if we should use
# Origin - Natural because trap is above that hatchery
# run method: fWS_race (Sheila Greene LAD with adjustments, all fall run are spring run)

battle_rst_clean <- battle_rst %>%
  select(-c(sample_id)) %>%
  group_by(date, run, fork_length, lifestage, dead, interpolated) %>%
  summarize(count = sum(count, na.rm = T)) 

battle_rst_min <- battle_rst_clean %>% 
  mutate(wy = ifelse(month(date) %in% 10:12, year(date) + 1, year(date))) %>% 
  group_by(wy) %>% 
  summarize(min = min(date))

# Trap operations and environmental data was captured separately
# Need to check that if data in environmental it is also in catch data
# e.g. make sure that if no catch then 0 in catch data

battle_trap_clean <- battle_environmental %>%
  # use sample date because this is the date the trap would have been checked
  select(sample_date)

battle_trap_min <- battle_trap_clean %>% 
  mutate(wy = ifelse(month(sample_date) %in% 10:12, year(sample_date) + 1, year(sample_date))) %>% 
  group_by(wy) %>% 
  summarize(trap_min = min(sample_date))

# when comparing min dates in rst and environmental data, they differ
# this means that we need to add in zero catch data
battle_min_date_compare <- full_join(battle_rst_min, battle_trap_min)

# This contains ALL data
# Assumption is that if date is in environmental data but not catch data there was zero catch
battle_rst_clean_final <- full_join(battle_rst_clean, 
                                    battle_trap_clean %>% 
                                      rename(date = sample_date)) %>% 
  mutate(count = ifelse(is.na(count), 0, count),
         stream = "battle creek",
         site = stream,
         adipose_clipped = F,
         run_method = "adjusted length-at-date")
```

### Variables removed

- sample_id: unable to connect this to any additional data so it is not relevant
to include


## Butte Creek
```{r, butte_data_dictionary}
butte_data_dictionary <- read_rds("data/rst/butte_rst_data_dictionary.rds")
kable(butte_data_dictionary)
```

```{r, butte_clean}
# Run was filtered to spring (or only spring is collected) prior to sharing data
# According to methods (https://www.calfish.org/ProgramsData/ConservationandManagement/CentralValleyMonitoring/SacramentoValleyTributaryMonitoring/ButteCreek.aspx)
# the trapping site is downstream of spring run spawning habitat but upstream of fall run spawning habitat
# TODO uncertainty associated with trapping spring - what percentage may be fall?
butte_rst %>% glimpse
unique(butte_rst$station)
unique(butte_rst$mark_code)
unique(butte_rst$gear_id)
unique(butte_rst$lifestage)
ck <- filter(butte_rst, gear_id == "diversion fyke trap 1")
filter(butte_rst, is.na(fork_length), count > 0) %>% glimpse
filter(butte_rst, is.na(mark_code)) %>% tally()

butte_rst_clean <- butte_rst %>%
  select(date, station, dead, count, fork_length, weight, mark_code, lifestage) %>%
  rename(adipose_clipped = mark_code, 
         site = station) %>%
  mutate(stream = "butte creek",
         subsite = tolower(site),
         site = case_when(grepl("Okie Dam", site) ~ "okie dam",
                          T ~ tolower(site)),
         run = "spring",
         adipose_clipped = case_when(adipose_clipped == "none" ~ F,
                            adipose_clipped == "adclipped" ~ T),
         run_method = "unknown") %>%
  group_by(date, site, dead, fork_length, weight, adipose_clipped, lifestage, stream, run, run_method) %>%
  summarize(count = sum(count, na.rm = T))
```

### Variables removed

- trap_status, gear_id, north_brush, south_brush, debris, comments, trap_revolutions, rpms_start, rpms_end: included in operations table
- weather, temperature, turbidity, secchi, velocity: included in environmental table
- time is removed because this is captured in trap operations table

## Clear Creek

```{r, clear_data_dictionary}
clear_data_dictionary <- read_rds("data/rst/clear_rst_data_dictionary.rds")
kable(clear_data_dictionary)
```

```{r, clear_clean}
clear_rst %>%glimpse
unique(clear_rst$run)
unique(clear_rst$lifestage)
# only one with missing run designation
filter(clear_rst, is.na(run)) %>% tally()
# notes to include
# some data may be interpolated (less than 1% may be interpolated)
# all runs included
# no variable for mark code so assume all unmarked
# locations are unique locations
# run method: fWS_race (Sheila Greene LAD with adjustments, all fall run are spring run)
unique(clear_rst$station_code)

clear_rst_clean <- clear_rst %>%
  select(-c(sample_id)) %>%
  rename(site = station_code) %>%
  group_by(date, site, run, fork_length, lifestage, dead, interpolated) %>%
  summarize(count = sum(count, na.rm = T)) 

clear_rst_min <- clear_rst_clean %>% 
  mutate(wy = ifelse(month(date) %in% 10:12, year(date) + 1, year(date))) %>% 
  group_by(wy) %>% 
  summarize(min = min(date))

# Trap operations and environmental data was captured separately
# Need to check that if data in environmental it is also in catch data
# e.g. make sure that if no catch then 0 in catch data

clear_trap_clean <- clear_environmental %>%
  rename(site = station_code) %>%
  # use sample date because this is the date the trap would have been checked
  select(site, sample_date)

clear_trap_min <- clear_trap_clean %>% 
  mutate(wy = ifelse(month(sample_date) %in% 10:12, year(sample_date) + 1, year(sample_date))) %>% 
  group_by(wy) %>% 
  summarize(trap_min = min(sample_date))

# when comparing min dates in rst and environmental data, they differ
# this means that we need to add in zero catch data
clear_min_date_compare <- full_join(clear_rst_min, clear_trap_min)

# This contains ALL data
# Assumption is that if date is in environmental data but not catch data there was zero catch
clear_rst_clean_final <- full_join(clear_rst_clean, 
                                    clear_trap_clean %>% 
                                      rename(date = sample_date)) %>% 
  mutate(count = ifelse(is.na(count), 0, count),
         stream = "clear creek",
         site = tolower(site),
         adipose_clipped = F,
         run_method = "adjusted length-at-date")
  
```

### Variables removed

- sample_id: unable to connect this to any additional data so it is not relevant
to include


## Deer Creek

```{r, deer_data_dictionary}
deer_data_dictionary <- read_rds("data/rst/deer_rst_data_dictionary.rds")
kable(deer_data_dictionary)
```

```{r, deer_clean}
deer_rst %>% glimpse
unique(deer_rst$location)
filter(deer_rst, is.na(fork_length), count > 0) %>% glimpse

deer_rst_clean <- deer_rst %>%
  select(date, location, count, fork_length, weight) %>%
  group_by(date, fork_length, weight) %>%
  summarize(count = sum(count, na.rm = T)) %>%
  mutate(stream = "deer creek",
         site = stream,
         run = "not recorded",
         run_method = NA_character_,
         adipose_clipped = F,
         lifestage = "not recorded")
```

### Variables removed

- flow, turbidity, weather, water_temperature_celsius: included in environmental table
- tubs_of_debris, trap_condition_code, comments, time_for_10_revolutions: included in operations table

## Feather River

```{r, feather_data_dictionary}
feather_data_dictionary <- read_rds("data/rst/feather_rst_data_dictionary.rds")
kable(feather_data_dictionary)
```

```{r, feather_clean}
feather_rst %>% glimpse
unique(feather_rst$run)
unique(feather_rst$lifestage)
# 127 out of 180871 where run is not designated
# data are for all natural salmon
filter(feather_rst, is.na(run)) %>% tally()
# notes - sites are unique locations
# origin is all natural
# TODO method for designating run?

feather_rst_clean <- feather_rst %>%
  rename(site = site_name) %>%
  group_by(date, site, run, lifestage, fork_length) %>%
  summarize(count = sum(count, na.rm = T))

feather_rst_min <- feather_rst_clean %>% 
  mutate(wy = ifelse(month(date) %in% 10:12, year(date) + 1, year(date))) %>% 
  group_by(wy) %>% 
  summarize(min = min(date))

# Trap operations and environmental data was captured separately
# Need to check that if data in environmental it is also in catch data
# e.g. make sure that if no catch then 0 in catch data

feather_trap_clean <- feather_effort %>%
  rename(site = site_name) %>%
  # use sample date because this is the date the trap would have been checked
  select(date, site)

feather_trap_min <- feather_trap_clean %>% 
  mutate(wy = ifelse(month(date) %in% 10:12, year(date) + 1, year(date))) %>% 
  group_by(wy) %>% 
  summarize(trap_min = min(date))

# when comparing min dates in rst and environmental data, they differ
# this means that we need to add in zero catch data
feather_min_date_compare <- full_join(feather_rst_min, feather_trap_min)

# This contains ALL data
# Assumption is that if date is in environmental data but not catch data there was zero catch
feather_rst_clean_final <- full_join(feather_rst_clean, 
                                    feather_trap_clean) %>% 
  mutate(count = ifelse(is.na(count), 0, count),
         stream = "feather river",
         site = tolower(site),
         adipose_clipped = F,
         run_method = "unknown")
  
```

## Mill Creek

```{r, mill_data_dictionary}
mill_data_dictionary <- read_rds("data/rst/mill_rst_data_dictionary.rds")
kable(mill_data_dictionary)
```

```{r, mill_clean}
# No hours fishing data available
# Run is not collected
mill_rst %>% glimpse
unique(mill_rst$location)
filter(mill_rst, is.na(fork_length), count > 0) %>% glimpse
filter(mill_rst, is.na(count))

mill_rst_clean <- mill_rst %>%
  select(date, count, fork_length) %>%
  group_by(date, fork_length) %>%
  summarize(count = sum(count, na.rm = T)) %>%
  mutate(stream = "mill creek",
         site = stream,
         run = "not recorded",
         run_method = NA_character_,
         adipose_clipped = F,
         lifestage = "not recorded")
```

### Variables removed

- flow, water_temperature, turbidity, weather: included in environmental table
- tubs_of_debris, trap_condition_code, comments, time_for_10_revolutions: included in operations table

## Yuba River

```{r, yuba_data_dictionary}
yuba_data_dictionary <- read_rds("data/rst/yuba_rst_data_dictionary.rds")
kable(yuba_data_dictionary)
```

```{r, yuba_clean}
yuba_rst %>% glimpse
unique(yuba_rst$location)
unique(yuba_rst$run)
ck <- filter(yuba_rst, is.na(run), !is.na(count), count > 0)
# all are CHN
unique(yuba_rst$organism_code)
unique(yuba_rst$lifestage)
# note that run designation is a combination of run and lifestage.
# run not filtered
# sites are names for traps at the same location and should be summed

filter(yuba_rst, is.na(fork_length), count > 0) %>% glimpse
filter(yuba_rst, is.na(run), count > 0) %>% glimpse
filter(yuba_rst, run == "unknown") %>% glimpse

yuba_rst_clean<- yuba_rst %>%
  select(date, fork_length, weight, lifestage, count, run, location) %>%
  mutate(site = ifelse(location == "Yuba River", "yuba river", "hallwood")) %>%
  group_by(date, fork_length, weight, lifestage, run, site) %>%
  summarize(count = sum(count, na.rm = T)) %>%
  mutate(stream = "yuba river",
         adipose_clipped = F,
         run_method = "unknown")
```

### Variables removed

- method, trap_status, debris, comments, trap_revolutions, trap_revolutions2, rpms_before, rpms_after: included in operations table
- temperature, turbidity, velocity: included in environmental table
- organism_code removed because all are CHN
- time removed because this is captured in trap operations

## Lower Sacramento - Knights Landing

```{r, knights_clean}
unique(knights_landing_rst$commonName)
unique(knights_landing_rst$fishOrigin)
unique(knights_landing_rst$run)
filter(knights_landing_rst, run == "Not applicable (n/a)") %>% glimpse
filter(knights_landing_rst, is.na(forkLength), n > 0) %>% glimpse
unique(knights_landing_rst$runMethod)
unique(knights_landing_rst$lifeStage)

# 1,603 unknown, 2 not recorded
filter(knights_landing_rst, fishOrigin == "Unknown") %>% tally()

knights_rst_clean <- knights_landing_rst %>%
  select(-c(catchRawID, trapVisitID, lifeStageCAMPID, visitTime2, visitType)) %>%
  rename(count = n,
         date = visitTime,
         fork_length = forkLength,
         adipose_clipped = fishOrigin,
         species = commonName,
         run_method = runMethod,
         lifestage = lifeStage) %>%
  group_by(fork_length, weight, species, run, run_method, lifestage, adipose_clipped, date) %>%
  summarize(count = sum(count, na.rm = T))

knights_rst_min <- knights_rst_clean %>% 
  mutate(wy = ifelse(month(date) %in% 10:12, year(date) + 1, year(date))) %>% 
  group_by(wy) %>% 
  summarize(min = min(date))

# Trap operations and environmental data was captured separately
# Need to check that if data in environmental it is also in catch data
# e.g. make sure that if no catch then 0 in catch data

knights_trap_clean <- knights_effort %>%
  # use sample date because this is the date the trap would have been checked
  select(date)

knights_trap_min <- knights_trap_clean %>% 
  mutate(wy = ifelse(month(date) %in% 10:12, year(date) + 1, year(date))) %>% 
  group_by(wy) %>% 
  summarize(trap_min = min(date))

# when comparing min dates in rst and environmental data, they differ
# this means that we need to add in zero catch data
knights_min_date_compare <- full_join(knights_rst_min, knights_trap_min)

# This contains ALL data
# Assumption is that if date is in environmental data but not catch data there was zero catch
knights_rst_clean_final <- full_join(knights_rst_clean, 
                                    knights_trap_clean) %>% 
  mutate(count = ifelse(is.na(count), 0, count),
         stream = "sacramento river",
         site = "knights landing",
         date = as_date(date),
         adipose_clipped = case_when(adipose_clipped == "Natural" ~ F,
                                     adipose_clipped == "Hatchery" ~ T),
         run_method = tolower(run_method),
         species = tolower(species),
         lifestage = tolower(lifestage)) %>% 
  filter(date >= "2006-10-02")
```

### Variables removed

- catchRawID, trapVisitID, lifeStageCAMPID removed because outside of CAMP this doesn't link well
- visitTime2 is typically the same as visitTime and is included in effort table
- visitType is included in operations table


## Lower Sacramento - Tisdale

```{r, tisdale_data_dictionary}
tisdale_data_dictionary <- read_rds("data/rst/lower_sac_tisdale_rst_data_dictionary.rds")
kable(tisdale_data_dictionary)
```

```{r, tisdale_clean}
tisdale_rst %>% glimpse
# 15 obs where run is not recorded, 9 where run is NA
unique(tisdale_rst$run)
unique(tisdale_rst$species)
unique(tisdale_rst$rearing)
unique(tisdale_rst$mark_type)
# 18 rows with mark type pigment
filter(tisdale_rst, mark_type == "Pigment") %>% glimpse
# 17 rows with mark type elastomer
filter(tisdale_rst, mark_type == "Elastomer") %>% glimpse
filter(tisdale_rst, is.na(run)) %>% glimpse
filter(tisdale_rst, is.na(fork_length_mm), count > 0) %>% glimpse
filter(tisdale_rst, run == "unknown") %>% glimpse
unique(tisdale_rst$life_stage)
filter(tisdale_rst, random == F, count > 0)

tisdale_rst_clean <- tisdale_rst %>%
  select(-c(fish_processed, at_capture_run, final_run, release_id, mark_position, mark_color, trap_visit_comment)) %>%
  rename(fork_length = fork_length_mm,
         adipose_clipped = rearing,
         lifestage = life_stage,
         dead = mortality) %>%
  group_by(date, species, fork_length, weight, lifestage, dead, run, adipose_clipped) %>%
  summarize(count = sum(count, na.rm = T)) %>%
  mutate(stream = "sacramento river",
         site = "tisdale",
         adipose_clipped = case_when(adipose_clipped == "Natural" ~ F,
                                     adipose_clipped == "Hatchery" ~ T),
         lifestage = tolower(lifestage),
         species = tolower(species),
         run_method = "unknown") 
```

### Variables removed

- fish_processed: included in operations table
- run is a combination of at_capture_run and final_run (replaces at_capture_run with final_run when final_run exists)
- release_id is an ID column from CAMP and doesn't link well outside of CAMP
- mark_type, mark_position, mark_color removed because little information (35 obs) and rearing includes the fin clip marking

# Standard format {.tabset}

```{r, combined}
# TODO fill in run method - this will involve outreach with monitoring programs
combined_rst_raw <- bind_rows(battle_rst_clean_final,
                          butte_rst_clean,
                          clear_rst_clean_final,
                          deer_rst_clean,
                          feather_rst_clean_final,
                          mill_rst_clean,
                          yuba_rst_clean,
                          knights_rst_clean_final,
                          tisdale_rst_clean) 
combined_rst <- combined_rst_raw %>%
  run_encoding() %>%
  lifestage_encoding() %>%
  # all should be chinook salmon
  mutate(species = ifelse(is.na(species), "chinook salmon", species),
         run_method = case_when(is.na(run_method) ~ "not recorded",
                                run == "not recorded" | count == 0 ~ NA_character_,
                                T ~ tolower(run_method)))

unique(combined_rst$run)
unique(combined_rst$lifestage)
unique(combined_rst$site)
unique(combined_rst$stream)
```

## Data dictionary

```{r, data_dictionary_prep, include = F}
colnames(combined_rst)

rst_catch_data_dictionary <- tibble(variable_name = colnames(combined_rst),
                                    description = c("Date trap checked.",
                                                    "Designated run of fish using method in run_method. Some locations did not designated a run. NA when count is 0.",
                                                    "Fork length of fish in mm.",
                                                    "Life stage of fish. NA when count is 0.",
                                                    "Describes if fish were dead when observed (T/F).",
                                                    "Describes if data were interpolated (T/F).",
                                                    "Number of fish caught.",
                                                    "Mainstem/tributary location of trap.",
                                                    "Site of trap within location. Some locations do not have multiples sites in which stream = site. Site names are specific to the tributary.",
                                                    "Describes if adipose fin is clipped (T/F). This is used to determine if the fish is natural or hatchery origin. In some cases this information may be unknown.",
                                                    "Method used to designate run. NA if count is 0.",
                                                    "Weight in grams.",
                                                    "Species of fish. All were filtered to chinook."),
                                    
                                    encoding = c(NA,
                                                 "late fall, spring, fall, winter, not recorded, unknown",
                                                 NA,
                                                 "smolt, fry, yolk sac fry, not recorded, parr, silvery parr, adult, unknown, yearling",
                                                 "TRUE, FALSE",
                                                 "TRUE, FALSE",
                                                 NA,
                                                 "battle creek, butte creek, clear creek, deer creek, feather river, mill creek, yuba river, sacramento river",
                                                 "battle creek, okie dam, adams dam, lcc, ucc, deer creek, eye riffle, live oak, herringer riffle, steep riffle, sunset pumps, shawns beach, gateway riffle, mill creek, yuba river, hallwood, knights landing, tisdale",
                                                 "TRUE, FALSE",
                                                 "not recorded, length-at-date criteria, appearance, hatchery attribute",
                                                 NA,
                                                 "chinook salmon"),
                                    collected = c("All",
                                                       "All but Deer, Mill",
                                                       "All",
                                                       "All but Deer, Mill",
                                                       "Battle, Butte, Clear, Tisdale",
                                                       "Battle, Clear",
                                                       "All",
                                                       "All",
                                                       "All",
                                                       "Butte, Feather, Knights, Tisdale",
                                                       "Butte",
                                                       "Butte, Deer, Yuba, Knights, Tisdale",
                                                       "Knights"))
```

```{r, data_dictionary}
kable(rst_catch_data_dictionary)
# write_csv(rst_catch_data_dictionary, "rst_catch_data_dictionary.csv")
```

## Exploratory plots

Boxplots of lifestage and fork length to verify lifestage encodings

```{r}
ggplot(combined_rst_raw, aes(x = lifestage, y = fork_length)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45))
```

Yolk sac fry categories

```{r}
# check category mappings
# yolk sac fry
ggplot(filter(combined_rst_raw, lifestage %in% c("yolk-sac fry", "yolk sac fry (alevin)", "yolk sac fry")), aes(x = lifestage, y = fork_length)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45))
```

Silvery fry categories 

Fingerling and pre-smolt added to silvery parr because of similar fork lengths.

```{r}
# silvery parr
ggplot(filter(combined_rst_raw, lifestage %in% c("silvery parr", "fingerling", "pre-smolt")), aes(x = lifestage, y = fork_length)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45))
```

Juvenile and unknown

Only one "yoy (young of the year)" and two juvenile. These are added to unknown (there is 1 unknown).

```{r}
# unknown
ggplot(filter(combined_rst_raw, lifestage %in% c("unknown", "yoy (young of the year)", "juvenile")), aes(x = lifestage, y = fork_length)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45))

filter(combined_rst_raw, lifestage == "yoy (young of the year)") %>% tally()
filter(combined_rst_raw, lifestage == "juvenile") %>% tally()
filter(combined_rst_raw, lifestage == "unknown") %>% tally()
```

Parr

Pre-smolt fits better with silvery parr

```{r}
# parr
ggplot(filter(combined_rst_raw, lifestage %in% c("parr", "pre-smolt")), aes(x = lifestage, y = fork_length)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45))
```

Fry

Button up fry and fry are similar fork lengths

```{r}
# fry
ggplot(filter(combined_rst_raw,  lifestage %in% c("fry", "button-up fry", "fry (button-up)")), aes(x = lifestage, y = fork_length)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45))
```


# QA/QC {.tabset}

## run

Run is not recorded for Mill and Deer. Butte only has spring run.

Figure below shows the percentage by run for each tributary and year.

```{r, run_qaqc}
unique(combined_rst$run)

total_count <- combined_rst %>%
  mutate(year = year(date)) %>%
  group_by(stream, year) %>%
  summarize(total = sum(count, na.rm = T))

combined_rst %>%
  mutate(year = year(date)) %>%
  group_by(stream, year, run) %>%
  summarize(count = sum(count, na.rm = T)) %>%
  left_join(total_count) %>%
  mutate(percent = (count/total)*100) %>%
  ggplot(aes(x = year, y = percent, fill = run)) +
  geom_col() +
  facet_wrap(~stream, scales = "free_y") +
  theme_minimal() +
  theme(legend.position = "bottom")
```

## fork_length

Figure below shows the percent of total fish counted that have a fork length measurement.

```{r, forklength_qaqc}
combined_rst %>%
  filter(!is.na(fork_length)) %>%
  mutate(year = year(date)) %>%
  group_by(stream, year) %>%
  summarize(count = sum(count, na.rm = T)) %>%
  left_join(total_count) %>%
  mutate(percent = (count/total)*100) %>%
  ggplot(aes(x = year, y = percent)) +
  geom_col() +
  facet_wrap(~stream)
  
```

## lifestage

Deer and Mill do not recored lifestage. Data is spotty for Butte and Yuba.

Figure below shows the percentage by lifestage for each tributary and year.

```{r, lifestage_qaqc}
combined_rst %>%
  mutate(year = year(date)) %>%
  group_by(stream, year, lifestage) %>%
  summarize(count = sum(count, na.rm = T)) %>%
  left_join(total_count) %>%
  mutate(percent = (count/total)*100) %>%
  ggplot(aes(x = year, y = percent, fill = lifestage)) +
  geom_col() +
  facet_wrap(~stream, scales = "free_y") +
  theme_minimal() +
  theme(legend.position = "bottom")
```
## count

Note that there are 72 observations for Mill Creek where count is NA. Count could be 0, 1, or more than 1. 

```{r, count_qaqc}
filter(combined_rst, is.na(count)) %>% glimpse()
```

## dead

Figure below shows percent of fish observed that were marked as dead. Note that some
locations do not record this information.

```{r, dead_qaqc}
combined_rst %>%
  filter(dead == T) %>%
  mutate(year = year(date)) %>%
  group_by(stream, year) %>%
  summarize(count = sum(count, na.rm = T)) %>%
  left_join(total_count) %>%
  mutate(percent = (count/total)*100) %>%
  ggplot(aes(x = year, y = percent)) +
  geom_col() +
  facet_wrap(~stream)
```

## interpolated

Battle and Clear include interpolated values.

Figure below shows percent of fish observed that were interpolated. Interpolated
counts do not include values for fork length.

```{r, interpolated_qaqc}
combined_rst %>%
  filter(interpolated == T) %>%
  mutate(year = year(date)) %>%
  group_by(stream, year) %>%
  summarize(count = sum(count, na.rm = T)) %>%
  left_join(total_count) %>%
  mutate(percent = (count/total)*100) %>%
  ggplot(aes(x = year, y = percent)) +
  geom_col() +
  facet_wrap(~stream)

combined_rst %>%
  filter(stream %in% c("battle creek", "clear creek")) %>%
  group_by(stream, date, interpolated) %>%
  summarize(count = sum(count, na.rm = T)) %>%
  ggplot(aes(x = date, y = count, color = interpolated)) +
  geom_line() +
  facet_wrap(~stream, scales = "free_y")
```

## adipose_clipped

Origin is mostly natural. Only Butte Creek, Knights Landing, Tisdale included data
for origin. For other locations it is not relevant or was already filtered.

```{r, origin_qaqc}
combined_rst %>%
  mutate(year = year(date)) %>%
  group_by(stream, year, adipose_clipped) %>%
  summarize(count = sum(count, na.rm = T)) %>%
  left_join(total_count) %>%
  mutate(percent = (count/total)*100) %>%
  ggplot(aes(x = year, y = percent, fill = origin)) +
  geom_col() +
  facet_wrap(~stream, scales = "free_y") +
  theme_minimal() +
  theme(legend.position = "bottom")
```

## weight

Figure below shows the percent of total fish counted that have a weight measurement.

```{r, weight_qaqc}
combined_rst %>%
  filter(!is.na(weight)) %>%
  mutate(year = year(date)) %>%
  group_by(stream, year) %>%
  summarize(count = sum(count, na.rm = T)) %>%
  left_join(total_count) %>%
  mutate(percent = (count/total)*100) %>%
  ggplot(aes(x = year, y = percent)) +
  geom_col() +
  facet_wrap(~stream)
```
## run_method

Only Knights Landing recorded this information. Method is assumed to be length-at-date
for all others. 

```{r, runmethod_qaqc}
combined_rst %>%
  mutate(year = year(date)) %>%
  group_by(stream, year, run_method) %>%
  summarize(count = sum(count, na.rm = T)) %>%
  left_join(total_count) %>%
  mutate(percent = (count/total)*100) %>%
  ggplot(aes(x = year, y = percent, fill = run_method)) +
  geom_col() +
  facet_wrap(~stream, scales = "free_y") +
  theme_minimal() +
  theme(legend.position = "bottom")
```

# Save data

```{r, save_data}
f <- function(input, output) write_csv(input, file = output)

gcs_upload(combined_rst,
           object_function = f,
           type = "csv",
           name = "standard-format-data/standard_rst_catch.csv",
           predefinedAcl = "bucketLevel")
```
