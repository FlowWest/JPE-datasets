---
title: "Standardize Adult Redd Datasets"
author: "Maddee Rubenson (FlowWest)"
date: '2022-07-11'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, fig.width=15, fig.height=10)
library(tidyverse)
library(googleCloudStorageR)
library(knitr)
color_pal <- c("#9A8822",  "#F8AFA8", "#FDDDA0", "#74A089", "#899DA4", "#446455", "#DC863B", "#C93312")
```

## Adult Redd Data Standardization

FlowWest received Adult Redd data from four monitoring programs:

-   Feather River
-   Battle Creek
-   Clear Creek
-   Mill Creek

Caveat about redd counts maybe double counted.

## Standard format for Adult Redd Data

Data dictionary for standard format:

(B - Battle Creek, C - Clear Creek,\
F - Feather River, M - Mill Creek)

| column name             | tributary collects | definition                                                                            |
|:-----------------------|:-----------------------|:-----------------------|
| date                    | B, C, F            | Date in which redd data was collected                                                 |
| latitude                | B, C, F, M         | Latitude of redd location                                                             |
| longitude               | B, C, F, M         | Longitude of redd location                                                            |
| reach                   | B, C, F, M         | Unique name identifer of reach sampled                                                |
| river_mile              | B, C               | River mile associated with redd measured                                              |
| redd_measured           | B, C               | Whether or not a redd was measured (T/F)                                              |
| age                     | C                  | integer ranging from 1 - 5; redd age                                                  |
| fish_guarding           | B, C               | Whether or not a fish is on redd when measured ??                                     |
| ~~redd_count~~          | ~~B, C, F, M~~     | ~~Amount of redds counted in given reach on given date~~                              |
| redd_length             | B, C, F            | Length of measured redd (m)                                                           |
| redd_width              | B, C, F            | Width of measured redd (m)                                                            |
| run                     | C                  | `spring`, `fall`, `late-fall`                                                         |
| stream                  | B, C, F, M         | Unique stream associated with redd data collected                                     |
| redd_substrate_size     | B, C               |                                                                                       |
| pre_redd_substrate_size | B, C               |                                                                                       |
| tail_substrate_size     | B, C               |                                                                                       |
| year                    | B, C, F, M         | Calendar year sampling occurred                                                       |
| velocity                | B, C, F            | measured flow --- **unsure units of clear creek. All others are in feet per second.** |

## Read in data {.tabset}

Below we read in the adult redd data for each monitoring program and rename or select columns so that we can join all the monitoring datasets together in the section below.

### Battle Creek

#### Columns Removed

-   `why_not_measured`: enumerated; `NA`, `fish_on_redd`, `sub sample`, `too deep` Deemed unnecessary.
-   `flow_meter`: type of flow meter used; deemed unnecessary for final dataset
-   `start_number_flow_meter`: deemed unnecessary for final dataset
-   `end_number_flow_meter`: deemed unnecessary for final dataset
-   `flow_meter_time`: deemed unnecessary for final dataset
-   `start_number_flow_meter_80`: deemed unnecessary for final dataset
-   `end_number_flow_meter_80`: deemed unnecessary for final dataset
-   `flow_meter_time_80`: deemed unnecessary for final dataset
-   `redd_pit_depth`: deemed unnecessary for final dataset
-   `redd_tail_depth`: deemed unnecessary for final dataset
-   `comments`: deemed unecessary for final dataset

columns created:

-   `redd_count`: based on the count of `redd_measured` for alike days and reach identifier
-   `stream`: used Battle Creek
-   `flow_fps` changed to `velocity`

```{r}
# Adult upstream passage data for Battle Creek
battle_redd <- read_csv("../../data/redd-carcass-holding/battle_redd.csv", 
                        col_names = TRUE, 
                        col_types = list("n", "n", "D", "c", "n", "c", 
                                         "c", "c", "l", "l", "l", "n", 
                                         "n", "n", "n", "n", "c", "n", 
                                         "n", "n", "n", "n", "n", "n", 
                                         "c")) %>% glimpse

summary(battle_redd)

table(battle_redd$pre_redd_substrate_size, useNA = "ifany")
table(battle_redd$redd_substrate_size, useNA = "ifany")
table(battle_redd$tail_substrate_size, useNA = "ifany")
unique(battle_redd$why_not_measured)
unique(battle_redd$flow_meter)

clean_battle_redd <- battle_redd %>%
  select(date, latitude, longitude, 
         reach, river_mile, fish_guarding, 
         redd_measured, redd_width, redd_length, 
         pre_redd_substrate_size, redd_substrate_size, 
         tail_substrate_size, 
         flow_fps) %>%
  group_by(date, reach) %>%
  mutate(redd_count = n(),
         stream = 'Battle Creek', 
         year = lubridate::year(date)) %>%
  rename(velocity = flow_fps) %>%
  glimpse

view(clean_battle_redd)
```

### Clear Creek

FlowWest acquired Clear Creek redd data for late fall and spring runs through CVPIA. This data was integrated into this dataset by taking the maximum date of data provided to JPE spring run and filtering the CVPIA-provided spring run to only include newer data. Late fall run data was bound to this dataset.

TODO: confirm velocity in feet per second

TODO: do we want to include O. mykiss redd data? It is currently included but can be filtered out.

#### Columns Removed

-   `survey`: integer ranging from 1 to 12; deemed unnecessary for final dataset
-   `X1000ftbreak`: deemed unnecessary for final dataset
-   `ucc_relate`: enumerated value of `above` or `below`; deemed unnecessary for final dataset
-   `picket_weir_location`: numeric value ranging from 7.4 to 8.2; deemed unnecessary for final dataset
-   `picket_weir_relation`: this could be used to determine the run type, if needed; enumerated as `above` or `below`
-   `redd_id`: unique identifier to each redd; deemed unnecessary for final redd dataset
-   `gravel`: enumerated value of `combination`, `injection`, or `native`; deemed unnecessary for final redd dataset
-   `fish_on_redd`: ??? TRUE/FALSE
-   `why_not_measured`: description of why redd was not measured; deemed unnecessary for final redd dataset
-   `date_measured`: chose to use `date` instead of this column
-   `pre_redd_depth`: numeric range from 0.13 to 2.24; deemed unnecessary
-   `redd_pit_depth`: numeric range from 0.15 to 2.41; deemed unnecessary
-   `redd_tail_depth`: numeric range from 0.076 to 2.13; deemed unnecessary
-   `velocity`: numeric range from 0.25 to 11.1; deemed unnecessary
-   `start_60`: numeric; deemed unnecessary
-   `end_60`: numeric; deemed unnecessary
-   `sec_60`: numeric; deemed unnecessary
-   `start_80`: numeric; deemed unnecessary
-   `end_80`: numeric; deemed unnecessary
-   `sec_80`: numeric; deemed unnecessary
-   `bomb_vel60`: numeric; deemed unnecessary
-   `bomb_vel80`: numeric; deemed unnecessary
-   `comments`: unique to dataset and deemed unnecessary
-   `run`: enumerated as `spring`, `fall`, `late-fall` though mostly `NA`; deemed unnecessary.
-   `observation_reach` -- Incomplete and matches `surveyed_reach`
-   `observation_date` -- Incomplete and matches `date`
-   `observation_age` -- Incomplete and matches `age`
-   `survey_observed`: TRUE/FALSE though mostly `NA`
-   `method`: mostly snorkel surveys, method deemed unnecessary for final dataset

```{r}
# spring run Chinook Salmon from USFW - Ryan Shaffer 
clear_redd <- read_csv("../../data/redd-carcass-holding/clear_redd.csv", 
                       col_names = TRUE,
                       col_types = list("c", "n", "n", "n", "n", "n", 
                                        "c", "n", "c", "D", "c", "c", "n", "c", 
                                        "c", "c", "c", "c", "c", "l", "l", "l", 
                                        "D", "n", "n", "n", "n", "n", "n", "n", 
                                        "n", "n", "n", "n", "n", "c", "c", "c",
                                        "D", "n", "l", "n", "n")) %>% glimpse()

summary(clear_redd)
table(clear_redd$method, useNA = "ifany")
table(clear_redd$ucc_relate, useNA = "ifany")
table(clear_redd$picket_weir_relation, useNA = "ifany")
table(clear_redd$run, useNA = "ifany")


clean_clear_redd <- clear_redd %>%
  select(surveyed_reach, date, river_mile, 
         latitude, longitude, 
         measured, fish_on_redd,
         redd_length, redd_width, run,
         pre_redd_substrate_size, redd_substrate_size, 
         tail_substrate_size, 
         velocity) %>%
  group_by(date, surveyed_reach) %>%
  mutate(redd_count = length(measured),
         stream = 'Clear Creek', 
         year = lubridate::year(date)) %>%  
  rename(reach = surveyed_reach,
         redd_measured = measured,
         fish_guarding = fish_on_redd) %>%
  glimpse()

# load in aggregated clear creek data from other runs 
clear_all_runs <- read_csv('../../../../CVPIA/CVPIA-EDA/jim_data_requests/redd_monitoring_data/all_redd_data_for_clear_creek.csv') %>% glimpse

# TODO: do we want O. mykiss too? 
# TODO: spring run overlap -- keep all spring run data and fill in with new data to 2021?

max_date <- max(clear_redd$date)
print(max_date)

spring_filter <- clear_all_runs %>% 
  filter(run == "spring") %>%
  filter(date > max_date)
clear_fall_and_spring <- clear_all_runs %>% 
  filter(run == "late fall") %>%
  bind_rows(spring_filter) %>%
  mutate(stream = "Clear Creek") %>%
  bind_rows(clean_clear_redd) %>%
  mutate(run = case_when(run == "late-fall" ~ "late fall",
                         TRUE ~ as.character(run)))

# replace name 
clean_clear_redd <- clear_fall_and_spring %>% glimpse
```

### Mill Creek

-   changed `location` to `reach` to align with other datasets

#### Columns Removed

-   `starting_elevation_ft`: numeric and ranging from 1600 to 5200; deemed unnecessary for final dataset

```{r}

mill_redd <- read_csv("../../data/redd-carcass-holding/mill_redd.csv") %>% glimpse()

summary(mill_redd)

clean_mill_redd <- mill_redd %>%
  rename(reach = location) %>%
  select(-starting_elevation_ft) %>%
  mutate(stream = 'Mill Creek') %>%
  glimpse
```

### Feather River

-   changed `location` to `reach` to align with other datasets
-   `velocity_m_per_s` converted to feet per second and named velocity

#### Columns Removed

-   `type`: enumerated as `Area`, `Point`, `Questionable Redds`, or `NA`; deemed unnecessary
-   `salmon_count`: integer ranging from 0 to 200; deemed unnecessary
-   `pot_depth_m`: numeric ranging from 0 to 50; deeemd unnecessary
-   `percent_fine_substrate`: numeric ranging from 0 to 90; mostly `NA` and deemed unnecessary
-   `percent_small_substrate`: numeric ranging from 0 to 90; mostly `NA` and deemed unnecessary
-   `percent_medium_substrate`: numeric ranging from 0 to 95; mostly `NA` and deemed unnecessary
-   `percent_large_substrate`: numeric ranging from 0 to 90; mostly `NA` and deemed unnecessary
-   `percent_boulder`: numeric ranging from 0 to 70; mostly `NA` and deemed unnecessary
-   `depth_m`: numeric ranging from 0.02 to 1.5; mostly NA and deemed unnecessary

```{r}
feather_redd <- read_csv("../../data/redd-carcass-holding/feather_redd.csv", 
                         col_names = TRUE, 
                         col_types = list("D", "c", "c", "n",
                                       "n", "n", "n", "n", "n",
                                       "n", "n", "n", "n", "n",
                                       "n", "n", "n")) %>% glimpse()

summary(feather_redd)
table(feather_redd$type, useNA = "ifany")

clean_feather_redd <- feather_redd %>%
  select(date, location, redd_count, 
         latitude, longitude, 
         redd_width_m, redd_length_m, velocity_m_per_s) %>% 
  rename(reach = location,
         redd_width = redd_width_m, 
         redd_length = redd_length_m) %>%
  mutate(stream = "Feather River",
         year = lubridate::year(date),
         date = as.Date(date),
         velocity = velocity_m_per_s / 0.3048) %>% # convert to feet per second 
  select(-velocity_m_per_s) %>%
  glimpse

```

## Combine data:

```{r}
all_redd_data <- bind_rows(clean_battle_redd, 
                           clean_clear_redd,
                           clean_feather_redd,
                           clean_mill_redd) %>% 
  select(-redd_count) %>%
  # remove mill creek
  filter(stream != "Mill Creek") %>%
  glimpse
```

## Substrate Size Standardization

Substrate sizes were given names and classes following the Wentworth Scale, created by W.C. Krumbein. This scale is what is commonly used in the United States. The substrate size provided for redd data was standardized using this scale. When the size range fell into two categories, they were rounded down.

| Class              | Size Range (mm) |
|--------------------|-----------------|
| Boulder            | \>256           |
| Cobble             | 64-256          |
| Very coarse gravel | 32-64           |
| Coarse gravel      | 16-32           |
| Medium gravel      | 8-16            |
| Fine gravel        | 4-8             |
| Very fine gravel   | 2-4             |
| Very coarse sand   | 1-2             |
| Coarse sand        | 0.5-1           |
| Medium sand        | 0.25-0.5        |
| Fine sand - clay   | \<0.25          |

```{r}
# standarized size ranges lookup
substrate_class = data.frame("standardized_size_range" = c("<0.25", 
                                                           "0.25-0.5",
                                                           "0.5-1",
                                                           "1-2",
                                                           "2-4", "4-8", '8-16', ">16"),
                              "substrate_class" = c("fine sand",
                                                    "medium sand",
                                                    "coarse sand", "very coarse sand",
                                                    "very fine gravel", "fine gravel",
                                                    "medium gravel", 
                                                    "coarse gravel to boulder"))

unique(all_redd_data$redd_substrate_size)

redd_substrate_size_lookup <- 
  data.frame("redd_substrate_size" = unique(all_redd_data$redd_substrate_size),
                     "standardized_size_range" = c(NA, "1-2", "2-4", "1-2", "2-4",
                                                   "2-4", "1-2", "2-4", "0.25-0.5", 
                                                   "<0.25", "4-8", "4-8", ">16", "2-4", 
                                                   "2-4", "1-2", "2-4", "1-2", "2-4",
                                                   "0.25-0.5", "2-4", "2-4", "4-8", 
                                                   "4-8", "8-16"))

                    

redd_substrate_size_lookup <- redd_substrate_size_lookup %>% left_join(substrate_class)

tail_substrate_size_lookup <- all_redd_data %>% 
  ungroup() %>%
  select(tail_substrate_size) %>% 
  full_join(redd_substrate_size_lookup %>% rename(tail_substrate_size = redd_substrate_size)) %>% distinct() %>%
  rename(tail_substrate_class = substrate_class)

tmp <- all_redd_data %>% 
  left_join(redd_substrate_size_lookup) %>%
  left_join(tail_substrate_size_lookup)


```

## Explore Variables {.tabset}

### stream

```{r}
table(all_redd_data$stream)
```

### date

```{r}
summary(all_redd_data$date)

all_redd_data %>%
  group_by(stream) %>%
  summarise(year_range = paste0(min(year, na.rm = TRUE), " : ", max(year, na.rm = TRUE)), 
            months = paste0(unique(sort(lubridate::month(date))), collapse = ", ")) %>%
  ungroup() %>%
  distinct %>% kable()

```

### velocity

```{r}
summary(all_redd_data$velocity)

ggplot() + 
  geom_point(data = all_redd_data, aes(x = date, y = velocity, color = reach)) + 
  facet_wrap(~ stream) +
  theme(legend.position = "none")
```

### fish_guarding

```{r}
table(all_redd_data$fish_guarding, useNA = "ifany")
```

### redd_measured

```{r}
table(all_redd_data$redd_measured, useNA = "ifany")

```

### redd_width and redd_length

```{r}

summary(all_redd_data$redd_width)

summary(all_redd_data$redd_length)

ggplot() + 
  geom_histogram(data = all_redd_data, aes(redd_width)) 
  
ggplot() +   
  geom_histogram(data = all_redd_data, aes(redd_length))

```

### redd_count

```{r}
# summary(all_redd_data$redd_count)
# 
# # redd data without Mill Creek
# all_redd_data %>% 
#   ungroup() %>%
#  # filter(stream != "Mill Creek") %>% 
#   select(redd_count) %>% 
#   summary()
# 
# all_redd_data %>% 
# ggplot() + 
#   geom_histogram(aes(redd_count)) 
# 
# # ggplot() + 
# #   geom_point(data = all_redd_data %>% filter(stream != "Mill Creek"), aes(x = date, y = redd_count)) +
# #   facet_wrap(~ stream)
# 
# # I'm not positive that this is comparing apples-to-apples because Mill Creek is aggregated 
# # by year
# ggplot() + 
#   geom_point(data = all_redd_data , aes(x = (year), y = redd_count)) +
#   facet_wrap(~ stream) +
#   coord_flip()
```

### pre_redd_substrate_size

-   TODO: standardize!!!!!

```{r}
table(all_redd_data$pre_redd_substrate_size)

# tmp <- all_redd_data %>% 
#   separate(pre_redd_substrate_size, c('A', 'B'), sep = "to", remove = FALSE) %>%
#   mutate(tmp = case_when(!is.na(pre_redd_substrate_size) ~ paste0(A,"-", B),
#                                              TRUE ~ as.character(pre_redd_substrate_size)))


```

### redd_substrate_size

-   TODO: standardize!!!!!

```{r}
table(all_redd_data$redd_substrate_size)

```

### tail_substrate_size

```{r}
table(all_redd_data$tail_substrate_size)

```

## By Year Aggregation

All redd data was aggregated by sampled reach and date to get a count of redds. In order to not potentially double count, the maximum of a daily count is reported as the yearly redd count. Since Mill Creek is aggregated by year already, this dataset includes Mill Creek.

```{r}

redd_count_by_year <- bind_rows(clean_battle_redd, 
                           clean_clear_redd,
                           clean_feather_redd) %>% 
  group_by(reach, date) %>%
  mutate(sum_redd = n()) %>%
  # how many redds were counted on each day? 
  group_by(year, stream) %>%
  mutate(max_yearly_redd_count = max(sum_redd)) %>%  # maximum per year 
  select(-sum_redd) %>%
  bind_rows(clean_mill_redd %>% 
              group_by(year) %>%
              mutate(max_yearly_redd_count = sum(redd_count, na.rm = TRUE))) %>%
  select(-redd_count) %>%
  distinct() %>%
  glimpse

redd_count_by_year %>% 
  select(year, max_yearly_redd_count, stream) %>%
  distinct() %>%
ggplot() + 
  geom_bar(aes(x = year, y = max_yearly_redd_count, fill = stream), stat = "identity") + 
  facet_wrap(~stream) +
  scale_fill_manual(values = color_pal) + 
  theme_minimal()
```

## Save Cleaned Data to Google Cloud

```{r}
# clean_passage <- combined_upstream_passage
# 
# knitr::kable(clean_passage %>% head)
```

```{r, eval=FALSE}
# Write to google cloud 
# Name file [watershed]_[data type].csv

# write_csv(clean_passage, "../../data/standard-format-data/standard_adult_upstream_passage.csv")
# f <- function(input, output) write_csv(input, file = output)
# gcs_upload(clean_passage,
#            object_function = f,
#            type = "csv",
#            name = "standard-format-data/standard_adult_upstream_passage.csv")
```
