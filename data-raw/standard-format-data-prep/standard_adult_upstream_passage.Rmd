---
title: "Standardize Adult Upstream Passage Datasets"
author: "Erin Cain"
date: '2022-05-03'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, fig.width=15, fig.height=10)
library(tidyverse)
library(googleCloudStorageR)
color_pal <- c("#9A8822",  "#F8AFA8", "#FDDDA0", "#74A089", "#899DA4", "#446455", "#DC863B", "#C93312")
```

## Adult Upstream Passage Data Standardization

FlowWest received Adult Upstream Passage data from 5 monitoring programs:

-   Battle Creek
-   Clear Creek
-   Deer Creek
-   Mill Creek
-   Yuba River

Butte collects this data but has not been acquired (database lost?). Feather River started adult video monitoring in 2022.

## Standard format for Adult Upstream Passage Data

Data dictionary for standard format:

(B - Battle Creek, C - Clear Creek,  
D - Deer Creek, M - Mill Creek, Y - Yuba River)

| column name        | tributary collects | definition                                                                                             |
|:------------------|:-----------------|:----------------------------------|
| stream             |                    | Which Spring Run JPE stream is the data from                                                           |
| location           |                    | what is the location name                                                                              |
| date               |                    | date of video footage                                                                                  |
| time               |                    | time of video footage                                                                                  |
| hours_viewed       |                    | number of hours viewed by day                                                                          |
| count              |                    | number of fish observed                                                                                |
| adipose            |                    | if adipose fin is present (TRUE/FALSE)                                                                 |
| run                |                    | run designation                                                                                        |
| run_method         |                    | method used to identify run                                                                            |
| passage_direction  |                    | direction of fish passage                                                                              |
| sex                |                    | sex of fish observed                                                                                   |
| length             |                    | length of fish observed in feet TODO check units                                                       |
| viewing_condition  |                    | direction of fish observed (normal, readable, not readable, weir is flooded)                           |
| spawning_condition |                    | description of spawning status based on coloration (none, energetic, spawning colors, fungus, unknown) |

## Read in data {.tabset}

Below we read in the adult upstream passage data for each monitoring program and rename or select columns so that we can join all the monitoring datasets together in the section below.

### Battle Creek

#### Columns Removed

No columns are removed from battle creek upstream passage video data.

TODO see if we can pull useful info from comments

```{r}
# Set your authentication using gcs_auth
# gcs_auth(json_file = Sys.getenv("GCS_AUTH_FILE"))
# # Set global bucket
# gcs_global_bucket(bucket = Sys.getenv("GCS_DEFAULT_BUCKET"))
# download file as csv
# gcs_get_object(object_name = "adult-upstream-passage-monitoring/battle-creek/data/battle_passage_video.csv",
#                bucket = gcs_get_global_bucket(),
#                saveToDisk = "../../data/adult-upstream-passage-monitoring/battle_adult_upstream.csv",
#                overwrite = TRUE)

battle_upstream_passage <- read_csv("../../data/adult-upstream-passage-monitoring/battle_adult_upstream.csv") %>% 
  mutate(stream = "Battle Creek") %>% 
  glimpse

battle_upstream_passage %>% View
```

### Clear Creek

#### Columns Removed

-   **time_block**: Time block was removed because it refers to the time block being viewed and this is not relevant if we only care specifically about when the fish passes. We retained the time_passed column instead to keep this information

-   TODO update encoding for spawning_condition

        names(clear_passage_spawning_condition) <- c(
          "Energetic; bright or silvery; no spawning coloration or developed secondary sex characteristics.",
          "Energetic, can tell sex from secondary characteristics (kype) silvery or bright coloration but may have some hint of spawning colors.",
          "Spawning colors, defined kype, some tail wear or small amounts of fungus.",
          "Fungus, lethargic, wandering; “ Zombie fish”. Significant tail wear in females to indicate the spawning process has already occurred.",
          "Unable to make distinction.")

```{r}
# download file as csv
# gcs_get_object(object_name = "adult-upstream-passage-monitoring/clear-creek/data/clear_passage.csv",
#                bucket = gcs_get_global_bucket(),
#                saveToDisk = "../../data/adult-upstream-passage-monitoring/clear_adult_upstream.csv",
#                overwrite = TRUE)

clear_upstream_passage <- read_csv("../../data/adult-upstream-passage-monitoring/clear_adult_upstream.csv") %>% 
  select(-time_block) %>%
  rename(time = time_passed) %>% 
  mutate(stream = "Clear Creek",
         viewing_condition = case_when( 
           viewing_condition == 1 ~ "Normal",  
           viewing_condition == 2 ~ "Readable",  
           viewing_condition == 3 ~ "Not Readable",
           viewing_condition == 4 ~"Weir is flooded")) %>% 
  glimpse
```

### Deer Creek

#### Columns Removed

No columns are removed from battle creek upstream passage video data.

```{r}
# download file as csv
# gcs_get_object(object_name = "adult-upstream-passage-monitoring/deer-creek/data/deer_upstream_passage_estimate.csv",
#                bucket = gcs_get_global_bucket(),
#                saveToDisk = "../../data/adult-upstream-passage-monitoring/deer_adult_upstream.csv",
#                overwrite = TRUE)

deer_upstream_passage <- read_csv("../../data/adult-upstream-passage-monitoring/deer_adult_upstream.csv") %>% 
    rename(count = passage_estimate) %>% # confirm with matt johnson that this is a count not a modeled passage
    mutate(stream = "Deer Creek") %>% 
    glimpse
```

### Mill Creek

#### Columns Removed

No columns are removed from battle creek upstream passage video data.

```{r}

# download file as csv
# gcs_get_object(object_name = "adult-upstream-passage-monitoring/mill-creek/data/mill_upstream_passage_estimate.csv",
#                 bucket = gcs_get_global_bucket(),
#                 saveToDisk = "../../data/adult-upstream-passage-monitoring/mill_adult_upstream.csv",
#                 overwrite = TRUE)

mill_upstream_passage <- read_csv("../../data/adult-upstream-passage-monitoring/mill_adult_upstream.csv") %>% 
  rename(count = passage_estimate) %>% # confirm with matt johnson that this is a count not a modeled passage
  mutate(stream = "Mill Creek") %>% 
  glimpse
```

### Yuba River

#### Columns Removed

The following columns were removed from the Yuba River dataset. There was no clear methodology on how these columns were generated or how they should be used so we removed from dataset.

-   category

-   length_cm

-   speed_m\_per_s

-   depth_m

-   position_in_frame

```{r}

# download file as csv
# gcs_get_object(object_name = "adult-upstream-passage-monitoring/yuba-river/data/yuba_upstream_passage.csv",
#                 bucket = gcs_get_global_bucket(),
#                 saveToDisk = "../../data/adult-upstream-passage-monitoring/yuba_adult_upstream.csv",
#                 overwrite = TRUE)

yuba_upstream_passage <- read_csv("../../data/adult-upstream-passage-monitoring/yuba_adult_upstream.csv") %>% 
  select(-category, -length_cm, -speed_m_per_s, 
         -depth_m, -position_in_frame) %>% # No clear methodology shared by yuba on these data and how they should be used  
  mutate(stream = "Yuba River") %>% 
  glimpse
```

## Combine data:

```{r}
combined_upstream_passage <- bind_rows(battle_upstream_passage, clear_upstream_passage, 
                                       deer_upstream_passage, mill_upstream_passage, 
                                       yuba_upstream_passage) %>% 
  glimpse
```

## Explore Varibles{.tabset}

### stream 

```{r}
unique(combined_upstream_passage$stream)
```

### date 

```{r}
combined_upstream_passage %>% ggplot() + 
  geom_point(aes(x = date, y = stream, color = stream), alpha = .1) +
  scale_color_manual(values = color_pal) +
  theme_minimal() + 
  theme(legend.position = "bottom", 
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
```

### time 

Mill and Deer do not give passage time they give daily passage only.

```{r}
combined_upstream_passage %>% ggplot() + 
  geom_point(aes(x = time, y = stream, color = stream), alpha = .1) +
  scale_color_manual(values = color_pal) +
  theme_minimal() + 
  theme(legend.position = "bottom", 
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
```

### count 

Group by day to see distribution of daily count values

```{r}
daily <- combined_upstream_passage %>% 
  group_by(stream, date) %>%
  summarize(count = sum(count, na.rm = T)) 

summary(daily$count)


daily %>% ggplot() + 
  geom_boxplot(aes(x = count,y = stream,  color = stream), 
                 alpha = .5, binwidth  = 1) + 
  scale_color_manual(values = color_pal) +
  theme_minimal() + 
  theme(legend.position = "bottom", 
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
```

### run

```{r}
unique(combined_upstream_passage$run)

combined_upstream_passage <- combined_upstream_passage %>% 
  mutate(run = case_when(run == "SR" ~ "spring run",
                         run == "LF" ~ "late fall run",
                         run == "WR" ~ "winter run", 
                         run == "FR" ~ "fall run", 
                         run == "unknown" ~ "unknown"))

unique(combined_upstream_passage$run)
```

### adipose 

```{r}
unique(combined_upstream_passage$adipose)

combined_upstream_passage <- combined_upstream_passage %>% 
  mutate(adipose = ifelse(adipose == "clipped", "absent", adipose))

unique(combined_upstream_passage$adipose)


```

### sex

### passage_direction

### viewing_condition

### spawning_condition

### jack_size

### ladder
