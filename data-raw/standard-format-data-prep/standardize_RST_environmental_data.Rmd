---
title: "Standardize RST Environmental Data"
author: "Erin Cain"
date: "4/20/2022"
output: 
  html_document:
  theme: flatly
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, fig.width=15, fig.height=10)
library(tidyverse)
library(googleCloudStorageR)

color_pal <- c("#9A8822",  "#F8AFA8", "#FDDDA0", "#74A089", "#899DA4", "#446455", "#DC863B", "#C93312")
```

## RST Environmental Data Standardization

FlowWest received environmental data for rst from 8 monitoring programs:

-   Battle Creek
-   Butte Creek
-   Clear Creek
-   Deer Creek
-   Feather River
-   Mill Creek
-   Knights Landing
-   Yuba River

No environmental data is provided for the Tisdale RST.

## Standard format for RST Environmental Data

Data dictionary for standard format:

(B - Battle Creek, Bu - Butte Creek, C - Clear Creek, F - Feather River,
D - Deer Creek, F - Feather River, M - Mill Creek, S- Sacramento River,
Y - Yuba River)

| column name                        | stream collects         | definition                                               |
|:---------------|:--------------------|:------------------------------------|
| stream                             | B, Bu, C, D, F, M, S, Y | Which stream the RST is located on                       |
| location                           | B, Bu, C, D, F, M, S, Y | ?                                                        |
| sub_site/trap_id (todo figure out) | F                       | sub site information name                                |
| date                               | B, Bu, C, D, F, M, S, Y | date that samples are taken                              |
| trap_visit_ID                      | B, C                    | sample id that links with catch or trap condition tables |
| velocity                           | B, Bu, C, Y             | velocity measure in feet per second                      |
| flow                               | D, KL, M                | flow in cfs                                              |
| temperature                        | Bu, D, F, KL, M, Y      | temperature measure in degrees Celsius                   |
| turbidity                          | B, Bu, C, D, F, M, S, Y | turbidity measure in NTU                                 |
| secchi                             | Bu, KL                  | secchi measure in ft                                     |
| weather                            | B, Bu, C, D, M          | Weather condition at time of trapping                    |
| habitat                            | B, C                    | Habitat trap is located in (backwater pool, glide, run)  |
|                                    |                         |                                                          |

## Read in data {.tabset}

### Battle Creek

#### Columns Removed

The dataset included operations and environmental data. Below only
columns for environmental data are selected.

```{r, message=FALSE, warning=FALSE}
# gcs_auth(json_file = Sys.getenv("GCS_AUTH_FILE"))
# Set global bucket 
# gcs_global_bucket(bucket = Sys.getenv("GCS_DEFAULT_BUCKET"))

# gcs_get_object(object_name = "rst/battle-creek/data/battle_rst_environmental.csv",
#                bucket = gcs_get_global_bucket(),
#                saveToDisk = "../../data/rst/battle_rst_environmental.csv",
#                overwrite = TRUE)

battle_env <- read_csv("../../data/rst/battle_rst_environmental.csv") %>% 
  select(trap_visit_id = sample_id, date = sample_date, 
         velocity, turbidity, weather = weather_code, habitat) %>%
  mutate(stream = "Battle Creek",
         location = "Upper Battle Creek") %>%
  glimpse
```

### Butte Creek

#### Columns Removed

The dataset included catch, operations and environmental data. Below
only columns for environmental data are selected.

```{r, message=FALSE, warning=FALSE}
# gcs_get_object(object_name = "rst/butte-creek/data/butte_rst.csv",
#                bucket = gcs_get_global_bucket(),
#                saveToDisk = "../../data/rst/butte_rst_environmental.csv",
#                overwrite = TRUE)

butte_env <- read_csv("../../data/rst/butte_rst_environmental.csv", 
                      col_types = list(
                      "D", "c", "c", "l", "n", "n", "n", "n", "c", "t", 
                      "c", "c", "n", "n", "n", "n", "l", "l", "n", "c", 
                      "n", "n", "c"
                      )) %>%
  select(date, location = station, weather, temperature, turbidity, secchi, velocity) %>%
  mutate(stream = "Butte Creek") %>%
  glimpse
```

### Clear Creek

#### Columns Removed

The dataset included operations and environmental data. Below only
columns for environmental data are selected.

```{r, message=FALSE, warning=FALSE}
# gcs_get_object(object_name = "rst/clear-creek/data/clear_rst_environmental.csv",
#                bucket = gcs_get_global_bucket(),
#                saveToDisk = "../../data/rst/clear_rst_environmental.csv",
#                overwrite = TRUE)

clear_env <- read_csv("../../data/rst/clear_rst_environmental.csv") %>% 
  select(trap_visit_id = sample_id, date = sample_date, 
         velocity, turbidity, weather = weather_code, lunar_phase, habitat, station_code) %>%
  mutate(stream = "Clear Creek", 
         location = ifelse(station_code == "ucc", "Upper Clear Creek", "Lower Clear Creek")) %>%
  select(-station_code) %>%
  glimpse
```

### Deer Creek

#### Columns Removed

The dataset included operations and environmental data. Below only
columns for environmental data are selected.

```{r, message=FALSE, warning=FALSE}
# gcs_get_object(object_name = "rst/deer-creek/data/deer_rst.csv",
#                bucket = gcs_get_global_bucket(),
#                saveToDisk = "../../data/rst/deer_rst_environmental.csv",
#                overwrite = TRUE)

deer_env <- read_csv("../../data/rst/deer_rst_environmental.csv", 
                     col_types = list("D", "c", "n", "n", "n", "n", "n", "n", "c", 
                                      "n", "c", "c", "n")) %>% 
  select(date, location, flow, turbidity, weather, temperature = water_temperature_celsius) %>%
  mutate(stream = "Deer Creek") %>%
  glimpse

```

### Feather River

#### Columns Removed

The dataset included operations and environmental data. Below only
columns for environmental data are selected.

```{r, message=FALSE, warning=FALSE}
# gcs_get_object(object_name = "rst/feather-river/data/feather_rst_effort.csv",
#                bucket = gcs_get_global_bucket(),
#                saveToDisk = "../../data/rst/feather_rst_environmental.csv",
#                overwrite = TRUE)

feather_env <- read_csv("../../data/rst/feather_rst_environmental.csv") %>% 
  select(date, location = site_name, sub_site = sub_site_name, temperature = water_temp_c, 
         turbidity = turbidity_ntu) %>%
  mutate(stream = "Feather Creek") %>%
  glimpse

```

### Lower Sac - Knights Landing

#### Columns Removed

The dataset included operations and environmental data. Below only
columns for environmental data are selected.

```{r, message=FALSE, warning=FALSE}
# gcs_get_object(object_name = "rst/lower-sac-river/data/knights-landing/knl_combine_sampling_effort_clean.csv",
#                bucket = gcs_get_global_bucket(),
#                saveToDisk = "../../data/rst/knights_landing_rst_environmental.csv",
#                overwrite = TRUE)

knights_landing_env <- read_csv("../../data/rst/knights_landing_rst_environmental.csv") %>% 
  select(date, location, flow = flow_cfs, secchi = secchi_ft, temperature = water_t_f, turbidity) %>%
  mutate(temperature = round((temperature - 32) * (5/9), 1), 
         location = ifelse(location == "KL", "Knights Landing", location), 
         stream = "Sacramento River") %>%
  glimpse

```

### Mill Creek

#### Columns Removed

The dataset included operations and environmental data. Below only
columns for environmental data are selected.

```{r, message=FALSE, warning=FALSE}
# gcs_get_object(object_name = "rst/mill-creek/data/mill_rst.csv",
#                bucket = gcs_get_global_bucket(),
#                saveToDisk = "../../data/rst/mill_rst_environmental.csv",
#                overwrite = TRUE)

mill_env <- read_csv("../../data/rst/mill_rst_environmental.csv") %>% 
  select(date, location, flow, temperature = water_temperature, turbidity, weather) %>%
  mutate(temperature = round((temperature - 32) * (5/9), 1),
         stream = "Mill Creek") %>%
  glimpse

```

### Yuba River

#### Columns Removed

The dataset included operations and environmental data. Below only
columns for environmental data are selected.

```{r, message=FALSE, warning=FALSE}
# gcs_get_object(object_name = "rst/yuba-river/data/yuba_rst.csv",
#                bucket = gcs_get_global_bucket(),
#                saveToDisk = "../../data/rst/yuba_rst_environmental.csv",
#                overwrite = TRUE)

yuba_env <- read_csv("../../data/rst/yuba_rst_environmental.csv", 
                     col_types = list("T", "t", "c", "n", "n", "n", "c", "n", 
                                      "n", "c", "n", "n", "c", "c", "n", "n", 
                                      "c", "n", "c", "c")) %>% 
  mutate(date = lubridate::as_date(date)) %>%
  select(date, temperature, turbidity, velocity, location) %>%
  mutate(stream = "Yuba River",
         temperature = ifelse(temperature > 40, round((temperature - 32) * (5/9), 1), temperature)) %>% # appears to be F and C temps at yuba 
  glimpse

```

## Combine data:

```{r}
combined_env <- bind_rows(battle_env, butte_env, clear_env, deer_env,
                          feather_env, knights_landing_env, mill_env, 
                          yuba_env) %>% glimpse


```

## Explore Varibles {.tabset}

### sample_id

Battle and Clear Creeks are the only tribs that give a sample ID. The
rest of the tribs are entirely NA for this column.

TODO assign trap visit ID for other tribs

```{r}
combined_env %>% group_by(stream) %>%
  summarize(unique_trap_visit_id = length(unique(trap_visit_id)))
```

### date

```{r}
combined_env %>% 
  ggplot() + 
  geom_point(aes(x = date, y = stream, color = stream), alpha = .5) + 
  theme_minimal() + 
  scale_color_manual(values = color_pal) + 
  theme(legend.position = "none", 
        text = element_text(size = 18)) 
```

### velocity

Battle, Butte, Clear, and Yuba provide velocity data.

```{r}
combined_env %>% 
  ggplot() + 
  geom_boxplot(aes(x = velocity, y = stream, color = stream), alpha = .5, binwidth = .5) + 
  theme_minimal() + 
  scale_color_manual(values = color_pal) +
  theme(legend.position = "none", 
        text = element_text(size = 18))
```

Zoom in on 0 - 10 velocity range:

```{r}
combined_env %>% 
  filter(velocity < 10) %>%
  ggplot() + 
  geom_histogram(aes(x = velocity, fill = stream), alpha = .5, binwidth = .3, position="identity") + 
  theme_minimal() + 
  scale_fill_manual(values = color_pal) +
  theme(legend.position = "bottom", 
        text = element_text(size = 18))
```

### turbidity

All watersheds provide turbidity data

```{r}
combined_env %>% 
  ggplot() + 
  geom_boxplot(aes(x = turbidity, y = stream, color = stream), alpha = .5) + 
  theme_minimal() + 
  scale_color_manual(values = color_pal) +
  theme(legend.position = "none", 
        text = element_text(size = 18))
```

Zoom in on 0 - 25 turbidity range:

```{r}
combined_env %>% 
  filter(turbidity < 50) %>% # 1,647 values above 50 (274,049 rows total)
  ggplot() + 
  geom_histogram(aes(x = turbidity, fill = stream), alpha = .5, binwidth = .3, position="identity") + 
  theme_minimal() + 
  scale_fill_manual(values = color_pal) +
  theme(legend.position = "bottom", 
        text = element_text(size = 18))
```

### weather

Battle, Butte, Clear Deer, and Mill collect weather data:

```{r}
unique(combined_env$weather)
combined_env %>% 
  ggplot() + 
  geom_bar(aes(x = weather, fill = stream), position = "dodge") + 
  theme_minimal() + 
  scale_fill_manual(values = color_pal) +
  theme(legend.position = "bottom", 
        text = element_text(size = 18), 
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

Fix encoding of weather data

```{r}
combined_env <- combined_env %>% 
  mutate(weather = case_when(weather %in% c("precipitation", "rain", "rainy", "windy and precipitation") ~ "precipitation",
                             weather %in% c("sunny", "clear") ~ "clear",
                             weather %in% c("partially cloudy", "partly cloudy") ~ "partially cloudy",
                             weather %in% c("fog", "foggy") ~ "clear",
                             weather %in% c("windy", "windy and clear") ~ "windy",
                             weather == "cloudy" ~ "cloudy")) %>% glimpse

table(combined_env$weather, useNA = "ifany")

combined_env %>% 
  ggplot() + 
  geom_bar(aes(x = weather, fill = stream), position = "dodge") + 
  theme_minimal() + 
  scale_fill_manual(values = color_pal) +
  theme(legend.position = "bottom", 
        text = element_text(size = 18))
```

### habitat

```{r}
table(combined_env$habitat, useNA = "ifany")
```

Only battle and clear give habitat:

```{r}
combined_env %>% 
  ggplot() + 
  geom_bar(aes(x = habitat, fill = stream), position = "dodge") +
  theme_minimal() + 
  scale_fill_manual(values = color_pal) +
  theme(legend.position = "bottom", 
        text = element_text(size = 18))


```

### stream

```{r}
table(combined_env$stream, useNA = "ifany")
```

### temperature

Butte, Deer, Feather, Knights Landing, Mill, and Yuba provide
temperature data

```{r}
combined_env %>% 
  ggplot() + 
  geom_boxplot(aes(x = temperature, y = stream, color = stream), alpha = .5, binwidth = .5) + 
  theme_minimal() +
  scale_color_manual(values = color_pal) +
  theme(legend.position = "none", 
        text = element_text(size = 18))
```

How many values are above 30 degrees C?

```{r}
combined_env %>% 
  filter(temperature > 40) # all on butte creek and seem like errors 


# Remove temps above 40 
combined_env <- combined_env %>% 
  filter(temperature < 40) 
```

Zoom in on 0 - 25 temperature range:

```{r}
combined_env %>% 
  filter(temperature < 30) %>% # Filter out outliers
  ggplot() + 
  geom_histogram(aes(x = temperature, fill = stream), alpha = .5, binwidth = 2.5, position = "identity") + 
  theme_minimal() + 
  scale_fill_manual(values = color_pal) +
  theme(legend.position = "bottom", 
        text = element_text(size = 18))
```

### secchi

Knights Landing and Butte provide secchi data

```{r}
combined_env %>% 
  ggplot() + 
  geom_boxplot(aes(x = secchi, y = stream, color = stream), alpha = .5, binwidth = .5) + 
  theme_minimal() + 
  scale_color_manual(values = color_pal) +
  theme(legend.position = "none", 
        text = element_text(size = 18))
```

```{r}
combined_env %>% 
  ggplot() + 
  geom_histogram(aes(x = secchi, fill = stream), binwidth = 2.5, position = "identity", alpha = .5) + 
  theme_minimal() + 
  scale_fill_manual(values = color_pal) +
  theme(legend.position = "bottom", 
        text = element_text(size = 18))
```

### location

```{r}
table(combined_env$location, useNA = "ifany")
```

### flow

Mill, Deer, and Knights Landing provide flow data

```{r}
combined_env %>% 
  ggplot() + 
  geom_boxplot(aes(x = flow, y = stream, color = stream), alpha = .5, binwidth = .5) + 
  theme_minimal() + 
  scale_color_manual(values = color_pal) +
  theme(legend.position = "none", 
        text = element_text(size = 18))
```

```{r}
combined_env %>% 
  filter(stream %in% c("Mill Creek", "Lower Sac - Knights Landing", "Deer Creek")) %>%
  ggplot() + 
  geom_histogram(aes(x = flow, fill = stream), binwidth = 10) + 
  theme_minimal() + 
  facet_wrap(~stream, ncol = 1, drop = TRUE, scales = "free") + 
  scale_fill_manual(values = color_pal) +
  theme(legend.position = "none", 
        text = element_text(size = 18))
```

### sub_site

```{r}
table(combined_env$sub_site, useNA = "ifany")
```

## Reorder columns and save data to GC

```{r}
reordered_env <- combined_env %>% 
  relocate(stream, location, sub_site, date, trap_visit_id, 
           velocity, turbidity, temperature, flow, secchi, 
           weather, habitat)

knitr::kable(align = 'c', head(reordered_env, 5)) 
```

```{r, eval = FALSE}
f <- function(input, output) write_csv(input, file = output)

gcs_upload(reordered_env,
           object_function = f,
           type = "csv",
           name = "standard-format-data/standard_RST_environmental.csv")
write_csv(reordered_env, "standard_RST_environmental.csv")
```
