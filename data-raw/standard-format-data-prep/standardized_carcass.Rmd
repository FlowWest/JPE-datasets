---
title: "Standardize Carcass Data"
output: 
  html_document:
  theme: flatly
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, fig.width=15, fig.height=10)
library(tidyverse)
library(googleCloudStorageR)

color_pal <- c("#9A8822",  "#F8AFA8", "#FDDDA0", "#74A089", "#899DA4", "#446455", "#DC863B", "#C93312")
```

## Carcass Data Standardization

FlowWest received carcass data from 4 monitoring programs:

-   Battle Creek
-   Butte Creek
-   Clear Creek
-   Feather River
-   Yuba River

## Standard format Carcass Data

Data dictionary for standard format:

(B - Battle Creek, Bu - Butte Creek, C - Clear Creek, F - Feather River, Y - Yuba River)

| column name   | stream collects         | definition                                               |
|:-----------------|:-------------------|:---------------------------------|
| longitude      | B, C | Longitude of survey site                    |
| latitude         | B, C | Latitude of survey site     |
| river_mile | B, C |
| date | B, Bu, F, C |
| survey_method | B, C |
| location | B |
|sex | B, Bu, F, C |
|fork_length | B, Bu, F, C|
| adipose | B, Bu, F, C |
| carcass_condition | B, Bu, F, C|
| spawn_condition | B, Bu, F, C|
| run | B, F, C |
| stream | B, Bu, F, C |
| chop_count | B, Bu, F, C |
| survey_id | Bu, F |
| section_cd | Bu |
| way_pt | Bu |
| tag_count | Bu, F |
| tag_col | F, C |
| sec | F |
| unit | F |
| chan | F |
| min | F |
| chan_id | F |
| reach | C |



## Read in data {.tabset}

### Battle Creek

#### Columns Removed

`comments`, `year`, `observed_only`, `cwt_code`

```{r, message=FALSE, warning=FALSE, include = FALSE}
gcs_auth(json_file = Sys.getenv("GCS_AUTH_FILE"))
# Set global bucket
gcs_global_bucket(bucket = Sys.getenv("GCS_DEFAULT_BUCKET"))

gcs_get_object(object_name = "adult-holding-redd-and-carcass-surveys/battle-creek/data/battle_carcass.csv",
               bucket = gcs_get_global_bucket(),
               saveToDisk = "data/redd-carcass-holding/battle_carcass.csv",
               overwrite = TRUE)
```
```{r, message = FALSE, warning = FALSE}

battle_carcass <- read_csv("data/redd-carcass-holding/battle_carcass.csv") |> 
  mutate(stream = "battle creek") |> 
  rename(carcass_condition = carcass_live_status,
         survey_method = method) |> 
  mutate(chop_count = 1) |> 
  select(-c(comments, year, observed_only, cwt_code)) |> 
  glimpse()
# each row is a carcass in table
```

### Butte Creek

#### Columns Removed

`disc_tag_applied`, `scale_nu`, `tissue_nu`, `otolith_nu`, `comments`, `year`

```{r, message=FALSE, warning=FALSE, include = FALSE}
gcs_get_object(object_name = "adult-holding-redd-and-carcass-surveys/butte-creek/data/butte_carcass_chops.csv",
               bucket = gcs_get_global_bucket(),
               saveToDisk = "data/redd-carcass-holding/butte_carcass.csv",
               overwrite = TRUE)

gcs_get_object(object_name = "adult-holding-redd-and-carcass-surveys/butte-creek/data/butte_carcass_2014-2016.csv",
               bucket = gcs_get_global_bucket(),
               saveToDisk = "data/redd-carcass-holding/butte_carcass_2014-2016.csv",
               overwrite = TRUE)

gcs_get_object(object_name = "adult-holding-redd-and-carcass-surveys/butte-creek/data/butte_carcass_2017-2020.csv",
               bucket = gcs_get_global_bucket(),
               saveToDisk = "data/redd-carcass-holding/butte_carcass-2017-2020.csv",
               overwrite = TRUE)
```
```{r, message = FALSE, warning = FALSE}

# this may contain carcasses that were chopped but did not have any biological information recorded
butte_carcass <- read_csv("data/redd-carcass-holding/butte_carcass.csv")
# each row is an individual for these
butte_carcass_2014_2016 <- read_csv("data/redd-carcass-holding/butte_carcass_2014-2016.csv")
butte_carcass_2017_2020 <- read_csv("data/redd-carcass-holding/butte_carcass-2017-2020.csv")

# combine tables with individual measurements
butte_carcass_combined <- bind_rows(butte_carcass_2014_2016, butte_carcass_2017_2020) |> 
  rename(survey_id = survey,
         tagged = disposition,
         fork_length = fork_length_mm,
         carcass_condition = condition,
         spawn_condition = spawning_status,
         adipose = ad_fin_clip_cd) |> 
  mutate(tag_count = case_when(tagged == "tagged" ~ 1,
                               is.na(tagged) ~ 0),
         chop_count = case_when(is.na(tagged) ~ 1,
                                tagged == "tagged" ~ 0),
         stream = "butte creek") |> 
  select(-c(scale_nu, tissue_nu, otolith_nu, comments, year, disc_tag_applied, tagged)) |> 
  glimpse()
```

### Clear Creek

#### Columns Removed

`scale`, `tis_eth`, `tis_dry`, `otolith_st`, `comments`, `verification_and_cwt_comments`, `obs_only`, `run_call`, `cwt_code`, `sample_id`, `species`, `why_sex_unknown`, `why_not_sp`, `head_retrieved`, `photo`, `brood_year`, `release_location`, `hatchery`, `age`, `mark_rate`, `genetic`

```{r, message=FALSE, warning=FALSE, include = FALSE}
gcs_get_object(object_name = "adult-holding-redd-and-carcass-surveys/clear-creek/data/clear_carcass.csv",
               bucket = gcs_get_global_bucket(),
               saveToDisk = "data/redd-carcass-holding/clear_carcass.csv",
               overwrite = TRUE)
```
```{r, message = FALSE, warning = FALSE}

clear_carcass <- read_csv("data/redd-carcass-holding/clear_carcass.csv")  |> 
  mutate(adipose = case_when(adipose == "present" ~ TRUE,
                             adipose == "absent" ~ FALSE,
                             is.na(adipose) ~ NA),
         stream = "clear creek",
         chop_count = 1) |> 
  rename(carcass_condition = condition,
         spawn_condition = spawn_status,
         survey_method = type, 
         tag_col = tag_type) |> 
  select(-c(scale, tis_eth, tis_dry, otolith_st, comments, 
            verification_and_cwt_comments, obs_only, run_call, 
            cwt_code, sample_id, species, why_sex_unknown,
            why_not_sp, head_retrieved, photo, brood_year, 
            release_location, hatchery, age, mark_rate, 
            genetic)) |> 
  glimpse()
```

### Feather River

#### Columns Removed

`tag_count`, `chop_count`, `species`, `disc_tag_applied`, `lifestage`, `tag_clip_status`, `scale_nu`, `tissue_nu`, `otolith_nu`, `comments`, `cwt_cd`, `cwt_status`, `tag_num`, `head_nu`, `dna_nu`, `egg_ret`, `data_recorder`, `creation_time`, `editor`, `edit_time`, `individual_id`, `recov_id`, `header_id`
```{r, message=FALSE, warning=FALSE, include = FALSE}
gcs_get_object(object_name = "adult-holding-redd-and-carcass-surveys/feather-river/data/feather_carcass.csv",
               bucket = gcs_get_global_bucket(),
               saveToDisk = "data/redd-carcass-holding/feather_carcass.csv",
               overwrite = TRUE)
```
```{r, message = FALSE, warning = FALSE}

feather_carcass <- read_csv("data/redd-carcass-holding/feather_carcass.csv") |> 
  filter(species %in% c("chinook salmon", NA)) |> 
  rename(fork_length = fl,
         carcass_condition = condition,
         spawn_condition = spawned,
         adipose = chop_clip_status) |> 
  mutate(adipose = case_when(adipose == "yes" ~ TRUE,
                              adipose == "no" ~ FALSE,
                              adipose %in% c("unknown", "partial", "not recorded", NA) ~ NA),
         stream = "feather river") |> 
  select(-c(species, disc_tag_applied, 
            lifestage, tag_clip_status, scale_nu, tissue_nu, otolith_nu, comments,
            cwt_cd, cwt_status, tag_num, head_nu, dna_nu, egg_ret, 
            data_recorder, creation_time, editor, edit_time, individual_id, recov_id,
            header_id)) |> glimpse()
```

### Yuba River

#### Columns Removed


```{r, message=FALSE, warning=FALSE}

```

### Combined

```{r}
carcass_combined <- bind_rows(battle_carcass, 
                              butte_carcass_combined,
                              feather_carcass,
                              clear_carcass) |> 
  glimpse()

```
# Upload standardized data to google cloud
```{r, include = FALSE}
f <- function(input, output) write_csv(input, file = output)

# combined chops and tags
gcs_upload(carcass_combined,
           object_function = f,
           type = "csv",
           name = "standard-format-data/standard_carcass.csv",
           predefinedAcl = "bucketLevel")
```

### For Analysis

```{r}

```
