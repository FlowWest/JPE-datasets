---
title: "pull temperature data for trap locations"
output: 
  html_document:
  theme: flatly
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, fig.width=15, fig.height=10)
library(tidyverse)
library(lubridate)
library(CDECRetrieve)
library(dataRetrieval)
library(hms)

# TO-DO: Standardize Units
# TO-DO: Update writing and reading CSV
# TO-DO: Pre and post outlier graph
# TO-DO: Update Labeling of graphs for clarity
# TO-DO: Set-up pull from Google Cloud
```

# Trap location and flow gage lookup

```{r}
# We need temperature data for each of the sites included in the trap_locations table
# for all of the years listed.
# We do not need to go to subsite scale of resolution.
# For now this table is for reference to find the years that data is needed.
# This table is also helpful for understanding years where we need flow data for each location:
# https://github.com/FlowWest/JPE-datasets/tree/main/data-raw/qc-markdowns/rst

# trap_locations_raw <- read_csv("data-raw/standard-format-data-prep/rst_sites.csv")
trap_locations_raw <- read_csv("rst_sites.csv")

trap_locations <- trap_locations_raw %>%
  select(tributary, site_name, sub_site_name, river_location, latitude, longitude, year) %>%
  distinct()
  # identify years

# gage_locations_raw <- read_csv("data-raw/standard-format-data-prep/gage_sites.csv")
gage_locations_raw <- read_csv("gage_sites.csv")

# Idenntify which flow gage locations have temperature measures

gage_locations <- gage_locations_raw %>%
  filter(flow_gage == T) %>%
  select(tributary, site_name, agency, latitude, longitude, identifier) %>%
  distinct() %>%
  rename(gage_latitude = latitude,
         gage_longitude = longitude)
  # get codes

gage_locations
```

# Pull in temperature data {.tabset}

## Battle Creek

```{r}
# Check if CDEC data provides temp data for respective location
cdec_datasets("BAT") 
# CDEC has no temperature data available
```


```{r}
# Using https://flowwest.shinyapps.io/jpe-eda-app/ to find temperature gage
# Using mapper to check if temp data is available for the site https://maps.waterdata.usgs.gov/mapper/index.html

#BAT_USGS <- readNWISdv(11376550, "00010") # parameter code 00010: water temperature
#write.csv(BAT_USGS,"BAT_USGS.csv", row.names = FALSE)

# Read created CSV
BAT_USGS <- read_csv("BAT_USGS.csv")
BAT_USGS
```

CDEC and USGS do not provide temperature data for Battle Creek. Temperature data is collected by sensor 25, but CDEC data is not available for this sensor. USGS mapper indicates as well there is no data available for the requested period.

## Butte Creek

### CDEC
```{r}
# Check if CDEC data provides temp data for respective location
cdec_datasets("BCK")

# Since this location has sensor that collects temp data, we can make request
#BCK_CDEC <- cdec_query(station = "BCK", dur_code = "H", sensor_num = "20", start_date = "1995-01-01")
#write.csv(BCK_CDEC,"BCK_CDEC.csv", row.names = FALSE)

# Read created CSV
BCK_CDEC <- read_csv("BCK_CDEC.csv")

BCK_hourly_temps <- BCK_CDEC %>%
  mutate(date = as_date(datetime),
         time = as_hms(datetime),
         temp_degf = parameter_value) %>%
  select(date,time,temp_degf)

# Date Ranges
tail(BCK_hourly_temps$date,n=1) # 
head(BCK_hourly_temps$date,n=1)

ggplot(BCK_hourly_temps, aes(x=date)) +
  geom_line(aes(y = temp_degf), color ="darkred") +
  labs(x="Year",y="Temperature (deg f)",title="Water Temperature at Butte Creek: Hourly (CDEC)")
```

CDEC data provides temperature data for Butte Creek. It ranges from 1997-03-14 to 2022-05-28

### USGS
```{r}
# Using https://flowwest.shinyapps.io/jpe-eda-app/ to find temperature gage
# Using mapper to check if temp data is available for the site https://maps.waterdata.usgs.gov/mapper/index.html

#BCK_USGS <- readNWISdv(11372000, "00010") # parameter code 00010: water temperature
#write.csv(BCK_USGS,"BCK_USGS.csv", row.names = FALSE)

# Read created CSV
BCK_USGS <- read_csv("BCK_USGS.csv")
BCK_USGS
# no data available from USGS
```

USGS provides no temperature data for Butte Creek. This was confirmed with mapper tool accessed from waterdata.usgs.gov.

### Explore Outliers
```{r}
BCK_hourly_temps %>%
  filter(temp_degf > 200)
```

### Explore Missing Values
```{r}
# Get the dates and frequency where the temp data is missing
BCK_hourly_temps_missing <- filter(BCK_hourly_temps,is.na(temp_degf))
BCK_hourly_temps_missing <- data.frame(table(BCK_hourly_temps_missing$date))

# Identify missing data by year
BCK_hourly_temps_missing %>%
  mutate(date = as_date(Var1),
         count = Freq) %>%
  select(date,count) %>%
  arrange(desc(count)) %>%
  mutate(month = format(date, "%m"), year = format(date, "%Y")) %>%
  group_by(year) %>%
  summarise(count = sum(count)) %>%
  ggplot(aes(x=as.numeric(year))) +
  geom_line(aes(y=count)) +
  labs(x="Year",y="Frequency",title="Missing Data at Butte Creek : Hourly (CDEC)")
```

Majority Butte Creek Missing data comes from the period of 2000 to 2008.
#===============================================================================
## Clear Creek
### CDEC
```{r}
# Check if CDEC data provides temp data for respective location
cdec_datasets("IGO")

# Since this location has sensor that collects temp data, we can make request
#IGO_CDEC <- cdec_query(station = "IGO", dur_code = "H", sensor_num = "25", start_date = "2003-01-01")
#write.csv(IGO_CDEC,"IGO_CDEC.csv", row.names = FALSE)

# Read created CSV
IGO_CDEC <- read_csv("IGO_CDEC.csv")

IGO_hourly_temps <- IGO_CDEC %>%
  mutate(date = as_date(datetime),
         time = as_hms(datetime),
         temp_degf = parameter_value) %>%
  select(date,time,temp_degf)

# Date Ranges
tail(IGO_hourly_temps$date,n=1)
head(IGO_hourly_temps$date,n=1)

ggplot(IGO_hourly_temps, aes(x=date)) +
  geom_line(aes(y = temp_degf), color ="darkred") +
  labs(x="Year",y="Temperature (deg f)",title="Water Temperature at Clear Creek: Hourly (CDEC)")
```
CDEC temeprature data for Clear Cleek ranges from 2002-12-31 to 2022-05-27.

### USGS
```{r}
# Using https://flowwest.shinyapps.io/jpe-eda-app/ to find temperature gage
# Using mapper to check if temp data is available for the site https://maps.waterdata.usgs.gov/mapper/index.html

#IGO_USGS <- readNWISdv(11372000, "00010") # parameter code 00010: water temperature
#write.csv(IGO_USGS,"IGO_USGS.csv", row.names = FALSE)

# Read created CSV
IGO_USGS <- read_csv("IGO_USGS.csv")
IGO_USGS
# no data available from USGS
```

USGS provides no temperature data for Clear Creek. This was confirmed with mapper tool accessed from waterdata.usgs.gov.

### Explore Outliers
```{r}
IGO_hourly_temps %>%
  filter(temp_degf > 200)
```

### Explore Missing Values
```{r}
# Get the dates and frequency where the temp data is missing
IGO_hourly_temps_missing <- filter(IGO_hourly_temps,is.na(temp_degf))
IGO_hourly_temps_missing <- data.frame(table(IGO_hourly_temps_missing$date))

# Identify missing data by year
IGO_hourly_temps_missing %>%
  mutate(date = as_date(Var1),
         count = Freq) %>%
  select(date,count) %>%
  arrange(desc(count)) %>%
  mutate(month = format(date, "%m"), year = format(date, "%Y")) %>%
  group_by(year) %>%
  summarise(count = sum(count)) %>%
  ggplot(aes(x=as.numeric(year))) +
  geom_line(aes(y=count)) +
  labs(x="Year",y="Frequency",title="Missing Data at Clear Creek : Hourly (CDEC)")
```

Majority of the missing data for clear creek comes from 2018-2020.

#===============================================================================
## Deer Creek
### CDEC
```{r}

cdec_datasets("DCV")

#DCV_CDEC <- cdec_query(station = "DCV", dur_code = "H", sensor_num = "20", start_date = "1995-01-01")
#write.csv(DCV_CDEC,"DCV_CDEC.csv", row.names = FALSE)

# Read created CSV
DCV_CDEC <- read_csv("DCV_CDEC.csv")

DCV_hourly_temps <- DCV_CDEC %>%
  mutate(date = as_date(datetime),
         time = as_hms(datetime),
         temp_degf = parameter_value) %>%
  select(date,time,temp_degf)

# Date Ranges
tail(DCV_hourly_temps$date,n=1)
head(DCV_hourly_temps$date,n=1)

# Plot
ggplot(DCV_hourly_temps, aes(x=date)) +
  geom_line(aes(y = temp_degf), color ="darkred") +
  labs(x="Year",y="Temperature (deg f)",title="Water Temperature at Deer Creek: Hourly (CDEC)")
```
CDEC Temperature Data for Deer Creek ranges from 1997-03-14 to 2022-05-07.

### USGS
```{r}
# Using https://flowwest.shinyapps.io/jpe-eda-app/ to find temperature gage
# Using mapper to check if temp data is available for the site https://maps.waterdata.usgs.gov/mapper/index.html

#DCV_USGS <- readNWISdv(11383500, "00010") # parameter code 00010: water temperature
#write.csv(DCV_USGS,"DCV_USGS.csv", row.names = FALSE)

# Read created CSV
DCV_USGS <- read_csv("DCV_USGS.csv")

# Format to make tidier
DCV_daily_temps <- DCV_USGS %>%
  select(Date, temp_degf =  X_00010_00003) %>%
  filter(lubridate::year(Date) >= 1995) %>%
  as_tibble() %>% 
  rename(date = Date)

# Date Ranges
tail(DCV_daily_temps$date,n=1)
head(DCV_daily_temps$date,n=1)

# Plot
ggplot(DCV_daily_temps, aes(x=date)) +
  geom_line(aes(y = temp_degf), color ="darkred") +
  labs(x="Year",y="Temperature (deg f)",title="Water Temperature at Deer Creek: Daily (USGS)")
```
USGS temperature data for deer creek ranges from 2016-10-01 to 2022-05-25.

#### Hourly USGS vs Daily CDEC data
```{r}
# comparison of USGS vs CDEC
# Does one have more data?
# Does one have a finer scale?
DCV_combined = DCV_hourly_temps %>% 
  full_join(DCV_daily_temps, by ="date") %>% 
  rename("temp_degf.CDEC"="temp_degf.x", "temp_degf.USGS"="temp_degf.y")

# Plot Temp CDEC vs USGS
ggplot(DCV_combined, aes(x=date)) +
  geom_line(aes(y = temp_degf.CDEC), color ="darkred") +
  geom_line(aes(y = temp_degf.USGS), color ="steelblue", linetype ="twodash") +
  labs(x="Year",y="Temperature (deg f)",title="Water Temperature at Deer Creek : Hourly CDEC vs Daily USGS")
```

Not as helpful to compare hourly CDEC data to daily USGS, it would be better to adjust the granularity to daily by taking the average.

#### Mean Daily USGS vs Daily CDEC data
```{r}
DCV_combined %>% 
  group_by(date = date(date)) %>% 
  group_by(date) %>% 
  summarise(
    temp_CDEC = mean(temp_degf.CDEC, na.rm = TRUE),
    temp_USGS = max(temp_degf.USGS, na.rm = TRUE)) %>% 
  ggplot(aes(x=date)) +
  geom_line(aes(y = temp_CDEC), color ="darkred") +
  geom_line(aes(y = temp_USGS), color ="steelblue", linetype ="twodash") +
  labs(y="Temperature (deg f)",title="Water Temperature at Deer Creek: Mean Daily CDEC vs Daily USGS")

```

This helps it become more apparent that we should use CDEC data for deer creek due to the availability of the data.

#===============================================================================
## Feather River
### CDEC
```{r}

cdec_datasets("GRL")

#GRL_CDEC <- cdec_query(station = "GRL", dur_code = "H", sensor_num = "25", start_date = "1996-01-01")
#write.csv(GRL_CDEC,"GRL_CDEC.csv", row.names = FALSE)

# Read created CSV
GRL_USGS <- read_csv("GRL_CDEC.csv")


GRL_hourly_temps <- GRL_CDEC %>%
  mutate(date = as_date(datetime),
         time = as_hms(datetime),
         temp_degf = parameter_value) %>%
  select(date,time,temp_degf)

# Date Ranges
tail(GRL_hourly_temps$date,n=1)
head(GRL_hourly_temps$date,n=1)

# Plot DCV
ggplot(GRL_hourly_temps, aes(x=date)) +
  geom_line(aes(y = temp_degf), color ="darkred") +
  labs(x="Year",y="Temperature (deg f)",title="Temperature at Feather River: Hourly (CDEC)")
```
CDEC provides temperature data for Feather River from 2003-01-05 to 2007-06-15.

### USGS
```{r}
# Using https://flowwest.shinyapps.io/jpe-eda-app/ to find temperature gage
# Using mapper to check if temp data is available for the site https://maps.waterdata.usgs.gov/mapper/index.html

#GRL_USGS <- readNWISdv(11407000, "00010") # parameter code 00010: water temperature
#write.csv(GRL_USGS,"GRL_USGS.csv", row.names = FALSE)

# Read created CSV
GRL_USGS <- read_csv("GRL_USGS.csv")
GRL_USGS
```

USGS does not provide temperature data for Feather River. This was confirmed with mapper tool accessed from waterdata.usgs.gov.

#### Mean Daily CDEC
```{r}
GRL_hourly_temps %>% 
  group_by(date) %>% 
  summarise(
    temp_CDEC = mean(temp_degf, na.rm = TRUE))%>% 
  ggplot(aes(x=date)) +
  geom_line(aes(y = temp_CDEC), color ="darkred") +
  labs(y="Temperature (deg f)",title="Water Temperature at Deer Creek: Mean Daily CDEC")

```

#===============================================================================
## Mill Creek
### CDEC
```{r}

cdec_datasets("MLM") 

#MLM_CDEC <- cdec_query(station = "MLM", dur_code = "H", sensor_num = "25", start_date = "1996-01-01")
#rite.csv(MLM_CDEC,"MLM_CDEC.csv", row.names = FALSE)

# Read created CSV
MLM_CDEC <- read_csv("MLM_CDEC.csv")

MLM_hourly_temps <- MLM_CDEC %>%
  mutate(date = as_date(datetime),
         time = as_hms(datetime),
         temp_degf = parameter_value) %>%
  select(date,time,temp_degf)

# Date Ranges
tail(MLM_hourly_temps$date,n=1)
head(MLM_hourly_temps$date,n=1)

# Plot DCV
ggplot(MLM_hourly_temps, aes(x=date)) +
  geom_line(aes(y = temp_degf), color ="darkred") +
  labs(x="Year",y="Temperature (deg f)",title="Temperature at Mill Creek: Hourly (CDEC)")
```
CDEC provides temperature data for Mill Creek from 1998-09-30 to 2022-05-27

### USGS
```{r}
# Using https://flowwest.shinyapps.io/jpe-eda-app/ to find temperature gage
# Using mapper to check if temp data is available for the site https://maps.waterdata.usgs.gov/mapper/index.html

#MLM_USGS <- readNWISdv(11381500, "00010") # parameter code 00010: water temperature temperature
#write.csv(MLM_USGS,"MLM_USGS.csv", row.names = FALSE)

# Read created CSV
MLM_USGS <- read_csv("MLM_USGS.csv")

# Format to make tidier
MLM_daily_temps <- MLM_USGS %>%
  select(Date, temp_degf =  X_00010_00003) %>%
  filter(lubridate::year(Date) >= 1996) %>%
  as_tibble() %>% 
  rename(date = Date)

# Date Ranges
tail(MLM_daily_temps$date,n=1)
head(MLM_daily_temps$date,n=1)

# Plot DCV
ggplot(MLM_daily_temps, aes(x=date)) +
  geom_line(aes(y = temp_degf), color ="darkred") +
  labs(x="Year",y="Temperature (deg f)",title="Temperature at Mill Creek: Daily (USGS)")
```

USGS provides daily temperature daily for Mill Creek from 2016-10-01 to 2022-05-25

#### Hourly USGS vs Daily CDEC data
```{r}
# comparison of USGS vs CDEC
# Does one have more data?
# Does one have a finer scale?
MLM_combined = MLM_hourly_temps %>% 
  full_join(MLM_daily_temps, by ="date") %>% 
  rename("temp_degf.CDEC"="temp_degf.x", "temp_degf.USGS"="temp_degf.y")

# Plot Temp CDEC vs USGS
ggplot(MLM_combined, aes(x=date)) +
  geom_line(aes(y = temp_degf.CDEC), color ="darkred") +
  geom_line(aes(y = temp_degf.USGS), color ="steelblue", linetype ="twodash") +
  labs(x="Year",y="Temperature (deg f)",title="Water Temperature at Mill Creek : Hourly CDEC vs Daily USGS")
```
Again, not as clear comparing hourly CDEC to daily USGS, can adjust granularity of CDEC to daily by taking the mean.

#### Mean Daily USGS vs Daily CDEC data
```{r}
MLM_combined %>% 
  group_by(date = date(date)) %>% 
  group_by(date) %>% 
  summarise(
    temp_CDEC = mean(temp_degf.CDEC, na.rm = TRUE),
    temp_USGS = max(temp_degf.USGS, na.rm = TRUE)) %>% 
  ggplot(aes(x=date)) +
  geom_line(aes(y = temp_CDEC), color ="darkred") +
  geom_line(aes(y = temp_USGS), color ="steelblue", linetype ="twodash") +
  labs(y="Temperature (deg f)",title="Water Temperature at Deer Creek: Mean Daily CDEC vs Daily USGS")

```

I would recommend using the CDEC data for Mill Creek due to the significant data gaps for USGS.

#===============================================================================
## Yuba River
### CDEC
```{r}

cdec_datasets("MRY")
# CDEC doesnt not have temperature data
```
There is not CDEC data available for Yuba River.
### USGS
```{r}
# Using https://flowwest.shinyapps.io/jpe-eda-app/ to find temperature gage
# Using mapper to check if temp data is available for the site https://maps.waterdata.usgs.gov/mapper/index.html

MLM_USGS <- readNWISdv(11421000, "00010") # parameter code 00010: water temperature temperature
# No temp data
```

There is no USGS temperature data available for Yuba River.

## Sacramento River - Knights Landing
```{r}

# TODO : Re-run when cdec is back up

cdec_datasets("WLK")

WLK_CDEC <- cdec_query(station = "WLK", dur_code = "H", sensor_num = "25", start_date = "1995-01-01")
write.csv(WLK_CDEC,"WLK_CDEC.csv", row.names = FALSE)

# Read created CSV
WLK_CDEC <- read_csv("WLK_CDEC.csv")

WLK_hourly_temps <- WLK_CDEC %>%
  mutate(date = as_date(datetime),
         time = as_hms(datetime),
         temp_degf = parameter_value) %>%
  select(date,time,temp_degf)

# Date Ranges
tail(WLK_hourly_temps$date,n=1)
head(WLK_hourly_temps$date,n=1)

# Plot WLK
ggplot(WLK_hourly_temps, aes(x=date)) +
  geom_line(aes(y = temp_degf), color ="darkred") +
  labs(x="Year",y="Temperature (deg f)",title="Temperature at Sacramento River- Knights Landing: Hourly (CDEC)")
```

CDEC provides temperature data for Sacramento River - Knights Landing from 2002-12-31 to 2022-05-25

### Explore Missing Values
```{r}
# Get the dates and frequency where the temp data is missing
WLK_hourly_temps_missing <- filter(WLK_hourly_temps,is.na(temp_degf))
WLK_hourly_temps_missing <- data.frame(table(WLK_hourly_temps_missing$date))

# Identify missing data by year
WLK_hourly_temps_missing %>%
  mutate(date = as_date(Var1),
         count = Freq) %>%
  select(date,count) %>%
  arrange(desc(count)) %>%
  mutate(month = format(date, "%m"), year = format(date, "%Y")) %>%
  group_by(year) %>%
  summarise(count = sum(count)) %>%
  ggplot(aes(x=as.numeric(year))) +
  geom_line(aes(y=count)) +
  labs(x="Year",y="Frequency",title="Missing Data at Sacramento River - Knights Landing : Hourly (CDEC)")
```

This plot gives a cleaer look to see were most of the missing data is for Sacramento River - Knights Landing. Which is around 2007.
### USGS
```{r}
# Using https://flowwest.shinyapps.io/jpe-eda-app/ to find temperature gage
# Using mapper to check if temp data is available for the site https://maps.waterdata.usgs.gov/mapper/index.html

WLK_USGS <- readNWISdv(11390500, "00010") # parameter code 00010: water temperature temperature
write.csv(WLK_USGS,"WLK_USGS.csv", row.names = FALSE)

# Format to make tidier
WLK_daily_temps <- WLK_USGS %>%
  select(Date, temp_degf =  X_00010_00003) %>%
  filter(lubridate::year(Date) >= 1995) %>%
  as_tibble() %>% 
  rename(date = Date)

# Date Ranges
tail(WLK_daily_temps$date,n=1)
head(WLK_daily_temps$date,n=1)

# Plot
ggplot(WLK_daily_temps, aes(x=date)) +
  geom_line(aes(y = temp_degf), color ="darkred") +
  labs(x="Year",y="Temperature (deg f)",title="Temperature at Sacramento River- Knights Landing: Daily (USGS)")
```

USGS provides temperature data for Sacramento River - Knights Landing from 1995-01-01 to 2022-05-25

#### Mean Daily USGS vs Daily CDEC data
```{r}
WLK_combined %>% 
  group_by(date = date(date)) %>% 
  group_by(date) %>% 
  summarise(
    temp_CDEC = mean(temp_degf.CDEC, na.rm = TRUE),
    temp_USGS = max(temp_degf.USGS, na.rm = TRUE)) %>% 
  ggplot(aes(x=date)) +
  geom_line(aes(y = temp_CDEC), color ="darkred") +
  geom_line(aes(y = temp_USGS), color ="steelblue", linetype ="twodash") +
  labs(y="Temperature (deg f)",title="Water Temperature at Sacramento River - Knights Landing : Mean Daily CDEC vs Daily USGS")

```

#===============================================================================
## Sacramento River - Tisdale
### CDEC data

```{r}
# Only CDEC data is available for Tisdale
cdec_datasets("TIS") 

TIS_CDEC <- cdec_query(station = "TIS", dur_code = "H", sensor_num = "20", start_date = "2010-01-01")
write.csv(TIS_CDEC,"TIS_CDEC.csv", row.names = FALSE)

# Format data
TIS_hourly_temps <- TIS_CDEC %>%
  mutate(date = as_date(datetime),
         time = as_hms(datetime),
         temp_degf = parameter_value) %>%
  select(date,time,temp_degf)

# Date Ranges
tail(TIS_hourly_temps$date,n=1)
head(TIS_hourly_temps$date,n=1)

# Plot DCV
ggplot(TIS_hourly_temps, aes(x=date)) +
  geom_line(aes(y = temp_degf), color ="darkred") +
  labs(x="Year",y="Temperature (deg f)",title="Temperature at Sacramento River - Tisdale: Hourly (CDEC)")

```
CDEC provides temperature data for Sacramento River - Tisdale from 2009-12-31 to 2022-05-27.























