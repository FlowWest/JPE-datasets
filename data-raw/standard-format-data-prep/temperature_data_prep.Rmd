---
title: "pull temperature data for trap locations"
output: 
  html_document:
  theme: flatly
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, fig.width=15, fig.height=10, 
                      root.dir = rprojroot::find_rstudio_root_file())

library(tidyverse)
library(lubridate)
library(CDECRetrieve)
library(dataRetrieval)
library(hms)
library(weathermetrics) # conversion of temperature units
library(googleCloudStorageR)

# TODO: Set-up pull from Google Cloud
```

# Trap location and flow gage lookup

```{r}
# We need temperature data for each of the sites included in the trap_locations table
# for all of the years listed.
# We do not need to go to subsite scale of resolution.
# For now this table is for reference to find the years that data is needed.
# This table is also helpful for understanding years where we need flow data for each location:
# https://github.com/FlowWest/JPE-datasets/tree/main/data-raw/qc-markdowns/rst


# Google Cloud Set up
Sys.setenv("GCS_AUTH_FILE" = "config.json")
Sys.setenv("GCS_DEFAULT_BUCKET" = "jpe-dev-bucket")
gcs_auth(json_file = Sys.getenv("GCS_AUTH_FILE"))
gcs_global_bucket(bucket = Sys.getenv("GCS_DEFAULT_BUCKET"))
gcs_get_object(object_name = "standard-format-data/rst_trap_locations.csv",
               bucket = gcs_get_global_bucket(),
               saveToDisk = "rst_sites.csv",
               overwrite = TRUE)

trap_locations_raw <- read_csv("../../data/standard-format-data/rst_trap_locations.csv")

trap_locations <- trap_locations_raw %>%
<<<<<<< HEAD
  select(stream, site, subsite, river_location, latitude, longitude, start_date) %>%
=======
  select(stream, site, subsite, river_location, latitude, longitude) %>%
>>>>>>> 74c731d2a657d379d3b0d887420351309bc5b6ea
  distinct()
  # identify years

gage_locations_raw <- read_csv("../../analysis/exploratory-analysis/data-raw/gage_sites.csv")
gage_locations_raw <- read_csv("gage_sites.csv")

# Idenntify which flow gage locations have temperature measures

gage_locations <- gage_locations_raw %>%
  filter(flow_gage == T) %>%
  select(tributary, site_name, agency, latitude, longitude, identifier) %>%
  distinct() %>%
  rename(gage_latitude = latitude,
         gage_longitude = longitude)
  # get codes

gage_locations
```

# Pull in temperature data {.tabset}

## Battle Creek

```{r}
# Check if CDEC data provides temp data for respective location
cdec_datasets("BAT") 
# CDEC has no temperature data available
```


```{r}
# Using https://flowwest.shinyapps.io/jpe-eda-app/ to find temperature gage
# Using mapper to check if temp data is available for the site https://maps.waterdata.usgs.gov/mapper/index.html

# BAT_USGS <- readNWISdv(11376550, "00010") # parameter code 00010: water temperature
#write.csv(BAT_USGS,"BAT_USGS.csv", row.names = FALSE)

# Read created CSV
BAT_USGS <- read_csv("BAT_USGS.csv")
BAT_USGS
```

CDEC and USGS do not provide temperature data for Battle Creek. Temperature data is collected by sensor 25, but CDEC data is not available for this sensor. USGS mapper indicates as well there is no data available for the requested period.

## Butte Creek
```{r}
# Check if CDEC data provides temp data for respective location
cdec_datasets("BCK")
```

### CDEC
```{r}
# Check if CDEC data provides temp data for respective location
cdec_datasets("BCK")

# Since this location has sensor that collects temp data, we can make request
#BCK_CDEC <- cdec_query(station = "BCK", dur_code = "H", sensor_num = "25", start_date = "1995-01-01")
#write.csv(BCK_CDEC,"BCK_CDEC.csv", row.names = FALSE)

# Read created CSV
BCK_CDEC <- read_csv("BCK_CDEC.csv")

BCK_hourly_temps <- BCK_CDEC %>%
  mutate(date = as_date(datetime),
         time = as_hms(datetime),
         temp_degC = fahrenheit.to.celsius(parameter_value, round = 1)) %>%
  select(date, time, temp_degC)

# Date Ranges
tail(BCK_hourly_temps$date, n=1)
head(BCK_hourly_temps$date, n=1)

ggplot(BCK_hourly_temps, aes(x=date)) +
  geom_line(aes(y = temp_degC), color = "darkred") +
  labs(x = "Year", y = "Temperature (deg C)", title = "CDEC Water Temperature at Buttle Creek", caption = "CDEC")
```

CDEC data provides temperature data for Butte Creek. It ranges from 1998-09-16 to 2022-06-16

### CDEC Outliers Removed
```{r}
# Plot without outliers
BCK_hourly_temps %>%
  filter(temp_degC < 37, temp_degC > -18) %>%
  ggplot(aes(x=date)) +
  geom_line(aes(y = temp_degC), color = "darkred") +
  labs(x = "Year", y = "Temperature (deg C)", title = "CDEC Water Temperature at Buttle Creek", caption = "CDEC")
```

### USGS
```{r}
# Using https://flowwest.shinyapps.io/jpe-eda-app/ to find temperature gage
# Using mapper to check if temp data is available for the site https://maps.waterdata.usgs.gov/mapper/index.html

#BCK_USGS <- readNWISdv(11372000, "00010") # parameter code 00010: water temperature
#write.csv(BCK_USGS,"BCK_USGS.csv", row.names = FALSE)

# Read created CSV
BCK_USGS <- read_csv("BCK_USGS.csv")
BCK_USGS
# no data available from USGS
```

```{r}
# write_rds(BCK_hourly_temps, "../../data-raw/standard-format-data-prep/temp_data/butte_temp.rds")

```


USGS provides no temperature data for Butte Creek. This was confirmed with mapper tool accessed from waterdata.usgs.gov.

#===============================================================================
## Clear Creek
### CDEC
```{r}
# Check if CDEC data provides temp data for respective location
cdec_datasets("IGO")

# Since this location has sensor that collects temp data, we can make request
#IGO_CDEC <- cdec_query(station = "IGO", dur_code = "H", sensor_num = "25", start_date = "2003-01-01")
#write.csv(IGO_CDEC,"IGO_CDEC.csv", row.names = FALSE)

# Read created CSV
IGO_CDEC <- read_csv("IGO_CDEC.csv")

IGO_hourly_temps <- IGO_CDEC %>%
  mutate(date = as_date(datetime),
         time = as_hms(datetime),
         temp_degC = fahrenheit.to.celsius(parameter_value, round = 1)) %>%
  select(date,time,temp_degC)

# Date Ranges
tail(IGO_hourly_temps$date, n=1)
head(IGO_hourly_temps$date, n=1)

ggplot(IGO_hourly_temps, aes(x=date)) +
  geom_line(aes(y = temp_degC), color = "darkred") +
  labs(x = "Year", y ="Temperature (deg C)", title = "Water Temperature at Clear Creek", caption = "CDEC")
```
CDEC temeprature data for Clear Cleek ranges from 2002-12-31 to 2022-05-27.

### CDEC Outliers Removed
```{r}
# Plot without outliers
IGO_hourly_temps %>%
  filter(temp_degC < 37, temp_degC > -18) %>%
  ggplot(aes(x = date)) +
  geom_line(aes(y = temp_degC), color = "darkred") +
  labs(x = "Year", y = "Temperature (deg C)", title = "CDEC Water Temperature at Clear Creek", caption = "CDEC")
```

### USGS
```{r}
# Using https://flowwest.shinyapps.io/jpe-eda-app/ to find temperature gage
# Using mapper to check if temp data is available for the site https://maps.waterdata.usgs.gov/mapper/index.html

#IGO_USGS <- readNWISdv(11372000, "00010") # parameter code 00010: water temperature
#write.csv(IGO_USGS,"IGO_USGS.csv", row.names = FALSE)

# Read created CSV
IGO_USGS <- read_csv("IGO_USGS.csv")
IGO_USGS
# no data available from USGS
```

USGS provides no temperature data for Clear Creek. This was confirmed with mapper tool accessed from waterdata.usgs.gov.

```{r}
# write_rds(IGO_hourly_temps, "../../data-raw/standard-format-data-prep/temp_data/clear_temp.rds")
```

#===============================================================================
## Deer Creek
### CDEC
```{r}

cdec_datasets("DCV")

#DCV_CDEC <- cdec_query(station = "DCV", dur_code = "H", sensor_num = "25", start_date = "1995-01-01")
#write.csv(DCV_CDEC,"DCV_CDEC.csv", row.names = FALSE)

# Read created CSV
DCV_CDEC <- read_csv("DCV_CDEC.csv")

DCV_hourly_temps <- DCV_CDEC %>%
  mutate(date = as_date(datetime),
         time = as_hms(datetime),
         temp_degC = fahrenheit.to.celsius(parameter_value, round = 1)) %>%
  select(date,time,temp_degC)

# Date Ranges
tail(DCV_hourly_temps$date, n = 1)
head(DCV_hourly_temps$date, n = 1)

# Plot
ggplot(DCV_hourly_temps, aes(x=date)) +
  geom_line(aes(y = temp_degC), color = "darkred") +
  labs(x = "Year",y = "Temperature (deg C)",title = "Water Temperature at Deer Creek", caption = " CDEC")
```
CDEC Temperature Data for Deer Creek ranges from 1998-10-01 to 2022-06-16.

### CDEC Outliers Removed
```{r}
# Plot without outliers
DCV_hourly_temps %>%
    filter(temp_degC < 37, temp_degC > -18) %>%
  ggplot(aes(x=date)) +
  geom_line(aes(y = temp_degC), color ="darkred") +
  labs(x = "Year",y = "Temperature (deg C)", title = "CDEC Water Temperature at Buttle Creek", caption = "CDEC")
```

### USGS
```{r}
# Using https://flowwest.shinyapps.io/jpe-eda-app/ to find temperature gage
# Using mapper to check if temp data is available for the site https://maps.waterdata.usgs.gov/mapper/index.html

#DCV_USGS <- readNWISdv(11383500, "00010") # parameter code 00010: water temperature
#write.csv(DCV_USGS,"DCV_USGS.csv", row.names = FALSE)

# Read created CSV
DCV_USGS <- read_csv("DCV_USGS.csv")

# Format to make tidier
DCV_daily_temps <- DCV_USGS %>%
  select(Date, temp_degC =  X_00010_00003) %>%
  filter(lubridate::year(Date) >= 1995) %>%
  as_tibble() %>% 
  rename(date = Date)

# Date Ranges
tail(DCV_daily_temps$date,n=1)
head(DCV_daily_temps$date,n=1)

# Plot
ggplot(DCV_daily_temps, aes(x=date)) +
  geom_line(aes(y = temp_degC), color = "darkred") +
  labs(x = "Year",y = "Temperature (deg f)", title = "Water Temperature at Deer Creek", caption = "USGS")
```
USGS temperature data for deer creek ranges from 2016-10-01 to 2022-05-25.

#### Mean Daily USGS vs Daily CDEC data
```{r}
DCV_combined = DCV_hourly_temps %>% 
  full_join(DCV_daily_temps, by ="date") %>% 
  rename("temp_degC.CDEC"="temp_degC.x", "temp_degC.USGS"="temp_degC.y")

DCV_combined %>% 
  group_by(date = date(date)) %>% 
  group_by(date) %>% 
  summarise(
    temp_CDEC = median(temp_degC.CDEC, na.rm = TRUE),
    temp_USGS = max(temp_degC.USGS, na.rm = TRUE)) %>% 
  ggplot(aes(x = date)) +
  geom_line(aes(y = temp_CDEC), color = "darkred") +
  geom_line(aes(y = temp_USGS), color = "steelblue", linetype = "twodash") +
  labs(y = "Temperature (deg C)", title = "Water Temperature at Deer Creek")
```

This helps it become more apparent that we should use CDEC data for deer creek due to the availability of the data.

```{r}
# write_rds(DCV_hourly_temps, "../../data-raw/standard-format-data-prep/temp_data/deer_temp.rds")
```

#===============================================================================
## Feather River
### CDEC
```{r}

cdec_datasets("GRL")

#GRL_CDEC <- cdec_query(station = "GRL", dur_code = "H", sensor_num = "25", start_date = "1996-01-01")
#write.csv(GRL_CDEC,"GRL_CDEC.csv", row.names = FALSE)

# Read created CSV
GRL_CDEC <- read_csv("GRL_CDEC.csv")

GRL_hourly_temps <- GRL_CDEC %>%
  mutate(date = as_date(datetime),
         time = as_hms(datetime),
         temp_degC = fahrenheit.to.celsius(parameter_value, round = 1)) %>%
  select(date,time,temp_degC)

# Date Ranges
tail(GRL_hourly_temps$date, n = 1)
head(GRL_hourly_temps$date, n = 1)

# Plot GRL
ggplot(GRL_hourly_temps, aes(x = date)) +
  geom_line(aes(y = temp_degC), color = "darkred") +
  labs(x = "Year", y="Temperature (deg C)", title = "Temperature at Feather River", caption = "CDEC")
```
CDEC provides temperature data for Feather River from 2003-01-05 to 2007-06-15.

### CDEC Outliers Removed
```{r}
# Plot without outliers
GRL_hourly_temps %>%
   filter(temp_degC < 37, temp_degC > -18) %>%
  ggplot(aes(x=date)) +
  geom_line(aes(y = temp_degC), color = "darkred") +
  labs(x = "Year", y = "Temperature (deg C)", title = "CDEC Water Temperature at Feather River", caption = "CDEC")
```

### USGS
```{r}
# Using https://flowwest.shinyapps.io/jpe-eda-app/ to find temperature gage
# Using mapper to check if temp data is available for the site https://maps.waterdata.usgs.gov/mapper/index.html

# GRL_USGS <- readNWISdv(11407000, "00010") # parameter code 00010: water temperature
# write.csv(GRL_USGS,"GRL_USGS.csv", row.names = FALSE)

# Read created CSV
GRL_USGS <- read_csv("GRL_USGS.csv")
GRL_USGS
```

USGS does not provide temperature data for Feather River. This was confirmed with mapper tool accessed from waterdata.usgs.gov.

```{r}
# write_rds(GRL_hourly_temps, "../../data-raw/standard-format-data-prep/temp_data/feather_temp.rds")
```

## Mill Creek
### CDEC
```{r}

cdec_datasets("MLM") 

#MLM_CDEC <- cdec_query(station = "MLM", dur_code = "H", sensor_num = "25", start_date = "1996-01-01")
#rite.csv(MLM_CDEC,"MLM_CDEC.csv", row.names = FALSE)

# Read created CSV
MLM_CDEC <- read_csv("MLM_CDEC.csv")

MLM_hourly_temps <- MLM_CDEC %>%
  mutate(date = as_date(datetime),
         time = as_hms(datetime),
         temp_degC = fahrenheit.to.celsius(parameter_value, round = 1)) %>%
  select(date,time,temp_degC)

# Date Ranges
tail(MLM_hourly_temps$date, n = 1)
head(MLM_hourly_temps$date, n = 1)

# Plot DCV
ggplot(MLM_hourly_temps, aes(x = date)) +
  geom_line(aes(y = temp_degC), color = "darkred") +
  labs(x = "Year", y = "Temperature (deg C)", title = "Temperature at Mill Creek", caption = "CDEC")
```
CDEC provides temperature data for Mill Creek from 1998-09-30 to 2022-05-27

### CDEC Outliers Removed
```{r}
# Plot without outliers
MLM_hourly_temps %>%
    filter(temp_degC < 37, temp_degC > -18) %>%
  ggplot(aes(x = date)) +
  geom_line(aes(y = temp_degC), color = "darkred") +
  labs(x = "Year",y = "Temperature (deg C)", title = "CDEC Water Temperature at Mill Creek", caption = "CDEC")
```

### USGS
```{r}
# Using https://flowwest.shinyapps.io/jpe-eda-app/ to find temperature gage
# Using mapper to check if temp data is available for the site https://maps.waterdata.usgs.gov/mapper/index.html

#MLM_USGS <- readNWISdv(11381500, "00010") # parameter code 00010: water temperature temperature
#write.csv(MLM_USGS,"MLM_USGS.csv", row.names = FALSE)

# Read created CSV
MLM_USGS <- read_csv("MLM_USGS.csv")

# Format to make tidier
MLM_daily_temps <- MLM_USGS %>%
  select(Date, temp_degC =  X_00010_00003) %>%
  filter(lubridate::year(Date) >= 1996) %>%
  as_tibble() %>% 
  rename(date = Date)

# Date Ranges
tail(MLM_daily_temps$date, n = 1)
head(MLM_daily_temps$date, n = 1)

# Plot DCV
ggplot(MLM_daily_temps, aes(x=date)) +
  geom_line(aes(y = temp_degC), color = "darkred") +
  labs(x = "Year",y = "Temperature (deg C)",title = "Temperature at Mill Creek", caption = "USGS")
```

USGS provides daily temperature daily for Mill Creek from 2016-10-01 to 2022-05-25

#### Mean Daily USGS vs Daily CDEC data
```{r}
# comparison of USGS vs CDEC
# Does one have more data?
# Does one have a finer scale?
MLM_combined = MLM_hourly_temps %>% 
  full_join(MLM_daily_temps, by = "date") %>% 
  rename("temp_degC.CDEC" = "temp_degC.x", "temp_degC.USGS" = "temp_degC.y")

MLM_combined %>% 
  group_by(date = date(date)) %>% 
  group_by(date) %>% 
  summarise(
    temp_CDEC = median(temp_degC.CDEC, na.rm = TRUE),
    temp_USGS = max(temp_degC.USGS, na.rm = TRUE)) %>% 
  ggplot(aes(x=date)) +
  geom_line(aes(y = temp_CDEC), color = "darkred") +
  geom_line(aes(y = temp_USGS), color = "steelblue", linetype = "twodash") +
  labs(y = "Temperature (deg C)", title = "Water Temperature at Mill Creek")

```

I would recommend using the CDEC data for Mill Creek due to the significant data gaps for USGS.

```{r}
# write_rds(MLM_hourly_temps, "../../data-raw/standard-format-data-prep/temp_data/mill_temp.rds")
```

#===============================================================================
## Yuba River
### CDEC
```{r}
cdec_datasets("MRY")
# CDEC doesnt not have temperature data
```
There is not CDEC data available for Yuba River.
### USGS
```{r}
# Using https://flowwest.shinyapps.io/jpe-eda-app/ to find temperature gage
# Using mapper to check if temp data is available for the site https://maps.waterdata.usgs.gov/mapper/index.html

MLM_USGS <- readNWISdv(11421000, "00010") # parameter code 00010: water temperature temperature
# No temp data
```

There is no USGS temperature data available for Yuba River.

## Sacramento River - Knights Landing
```{r}
cdec_datasets("WLK")

#WLK_CDEC <- cdec_query(station = "WLK", dur_code = "E", sensor_num = "25", start_date = "1995-01-01")
#write.csv(WLK_CDEC,"WLK_CDEC.csv", row.names = FALSE)

# Read created CSV
WLK_CDEC <- read_csv("WLK_CDEC.csv")

WLK_hourly_temps <- WLK_CDEC %>%
  mutate(date = as_date(datetime),
         time = as_hms(datetime),
         temp_degC = fahrenheit.to.celsius(parameter_value, round = 1)) %>%
  select(date,time,temp_degC)

# Date Ranges
tail(WLK_hourly_temps$date, n = 1)
head(WLK_hourly_temps$date, n = 1)

# Plot WLK
ggplot(WLK_hourly_temps, aes(x = date)) +
  geom_line(aes(y = temp_degC), color = "darkred") +
  labs(x = "Year", y = "Temperature (deg C)", title = "Temperature at Sacramento River- Knights Landing", caption = "CDEC")
```

CDEC provides temperature data for Sacramento River - Knights Landing from 2012-11-15 to 2022-06-16

### CDEC Outliers Removed
```{r}
# Plot without outliers
WLK_hourly_temps %>%
  filter(temp_degC < 37, temp_degC > -18) %>%
  ggplot(aes(x = date)) +
  geom_line(aes(y = temp_degC), color = "darkred") +
  labs(x = "Year", y = "Temperature (deg C)", title = "Temperature at Sacramento River- Knights Landing", caption = "CDEC")
```

### USGS
```{r}
# Using https://flowwest.shinyapps.io/jpe-eda-app/ to find temperature gage
# Using mapper to check if temp data is available for the site https://maps.waterdata.usgs.gov/mapper/index.html

#WLK_USGS <- readNWISdv(11390500, "00010") # parameter code 00010: water temperature temperature
#write.csv(WLK_USGS,"WLK_USGS.csv", row.names = FALSE)

# Read created CSV
WLK_USGS <- read_csv("WLK_USGS.csv")

# Format to make tidier
WLK_daily_temps <- WLK_USGS %>%
  select(Date, temp_degC =  X_00010_00003) %>%
  filter(lubridate::year(Date) >= 1995) %>%
  as_tibble() %>% 
  rename(date = Date)

# Date Ranges
tail(WLK_daily_temps$date, n = 1)
head(WLK_daily_temps$date, n = 1)

# Plot
ggplot(WLK_daily_temps, aes(x=date)) +
  geom_line(aes(y = temp_degC), color = "darkred") +
  labs(x = "Year",y = "Temperature (deg C)", title = "Temperature at Sacramento River- Knights Landing", caption = "USGS")
```
Temperature data for Sacramento River - Knights landing has data from 1995-01-01 to 2022-06-14, but we should explore further the signifcant data gap and identify that period.

### Data before Missing Data Gap
```{r}
### Identify date data starts to be missing
WLK_daily_temps %>%
  filter(date < "2004-01-01") %>%
  arrange(desc(date))
  # 1998-09-30

# data before missing data gap
WLK_daily_temps %>%
  filter(date < "1999-10-01") %>% 
  arrange(desc(date)) %>%
  ggplot(aes(x = date)) +
  geom_line(aes(y = temp_degC), color = "darkred") +
  labs(x = "Year", y = "Temperature (deg C)", title = "Temperature at Sacramento River- Knights Landing", caption = "USGS")
```
### Data after missing data gap
```{r}
### Identify date data starts to be missing
WLK_daily_temps %>%
  filter(date > "2015-01-01") %>%
  arrange(date)
  # 2016-10-01

# data after missing data gap
WLK_daily_temps %>%
  filter(date >= "2016-10-01") %>% 
  arrange(desc(date)) %>%
  ggplot(aes(x = date)) +
  geom_line(aes(y = temp_degC), color = "darkred") +
  labs(x = "Year", y ="Temperature (deg C)", title = "Temperature at Sacramento River- Knights Landing", caption = "USGS")
#
```
Temperature data for Sacramento River - Knights landing is missing significant data from the period of 1998-09-30 to 2016-09-31.

#### Mean Daily USGS vs Daily CDEC data
```{r}
WLK_combined = WLK_hourly_temps %>% 
  full_join(WLK_daily_temps, by = "date") %>% 
  rename("temp_degC.CDEC" = "temp_degC.x", "temp_degC.USGS" = "temp_degC.y")

WLK_combined %>% 
  group_by(date = date(date)) %>% 
  group_by(date) %>% 
  summarise(
    temp_CDEC = median(temp_degC.CDEC, na.rm = TRUE),
    temp_USGS = max(temp_degC.USGS, na.rm = TRUE)) %>% 
  ggplot(aes(x=date)) +
  geom_line(aes(y = temp_CDEC), color = "darkred") +
  geom_line(aes(y = temp_USGS), color = "steelblue", linetype =" twodash") +
  labs(y = "Temperature (deg C)", title = "Temperature at Sacramento River- Knights Landing", caption = "USGS")


```
#===============================================================================
## Sacramento River - Tisdale
### CDEC data

```{r}
cdec_datasets("TIS") 
```
CDEC and USSGS temperature data is available for Tisdale



















