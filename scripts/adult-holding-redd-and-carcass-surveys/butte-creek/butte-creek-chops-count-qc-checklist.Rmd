---
title: "butte-creek-carcass-chopcount-qc-checklist"
author: "Inigo Peng"
date: "10/21/2021"
output: rmarkdown::github_document
---
---
```{r include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
library(tidyverse)
library(lubridate)
library(googleCloudStorageR)
library(ggplot2)
library(scales)
library (RColorBrewer)
```
# BUtte Creek Carcass Survey Data  

## Description of Monitoring Data

**Timeframe:** 2014-2020


**Completeness of Record throughout timeframe:**  



**Sampling Location:** Various sampling locations on Butte Creek.

TODO: Upper survey?


**Data Contact:** [Jessica Nichols](mailto::Jessica.Nichols@Wildlife.ca.gov)


Additional Info:  
The carcass data came in 12 documents for each year. We identified the 'SurveyChops' and 'SurveyIndividuals' datasets as the documents with the most complete information and joined them for all of the years.

## Access Cloud Data

```{r, eval=FALSE}
# Run Sys.setenv() to specify GCS_AUTH_FILE and GCS_DEFAULT_BUCKET before running
# Open object from google cloud storage
# Set your authentication using gcs_auth
gcs_auth(json_file = Sys.getenv("GCS_AUTH_FILE"))
# Set global bucket 
gcs_global_bucket(bucket = Sys.getenv("GCS_DEFAULT_BUCKET"))
gcs_list_objects()

# git data and save as xlsx
read_from_cloud <- function(year){
  gcs_get_object(object_name = paste0("adult-holding-redd-and-carcass-surveys/butte-creek/data-raw/", year, "_SurveyChops.xlsx"),
               bucket = gcs_get_global_bucket(),
               saveToDisk = paste0(year,"_raw_surveychops.xlsx"),
               overwrite = TRUE)
  data <- readxl::read_excel(paste0(year,"_raw_surveychops.xlsx")) %>% 
    glimpse()
}

open_files <- function(year){
  data <- readxl::read_excel(paste0(year, "_raw_surveychops.xlsx"))
  return (data)
}
years <- c(2014, 2015, 2016, 2017, 2018, 2019, 2020)
# year <- 2020
raw_data <- purrr::map(years, read_from_cloud) %>%
  reduce(bind_rows)
raw_data <- purrr::map(years, open_files) %>% 
  reduce(bind_rows)
write_csv(raw_data, "raw_chops_data.csv")
```

Read in data from google cloud, glimpse raw data and domain description sheet: 
```{r}
# read in data to clean 
raw_chops_data <- read_csv("raw_chops_data.csv") %>% glimpse
```

## Data Transformations


```{r}
cleaner_data<- raw_chops_data %>%
  janitor::clean_names() %>%
  select(-'week', -'year', -'location_cd', -'disposition', -'condition', -'size_class',
         -'sex', - 'species_code', - 'survey') %>% #could extract week and year from date;all location is the same (upper_cd); all disposition is chopped', all condition decayed, all size class not recorded, all sex is not recorded or unknown, all species_code is spring run chinook
  mutate(date = as.Date(date)) %>% 
  glimpse()
```
## Explore `date`
```{r}
cleaner_data%>%
  ggplot(aes(x = date)) +
  geom_histogram(binwidth = 7, position = 'stack', color = "black") +
  labs(title = "Value Counts For Survey Season Dates")+
  theme(legend.text = element_text(size = 8))
```

```{r}
summary(cleaner_data$date)
```

**NA and Unknown Values**  

*  `r round(sum(is.na(cleaner_data$date))/nrow(cleaner_data), 3)*100` % of values in the `date` column are NA.

## Explore Categorical Variables

```{r}
cleaner_data %>% 
  select_if(is.character) %>% colnames()
```
### Variable:`section_cd`

TODO: need section_cd lookup
```{r}
table(cleaner_data$section_cd)
```
**NA and Unknown Values**  

*  `r round(sum(is.na(cleaner_data$section_cd))/nrow(cleaner_data), 3)*100` % of values in the `section_cd` column are NA.

### Variable:`way_pt`

```{r}
table(cleaner_data$way_pt)
```
```{r}
cleaner_data <- cleaner_data %>%
  mutate(way_pt = set_names(toupper(way_pt))) %>% 
  mutate(way_pt = case_when(
    way_pt == 'N/A' ~ 'NA_character_',
    way_pt == 'N/R' ~ 'NA_character_', 
    TRUE ~ as.character(way_pt)
  ))
table(cleaner_data$way_pt)
```

**NA and Unknown Values**  

*  `r round(sum(is.na(cleaner_data$way_pt))/nrow(cleaner_data), 3)*100` % of values in the `way_pt` column are NA.

### Variable:`ad_fin_clip`

```{r}
table(cleaner_data$ad_fin_clip)
cleaner_data <- cleaner_data %>% 
  mutate(ad_fin_clip = set_names(tolower(ad_fin_clip)))
```

## Explore Numerical Variables

```{r}
cleaner_data %>% 
  select_if(is.numeric) %>% colnames()
```

### Variable:`chop_count`
```{r}
colourCount = length(unique(years))
getPalette = colorRampPalette(brewer.pal(12, "Paired"))

cleaner_data %>% 
  group_by(date) %>% 
  mutate(total_daily_count = sum(chop_count)) %>% 
  ungroup() %>% 
  mutate(water_year = if_else(month(date)%in% 10:12, year(date)+1, year(date))) %>% 
  glimpse() %>% 
  mutate(years = as.factor(year(date)),
         fake_year= if_else(month(date) %in% 10:12, 1900, 1901),
         fake_date = as.Date(paste0(fake_year, "-", month(date), "-", day(date)))) %>% 
  ggplot(aes(x = fake_date, y = chop_count, color = years))+
  scale_color_manual(values = getPalette(colourCount))+
  theme_minimal()+
  scale_x_date(labels = date_format("%b"), limits = c(as.Date("1900-10-01"), as.Date("1900-11-01")), date_breaks = "1 month")+
  theme(text = element_text(size = 10),
        axis.text.x = element_text(angle = 90))+
  # facet_wrap(~water_year, scales = "free")+
  geom_point()+
  labs(title = "Total Daily Chops Count 2014 - 2021",
       x = 'Date',
       y = 'Total Chop Count')
```

```{r}
summary(cleaner_data$chop_count)
```
**NA and Unknown Values**  

*  `r round(sum(is.na(cleaner_data$chop_count))/nrow(cleaner_data), 3)*100` % of values in the `chop_count` column are NA.

