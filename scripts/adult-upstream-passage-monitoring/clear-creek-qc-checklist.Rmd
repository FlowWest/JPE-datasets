---
title: "Clear Creek Adult Upstream Video Data QC Checklist"
author: "Erin Cain"
date: "9/29/2021"
output: rmarkdown::github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, fig.width=15, fig.height=10)
library(tidyverse)
library(lubridate)
library(googleCloudStorageR)
library(ggplot2)
library(scales)
```

# Clear Creek Adult Upstream Video Data 

## Description of Monitoring Data

**Data type** Raw passage counts

**Timeframe:** 2013-2020

**Video Season:** TODO 

**Completeness of Record throughout timeframe:** 
Data are not padded - missing data indicate a period where footage was not collected by USFWS
(However we are filtering for spring run so it is also possible that footage was taken but no spring run were found)

* TODO investigate/talk about outages, is a 0 a real zero or explained by other factors

**Sampling Location:**
Located at the mouth of clear creek

**Data Contact:** [Sam Provins](mailto:samuel_provins@fws.gov) 

Additional information describing this monitoring data is available in the [Adult Spring Run Chinook Salmon Monitoring in Clear Creek Report](https://www.fws.gov/redbluff/CC%20BC/Clear%20Creek%20Monitoring%20Final%20Reports/2013-2018%20Clear%20Creek%20Adult%20Spring-run%20Chinook%20Salmon%20Monitoring.pdf) prepared by USFWS.

## Access Cloud Data

```{r, eval=FALSE}
# Run Sys.setenv() to specify GCS_AUTH_FILE and GCS_DEFAULT_BUCKET before running 
# getwd()
# Open object from google cloud storage
# Set your authentication using gcs_auth
gcs_auth(json_file = Sys.getenv("GCS_AUTH_FILE"))
# Set global bucket 
gcs_global_bucket(bucket = Sys.getenv("GCS_DEFAULT_BUCKET"))

# git data and save as xlsx
gcs_get_object(object_name = 
                 "adult-upstream-passage-monitoring/clear-creek/data-raw/ClearCreekVideoWeir_AdultRecruitment_2013-2020.xlsx",
               bucket = gcs_get_global_bucket(),
               saveToDisk = "raw_clear_creek_passage_data.xlsx",
               overwrite = TRUE)
```

Read in data from google cloud, glimpse raw data and domain description sheet: 
```{r}
# read in data to clean 
sheets <- readxl::excel_sheets("raw_clear_creek_passage_data.xlsx")
domain_description <- readxl::read_excel("raw_clear_creek_passage_data.xlsx", 
                                         sheet = "Domain Description") 
domain_description %>% head(10)
raw_video_data <- readxl::read_excel("raw_clear_creek_passage_data.xlsx", 
                                     sheet = "ClearCreekVideoWeir_AdultRecrui",
                                     col_types = c("numeric", "date", "date", 
                                                   "text", "text", "numeric", 
                                                   "numeric", "date", "text",
                                                   "text", "text", "text", 
                                                   "text", "text")) %>% 
  glimpse()
```

## Data transformations

We cleaned up the column names, filtered to only show Spring Run Chinook data, and removed an unneeded and redundant columns. 

```{r}
cleaner_video_data <- raw_video_data %>% 
  set_names(tolower(colnames(raw_video_data))) %>%
  mutate(date = as.Date(date),
         time_block = hms::as_hms(time_block),
         time_passed = hms::as_hms(time_passed)) %>%
  filter(species == "CHN", run == "SR") %>%
  select(-stt_size, -video_year, -species, -run) %>% 
  glimpse() 
  
```

## Explore Numeric Variables: {.tabset}

```{r}
cleaner_video_data %>% select_if(is.numeric) %>% colnames()
```

### Variable: `up`

**Plotting Passage Counts Moving Up over Period of Record**

```{r}
cleaner_video_data %>% ggplot(aes(x = date, y = up)) + 
  geom_col() + 
  facet_wrap(~year(date), scales = "free") + 
  scale_x_date(labels = date_format("%b"), date_breaks = "1 month") + 
  theme_minimal() + 
  theme(text = element_text(size = 23)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```
```{r}
# Boxplots of daily counts by year
cleaner_video_data %>% group_by(date) %>%
  summarise(daily_count_upstream = sum(up)) %>%
  mutate(year = as.factor(year(date))) %>% 
  ggplot(aes(x = year, y = daily_count_upstream)) + 
  geom_boxplot() + 
  theme_minimal() +
  theme(text = element_text(size = 23)) 
```

**Numeric Summary of Passage Counts Moving Up over Period of Record**

```{r}
# Table with summary statistics
summary(cleaner_video_data$up)

# daily numeric summary 
cleaner_video_data %>% group_by(date) %>%
  summarise(count = sum(up, na.rm = T)) %>%
  pull(count) %>%
  summary()
```

**NA and Unknown Values**

* `r round(sum(is.na(cleaner_video_data$up))/nrow(cleaner_video_data), 3)` % of values in the `up` column are NA. However, there are clearly gaps in data. More investigation needs to be done to see if 0 is a real 0 or if it can be explained by other factors (outages).


### Variable: `down` 

**Plotting Passage Counts Moving Down over Period of Record**
```{r}
cleaner_video_data %>% ggplot(aes(x = date, y = down)) + 
  geom_col() + 
  facet_wrap(~year(date), scales = "free") + 
  scale_x_date(labels = date_format("%b"), date_breaks = "1 month") + 
  theme_minimal() + 
  theme(text = element_text(size = 23)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```
```{r}
cleaner_video_data %>% group_by(date) %>%
  summarise(daily_count_downstream = sum(down)) %>%
  mutate(year = as.factor(year(date))) %>% 
  ggplot(aes(x = year, y = daily_count_downstream)) + 
  geom_boxplot() + 
  theme_minimal() +
  theme(text = element_text(size = 23)) 
```

**Numeric Summary of Passage Counts Moving Down over Period of Record**

```{r}
# Table with summary statistics 
summary(cleaner_video_data$down)

# Daily numeric summary of passage data
cleaner_video_data %>% group_by(date) %>%
  summarise(count = sum(down, na.rm = T)) %>%
  pull(count) %>%
  summary()
```

**NA and Unknown Values**

* `r round(sum(is.na(cleaner_video_data$down))/nrow(cleaner_video_data), 3)` % of values in the `up` column are NA. 

## Explore Categorical variables: {.tabset}

```{r}
# Filter for coltypes that are characters
cleaner_video_data %>% select_if(is.character) %>% colnames()
```

### Variable: `viewing_condition`
```{r}
table(cleaner_video_data$viewing_condition) 
```
**Create lookup rda for viewing condition encoding:** 
```{r}
# View description of domain for viewing condition 
description <- domain_description[which(domain_description$Domain == "VIEWING CONDITION"), ]$Description
clear_passage_viewing_condition <- 0:3
names(clear_passage_viewing_condition) <- c(
  "Normal (good visability, clear water, all equiptment working, no obstructions)", 
  "Readable (lower confidence due to turbidity or partial loss of video equiptment)", 
  "Not Readable (high turbidity or equiptment failure)",
  "Weir is flooded")

write_rds(clear_passage_viewing_condition, "../../data/clear_passage_viewing_condition.rds")

tibble(code = clear_passage_viewing_condition, 
       definitions = names(clear_passage_viewing_condition))
```

**NA and Unknown Values**
  
* `r round(sum(is.na(cleaner_video_data$viewing_condition))/nrow(cleaner_video_data), 3)` % of values in the `viewing_condition` column are NA. 
* `r round(sum(cleaner_video_data$viewing_condition == "2")/nrow(cleaner_video_data), 3)` % of values in the `viewing_condition` column are considered Not Readable because of high turbidity or equipment failure. 

### Variable: `adipose`
```{r}
table(cleaner_video_data$adipose) 
description <- domain_description[which(domain_description$Domain == "ADIPOSE"), ]$Description
```
Fix inconsistencies with spelling, capitalization, and abbreviations.  

```{r}
# Fix yes/no/unknown
cleaner_video_data$adipose = tolower(if_else(cleaner_video_data$adipose == "UNK", "unknown", cleaner_video_data$adipose))
```
  
**NA or Unknown Values**

* `r round(sum(is.na(cleaner_video_data$adipose))/nrow(cleaner_video_data), 3)` % of values in the `adipose` column are NA. 
* `r round(sum(cleaner_video_data$adipose == "unknown", na.rm = T)/nrow(cleaner_video_data), 3)` % of values in the `adipose` column are`unknown`.


### Variable: `sex`
```{r}
table(cleaner_video_data$sex) 
```

Fix inconsistencies with spelling, capitalization, and abbreviations.  

```{r}
# Fix yes/no/unknown
cleaner_video_data$sex = tolower(if_else(cleaner_video_data$sex == "UNK", "unknown", cleaner_video_data$sex))
```

**NA or Unknown Values**

* `r round(sum(is.na(cleaner_video_data$sex))/nrow(cleaner_video_data), 3)` % of values in the `sex` column are NA.
* `r round(sum(cleaner_video_data$sex == "unknown", na.rm = T)/nrow(cleaner_video_data), 3)` % of values in the `sex` column are`unknown`.

### Variable: `spawning_condition`
Describes fish condition as it relates to spawning. 
```{r}
table(cleaner_video_data$spawning_condition)
```
**Create lookup rda for spawning condition encoding:** 
```{r}
# View description of domain for viewing condition 
description <- domain_description[which(domain_description$Domain == "SPAWNING CONDITION"), ]$Description
clear_passage_spawning_condition <- c(1:5)
names(clear_passage_spawning_condition) <- c(
  "Energetic; bright or silvery; no spawning coloration or developed secondary sex characteristics.",
  "Energetic, can tell sex from secondary characteristics (kype) silvery or bright coloration but may have some hint of spawning colors.",
  "Spawning colors, defined kype, some tail wear or small amounts of fungus.",
  "Fungus, lethargic, wandering; “ Zombie fish”. Significant tail wear in females to indicate the spawning process has already occurred.",
  "Unable to make distinction.")

write_rds(clear_passage_spawning_condition, "../../data/clear_passage_spawning_condition.rds")

tibble(code = clear_passage_spawning_condition, 
       definitions = names(clear_passage_spawning_condition))
```

**NA or Unknown Values**

* `r round(sum(is.na(cleaner_video_data$spawning_condition))/nrow(cleaner_video_data), 3)` % of values in the `spawning_condition` column are NA. 

* `r round(sum(cleaner_video_data$spawning_condition == "5", na.rm = T)/nrow(cleaner_video_data), 3)` % of values in the `spawning_condition` column are considered Unknown.

### Variable: `jack_size`
Whether or not the total width of Jack plate is 22".
```{r}
table(cleaner_video_data$jack_size) 
description <- domain_description[which(domain_description$Domain == "JACKSIZE"), ]$Description
```
Fix inconsistencies with spelling, capitalization, and abbreviations.  

```{r}
# Fix yes/no/unknown
cleaner_video_data$jack_size = tolower(if_else(cleaner_video_data$jack_size == "UNK", "unknown", cleaner_video_data$jack_size))
```

**NA or Unknown Values**
  
* `r round(sum(is.na(cleaner_video_data$jack_size))/nrow(cleaner_video_data), 3)` % of values in the `jack_size` column are NA.
* `r round(sum(cleaner_video_data$jack_size == "unknown", na.rm = T)/nrow(cleaner_video_data), 3)` % of values in the `jack_size` column are`unknown`.


```{r}
clear_passage <- cleaner_video_data %>% 
  glimpse()
```

### Save cleaned data back to google cloud 

```{r, eval=FALSE}
f <- function(input, output) write_csv(input, file = output)

gcs_upload(clear_passage,
           object_function = f,
           type = "csv",
           name = "adult-upstream-passage-monitoring/clear-creek/data/clear_passage.csv")
```

