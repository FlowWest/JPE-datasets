---
title: "Clear Creek Adult Upstream Video Data QC Checklist"
author: "Erin Cain"
date: "9/29/2021"
output: rmarkdown::github_document
---

```{r setup, include=FALSE, fig.width=15, fig.height=10}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(googleCloudStorageR)
library(ggplot2)
library(scales)
```

## Clear Creek Adult Upstream Video Data 
```{r, include = FALSE}
# getwd()
# Open object from google cloud storage
# Set your authentication using gcs_auth
gcs_auth(json_file = Sys.getenv("GCS_AUTH_FILE"))
# Set global bucket 
gcs_global_bucket(bucket = Sys.getenv("GCS_DEFAULT_BUCKET"))

# git data and save as xlsx
gcs_get_object(object_name = "adult-upstream-passage-monitoring/clear-creek/ClearCreekVideoWeir_AdultRecruitment_2013-2020.xlsx",
               bucket = gcs_get_global_bucket(),
               saveToDisk = "test-data.xlsx",
               overwrite = TRUE)
```

Read in data from google cloud, glimpse raw data and domain description sheet: 
```{r}
# read in data to clean 
sheets <- readxl::excel_sheets("test-data.xlsx")
domain_description <- readxl::read_excel("test-data.xlsx", sheet = "Domain Description") 
domain_description %>% head(10)
raw_video_data <- readxl::read_excel("test-data.xlsx", sheet = "ClearCreekVideoWeir_AdultRecrui") %>% glimpse()
```

## Checklist

* Update column names to snake case/remove any funky spacing
* Check column types to ensure all data is stored as desired:
  * Numerical data - `<dbl>` or `<int>` 
  * Character data - `<str>` or `<chr>`
  * Date - <datetime> or `<date>` or `<time>`
* remove any redundant columns

```{r}
cleaner_video_data <- raw_video_data %>% 
  set_names(tolower(colnames(raw_video_data))) %>%
  mutate(date = as.Date(date),
         time_block = hms::as_hms(time_block)) %>% # TODO fix time_passed 
  filter(species == "CHN", run == "SR") %>%
  select(-stt_size) %>% 
  glimpse() 
```
* Transform into tidy format, check that:
  * Each variable has its own column 
  * Each observation has its own row 
  * Each value has its own cell
```{r}
# Each variable has its own column, each observation has its own row (an observation is count in time period), and each value has its own cell 
```

Visualize Data to quickly determine if it looks reasonable: 

* Plot numerical values
* table on categorical columns

### Plots visualizing numeric variables: {.tabset}

#### `up`
```{r}
cleaner_video_data %>% ggplot(aes(x = date, y = up)) + 
  geom_col() + 
  facet_wrap(~year(date), scales = "free_x") + 
  scale_x_date(labels = date_format("%b"), date_breaks = "1 month") + 
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

* check for missing values, convert -9999 or other placeholders to NA 
  * summarize quantity of missing values to determine quality and completeness of data
  
We know from the plot above that there are no -9999 values

`r round(sum(is.na(cleaner_video_data$up))/nrow(cleaner_video_data), 3)` % of values in the `up` column are NA. 

#### `down` 
```{r}
cleaner_video_data %>% ggplot(aes(x = date, y = down)) + 
  geom_col() + 
  facet_wrap(~year(date), scales = "free_x") + 
  scale_x_date(labels = date_format("%b"), date_breaks = "1 month") + 
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

* check for missing values, convert -9999 or other placeholders to NA 
  * summarize quantity of missing values to determine quality and completeness of data
  
We know from the plot above that there are no -9999 values

`r round(sum(is.na(cleaner_video_data$down))/nrow(cleaner_video_data), 3)` % of values in the `up` column are NA. 

### Tables describing categorical variables: {.tabset}

#### `viewing_condition`
```{r}
table(cleaner_video_data$viewing_condition)
domain_description[which(domain_description$Domain == "VIEWING CONDITION"), ]$Description
```

* check for missing values, convert -9999 or other placeholders to NA 
  * summarize quantity of missing values to determine quality and completeness of data
  
`r round(sum(is.na(cleaner_video_data$viewing_condition))/nrow(cleaner_video_data), 3)` % of values in the `viewing_condition` column are NA. 

* Within a categorical column check that capitalization is consistent 
* Within a categorical column check that values are consistent, no typos
```{r}
# Looks fine
```

#### `adipose`
```{r}
table(cleaner_video_data$adipose)
domain_description[which(domain_description$Domain == "ADIPOSE"), ]$Description
```

* check for missing values, convert -9999 or other placeholders to NA 
  * summarize quantity of missing values to determine quality and completeness of data
  
`r round(sum(is.na(cleaner_video_data$adipose))/nrow(cleaner_video_data), 3)` % of values in the `viewing_condition` column are NA. 

* Within a categorical column check that capitalization is consistent 
* Within a categorical column check that values are consistent, no typos
```{r}
cleaner_video_data <- cleaner_video_data %>% 
  mutate(adipose = tolower(adipose)) 
```

#### `sex`
```{r}
table(cleaner_video_data$sex)
domain_description[which(domain_description$Domain == "SEX"), ]$Description
```

* check for missing values, convert -9999 or other placeholders to NA 
  * summarize quantity of missing values to determine quality and completeness of data
  
`r round(sum(is.na(cleaner_video_data$sex))/nrow(cleaner_video_data), 3)` % of values in the `viewing_condition` column are NA.   

* Within a categorical column check that capitalization is consistent 
* Within a categorical column check that values are consistent, no typos
```{r}
cleaner_video_data <- cleaner_video_data %>% 
  mutate(sex = tolower(if_else(sex == "UNK", "UNKNOWN", sex))) 
```

#### `spawning_condition`
```{r}
table(cleaner_video_data$spawning_condition)
domain_description[which(domain_description$Domain == "SPAWNING CONDITION"), ]$Description
```

* check for missing values, convert -9999 or other placeholders to NA 
  * summarize quantity of missing values to determine quality and completeness of data
  
`r round(sum(is.na(cleaner_video_data$spawning_condition))/nrow(cleaner_video_data), 3)` % of values in the `viewing_condition` column are NA. 

* Within a categorical column check that capitalization is consistent 
* Within a categorical column check that values are consistent, no typos
```{r}
# Looks good
```

#### `jack_size`
```{r}
table(cleaner_video_data$jack_size)
domain_description[which(domain_description$Domain == "JACKSIZE"), ]$Description
```

* check for missing values, convert -9999 or other placeholders to NA 
  * summarize quantity of missing values to determine quality and completeness of data
  
`r round(sum(is.na(cleaner_video_data$jack_size))/nrow(cleaner_video_data), 3)` % of values in the `viewing_condition` column are NA. 

* Within a categorical column check that capitalization is consistent (ex: if a column describes methodology and has “Snorkel” and “snorkel” listed as options fix to make all into snake case “snorkel”)
* Within a categorical column check that values are consistent, no typos
```{r}
cleaner_video_data <- cleaner_video_data %>% 
  mutate(jack_size = tolower(if_else(jack_size == "UNK", "UNKNOWN", jack_size))) 
```

### Checklist cont. 

* Check for location information for every station (latitude and longitude for every sampling location

*TODO* Need to inquire for location of video monitoring station 

### Save cleaned data back to google cloud 

TODO 