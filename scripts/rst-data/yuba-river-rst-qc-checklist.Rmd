---
title: "yuba-river-rst-qc-checklist"
author: "Inigo Peng"
date: "10/11/2021"
output: rmarkdown::github_document
---
```{r setup, include=FALSE, fig.width=15, fig.height=10}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
library(tidyverse)
library(lubridate)
library(googleCloudStorageR)
library(ggplot2)
library(scales)
library(leaflet)
```
# Yuba River RST Data  

## Description of Monitoring Data

**Timeframe:** 2000-2008


**Completeness of Record throughout timeframe: **\

TODO


**Sampling Location:** Yuba River


**Data Contact:** [Robyn Bilski](Robyn.Bilski@Wildlife.ca.gov)


## Access Cloud Data

```{r, eval=FALSE}
# Run Sys.setenv() to specify GCS_AUTH_FILE and GCS_DEFAULT_BUCKET before running
# Open object from google cloud storage
# Set your authentication using gcs_auth
gcs_auth(json_file = Sys.getenv("GCS_AUTH_FILE"))
# Set global bucket 
gcs_global_bucket(bucket = Sys.getenv("GCS_DEFAULT_BUCKET"))
gcs_list_objects()
# git data and save as xlsx
gcs_get_object(object_name = "rst/yuba-river/data-raw/yuba-river-rst-data.xlsx",
               bucket = gcs_get_global_bucket(),
               saveToDisk = "yuba-rst.xlsx",
               overwrite = TRUE)


```

Read in data from google cloud, glimpse raw data:
```{r}
raw_data = readxl::read_excel('yuba-rst.xlsx', col_types = c("text",
                                                             "date",
                                                             "date",
                                                             "text",
                                                             "numeric",
                                                             "numeric",
                                                             "numeric",
                                                             "text",
                                                             "numeric",
                                                             "numeric",
                                                             "text",
                                                             "numeric",
                                                             "numeric",
                                                             "text",
                                                             "text",
                                                             "text",
                                                             "text",
                                                             "numeric",
                                                             "numeric",
                                                             "text",
                                                             "numeric",
                                                             'text',
                                                             'numeric',
                                                             'numeric'))
glimpse(raw_data)
```

## Data Transformation

```{r}
cleaner_data <- raw_data %>% 
  select(-c('Catch_Entry_SampleRowID', 'CatchRowID')) %>% 
  rename('id' = Sample_Entry_SampleRowID,
         'date'= SampleDate,
         'time' = SampleTime,
         'method' = MethodCode,
         'water_temp' = WaterTemperature,
         'turbidity' = Turbidity,
         'water_velocity' = WaterVelocity,
         'trap_status' = TrapStatus,
         'trap_revolutions' = TrapRevolutions,
         'trap_revolutions2' = TrapRevolutions2,
         'rpms_before' = RPMsBefore,
         'rpms_after' = RPMsAfter,
         'organism_code' = OrganismCode,
         'fork_length' = ForkLength,
         'stage_code' = StageCode
         ) %>%
  mutate(time = hms::as_hms(time)) %>%
  filter(organism_code == 'CHN', rm.na = TRUE) %>% 
  glimpse()
```
```{r}
cleaner_data <- cleaner_data %>% 
  set_names(tolower(colnames(cleaner_data))) %>% 
  glimpse()
```

## Explore Numeric Variables

```{r}
cleaner_data %>% 
  select_if(is.numeric) %>% colnames()
```

### Variable:`water_temp`
#TODO: figure out what's happenign with the high temperature
#note: 2000 - fst had lower temperature (15s) while rst had high temp (60s) on the same day

```{r}
cleaner_data %>% 
  group_by(date) %>%
  mutate(avg_temp = mean(water_temp, na.rm = T)) %>%
  ungroup() %>% 
  mutate(year = as.factor(year(date)),
         fake_year = if_else(month(date) %in% 10:12, 1900, 1901),
         fake_date = as.Date(paste0(fake_year,"-", month(date), "-", day(date)))) %>% 
  ggplot(aes(x = fake_date, y = avg_temp, color = year)) + 
  geom_point(alpha = .25) + 
  scale_x_date(labels = date_format("%b"), date_breaks = "1 month") + 
  theme_minimal() + 
  theme(text = element_text(size = 15),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        legend.position = "none") + 
  labs(title = "Daily Water Temperature (colored by year)",
       y = "Average daily temp", 
       x = "Date")  
```
```{r}
cleaner_data %>% 
  mutate(year = as.factor(year(date))) %>%
  ggplot(aes(x = water_temp, y = year)) + 
  geom_boxplot() + 
  theme_minimal() +
  labs(title = "Water Temperature summarized by year",
       x = "Water Temperature C") + 
  theme(text = element_text(size = 15),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
```

**Numeric Summary of water_temp From 1999 to 2009**

```{r}
summary(cleaner_data$water_temp)
```

**NA and Unknown Values**  

* `r round(sum(is.na(cleaner_data$'water_temp'))/nrow(cleaner_data), 3)*100` % of values in the `water_temp` column are NA.


```{r}
summary(cleaner_data$water_temp)
```


### Variable:`turbidity`
```{r}
cleaner_data %>% 
  group_by(date) %>%
  mutate(avg_turb = mean(turbidity, na.rm = T)) %>%
  ungroup() %>% 
  mutate(year = as.factor(year(date)),
         fake_year = if_else(month(date) %in% 10:12, 1900, 1901),
         fake_date = as.Date(paste0(fake_year,"-", month(date), "-", day(date)))) %>% 
  ggplot(aes(x = fake_date, y = avg_turb, color = year)) + 
  geom_point(alpha = .25) + 
  scale_x_date(labels = date_format("%b"), date_breaks = "1 month") + 
  theme_minimal() + 
  theme(text = element_text(size = 15),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        legend.position = "none") + 
  labs(title = "Daily Water Turbidity (colored by year)",
       y = "Average daily turbdity", 
       x = "Date")  
```
```{r}
cleaner_data %>% 
  mutate(year = as.factor(year(date))) %>%
  ggplot(aes(x = turbidity, y = year)) + 
  geom_boxplot() + 
  theme_minimal() +
  labs(title = "Turbdity summarized by year",
       x = "Turbidity") + 
  theme(text = element_text(size = 15),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
```

**Numeric Summary of turbidity 1999 to 2009**

```{r}
summary(cleaner_data$turbidity)
```

**NA and Unknown Values**  

* `r round(sum(is.na(cleaner_data$'turbidity'))/nrow(cleaner_data), 3)*100` % of values in the `turbidity` column are NA.

### Variable:`water_velocity`
## TODO: 1999 has 1 value? 

```{r}
cleaner_data %>% 
  group_by(date) %>%
  mutate(avg_velocity = mean(water_velocity, na.rm = T)) %>%
  ungroup() %>% 
  mutate(year = as.factor(year(date)),
         fake_year = if_else(month(date) %in% 10:12, 1900, 1901),
         fake_date = as.Date(paste0(fake_year,"-", month(date), "-", day(date)))) %>% 
  ggplot(aes(x = fake_date, y = avg_velocity, color = year)) + 
  geom_point(alpha = .25) + 
  scale_x_date(labels = date_format("%b"), date_breaks = "1 month") + 
  theme_minimal() + 
  theme(text = element_text(size = 15),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        legend.position = "none") + 
  labs(title = "Daily Water Velocity (colored by year)",
       y = "Average daily velocity", 
       x = "Date")  
```
```{r}
cleaner_data %>% 
  mutate(year = as.factor(year(date))) %>%
  ggplot(aes(x = water_velocity, y = year)) + 
  geom_boxplot() + 
  theme_minimal() +
  labs(title = "Water velocity summarized by year",
       x = "Water Velocity") + 
  theme(text = element_text(size = 15),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
```

**Numeric Summary of water_velocity 1999 to 2009**

```{r}
summary(cleaner_data$water_velocity)
```

**NA and Unknown Values**  

* `r round(sum(is.na(cleaner_data$'water_velocity'))/nrow(cleaner_data), 3)*100` % of values in the `water_velocity` column are NA.

### Variable:`trap_revolutions`
```{r}
#Filter out significant high outliers (revolution > 10,000 )
cleaner_data %>% 
  ggplot(aes(x=trap_revolutions))+
  geom_histogram(binwidth = 1000)+
  labs(title = "Trap Revolutions Distribution")
```



```{r}
#Filter out significant significant higher values (277 points at revolution between 112178 rpms and 890793 rpms )
cleaner_data %>% 
  filter(trap_revolutions < 100000) %>% 
  ggplot(aes(x=trap_revolutions))+
  geom_histogram(binwidth = 1000)+
  labs(title = "Trap Revolutions Distribution")
```
**Numeric Summary of trap_revolutions 1999 to 2009**
```{r}
summary(cleaner_data$trap_revolutions)
```

**NA and Unknown Values**  

* `r round(sum(is.na(cleaner_data$'trap_revolutions'))/nrow(cleaner_data), 3)*100` % of values in the `trap_revolutions` column are NA.

### Variable:`trap_revolutions2`
```{r}
#Filter out significant significant higher values (220 points at revolution between 112178 rpms and 890793 rpms )
cleaner_data %>% 
  filter(trap_revolutions2 < 100000) %>%
  ggplot(aes(x=trap_revolutions2))+
  geom_histogram(binwidth = 1000)+
  labs(title = "Trap Revolutions Distribution")
```

**Numeric Summary of trap_revolutions2 1999 to 2009**
```{r}
summary(cleaner_data$trap_revolutions2)
```

**NA and Unknown Values**  

* `r round(sum(is.na(cleaner_data$'trap_revolutions2'))/nrow(cleaner_data), 3)*100` % of values in the `trap_revolutions2` column are NA.

### Variable:`rpms_before`

```{r}
cleaner_data %>% 
  ggplot(aes(x = rpms_before, y = location)) + 
  geom_boxplot() + 
  theme_minimal() +
  labs(title = "RPMS Before summarized by locations",
       x = "RPMs Before") + 
  theme(text = element_text(size = 15),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
```


**Numeric Summary of rpms_before 1999 to 2009**
```{r}
summary(cleaner_data$rpms_before)
```
**NA and Unknown Values**  

* `r round(sum(is.na(cleaner_data$'rpms_before'))/nrow(cleaner_data), 3)*100` % of values in the `rpms_before` column are NA.



### Variable:`rpms_after`

```{r}
cleaner_data %>% 
  ggplot(aes(x = rpms_after, y = location)) + 
  geom_boxplot() + 
  theme_minimal() +
  labs(title = "RPMS After summarized by locations",
       x = "RPMs After") + 
  theme(text = element_text(size = 15),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
```
```{r}
cleaner_data %>% 
  filter(rpms_after < 50) %>% #filter out 149 points that had significantly higher value-66 points at 50 rpm, 83 points at 1877 rpm (TODO)
  ggplot(aes(x = rpms_after, y = location)) + 
  geom_boxplot() + 
  theme_minimal() +
  labs(title = "RPMS After summarized by locations",
       x = "RPMs After") + 
  theme(text = element_text(size = 15),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
```

**Numeric Summary of rpms_after 1999 to 2009**
```{r}
summary(cleaner_data$rpms_after)
```
**NA and Unknown Values**  

* `r round(sum(is.na(cleaner_data$'rpms_after'))/nrow(cleaner_data), 3)*100` % of values in the `rpms_after` column are NA.


### Variable:`fork_length`
```{r}
#TODO: decide on filter for outlier values > 110 (137 points)
#TODO: one point at 723 length
cleaner_data %>% 
  ggplot(aes(x=fork_length))+
  # geom_histogram()
  geom_histogram(breaks = seq(0,150, by =2))+
  # scale_x_continuous(breaks=seq(0, 110, by=10)) +
  labs(title = "Fork Length Distribution")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust =1 ))
```
```{r}
# TODO: one outlier from 2001
cleaner_data %>% 
  mutate(year = as.factor(year(date))) %>%
  ggplot(aes(x = fork_length, y = year)) + 
  geom_boxplot() + 
  theme_minimal() +
  labs(title = "Fork length summarized by year",
       x = "Fork Length") + 
  theme(text = element_text(size = 15),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
```
```{r}
#TODO Add graph fork length by lifestage
```

**Numeric Summary of fork_length from 1999 to 2009**
```{r}
summary(cleaner_data$fork_length)
```
**NA and Unknown Values**  

* `r round(sum(is.na(cleaner_data$'fork_length'))/nrow(cleaner_data), 3)*100` % of values in the `fork_length` column are NA.

### Variable:`weight`
```{r}
#
cleaner_data %>% 
  filter(weight<50) %>% 
  ggplot(aes(x=weight))+
  geom_histogram(breaks = seq(0,10, by =0.2))+
  scale_x_continuous(breaks=seq(0, 10, by=1)) +
  labs(title = "Weight Distribution")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust =1 ))
```
```{r}
#TODO: weight by lifestage
```

**Numeric Summary of weight from 1999 to 2009**
```{r}
summary(cleaner_data$weight)
```
**NA and Unknown Values**  

* `r round(sum(is.na(cleaner_data$'weight'))/nrow(cleaner_data), 3)*100` % of values in the `weight` column are NA.

### Variable:`count`

```{r}
cleaner_data %>% 
  ggplot(aes(x = as.Date(date), y = count)) + 
  geom_col()+ 
  facet_wrap(~year(date), scales = "free") + 
  scale_x_date(labels = date_format("%b"), date_breaks = "1 month")+
  theme_minimal() +
  theme(axis.text.x = element_text(size = 8,angle = 90, vjust = 0.5, hjust=0.1)) +
  theme(axis.text.y = element_text(size = 8))+
  labs(title = "Salmon Count Over the Years",
       x = "Date")
```
```{r}
cleaner_data %>% 
  mutate(water_year = ifelse(month(date) %in% 10:12, year(date) + 1, year(date))) %>% 
  mutate(year = as.factor(year(date)),
         fake_year = if_else(month(date) %in% 10:12, 1900, 1901),
         fake_date = as.Date(paste0(fake_year,"-", month(date), "-", day(date)))) %>%
  filter(water_year < 2010) %>%
  group_by(date) %>%
  mutate(total_daily_catch = sum(count)) %>%
  ungroup() %>%
  ggplot(aes(x = fake_date, y = total_daily_catch)) + 
  geom_col() + 
  scale_x_date(labels = date_format("%b"), limits = c(as.Date("1900-10-01"), as.Date("1901-06-01")), date_breaks = "1 month") + 
  theme_minimal() + 
  theme(text = element_text(size = 10),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        legend.position = "bottom") + 
  labs(title = "Total Daily Raw Passage 2000 - 2010",
       y = "Total daily catch",
       x = "Date")+ 
  facet_wrap(~water_year, scales = "free") + 
  scale_fill_manual(values = palette)
```

```{r}
cleaner_data  %>%
  # filter(year(date) < 2021) %>% 
  mutate(year = as.factor(year(date))) %>%
  ggplot(aes(x = year, y = count)) + 
  geom_col() + 
  theme_minimal() +
  labs(title = "Total Fish Counted Each Year by Life Stage",
       y = "Total fish count") + 
  theme(text = element_text(size = 10),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
  facet_wrap(~stage_code, scales = "free_y")
```

**Numeric Summary of count from 1999 to 2009**
```{r}
summary(cleaner_data$count)
```
**NA and Unknown Values**  

* `r round(sum(is.na(cleaner_data$'count'))/nrow(cleaner_data), 3)*100` % of values in the `count` column are NA.
