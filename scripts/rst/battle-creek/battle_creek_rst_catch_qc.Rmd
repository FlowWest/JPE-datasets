---
title: "Battle Creek RST QC"
author: "Erin Cain"
date: "9/29/2021"
output: rmarkdown::github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, fig.width=15, fig.height=10)
library(tidyverse)
library(lubridate)
library(googleCloudStorageR)
library(ggplot2)
library(scales)
library(readxl)
palette <- wesanderson::wes_palette(name = "Moonrise2")
```

# Battle Creek Rotary Screw Trap Data

## Description of Monitoring Data

These data were collected by the U.S. Fish and Wildlife Service's, Red Bluff Fish and Wildlife Office's, Battle Creek Monitoring Program. These data represent brood years (BY) 2003-2020 The fish were captured in the upper Battle Creek rotary screw trap site (UBC), Shasta County, California, from September 30, 2003, through June 30, 2021. The catch data were collected using a 5-ft diameter rotary screw trap located at river mile 6.2. The data represent both the raw catch and processed catch values. The trap was only fished through March 25, 2020, during BY2019 sampling.									

**Timeframe:** 2003 - 2021

**Screw Trap Season:** September - June

**Completeness of Record throughout timeframe:** 

**Sampling Location:** Upper Battle Creek (UBC)

**Data Contact:** [Mike Schraml](mailto:mike_schraml@fws.gov)

Any additional info?

## Access Cloud Data

```{r, eval=FALSE}
# Run Sys.setenv() to specify GCS_AUTH_FILE and GCS_DEFAULT_BUCKET before running 
# getwd() to see how to specify paths 
# Open object from google cloud storage
# Set your authentication using gcs_auth
gcs_auth(json_file = Sys.getenv("GCS_AUTH_FILE"))
# Set global bucket 
gcs_global_bucket(bucket = Sys.getenv("GCS_DEFAULT_BUCKET"))

gcs_list_objects()
# git data and save as xlsx
gcs_get_object(object_name = "rst/battle-creek/data-raw/UBC Spring.xlsx",
               bucket = gcs_get_global_bucket(),
               saveToDisk = "raw_battle_rst_data.xlsx",
               overwrite = TRUE)
```

Read in data from google cloud, glimpse raw data and domain description sheet: 
```{r}
sheets <- excel_sheets("raw_battle_rst_data.xlsx")
sheets
raw_rst_count_data <- read_excel("raw_battle_rst_data.xlsx", sheet = "UBC Catch Data") %>% glimpse()
```

## Data transformations

```{r}
cleaner_rst_count <- raw_rst_count_data %>%
  janitor::clean_names() %>%
  rename("date" = sample_date,
         "fork_length" = fork_length,
         "lifestage" = life_stage,
         "count_2" = count,
         "count" = r_catch,
         "interpolated" = interp,
         "run" = race) %>%
  mutate(date = as.Date(date)) %>%
  select(-organism_code, -station_code, -brood_year, 
         -id_week, -fws_race,
         -count_2) %>% # raw catch data, I kept interpolated catch (only 1% of the data is interpolated)
  glimpse()

sum(cleaner_rst_count$interpolated == "YES")/nrow(cleaner_rst_count) * 100
```
 
## Explore Numeric Variables: {.tabset}

```{r}
cleaner_rst_count %>% select_if(is.numeric) %>% colnames()
```

### Variable: `fork_length`

**Plotting fork_length**
  
```{r}
cleaner_rst_count %>% filter(fork_length < 250) %>% # filter out 13 points so we can more clearly see distribution
  ggplot(aes(x = fork_length)) + 
  geom_histogram(breaks=seq(0, 200, by=2)) + 
  scale_x_continuous(breaks=seq(0, 200, by=25)) +
  theme_minimal() +
  labs(title = "Fork length distribution") + 
  theme(text = element_text(size = 18),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
```

```{r}
cleaner_rst_count %>% 
  mutate(year = as.factor(year(date))) %>%
  ggplot(aes(x = fork_length, y = lifestage)) + 
  geom_boxplot() + 
  theme_minimal() +
  labs(title = "Fork length summarized by lifestage") + 
  theme(text = element_text(size = 18),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
```

**Numeric Summary of fork_length over Period of Record**
  
```{r}
# Table with summary statistics
summary(cleaner_rst_count$fork_length)
```

**NA and Unknown Values**
  
* `r round(sum(is.na(cleaner_rst_count$fork_length))/nrow(cleaner_rst_count), 3) * 100` % of values in the `fork_length` column are NA. 
* 0 for `fork_length` seems like an NA or error

### Variable: `count`

Catch number used to generate passage indices for reports, plus counts are split into races, zero fork lengths have been assigned							


**Plotting fish counts over period of record**
```{r, include=FALSE}
sac_indices <- waterYearType::water_year_indices %>% 
    filter(location == "Sacramento Valley") %>% 
    transmute(water_year = WY, year_type = as.character(Yr_type))
```

```{r}
cleaner_rst_count %>% 
  filter(year(date) > 2014, year(date) < 2021) %>%
  mutate(water_year = ifelse(month(date) %in% 10:12, year(date) + 1, year(date))) %>% 
  left_join(sac_indices) %>%
  mutate(year = as.factor(year(date)),
         fake_year = if_else(month(date) %in% 10:12, 1900, 1901),
         fake_date = as.Date(paste0(fake_year,"-", month(date), "-", day(date)))) %>%
  filter(water_year < 2021) %>%
  group_by(date) %>%
  mutate(total_daily_catch = sum(count)) %>%
  ungroup() %>%
  ggplot(aes(x = fake_date, y = total_daily_catch, fill = year_type)) + 
  geom_col() + 
  scale_x_date(labels = date_format("%b"), limits = c(as.Date("1900-10-01"), as.Date("1901-06-01")), date_breaks = "1 month") + 
  theme_minimal() + 
  theme(text = element_text(size = 18),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        legend.position = "bottom") + 
  labs(title = "Total Daily Raw Passage 2015 - 2020",
       y = "Total daily raw catch",
       x = "Date")+ 
  facet_wrap(~water_year, scales = "free") +
  scale_color_manual(palette)
```

  
```{r}
cleaner_rst_count  %>%
  filter(year(date) < 2021, run %in% c("F", "L", "S", "W")) %>% 
  mutate(year = as.factor(year(date))) %>%
  ggplot(aes(x = year, y = count)) + 
  geom_col() + 
  theme_minimal() +
  labs(title = "Total Fish Counted each Year by run",
       y = "Total fish raw catch") + 
  theme(text = element_text(size = 18),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
  facet_wrap(~run, scales = "free_y")
```

**Numeric Summary of counts over Period of Record**
  
```{r}
# Table with summary statistics
summary(cleaner_rst_count$count)
```

**NA and Unknown Values**
  
* `r round(sum(is.na(cleaner_rst_count$count))/nrow(cleaner_rst_count), 3) * 100` % of values in the `count` column are NA.


## Explore Categorical variables: {.tabset}

General notes: If there is an opportunity to turn yes no into boolean do so, but not if you loose value 

```{r}
cleaner_rst_count %>% select_if(is.character) %>% colnames()
```


### Variable: `sample_id`
```{r}
length(unique(cleaner_rst_count$sample_id)) 
```

There are `r length(unique(cleaner_rst_count$sample_id))`  unique sample ID

**NA and Unknown Values**

* `r round(sum(is.na(cleaner_rst_count$sample_id))/nrow(cleaner_rst_count), 3) * 100` % of values in the `sample_id` column are NA.

### Variable: `run`
```{r}
table(cleaner_rst_count$run)
```


Fix inconsistencies with spelling, capitalization, and abbreviations. 

```{r}
cleaner_rst_count$run <- case_when(cleaner_rst_count$run == "F" ~ "fall", 
                                   cleaner_rst_count$run == "S" ~ "spring",
                                   cleaner_rst_count$run == "L" ~ "late fall",
                                   cleaner_rst_count$run == "W" ~ "winter")
table(cleaner_rst_count$run)
```

**NA and Unknown Values**

* `r round(sum(is.na(cleaner_rst_count$run))/nrow(cleaner_rst_count), 3) * 100` % of values in the `run` column are NA.


### Variable: `lifestage`

Life stage of the catch (CHN = C0 - yolk-sac fry, C1 - fry, C2 - parr, C3 - silvery parr, C4 - smolt, n/p - Not provided; RBT = R1 - yolk-sac fry, R2 - fry, R3 - parr, R4 - silvery parr, R5 - smolt, R6 - adult)							


```{r}
table(cleaner_rst_count$lifestage)
```


Fix inconsistencies with spelling, capitalization, and abbreviations. 

```{r}
cleaner_rst_count$lifestage <- case_when(cleaner_rst_count$lifestage == "C0" ~ "yolk-sac fry", 
                                   cleaner_rst_count$lifestage == "C1" ~ "fry",
                                   cleaner_rst_count$lifestage == "C2" ~ "parr",
                                   cleaner_rst_count$lifestage == "C3" ~ "silvery parr",
                                   cleaner_rst_count$lifestage == "C4" ~ "smolt")
table(cleaner_rst_count$lifestage)
```

**NA and Unknown Values**

* `r round(sum(is.na(cleaner_rst_count$lifestage))/nrow(cleaner_rst_count), 3) * 100` % of values in the `lifestage` column are NA.

### Variable: `dead`

Indicates if the fish was a mortality (YES = mortality)							
							


```{r}
table(cleaner_rst_count$dead)
```


Fix inconsistencies with spelling, capitalization, and abbreviations. 

```{r}
cleaner_rst_count$dead <- case_when(cleaner_rst_count$dead == "YES" ~ TRUE, 
                                   cleaner_rst_count$dead == "N" |  cleaner_rst_count$dead == "NO" ~ FALSE)
table(cleaner_rst_count$dead)
```

**NA and Unknown Values**

* `r round(sum(is.na(cleaner_rst_count$dead))/nrow(cleaner_rst_count), 3) * 100` % of values in the `dead` column are NA.

### Variable: `interpolated`

Is count value an interpolated catch for times the trap did not fish? Yes = the data is interpolated data and not actual catch data		

```{r}
table(cleaner_rst_count$interpolated)
```


Fix inconsistencies with spelling, capitalization, and abbreviations. 

```{r}
cleaner_rst_count$interpolated <- case_when(cleaner_rst_count$interpolated == "YES" ~ TRUE, 
                                            cleaner_rst_count$interpolated == "NO" ~ FALSE)
table(cleaner_rst_count$interpolated)
```

**NA and Unknown Values**

* `r round(sum(is.na(cleaner_rst_count$interpolated))/nrow(cleaner_rst_count), 3) * 100` % of values in the `interpolated` column are NA.

## Summary of identified issues

* Count values are interpolated on days where the traps were not fished, to see if interpolated or not refer to `interpolated` column,

## Save cleaned data back to google cloud 

```{r}
battle_rst_catch <- cleaner_rst_count %>% glimpse()
```

```{r, eval=FALSE}
# Write to google cloud 
# Name file [watershed]_[data type].csv
f <- function(input, output) write_csv(input, file = output)
gcs_upload(battle_rst_catch,
           object_function = f,
           type = "csv",
           name = "rst/battle-creek/data/battle_rst_catch.csv")
```